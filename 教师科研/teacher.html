<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›½äº§å¤§æ¨¡å‹æ§åˆ¶å° v3</title>
  <script src="assets/js/tailwindcss.js"></script>
  <link rel="stylesheet" href="assets/css/material-symbols.css">
  <script src="assets/js/marked.min.js"></script>
  <style>
    *{font-family:system-ui,-apple-system,sans-serif}
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
    .provider-btn.active{background:#1e293b!important;color:#fff!important}
    .mode-btn.active{background:#3b82f6!important;color:#fff!important}
    .markdown-body pre{background:#1e293b;padding:1em;border-radius:8px;overflow-x:auto}
    .markdown-body code{background:#f1f5f9;padding:2px 6px;border-radius:4px}
    .markdown-body pre code{background:transparent;color:#e2e8f0}
    .generated-image{max-width:100%;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);cursor:pointer;transition:transform 0.2s}
    .generated-image:hover{transform:scale(1.02)}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
        <span class="material-symbols-outlined text-blue-600">psychology</span>
        å›½äº§å¤§æ¨¡å‹æ§åˆ¶å° <span class="text-xs text-green-500 font-normal">v3.0</span>
      </h1>
      <div class="flex items-center gap-2">
        <button class="mode-btn active text-xs py-1.5 px-3 rounded-lg border border-slate-200" data-mode="chat">
          <span class="material-symbols-outlined text-sm align-middle">chat</span> å¯¹è¯
        </button>
        <button class="mode-btn text-xs py-1.5 px-3 rounded-lg border border-slate-200 bg-slate-50" data-mode="image">
          <span class="material-symbols-outlined text-sm align-middle">image</span> ç”Ÿå›¾
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <aside class="space-y-4">
      <!-- æœåŠ¡å•†é€‰æ‹© -->
      <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
        <h2 class="text-sm font-bold text-slate-700 mb-3">æœåŠ¡å•†</h2>
        <div id="providerBtns" class="grid grid-cols-3 gap-2 mb-4">
          <button class="provider-btn active text-xs py-2 px-3 rounded-lg border border-slate-200" data-provider="deepseek">DeepSeek</button>
          <button class="provider-btn text-xs py-2 px-3 rounded-lg border border-slate-200 bg-slate-50" data-provider="dashscope">é€šä¹‰åƒé—®</button>
          <button class="provider-btn text-xs py-2 px-3 rounded-lg border border-slate-200 bg-slate-50" data-provider="kimi">Kimi</button>
        </div>
        <div class="space-y-3">
          <div>
            <label class="text-xs text-slate-600 block mb-1">API Key</label>
            <input id="apiKey" type="password" placeholder="sk-..." class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="text-xs text-slate-600 block mb-1">æ¨¡å‹</label>
            <select id="model" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
          </div>
          <button onclick="saveConfig()" class="w-full bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium py-2.5 rounded-lg">ä¿å­˜é…ç½®</button>
        </div>
      </div>

      <!-- ç”Ÿå›¾å‚æ•° -->
      <div id="imageParams" class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hidden">
        <h2 class="text-sm font-bold text-slate-700 mb-3">ç”Ÿå›¾å‚æ•°</h2>
        <div class="space-y-3">
          <div>
            <label class="text-xs text-slate-600 block mb-1">å›¾ç‰‡å°ºå¯¸</label>
            <select id="imageSize" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="1024*1024">1024Ã—1024 (1:1 æ–¹å½¢)</option>
              <option value="1280*1280">1280Ã—1280 (1:1 é«˜æ¸…)</option>
              <option value="720*1280">720Ã—1280 (9:16 ç«–ç‰ˆ)</option>
              <option value="1280*720">1280Ã—720 (16:9 æ¨ªç‰ˆ)</option>
              <option value="960*1280">960Ã—1280 (3:4 ç«–ç‰ˆ)</option>
              <option value="1280*960">1280Ã—960 (4:3 æ¨ªç‰ˆ)</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-600 block mb-1">ç”Ÿæˆæ•°é‡</label>
            <select id="imageCount" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="1">1 å¼ </option>
              <option value="2">2 å¼ </option>
              <option value="4">4 å¼ </option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-600 block mb-1">æ™ºèƒ½æ”¹å†™æç¤ºè¯</label>
            <select id="promptExtend" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="true">å¼€å¯ï¼ˆæ¨èï¼‰</option>
              <option value="false">å…³é—­</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-600 block mb-1">åå‘æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
            <input id="negativePrompt" type="text" placeholder="ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
      </div>

      <!-- å¸®åŠ©ä¿¡æ¯ -->
      <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-xs text-slate-600">
        <p class="font-semibold text-slate-800 mb-2">ğŸ”‘ è·å– API Key</p>
        <ul class="space-y-1">
          <li><a href="https://platform.deepseek.com/api_keys" target="_blank" class="text-blue-600 hover:underline">â†’ DeepSeek</a></li>
          <li><a href="https://dashscope.console.aliyun.com/apiKey" target="_blank" class="text-blue-600 hover:underline">â†’ é€šä¹‰åƒé—®ï¼ˆæ”¯æŒç”Ÿå›¾ï¼‰</a></li>
          <li><a href="https://platform.moonshot.cn/console/api-keys" target="_blank" class="text-blue-600 hover:underline">â†’ Kimi</a></li>
        </ul>
        <div class="mt-3 p-2 bg-green-50 border border-green-200 rounded-lg">
          <p class="text-green-700 font-medium">ğŸ†• æœ€æ–°æ›´æ–°</p>
          <ul class="text-green-600 mt-1 space-y-0.5">
            <li>â€¢ ä¸‡ç›¸ 2.6 å›¾åƒç”Ÿæˆä¸ç¼–è¾‘</li>
            <li>â€¢ Kimi K2 Thinking æ¨ç†æ¨¡å‹</li>
          </ul>
        </div>
      </div>
    </aside>

    <section class="lg:col-span-2 flex flex-col bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden" style="height:calc(100vh - 160px)">
      <div class="flex items-center justify-between px-4 py-2 border-b border-slate-100 bg-slate-50">
        <span id="statusInfo" class="text-xs text-slate-500">DeepSeek Â· deepseek-chat Â· å¯¹è¯æ¨¡å¼</span>
        <button onclick="clearChat()" class="text-xs text-red-500 hover:underline">æ¸…ç©ºå†…å®¹</button>
      </div>
      <div id="chatlog" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="flex gap-3">
          <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
            <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
          </div>
          <div class="bg-slate-100 rounded-2xl rounded-tl-none px-4 py-3 text-sm text-slate-700 max-w-[80%]">
            æ¬¢è¿ä½¿ç”¨å›½äº§å¤§æ¨¡å‹æ§åˆ¶å° v3.0ï¼<br><br>
            <span class="text-green-600">ğŸ†• <b>æœ€æ–°æ¨¡å‹å·²æ›´æ–°ï¼š</b></span><br>
            â€¢ <b>ä¸‡ç›¸ 2.6</b> - æ”¯æŒå›¾åƒç¼–è¾‘ã€å›¾æ–‡æ··åˆè¾“å‡º<br>
            â€¢ <b>Kimi K2 Thinking</b> - æœ€å¼ºæ¨ç†ï¼Œæ”¯æŒ200+å·¥å…·è°ƒç”¨<br><br>
            <span class="text-amber-600">ğŸ’¡ åˆ‡æ¢åˆ°"ç”Ÿå›¾"æ¨¡å¼å¹¶é€‰æ‹©é€šä¹‰åƒé—®ï¼Œå³å¯ä½¿ç”¨æ–‡ç”Ÿå›¾åŠŸèƒ½ã€‚</span>
          </div>
        </div>
      </div>
      <div class="p-3 border-t border-slate-100">
        <div class="flex gap-2">
          <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€..." class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm resize-none h-12 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          <button onclick="send()" id="sendBtn" class="px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-1">
            <span class="material-symbols-outlined">send</span>
          </button>
        </div>
      </div>
    </section>
  </main>

<script>
// é…ç½®ä¿¡æ¯ - 2025å¹´12æœˆæœ€æ–°æ¨¡å‹
const P = {
  deepseek: { 
    name: "DeepSeek", 
    chatUrl: "https://api.deepseek.com/chat/completions", 
    imageUrl: null,
    chatModels: [
      { id: "deepseek-chat", name: "DeepSeek-V3" }, 
      { id: "deepseek-reasoner", name: "DeepSeek-R1 (æ¨ç†)" }
    ],
    imageModels: [],
    apiKey: "sk-91f13b8953f04ff1be1b81f0fc2975cf" 
  },
  dashscope: { 
    name: "é€šä¹‰åƒé—®", 
    chatUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions", 
    // æ–‡ç”Ÿå›¾V2 API (ä¸‡ç›¸2.5åŠä»¥ä¸‹)
    imageUrlV2: "https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis",
    // ä¸‡ç›¸2.6 API (æ–°ç‰ˆ)
    imageUrl26: "https://dashscope.aliyuncs.com/api/v1/services/aigc/image-generation/generation",
    imageTaskUrl: "https://dashscope.aliyuncs.com/api/v1/tasks/",
    chatModels: [
      { id: "qwen-max", name: "Qwen-Max (æ——èˆ°)" }, 
      { id: "qwen-plus", name: "Qwen-Plus" }, 
      { id: "qwen-turbo", name: "Qwen-Turbo (å¿«é€Ÿ)" },
      { id: "qwen3-235b-a22b", name: "Qwen3-235B (å¼€æºæ——èˆ°)" }
    ],
    // æœ€æ–°çš„æ–‡ç”Ÿå›¾æ¨¡å‹åˆ—è¡¨
    imageModels: [
      { id: "wan2.6-image", name: "ğŸ†• ä¸‡ç›¸ 2.6ï¼ˆæœ€æ–°æ¨èï¼‰", api: "v26" },
      { id: "wan2.5-t2i-preview", name: "ä¸‡ç›¸ 2.5 Preview", api: "v2" },
      { id: "wan2.2-t2i-flash", name: "ä¸‡ç›¸ 2.2 Flashï¼ˆæé€Ÿï¼‰", api: "v2" },
      { id: "wan2.2-t2i-plus", name: "ä¸‡ç›¸ 2.2 Plusï¼ˆä¸“ä¸šï¼‰", api: "v2" },
      { id: "wanx2.1-t2i-turbo", name: "ä¸‡ç›¸ 2.1 Turbo", api: "v2" }
    ],
    apiKey: "sk-c2d1035ff7504269b2f91d5015940a7d" 
  },
  kimi: { 
    name: "Kimi", 
    chatUrl: "https://api.moonshot.cn/v1/chat/completions", 
    imageUrl: null,
    chatModels: [
      { id: "kimi-k2-thinking", name: "ğŸ†• Kimi K2 Thinkingï¼ˆæœ€å¼ºæ¨ç†ï¼‰" },
      { id: "kimi-k2-0711-preview", name: "Kimi K2ï¼ˆä¸‡äº¿å‚æ•°ï¼‰" },
      { id: "moonshot-v1-128k", name: "Moonshot 128k" },
      { id: "moonshot-v1-32k", name: "Moonshot 32k" }, 
      { id: "moonshot-v1-8k", name: "Moonshot 8k" }
    ],
    imageModels: [],
    apiKey: "sk-AYgn7rfSo6IerhNhW45fj4QcSwQHfcC1yMOK2ilMxb1oERrq" 
  }
};

let S = { 
  provider: "deepseek", 
  apiKey: "", 
  model: "deepseek-chat", 
  messages: [],
  mode: "chat"
};

const $ = id => document.getElementById(id);

// åˆå§‹åŒ–
(function() {
  try { 
    const c = JSON.parse(localStorage.getItem("cfg")); 
    if (c) S = { ...S, ...c, messages: [] }; 
  } catch {}
  
  if (!localStorage.getItem("cfg") || !S.apiKey) {
    S.apiKey = P[S.provider].apiKey;
  }
  $("apiKey").value = S.apiKey;
  updateUI();
  saveConfig();
  
  document.querySelectorAll(".provider-btn").forEach(b => b.onclick = () => { 
    S.provider = b.dataset.provider; 
    S.apiKey = P[S.provider].apiKey;
    $("apiKey").value = S.apiKey;
    updateUI();
    saveConfig();
    toast("å·²åˆ‡æ¢åˆ° " + P[S.provider].name);
  });
  
  document.querySelectorAll(".mode-btn").forEach(b => b.onclick = () => {
    S.mode = b.dataset.mode;
    updateUI();
    if (S.mode === "image" && P[S.provider].imageModels.length === 0) {
      toast("âš ï¸ " + P[S.provider].name + " ä¸æ”¯æŒç”Ÿå›¾ï¼Œè¯·åˆ‡æ¢åˆ°é€šä¹‰åƒé—®");
    }
  });
  
  $("input").onkeydown = e => { 
    if (e.key === "Enter" && !e.shiftKey) { 
      e.preventDefault(); 
      send(); 
    } 
  };
})();

function updateUI() {
  document.querySelectorAll(".provider-btn").forEach(b => 
    b.classList.toggle("active", b.dataset.provider === S.provider)
  );
  document.querySelectorAll(".mode-btn").forEach(b => 
    b.classList.toggle("active", b.dataset.mode === S.mode)
  );
  
  const models = S.mode === "chat" ? P[S.provider].chatModels : P[S.provider].imageModels;
  if (models.length === 0 && S.mode === "image") {
    $("model").innerHTML = '<option value="">è¯¥æœåŠ¡å•†ä¸æ”¯æŒç”Ÿå›¾</option>';
  } else {
    $("model").innerHTML = models.map(x => `<option value="${x.id}">${x.name}</option>`).join("");
    if (models.find(x => x.id === S.model)) {
      $("model").value = S.model;
    } else if (models.length > 0) {
      S.model = models[0].id;
    }
  }
  
  const modeText = S.mode === "chat" ? "å¯¹è¯æ¨¡å¼" : "ç”Ÿå›¾æ¨¡å¼";
  $("statusInfo").textContent = `${P[S.provider].name} Â· ${S.model || "æ— å¯ç”¨æ¨¡å‹"} Â· ${modeText}`;
  $("input").placeholder = S.mode === "chat" ? "è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€..." : "æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡ï¼ŒæŒ‰ Enter ç”Ÿæˆ...";
  $("imageParams").classList.toggle("hidden", S.mode !== "image");
}

function saveConfig() {
  S.apiKey = $("apiKey").value.trim();
  S.model = $("model").value;
  localStorage.setItem("cfg", JSON.stringify({ 
    provider: S.provider, 
    apiKey: S.apiKey, 
    model: S.model,
    mode: S.mode
  }));
  updateUI();
  toast("å·²ä¿å­˜");
}

function clearChat() { 
  $("chatlog").innerHTML = ""; 
  S.messages = []; 
}

function toast(m) {
  const d = document.createElement("div");
  d.className = "fixed top-16 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-sm z-50";
  d.textContent = m;
  document.body.appendChild(d);
  setTimeout(() => d.remove(), 2000);
}

function addMsg(role, content) {
  const u = role === "user";
  const d = document.createElement("div");
  d.className = `flex gap-3 ${u ? "flex-row-reverse" : ""}`;
  d.innerHTML = `
    <div class="w-8 h-8 ${u ? "bg-slate-600" : "bg-blue-600"} rounded-full flex items-center justify-center flex-shrink-0">
      <span class="material-symbols-outlined text-white text-sm">${u ? "person" : "smart_toy"}</span>
    </div>
    <div class="max-w-[80%]">
      <div class="reason-box hidden mb-2 text-xs bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-800 max-h-40 overflow-y-auto"></div>
      <div class="content ${u ? "bg-blue-600 text-white rounded-tr-none" : "bg-slate-100 text-slate-700 rounded-tl-none"} rounded-2xl px-4 py-3 text-sm markdown-body">${content || '<span class="animate-pulse">å¤„ç†ä¸­...</span>'}</div>
    </div>`;
  $("chatlog").appendChild(d);
  $("chatlog").scrollTop = $("chatlog").scrollHeight;
  return d;
}

async function send() {
  const c = $("input").value.trim();
  if (!c) return;
  if (!S.apiKey) { toast("è¯·å…ˆå¡«å†™ API Key"); return; }
  
  if (S.mode === "image") {
    await generateImage(c);
  } else {
    await sendChat(c);
  }
}

// å¯¹è¯åŠŸèƒ½
async function sendChat(content) {
  addMsg("user", content);
  $("input").value = "";
  S.messages.push({ role: "user", content: content });
  
  const ai = addMsg("ai", "");
  const el = ai.querySelector(".content");
  const rb = ai.querySelector(".reason-box");
  
  try {
    const res = await fetch(P[S.provider].chatUrl, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${S.apiKey}`
      },
      body: JSON.stringify({ 
        model: S.model, 
        messages: S.messages, 
        temperature: 0.7, 
        max_tokens: 4096 
      })
    });
    
    if (!res.ok) {
      const errText = await res.text();
      throw new Error(`API é”™è¯¯ ${res.status}: ${errText.substring(0, 100)}`);
    }
    
    const j = await res.json();
    const m = j.choices?.[0]?.message;
    
    if (m?.content) {
      el.innerHTML = marked.parse(m.content);
      S.messages.push({ role: "assistant", content: m.content });
      // æ”¯æŒ reasoning_content (DeepSeek) å’Œ reasoning (Kimi K2 Thinking)
      const reasoning = m.reasoning_content || m.reasoning;
      if (reasoning) { 
        rb.classList.remove("hidden"); 
        rb.innerHTML = "<b>ğŸ’­ æ€è€ƒè¿‡ç¨‹:</b><br>" + reasoning; 
      }
    } else {
      throw new Error("æ— æ•ˆå“åº”");
    }
  } catch (e) {
    el.innerHTML = `<span class="text-red-500">âŒ ${e.message}</span>`;
  }
}

// è·å–å½“å‰é€‰ä¸­æ¨¡å‹çš„APIç‰ˆæœ¬
function getSelectedModelInfo() {
  const models = P[S.provider].imageModels;
  return models.find(m => m.id === S.model) || models[0];
}

// ç”Ÿå›¾åŠŸèƒ½
async function generateImage(prompt) {
  if (P[S.provider].imageModels.length === 0) {
    toast("âš ï¸ " + P[S.provider].name + " ä¸æ”¯æŒç”Ÿå›¾åŠŸèƒ½");
    return;
  }
  
  addMsg("user", "ğŸ¨ " + prompt);
  $("input").value = "";
  
  const ai = addMsg("ai", "");
  const el = ai.querySelector(".content");
  
  const modelInfo = getSelectedModelInfo();
  
  try {
    el.innerHTML = '<span class="animate-pulse">ğŸ¨ æ­£åœ¨æäº¤ç”Ÿå›¾ä»»åŠ¡...</span>';
    
    const size = $("imageSize").value;
    const n = parseInt($("imageCount").value);
    const promptExtend = $("promptExtend").value === "true";
    const negativePrompt = $("negativePrompt").value.trim();
    
    let imageUrl, requestBody;
    
    // æ ¹æ®æ¨¡å‹ç‰ˆæœ¬é€‰æ‹©ä¸åŒçš„API
    if (modelInfo.api === "v26") {
      // ä¸‡ç›¸ 2.6 API (æ–°ç‰ˆ messages æ ¼å¼)
      imageUrl = P[S.provider].imageUrl26;
      requestBody = {
        model: S.model,
        input: {
          messages: [{
            role: "user",
            content: [{ text: prompt }]
          }]
        },
        parameters: {
          size: size,
          n: n,
          prompt_extend: promptExtend,
          watermark: false,
          negative_prompt: negativePrompt || undefined
        }
      };
    } else {
      // ä¸‡ç›¸ 2.5 åŠä»¥ä¸‹ API (æ—§ç‰ˆæ ¼å¼)
      imageUrl = P[S.provider].imageUrlV2;
      requestBody = {
        model: S.model,
        input: {
          prompt: prompt,
          negative_prompt: negativePrompt || undefined
        },
        parameters: {
          size: size,
          n: n,
          prompt_extend: promptExtend,
          watermark: false
        }
      };
    }
    
    // æ­¥éª¤1ï¼šæäº¤ç”Ÿå›¾ä»»åŠ¡
    const submitRes = await fetch(imageUrl, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${S.apiKey}`,
        "X-DashScope-Async": "enable"
      },
      body: JSON.stringify(requestBody)
    });
    
    if (!submitRes.ok) {
      const errText = await submitRes.text();
      throw new Error(`æäº¤ä»»åŠ¡å¤±è´¥ ${submitRes.status}: ${errText.substring(0, 200)}`);
    }
    
    const submitData = await submitRes.json();
    const taskId = submitData.output?.task_id;
    
    if (!taskId) {
      throw new Error("æœªè·å–åˆ°ä»»åŠ¡ID: " + JSON.stringify(submitData));
    }
    
    el.innerHTML = `<span class="animate-pulse">ğŸ¨ ä»»åŠ¡å·²æäº¤ (${taskId.substring(0,8)}...)ï¼Œæ­£åœ¨ç”Ÿæˆ...</span>`;
    
    // æ­¥éª¤2ï¼šè½®è¯¢è·å–ç»“æœ
    let attempts = 0;
    const maxAttempts = 120;
    
    while (attempts < maxAttempts) {
      await new Promise(r => setTimeout(r, 2000));
      
      const taskRes = await fetch(P[S.provider].imageTaskUrl + taskId, {
        method: "GET",
        headers: { "Authorization": `Bearer ${S.apiKey}` }
      });
      
      if (!taskRes.ok) throw new Error(`æŸ¥è¯¢ä»»åŠ¡å¤±è´¥ ${taskRes.status}`);
      
      const taskData = await taskRes.json();
      const status = taskData.output?.task_status;
      
      if (status === "SUCCEEDED") {
        // æ ¹æ®APIç‰ˆæœ¬è§£æç»“æœ
        let images = [];
        
        if (modelInfo.api === "v26") {
          // ä¸‡ç›¸2.6è¿”å›æ ¼å¼
          const choices = taskData.output?.choices || [];
          choices.forEach(choice => {
            const content = choice.message?.content || [];
            content.forEach(item => {
              if (item.image) images.push({ url: item.image });
            });
          });
        } else {
          // ä¸‡ç›¸2.5åŠä»¥ä¸‹è¿”å›æ ¼å¼
          images = taskData.output?.results || [];
        }
        
        if (images.length === 0) throw new Error("æœªè·å–åˆ°ç”Ÿæˆçš„å›¾ç‰‡");
        
        // æ˜¾ç¤ºå›¾ç‰‡
        let html = '<div class="space-y-3">';
        images.forEach((img, idx) => {
          if (img.url) {
            html += `
              <div class="space-y-2">
                <img src="${img.url}" class="generated-image" alt="å›¾ç‰‡${idx+1}" onclick="window.open('${img.url}','_blank')">
                <div class="flex gap-2 text-xs">
                  <a href="${img.url}" target="_blank" class="text-blue-500 hover:underline">ğŸ”— æŸ¥çœ‹åŸå›¾</a>
                  <a href="${img.url}" download class="text-green-500 hover:underline">â¬‡ï¸ ä¸‹è½½</a>
                </div>
                ${img.actual_prompt ? `<details class="text-xs text-slate-500"><summary class="cursor-pointer">æŸ¥çœ‹ä¼˜åŒ–åçš„æç¤ºè¯</summary><p class="mt-1 p-2 bg-slate-50 rounded">${img.actual_prompt}</p></details>` : ''}
              </div>`;
          }
        });
        html += `<p class="text-xs text-slate-400 mt-2">âœ… æˆåŠŸç”Ÿæˆ ${images.length} å¼ å›¾ç‰‡ (é“¾æ¥24å°æ—¶å†…æœ‰æ•ˆ)</p></div>`;
        el.innerHTML = html;
        return;
        
      } else if (status === "FAILED") {
        throw new Error("ç”Ÿæˆå¤±è´¥: " + (taskData.output?.message || taskData.output?.code || "æœªçŸ¥é”™è¯¯"));
      } else if (status === "RUNNING") {
        el.innerHTML = `<span class="animate-pulse">ğŸ¨ ç”Ÿæˆä¸­... (${Math.floor(attempts * 2)}ç§’)</span>`;
      } else {
        el.innerHTML = `<span class="animate-pulse">â³ æ’é˜Ÿä¸­... (${Math.floor(attempts * 2)}ç§’)</span>`;
      }
      
      attempts++;
    }
    
    throw new Error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•");
    
  } catch (e) {
    el.innerHTML = `<span class="text-red-500">âŒ ${e.message}</span>`;
    console.error("ç”Ÿå›¾é”™è¯¯:", e);
  }
}
</script>
</body>
</html>