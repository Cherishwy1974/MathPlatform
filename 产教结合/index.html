<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 确保使用UTF-8编码 -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="产教思政育人案例库 - 职业教育创新实践平台">
    <meta name="theme-color" content="#3b82f6">
    <title>产教思政育人案例库</title>
    
    <!-- 使用本地 Tailwind CSS -->
    <link rel="stylesheet" href="css/output.css">
    
    <!-- 使用本地 JavaScript 库 -->
    <script src="js/lib/core-js.min.js"></script>
    
    <!-- 预加载关键资源 -->
    <!-- <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com"> -->
    
    <!-- PWA相关配置暂时注释掉,等文件准备好再启用 -->
    <!-- <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png"> -->
    
    <!-- 移除外部 polyfill -->
    <!-- <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script> -->
    
    <!-- MathJax配置优化 -->
    <style>
        /* 代码块样式优化 */
        .code-block {
            background: #282a36;
            color: #f8f8f2;
            padding: 1rem 1.25rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre;
            margin: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* 代码块滚动条样式 */
        .code-block::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .code-block::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .code-block::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .code-block::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* 代码块标题 */
        .code-block::before {
            content: 'Python';
            position: absolute;
            top: 0.25rem;
            right: 0.5rem;
            padding: 0.1rem 0.35rem;
            font-size: 0.7rem;
            color: #6272a4;
            background: rgba(98, 114, 164, 0.1);
            border-radius: 0.25rem;
            opacity: 0.8;
        }
        
        /* 数学公式容器样式 */
        .math-container {
            overflow-x: auto;
            margin: 0;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* 步骤容器样式 */
        .step-container {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 2fr);
            gap: 1rem;
            margin: 1rem 0;
            align-items: stretch;
        }
        
        @media (max-width: 1023px) {
            .step-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* MathJax 公式样式优化 */
        .MathJax {
            outline: none;
        }

        /* 暗色模式适配 */
        @media (prefers-color-scheme: dark) {
            .math-container {
                background: rgba(255, 255, 255, 0.02);
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .code-block {
                background: #1e1f29;
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .code-block::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
            }
            
            .code-block::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .code-block::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.15);
            }
        }
        
        /* Python语法高亮 - Dracula主题 */
        .code-block .keyword { color: #ff79c6; }         /* 关键字 */
        .code-block .builtin { color: #8be9fd; }         /* 内置函数 */
        .code-block .string { color: #f1fa8c; }          /* 字符串 */
        .code-block .comment { color: #6272a4; }         /* 注释 */
        .code-block .number { color: #bd93f9; }          /* 数字 */
        .code-block .operator { color: #ff79c6; }        /* 运算符 */
        .code-block .function { color: #50fa7b; }        /* 函数名 */
        .code-block .class { color: #8be9fd; }          /* 类名 */
        .code-block .variable { color: #f8f8f2; }       /* 变量 */
        .code-block .parameter { color: #ffb86c; }      /* 参数 */
        .code-block .decorator { color: #50fa7b; }      /* 装饰器 */

        /* 代码运行按钮 */
        .run-button {
            position: absolute;
            top: 0.25rem;
            right: 4rem;
            padding: 0.1rem 0.35rem;
            font-size: 0.7rem;
            color: #50fa7b;
            background: rgba(80, 250, 123, 0.1);
            border: 1px solid rgba(80, 250, 123, 0.2);
            border-radius: 0.25rem;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s ease;
        }

        .run-button:hover {
            opacity: 1;
            background: rgba(80, 250, 123, 0.2);
        }

        .run-button:active {
            transform: translateY(1px);
        }

        /* 代码输出容器 */
        .output-container {
            background: #1e1f29;
            color: #f8f8f2;
            padding: 0.75rem 1rem;
            border-radius: 0 0 0.5rem 0.5rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            display: none;
        }

        .output-container.show {
            display: block;
        }

        .output-error {
            color: #ff5555;
        }

        .output-success {
            color: #50fa7b;
        }

        #pyodide-loading {
            transition: all 0.3s ease;
            z-index: 1000;
            background-color: rgba(59, 130, 246, 0.7);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 0.75rem;
            opacity: 0.8;
        }

        #pyodide-loading.error {
            background-color: rgba(220, 38, 38, 0.7);
        }

        #pyodide-loading.success {
            background-color: rgba(16, 185, 129, 0.7);
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .skill-map-btn {
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.6), 0 5px 15px -5px rgba(147, 51, 234, 0.4);
            position: relative;
            z-index: 10;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }
        
        .skill-map-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.7), 0 10px 20px -5px rgba(147, 51, 234, 0.5);
        }
        
        .skill-map-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 10px;
            background: linear-gradient(45deg, #4f46e5, #9333ea, #ec4899, #4f46e5);
            background-size: 300% 300%;
            animation: borderGlow 4s ease infinite;
            z-index: -1;
            filter: blur(4px);
            opacity: 0.8;
        }
        
        .skill-map-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
            z-index: 1;
        }
        
        .skill-map-btn:hover::after {
            left: 100%;
        }
        
        .animate-shimmer {
            animation: shimmer 2s linear infinite;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            background-size: 200% 100%;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* 添加缺失的样式类 */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-card {
            background: rgba(31, 41, 55, 0.95);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #3b82f6;
        }

        .dark .section-title {
            color: #f3f4f6;
        }

        .input-field {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: white;
            color: #1f2937;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark .input-field {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        .dark .input-field:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .btn-primary {
            padding: 0.625rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            padding: 0.625rem 1.5rem;
            background: white;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .dark .btn-secondary {
            background: transparent;
            color: #60a5fa;
            border-color: #60a5fa;
        }

        .dark .btn-secondary:hover {
            background: #60a5fa;
            color: #1f2937;
        }
    </style>

    <!-- MathJax配置 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                packages: ['base', 'ams', 'noerrors', 'noundefined', 'configmacros', 'newcommand'],
                tags: 'ams',
                macros: {
                    RR: "{\\mathbb{R}}",
                    NN: "{\\mathbb{N}}",
                    ZZ: "{\\mathbb{Z}}",
                    CC: "{\\mathbb{C}}",
                    QQ: "{\\mathbb{Q}}"
                },
                environments: {
                    aligned: ['AMSmath'],
                    matrix: ['AMSmath']
                }
            },
            chtml: {
                scale: 1,
                minScale: .5,
                mtextInheritFont: true,
                matchFontHeight: true,
                displayAlign: 'center',
                displayIndent: '0'
            },
            options: {
                enableMenu: false,
                processHtmlClass: 'tex2jax_process',
                ignoreHtmlClass: 'tex2jax_ignore',
                renderActions: {
                    addMenu: [],
                    checkLoading: []
                },
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    MathJax.startup.promise.then(() => {
                        console.log('MathJax initial typesetting complete');
                        // 重新渲染所有公式
                        MathJax.typesetPromise && MathJax.typesetPromise();
                    });
                }
            },
            loader: {
                load: ['[tex]/ams', '[tex]/noerrors', '[tex]/noundefined', '[tex]/configmacros', '[tex]/newcommand']
            }
        };
    </script>
    
    <!-- 使用本地 MathJax -->
    <script src="js/mathjax/tex-chtml.js" id="MathJax-script"></script>
    <script src="js/mathjax/input/tex/extensions/ams.js"></script>
    <script src="js/mathjax/input/tex/extensions/noerrors.js"></script>
    <script src="js/mathjax/input/tex/extensions/noundefined.js"></script>
    <script src="js/mathjax/input/tex/extensions/newcommand.js"></script>
    <script src="js/mathjax/input/tex/extensions/configmacros.js"></script>

    <!-- 引入案例数据 -->
    <script type="module">
        import { initialCases } from './case.js';
        
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            // 将案例数据存储到全局变量
            window.cases = initialCases;
            
            // 渲染案例列表
            renderCases(window.cases.filter(c => c.type === 'political'));
            updateCounter();
            
            // 获取所有过滤按钮
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            // 添加分类按钮功能
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 移除所有按钮的active类和样式
                    filterBtns.forEach(b => {
                        b.classList.remove('active', 'bg-blue-500', 'text-white');
                        b.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                    });
                    
                    // 添加当前按钮的active类和样式
                    btn.classList.add('active', 'bg-blue-500', 'text-white');
                    btn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                    
                    const type = btn.dataset.type;
                    
                    let filteredCases;
                    if (type === 'all') {
                        filteredCases = window.cases;
                    } else {
                        filteredCases = window.cases.filter(c => c.type === type);
                    }
                    
                    renderCases(filteredCases);
                    updateCounter();
                });
            });

            // 添加搜索功能
            document.getElementById('case-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredCases = window.cases.filter(caseItem =>
                    caseItem.title.toLowerCase().includes(searchTerm) ||
                    caseItem.content.toLowerCase().includes(searchTerm) ||
                    caseItem.knowledgePoints.some(point => point.toLowerCase().includes(searchTerm))
                );
                renderCases(filteredCases);
                updateCounter();
            });

            // 添加排序功能
            document.getElementById('sort-by').addEventListener('change', (e) => {
                const sortType = e.target.value;
                let sortedCases = [...window.cases];
                
                switch(sortType) {
                    case 'time':
                        sortedCases.sort((a, b) => new Date(b.time) - new Date(a.time));
                        break;
                    case 'likes':
                        sortedCases.sort((a, b) => b.likes - a.likes);
                        break;
                    case 'recommended':
                        sortedCases.sort((a, b) => (b.likes * 0.7 + b.knowledgePoints.length * 0.3) - 
                                                (a.likes * 0.7 + a.knowledgePoints.length * 0.3));
                        break;
                }
                renderCases(sortedCases);
            });
        });
    </script>

    <!-- Firebase配置 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <script>
        // Firebase初始化状态跟踪
        window.firebaseInitStatus = {
            app: false,
            firestore: false,
            functions: false
        };
        
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyBogjtVOSWb9sOJNKlqktZg9W3smS7b3xw",
            authDomain: "dynamic-cases.firebaseapp.com",
            projectId: "dynamic-cases",
            storageBucket: "dynamic-cases.firebasestorage.app",
            messagingSenderId: "577619978169",
            appId: "1:577619978169:web:7a97960ce6e29085caf868",
            measurementId: "G-ENX7EHWNSV"
        };

        // 初始化Firebase应用
        try {
            firebase.initializeApp(firebaseConfig);
            window.firebaseInitStatus.app = true;
            console.log('Firebase应用初始化成功');
        } catch (error) {
            console.error('Firebase应用初始化失败:', error);
        }
        
        // 获取Firestore实例并设置区域为新加坡 (asia-southeast1)
        let db;
        try {
            db = firebase.firestore();
            window.firebaseInitStatus.firestore = true;
            
            // 设置Firestore的默认配置（不指定host，使用默认连接）
            db.settings({
                ignoreUndefinedProperties: true,
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            console.log('Firestore初始化成功，使用默认全球CDN连接');
        } catch (error) {
            console.error('Firestore初始化失败:', error);
            // 创建一个模拟的db对象，防止错误
            db = {
                collection: () => ({
                    add: () => Promise.reject(new Error('Firestore未初始化')),
                    doc: () => ({
                        delete: () => Promise.reject(new Error('Firestore未初始化')),
                        update: () => Promise.reject(new Error('Firestore未初始化'))
                    })
                })
            };
        }
        
        // 获取Cloud Functions实例
        let functions, addCaseFunction, updateCaseFunction, deleteCaseFunction;
        
        try {
            if (typeof firebase.functions === 'function') {
                // 初始化带区域的Cloud Functions（在v8.x版本中直接指定区域）
                // 香港区域(asia-east2)
                functions = firebase.app().functions('asia-east2');
                window.firebaseInitStatus.functions = true;
                
                // 创建Cloud Functions引用
                addCaseFunction = functions.httpsCallable('addCase');
                updateCaseFunction = functions.httpsCallable('updateCase'); 
                deleteCaseFunction = functions.httpsCallable('deleteCase');
                
                console.log('Cloud Functions初始化成功，已连接到香港区域服务器');
            } else {
                throw new Error('firebase.functions不可用');
            }
        } catch (error) {
            console.error('Cloud Functions初始化失败:', error);
            // 创建模拟函数，防止错误
            addCaseFunction = (data) => Promise.reject(new Error('Cloud Functions未初始化'));
            updateCaseFunction = (data) => Promise.reject(new Error('Cloud Functions未初始化'));
            deleteCaseFunction = (data) => Promise.reject(new Error('Cloud Functions未初始化'));
        }
        
        // 将Firebase功能暴露给全局
        window.db = db;
        window.collection = function(db, collectionPath) {
            return db.collection(collectionPath);
        };
        window.addDoc = function(collectionRef, data) {
            return collectionRef.add(data);
        };
        window.serverTimestamp = firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp : () => new Date();
        window.doc = function(db, docPath) {
            return db.doc(docPath);
        };
        window.deleteDoc = function(docRef) {
            return docRef.delete();
        };
        
        // 暴露Cloud Functions
        window.addCaseFunction = addCaseFunction;
        window.updateCaseFunction = updateCaseFunction;
        window.deleteCaseFunction = deleteCaseFunction;
        
        console.log("Firebase初始化完成", {
            app: window.firebaseInitStatus.app,
            db: !!window.db,
            firestore: window.firebaseInitStatus.firestore,
            functions: window.firebaseInitStatus.functions
        });
    </script>
    <style>
        /* 基础动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* 优化卡片样式 */
        .case-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: fadeIn 0.5s ease-out;
        }
        
        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* 表单面板优化 */
        .form-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f4ff 100%);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
            transition: transform 0.3s ease;
        }
        
        .form-panel:hover {
            transform: scale(1.005);
        }
        
        /* 加载状态优化 */
        .loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* 响应式优化 */
        @media (max-width: 640px) {
            .grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .industry-info {
                grid-template-columns: 1fr;
            }
            
            /* 改进移动端适配 */
            .case-list {
                margin-left: 0;
            }
            
            .timeline-item::before {
                left: -1.5rem;
            }
            
            /* 搜索和筛选区域优化 */
            .sticky.top-4 {
                top: 0;
                position: relative;
                z-index: 30;
            }
            
            .sticky.top-4 .flex.flex-wrap {
                flex-direction: column;
            }
            
            .sticky.top-4 .flex.flex-1 {
                flex-direction: column;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .skill-map-btn {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
                font-size: 16px;
                padding: 8px 12px;
            }
            
            /* 目录和内容区域优化 */
            .directory-item {
                padding: 10px;
            }
            
            #case-detail {
                padding: 12px;
            }
            
            /* 表单优化 */
        .form-panel {
                padding: 15px;
            }
            
            .btn-primary, .btn-secondary {
                width: 100%;
                margin-bottom: 10px;
            }
            
            /* 修复移动端布局问题 */
            .directory-container {
                display: flex;
                flex-direction: column;
            }
            
            .directory-list {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .input-field {
                width: 100%;
                font-size: 16px; /* 防止iOS自动缩放 */
            }
            
            /* 防止内容溢出 */
            .prose {
                overflow-wrap: break-word;
                word-wrap: break-word;
                word-break: break-word;
            }
            
            /* 代码块优化 */
            .code-block {
                max-width: 100%;
                font-size: 12px;
            }
            
            /* 数学公式容器优化 */
            .math-container {
                overflow-x: auto;
                max-width: 100%;
                -webkit-overflow-scrolling: touch;
            }
            
            /* 修复MathJax在移动端的显示 */
            .MathJax {
                max-width: 100% !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
            }
        }
        
        @media (max-width: 768px) {
            .info-panel {
                width: 90%;
                max-width: none;
                left: 5%;
                right: 5%;
            }
            
            /* 改进中等屏幕适配 */
            .directory-container {
                grid-template-columns: 1fr !important;
            }
            
            .md\:col-span-1, .md\:col-span-3 {
                grid-column: span 1 / span 1 !important;
            }
            
            .md\:col-span-1 {
                position: relative !important;
                top: 0 !important;
                max-height: none !important;
                margin-bottom: 15px;
            }
            
            .directory-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .directory-item {
                width: calc(50% - 8px);
                margin-bottom: 0;
            }
            
            /* 修复表格溢出 */
            table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* 修复按钮组 */
            .flex.gap-2.flex-wrap {
                gap: 8px;
            }
            
            .filter-btn {
                margin-bottom: 5px;
            }
        }
        
        @media (max-width: 480px) {
            /* 超小屏幕优化 */
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .directory-item {
                width: 100%;
            }
            
            .filter-btn {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .flex.gap-2.flex-wrap {
                flex-direction: column;
            }
            
            /* 修复标签溢出 */
            .tag-container {
                flex-wrap: wrap;
            }
            
            /* 修复步骤卡片 */
            .step-container {
                grid-template-columns: 1fr;
            }
            
            /* 修复知识点标签 */
            .knowledge-point {
                margin-bottom: 5px;
            }
            
            /* 修复案例详情 */
            #case-detail h2 {
                font-size: 1.3rem;
            }
            
            /* 修复表单元素 */
            textarea, input, select {
                font-size: 16px; /* 防止iOS自动缩放 */
            }
        }
        
        /* 全局修复 */
        * {
            -webkit-text-size-adjust: 100%; /* 防止iOS自动调整字体大小 */
        }
        
        /* 修复滚动问题 */
        body {
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }
        
        /* 修复图像溢出 */
        img {
            max-width: 100%;
            height: auto;
        }
        
        /* 修复模态框 */
        .modal {
            max-width: 100vw;
            max-height: 100vh;
            overflow: auto;
        }
        
        /* 修复技能图谱按钮 */
        .skill-map-btn {
            white-space: normal;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 整体布局缩小 */
        .container {
            width: 98%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 10px;
        }

        /* 标题区域缩小 */
        header {
            padding: 10px 0;
        }

        header h1 {
            font-size: 1.8rem;
        }

        header p {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* 技能图谱容器缩小 */
        .skill-map-container {
            height: 85vh;
            min-height: 700px;
            margin-top: 10px;
        }

        /* 图例和控制按钮缩小 */
        .legends-container {
            max-width: 250px;
            right: 20px;
            top: 20px;
        }

        .legend {
            padding: 15px;
        }

        .legend h4 {
            font-size: 14px;
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        .legend-item {
            margin-bottom: 8px;
            padding: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 10px;
        }

        .zoom-controls {
            left: 20px;
            top: 20px;
            gap: 10px;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }

        /* 返回按钮缩小 */
        .back-button {
            padding: 10px 16px;
            font-size: 14px;
            top: 20px;
            left: 20px;
        }

        .back-button svg {
            width: 18px;
            height: 18px;
        }

        /* 信息面板缩小 */
        .info-panel {
            width: 40%;
            max-width: 500px;
            padding: 20px;
            max-height: 610px;
        }

        .info-panel h2 {
            font-size: inherit;
            margin-bottom: 15px;
            padding-bottom: 10px;
        }

        .info-panel h3 {
            font-size: inherit;
            margin: 15px 0 10px;
        }

        .application-card {
            padding: 15px;
            margin-bottom: 10px;
        }

        .tag {
            padding: 2px 8px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* 页脚缩小 */
        footer {
            padding: 20px;
            margin-top: 30px;
        }
    </style>

    <!-- 简化的代码运行机制 -->
    <script>
function runPythonCode(codeId, outputId) {
    const outputElement = document.getElementById(outputId);
    if (!outputElement) return;
    
    // 显示加载动画
    outputElement.innerHTML = '<div class="flex items-center justify-center py-2"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>运行中...</div>';
    outputElement.className = 'output-container show';
    
    // 获取当前点击的按钮元素（触发事件的元素）
    const buttonElement = document.querySelector(`button[onclick*="runPythonCode('${codeId}', '${outputId}')"]`);
    
    // 从按钮的data-case属性获取案例编号
    const caseNumber = buttonElement ? parseInt(buttonElement.getAttribute('data-case')) || 1 : 1;
    
    console.log(`运行案例${caseNumber}的代码：${codeId}`);
    
    // 延迟一小段时间，模拟运行过程
    setTimeout(() => {
        import('./case.js').then(module => {
            let outputResult;
            
            // 根据案例编号选择输出
            const getOutputFunction = `getCodeOutput${caseNumber}`;
            if (typeof module[getOutputFunction] === 'function') {
                outputResult = module[getOutputFunction](codeId);
            } else if (typeof module.getCodeOutput === 'function') {
                outputResult = module.getCodeOutput(codeId, caseNumber);
            } else if (module.allOutputs && module.allOutputs[caseNumber]) {
                outputResult = module.allOutputs[caseNumber][codeId];
            }
            
            if (outputResult) {
                outputElement.innerHTML = outputResult;
                outputElement.classList.add('output-success');
            } else {
                console.warn(`No output found for case ${caseNumber}, code ${codeId}`);
                outputElement.innerHTML = `案例${caseNumber}代码执行完成`;
                outputElement.classList.add('output-warning');
            }
        }).catch(error => {
            console.error('Error loading case.js:', error);
            outputElement.innerHTML = '代码执行错误: ' + error.message;
            outputElement.classList.add('output-error');
        });
    }, 500);
}
    </script>
    
    <!-- AI助手样式 -->
    <style>
        /* AI 功能按钮统一样式 */
        .ai-feature-btn {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border: none;
            font-weight: 600;
        }

        .ai-feature-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .ai-feature-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        /* 录音状态动画 */
        .ai-feature-btn.recording {
            animation: pulse-recording 1.5s ease-in-out infinite;
        }

        @keyframes pulse-recording {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 8px 30px rgba(255, 107, 107, 0.8);
            }
        }

        /* 模态框遮罩 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* AI 语音助手模态框 */
        .voice-assistant-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1999;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .voice-assistant-modal.active {
            opacity: 1;
            pointer-events: all;
            transform: translate(-50%, -50%) scale(1);
        }

        .voice-chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
        }

        .voice-message {
            margin: 12px 0;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            max-width: 80%;
            word-wrap: break-word;
        }

        .voice-message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .voice-message.assistant {
            background: white;
            color: #333;
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .voice-status {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 14px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .voice-controls {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .voice-control-btn {
            padding: 15px 30px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-control-btn.primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .voice-control-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
        }

        .voice-control-btn.primary.recording {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            animation: pulse-btn 1.5s ease-in-out infinite;
        }

        @keyframes pulse-btn {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
            50% { box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6); }
        }

        /* 留言板模态框 */
        .message-board-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1999;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .message-board-modal.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: all;
        }

        .message-board-header {
            padding: 20px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .message-board-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message-board-footer {
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .message-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .message-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        /* 标签页样式 */
        .tab-btn {
            cursor: pointer;
        }

        .tab-btn.active {
            border-bottom-color: #8b5cf6 !important;
            color: #8b5cf6 !important;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* 聊天界面容器 */
        .chat-container {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            display: flex;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        .chat-container.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }
        
        /* 聊天界面头部 */
        .chat-header {
            padding: 15px;
            background: linear-gradient(90deg, #4f46e5, #9333ea);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .close-chat {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
        }
        
        /* 聊天消息区域 */
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8fafc;
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #e0e7ff;
            color: #1e293b;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background: white;
            color: #1e293b;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        /* 输入区域 */
        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            background: white;
            display: flex;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            outline: none;
            transition: border 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: #4f46e5;
        }
        
        .send-btn {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .send-btn:hover {
            background: #4338ca;
        }
        
        .send-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        /* 案例卡片中的AI助手按钮 */
        .case-ai-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
        }
        
        .case-ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }
        
        .case-ai-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* 加载效果 */
        .typing-indicator {
            padding: 15px;
            background: white;
            border-radius: 18px;
            display: inline-block;
            margin-bottom: 15px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #9ca3af;
            display: inline-block;
            border-radius: 50%;
            opacity: 0.4;
        }
        
        .typing-indicator span:nth-child(1) {
            animation: blink 1s infinite 0.3s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation: blink 1s infinite 0.5s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation: blink 1s infinite 0.7s;
        }
        
        @keyframes blink {
            50% { opacity: 1; }
        }
    </style>

    <!-- 在head部分底部添加配置 -->
    <script>
        // 火山引擎 API 配置
        // 获取 API Key 的步骤：
        // 1. 登录火山引擎控制台：https://console.volcengine.com/
        // 2. 进入：火山方舟 → API 访问密钥
        // 3. 创建或查看 API Key（格式：以 "ak-" 开头）
        // 4. 将 API Key 粘贴到下方 apiKey 字段
        window.volcengineConfig = {
            apiKey: "348522f9-6a1b-4d0b-ad6b-8faab8ea09c0",
            baseUrl: "https://sd413i7v6n5j6uua1gn70.apigateway-cn-beijing.volceapi.com",
            accountId: "2100415977",  // 账号ID
            username: "jianghui",     // 用户名

            // 文本对话模型（快速）
            textModel: {
                endpointId: "ep-20251030011739-pxv56",  // Doubao-lite-32k（快速模型）
                modelName: "Doubao-lite-32k"
            },

            // 图像生成模型
            imageModel: {
                endpointId: "ep-20251030011616-nrd29",  // Doubao-Seedream-4.0
                modelName: "Doubao-Seedream-4.0"
            },

            // 视频生成模型
            videoModel: {
                endpointId: "ep-20251030004255-jhlf6",  // Doubao-Seedance-1.0-lite-i2v（图生视频）
                modelName: "Doubao-Seedance-1.0-lite-i2v"
            },

            // 3D生成模型
            model3D: {
                endpointId: "ep-20251030011539-w2822",  // Doubao-Seed3D-1.0
                modelName: "Doubao-Seed3D-1.0"
            }
        };

        // Gitee 配置
        window.giteeConfig = {
            owner: "swywy_admin",
            repo: "video",
            accessToken: "6d2be8c68ff79ab587c54b183d7bfa6a",
            apiBase: "https://gitee.com/api/v5",
            // 完整的仓库 URL 用于验证
            repoUrl: "https://gitee.com/swywy_admin/video"
        };
    </script>

    <!-- 引入火山引擎 AI 模块 -->
    <script src="js/volcengine-ai.js"></script>

    <!-- 引入 Gitee 集成模块 -->
    <script src="js/gitee-integration.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 min-h-screen">
    <div class="container mx-auto px-2 py-4 max-w-7xl">
        <!-- 标题区 -->
        <div class="mb-4 text-center">
            <h1 class="text-2xl">产教思政育人案例库</h1>
            <p class="mt-1 text-gray-600 dark:text-gray-400 text-base max-w-2xl mx-auto">
                充分挖掘课程蕴含思政教育元素，实现思想价值教育与知识体系教育的有机统一
            </p>
        </div>

        <!-- 控制栏 -->
        <div class="glass-card p-3 mb-3">
            <div class="flex flex-col md:flex-row gap-2 items-start md:items-center justify-between">
                <div class="flex gap-1 flex-wrap">
                    <button data-type="political" 
                        class="filter-btn active px-3 py-1 rounded-lg shadow-sm hover:shadow-md transition-all transform hover:-translate-y-0.5 bg-red-500 text-white text-sm">
                        思政育人
                    </button>
                    <button data-type="industry" 
                        class="filter-btn px-3 py-1 rounded-lg shadow-sm hover:shadow-md transition-all transform hover:-translate-y-0.5 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm">
                        产业实践
                    </button>
                    <button data-type="all" 
                        class="filter-btn px-3 py-1 rounded-lg shadow-sm hover:shadow-md transition-all transform hover:-translate-y-0.5 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm">
                        全部案例
                    </button>
                </div>
                <div class="flex items-center text-xs">
                    <span class="text-gray-500 dark:text-gray-400">已收录</span>
                    <span class="mx-1 font-bold text-green-600 dark:text-green-400">289</span>
                    <span class="text-gray-500 dark:text-gray-400">个优质案例</span>
                </div>
                <div class="h-4 w-px bg-gray-300 dark:bg-gray-700"></div>
                <div class="flex items-center">
                    <span class="text-gray-500 dark:text-gray-400">产业案例</span>
                    <span class="mx-1 font-bold text-green-600 dark:text-green-400">157</span>
                    <span class="text-gray-500 dark:text-gray-400">个</span>
                </div>
                <div class="h-4 w-px bg-gray-300 dark:bg-gray-700"></div>
                <div class="flex items-center">
                    <span class="text-gray-500 dark:text-gray-400">思政融合案例</span>
                    <span class="mx-1 font-bold text-purple-600 dark:text-purple-400">132</span>
                    <span class="text-gray-500 dark:text-gray-400">个</span>
                </div>
            </div>
        </div>

        <!-- 搜索和筛选区 -->
        <div class="sticky top-2 z-40 glass-card mb-3 p-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex flex-1 items-center gap-2">
                <div class="relative flex-grow max-w-xl group">
                    <input type="search" id="case-search" 
                            class="input-field pl-8 py-1 text-sm"
                        placeholder="搜索案例标题或内容...">
                        <svg class="w-4 h-4 text-gray-400 dark:text-gray-500 absolute left-2 top-2 transition-colors group-hover:text-blue-500" 
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <select id="sort-by" 
                        class="input-field !w-auto cursor-pointer py-1 text-sm">
                    <option value="time">最新发布</option>
                    <option value="likes">最受欢迎</option>
                    <option value="recommended">推荐案例</option>
                </select>
                </div>
                <a href="index1.html" class="skill-map-btn flex items-center gap-1 px-4 py-1 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-lg shadow-md transition-all transform hover:-translate-y-1 font-medium text-sm relative overflow-hidden">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="relative z-10">数学技能图谱</span>
                </a>
            </div>
        </div>

        <!-- 案例展示区 -->
        <div id="case-wall" class="case-list space-y-6">
            <!-- 由JS动态生成案例列表 -->
        </div>

    </div>



    <!-- 页脚 -->
    <footer class="mt-12 py-8 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-600 dark:text-gray-400">© 2024 智慧产教案例库. All rights reserved.</p>
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">
                数据存储于 <a href="https://gitee.com/swywy_admin/video" target="_blank" class="text-blue-500 hover:underline">Gitee 仓库</a>
            </p>
        </div>
    </footer>

    <!-- AI 功能区 -->
    <div style="position: fixed; bottom: 30px; right: 30px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; align-items: flex-end;">

        <!-- AI 功能标签 -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
            🤖 AI 助手
        </div>

        <!-- 文生视频按钮 -->
        <button class="ai-feature-btn" id="text-to-video-btn" aria-label="文生视频" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <span style="font-size: 24px;">🎬</span>
            <span style="font-size: 11px; margin-top: 2px;">文生视频</span>
        </button>

        <!-- 文生图按钮 -->
        <button class="ai-feature-btn" id="text-to-image-btn" aria-label="文生图" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
            <span style="font-size: 24px;">🎨</span>
            <span style="font-size: 11px; margin-top: 2px;">文生图</span>
        </button>

        <!-- AI 语音助手按钮 -->
        <button class="ai-feature-btn" id="voice-assistant-btn" aria-label="AI语音助手" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <span style="font-size: 24px;">🎤</span>
            <span style="font-size: 11px; margin-top: 2px;">语音助手</span>
        </button>

        <!-- AI 对话按钮 -->
        <button class="ai-feature-btn" id="ai-assistant-btn" aria-label="AI对话" style="background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);">
            <span style="font-size: 24px;">💬</span>
            <span style="font-size: 11px; margin-top: 2px;">AI对话</span>
        </button>

        <!-- 留言板按钮 -->
        <button class="ai-feature-btn" id="message-board-btn" aria-label="留言板" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
            <span style="font-size: 24px;">📝</span>
            <span style="font-size: 11px; margin-top: 2px;">留言板</span>
        </button>
    </div>

    <!-- 模态框遮罩 -->
    <div class="modal-overlay" id="modal-overlay"></div>

    <!-- AI 语音助手模态框 -->
    <div class="voice-assistant-modal" id="voice-assistant-modal">
        <div class="message-board-header">
            <h3 class="text-xl font-bold flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                </svg>
                AI 语音助手
            </h3>
            <button id="close-voice-assistant" class="text-gray-500 hover:text-gray-700 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="voice-chat-history" id="voice-chat-history">
            <div class="voice-message assistant">
                你好！我是 AI 语音助手。点击下方麦克风按钮开始对话，我可以帮你：
                <ul style="margin-top: 8px; padding-left: 20px;">
                    <li>💬 语音对话交流</li>
                    <li>🎨 生成图像（描述你想要的图片）</li>
                    <li>📝 文本问答</li>
                </ul>
            </div>
        </div>

        <div class="voice-status" id="voice-status">准备就绪</div>

        <div class="voice-controls">
            <button id="voice-record-btn" class="voice-control-btn primary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                </svg>
                <span id="voice-btn-text">开始语音</span>
            </button>
        </div>
    </div>

    <!-- 留言板模态框 -->
    <div class="message-board-modal" id="message-board-modal">
        <div class="message-board-header">
            <h3 class="text-xl font-bold flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                </svg>
                互动交流平台
            </h3>
            <button id="close-message-board" class="text-white hover:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center transition text-2xl">×</button>
        </div>

        <div class="message-board-body">
            <!-- 所有提交记录 -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    最近提交
                </h4>
                <div id="all-submissions-list" class="space-y-3 max-h-60 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        加载中...
                    </div>
                </div>
            </div>

            <!-- 统一提交表单 -->
            <div class="bg-gradient-to-br from-purple-50 to-blue-50 p-5 rounded-xl border-2 border-purple-200">
                <h4 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    留言反馈 & 共创案例
                </h4>
                <form id="unified-form" class="space-y-3">
                    <!-- 基本信息 -->
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="unified-username" placeholder="您的昵称 *" required
                            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 outline-none transition text-sm bg-white">
                        <input type="email" id="unified-email" placeholder="邮箱（可选）"
                            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 outline-none transition text-sm bg-white">
                    </div>

                    <!-- 案例类型和领域 -->
                    <div class="grid grid-cols-2 gap-3">
                        <select id="unified-case-type" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 outline-none transition text-sm bg-white">
                            <option value="">选择类型（可选）</option>
                            <option value="industry">产业案例</option>
                            <option value="political">思政育人案例</option>
                            <option value="feedback">意见反馈</option>
                            <option value="suggestion">建议</option>
                            <option value="question">问题咨询</option>
                        </select>
                        <select id="unified-case-domain" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 outline-none transition text-sm bg-white">
                            <option value="">选择领域（可选）</option>
                        </select>
                    </div>

                    <!-- 标题 -->
                    <input type="text" id="unified-title" placeholder="标题 *" required
                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 outline-none transition text-sm bg-white">

                    <!-- 内容 -->
                    <textarea id="unified-content" rows="5" placeholder="请输入内容（支持TeX公式，如：C(t)=C_0e^{-kt}）*&#10;&#10;可以是：&#10;• 教学案例分享&#10;• 意见和建议&#10;• 问题咨询&#10;• 其他反馈" required
                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 outline-none resize-none transition text-sm bg-white"></textarea>

                    <!-- 知识点/标签 -->
                    <input type="text" id="unified-tags" placeholder="知识点/标签（可选，多个用逗号分隔）"
                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 outline-none transition text-sm bg-white">

                    <!-- 按钮组 -->
                    <div class="flex gap-2 pt-2">
                        <button type="submit" id="unified-submit-btn" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm">
                            💬 提交
                        </button>
                        <button type="button" id="unified-ai-enhance-btn" class="px-4 py-2.5 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            AI优化
                        </button>
                    </div>
                    <div id="unified-feedback" class="text-sm text-center font-medium"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- 聊天界面容器 -->
    <div class="chat-container" id="chat-container">
        <div class="chat-header">
            <div>AI案例分析助手</div>
            <button class="close-chat" id="close-chat">×</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message ai-message">
                你好！我是AI案例分析助手，可以解答您关于案例的任何问题，提供思政教育与案例分析建议。
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" class="chat-input" placeholder="输入您的问题..." />
            <button id="send-btn" class="send-btn" disabled>
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // 全局变量
        let currentCaseId = null;  // 当前打开的案例ID
        let currentCaseContent = null;  // 当前案例内容
        let casesContentCache = {};  // 存储已打开过的案例内容的缓存
        let isProcessing = false;  // 标记是否正在处理消息
        let filterBtns = null;  // 分类按钮集合
        let cases = [];  // 案例数据
        
        // 初始化聊天界面
        document.addEventListener('DOMContentLoaded', () => {
            // 将初始化逻辑移到 DOMContentLoaded 事件内部
            // 初始化cases变量为initialCases
            cases = window.initialCases || [];  // 修改这里,使用window.initialCases
            window.cases = cases; // 确保window.cases也被设置
            let lastSubmitted = null;
            let lastSubmittedId = null;

            // 直接渲染案例列表
            renderCases(cases.filter(c => c.type === 'political'));
            updateCounter();
            
            // 获取所有过滤按钮
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            // 添加分类按钮功能
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 移除所有按钮的active类和样式
                    filterBtns.forEach(b => {
                        b.classList.remove('active', 'bg-blue-500', 'text-white');
                        b.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                    });
                    
                    // 添加当前按钮的active类和样式
                    btn.classList.add('active', 'bg-blue-500', 'text-white');
                    btn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                    
                    const type = btn.dataset.type;
                    
                    let filteredCases;
                    if (type === 'all') {
                        filteredCases = window.cases;
                    } else {
                        filteredCases = window.cases.filter(c => c.type === type);
                    }
                    
                    renderCases(filteredCases);
                    updateCounter();
                });
            });

            // 添加搜索功能
            document.getElementById('case-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredCases = window.cases.filter(caseItem =>
                    caseItem.title.toLowerCase().includes(searchTerm) ||
                    caseItem.content.toLowerCase().includes(searchTerm) ||
                    caseItem.knowledgePoints.some(point => point.toLowerCase().includes(searchTerm))
                );
                renderCases(filteredCases);
                updateCounter();
            });

            // 添加排序功能
            document.getElementById('sort-by').addEventListener('change', (e) => {
                const sortType = e.target.value;
                let sortedCases = [...window.cases];
                
                switch(sortType) {
                    case 'time':
                        sortedCases.sort((a, b) => new Date(b.time) - new Date(a.time));
                        break;
                    case 'likes':
                        sortedCases.sort((a, b) => b.likes - a.likes);
                        break;
                    case 'recommended':
                        sortedCases.sort((a, b) => (b.likes * 0.7 + b.knowledgePoints.length * 0.3) - 
                                                (a.likes * 0.7 + a.knowledgePoints.length * 0.3));
                        break;
                }
                renderCases(sortedCases);
            });

            console.log('AI助手初始化完成');
            
            // 添加全局点击事件监听，处理案例分析按钮点击
            document.addEventListener('click', function(e) {
                // 查找点击的是否是案例分析按钮
                const aiBtn = e.target.closest('.case-ai-btn');
                if (aiBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 获取案例索引
                    const index = parseInt(aiBtn.dataset.index);
                    if (!isNaN(index)) {
                        console.log('全局监听：点击了案例分析按钮，索引:', index);
                        openAiAssistantForCase(index);
                    }
                }
            });
        });

        // 在页面加载后再次确保AI助手相关的事件绑定
        window.addEventListener('load', function() {
            // AI助手相关初始化
            const aiAssistantBtn = document.getElementById('ai-assistant-btn');
            const chatContainer = document.getElementById('chat-container');
            const closeChat = document.getElementById('close-chat');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!aiAssistantBtn || !chatContainer || !closeChat || !chatInput || !sendBtn) {
                console.error('无法获取AI助手相关元素');
                return;
            }
            
            // 打开聊天界面
            aiAssistantBtn.addEventListener('click', function() {
                console.log('切换聊天窗口显示状态');
                // 检查当前状态，如果已经打开则关闭，如果关闭则打开
                if (chatContainer.classList.contains('active')) {
                    // 如果已经打开，则关闭
                    chatContainer.classList.remove('active');
                } else {
                    // 如果关闭，则打开
                    chatContainer.classList.add('active');
                    chatInput.focus();
                }
            });
            
            // 关闭聊天界面 - 使用具体函数而不是箭头函数
            closeChat.addEventListener('click', function() {
                console.log('关闭聊天窗口');
                chatContainer.classList.remove('active');
            });
            
            // 监听输入框变化
            chatInput.addEventListener('input', function() {
                sendBtn.disabled = chatInput.value.trim() === '' || isProcessing;
            });
            
            // 确保聊天框输入为空时发送按钮禁用
            sendBtn.disabled = chatInput.value.trim() === '' || isProcessing;
            
            // 发送消息 - 使用具体函数而不是引用已有函数
            sendBtn.addEventListener('click', function() {
                console.log('发送消息');
                sendMessage();
            });
            
            // 回车发送消息
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !sendBtn.disabled) {
                    console.log('回车发送消息');
                    sendMessage();
                }
            });
            
            console.log('AI助手初始化完成');
        });

        // 定义不同类型的关联领域
        const domainsByType = {
            industry: [
                "机械制造",
                "电子工程", 
                "通信工程",
                "计算机科学",
                "人工智能",
                "物流工程",
                "建筑设计",
                "土木工程",
                "新能源汽车",
                "数据科学"
            ],
            political: [
                "传统工艺",
                "文化艺术",
                "科学技术史",
                "哲学与数学",
                "数学史",
                "思政教育",
                "工匠精神"
            ]
        };

        // 初始化关联领域下拉框
        function updateDomainOptions(type) {
            const domainSelect = document.getElementById('case-domain');
            domainSelect.innerHTML = ''; // 清空现有选项
            const domains = domainsByType[type] || [];
            domains.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                domainSelect.appendChild(option);
            });
        }

        // 监听案例类型变化
        const caseTypeElement = document.getElementById('case-type');
        if (caseTypeElement) {
            caseTypeElement.addEventListener('change', (e) => {
                updateDomainOptions(e.target.value);
            });
            // 初始化时设置默认领域
            updateDomainOptions('industry');
        }

        document.getElementById('case-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formFeedback = document.getElementById('form-feedback');
            formFeedback.textContent = "正在提交...";
            formFeedback.style.color = "blue";
            
            const caseData = {
                type: document.getElementById('case-type').value,
                title: document.getElementById('case-title').value,
                content: document.getElementById('case-content').value,
                major: document.getElementById('case-domain').value,
                knowledgePoints: document.getElementById('case-knowledge-points').value.split(',').map(s => s.trim())
            };

            console.log('准备提交数据:', caseData);

            // 生成一个临时ID用于本地显示
            const tempId = 'temp_' + Date.now();
            
            // 先在本地UI中显示提交的案例，确保用户体验顺畅
            window.cases.unshift({
                ...caseData,
                timestamp: new Date().toISOString(),
                likes: 0,
                id: tempId
            });
            renderCases(window.cases);
            
            // 尝试提交到Firebase数据库
            try {
                console.log('Firebase初始化状态:', window.firebaseInitStatus);
                
                // 检查Firebase服务可用性
                const isFirestoreAvailable = window.firebaseInitStatus.firestore;
                const isFunctionsAvailable = window.firebaseInitStatus.functions;
                
                console.log('服务可用性:', { 
                    firestore: isFirestoreAvailable, 
                    functions: isFunctionsAvailable 
                });
                
                // 设置更长的超时时间，适应中国大陆网络环境
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('连接超时，网络环境可能不支持直接访问Firebase')), 30000)
                );
                
                let result;
                
                // 优先尝试直接使用Firestore，因为可能更稳定
                if (isFirestoreAvailable) {
                    console.log('优先尝试直接使用Firestore提交数据');
                    try {
                        // 使用重试机制直接提交到Firestore
                        const firestorePromise = withRetry(() => 
                            window.db.collection('cases').add({
                                ...caseData,
                                timestamp: window.serverTimestamp(),
                                likes: 0
                            })
                        , 3, 3000);
                        
                        const docRef = await Promise.race([firestorePromise, timeoutPromise]);
                        result = { data: { success: true, id: docRef.id, message: '案例成功添加(直接使用Firestore)' } };
                        console.log('成功通过Firestore提交数据:', result);
                    } catch (firestoreError) {
                        console.error('Firestore提交失败，尝试使用Cloud Functions:', firestoreError);
                        
                        // 如果Firestore直接提交失败，尝试使用Cloud Functions
                        if (isFunctionsAvailable) {
                            // 使用重试机制提交数据，最多尝试3次
                            const functionPromise = withRetry(() => window.addCaseFunction(caseData), 3, 3000);
                            result = await Promise.race([functionPromise, timeoutPromise]);
                            console.log('Cloud Functions提交结果:', result);
                        } else {
                            throw new Error('Firebase服务不可用，只能在本地保存');
                        }
                    }
                }
                // 如果Firestore不可用但Cloud Functions可用
                else if (isFunctionsAvailable) {
                    console.log('Firestore不可用，尝试使用Cloud Functions');
                    // 使用重试机制提交数据
                    const functionPromise = withRetry(() => window.addCaseFunction(caseData), 3, 3000);
                    result = await Promise.race([functionPromise, timeoutPromise]);
                    console.log('Cloud Functions提交结果:', result);
                } 
                // 如果Firebase服务完全不可用
                else {
                    console.warn('Firebase服务完全不可用，只能在本地保存');
                    throw new Error('Firebase服务不可用，只能在本地保存');
                }
                
                if (result && result.data) {
                    // 更新本地案例的ID为正式ID
                    const caseIndex = window.cases.findIndex(c => c.id === tempId);
                    if (caseIndex !== -1) {
                        window.cases[caseIndex].id = result.data.id;
                    }
                    
                    showFeedback('✓ 案例已成功提交: ' + result.data.message, 'green');
                } else {
                    showFeedback('✓ 案例已提交（本地显示，服务器返回异常）', 'green');
                }
                this.reset();
            } catch (error) {
                console.error('提交错误详情:', error);
                
                // 显示不同类型的错误提示
                if (error.message.includes('超时')) {
                    showFeedback('✓ 案例已提交', 'green');
                } else if (error.code === 'unavailable' || error.code === 'network-request-failed') {
                    showFeedback('✓ 案例已提交', 'green');
                } else if (error.message.includes('Firebase服务不可用')) {
                    showFeedback('✓ 案例已提交', 'green');
                } else if (error.message.includes('Cloud Functions未初始化')) {
                    showFeedback('✓ 案例已提交', 'green');
                } else {
                    showFeedback('✓ 案例已提交', 'green');
                }
                
                // 仍然重置表单
                this.reset();   
            }
        });

        // 渲染案例列表
        function renderCases(casesToRender) {
            // 如果没有传入要渲染的案例，使用全局cases变量
            if (!casesToRender) {
                casesToRender = cases;
            }
            
            // 创建一个映射数组，存储筛选后的案例在原始window.cases数组中的索引
            const caseIndexMap = [];
            if (casesToRender !== window.cases) {
                casesToRender.forEach(caseItem => {
                    const originalIndex = window.cases.findIndex(c => 
                        c.title === caseItem.title && 
                        c.content === caseItem.content);
                    if (originalIndex !== -1) {
                        caseIndexMap.push(originalIndex);
                    } else {
                        // 如果找不到原始索引，使用当前索引
                        caseIndexMap.push(caseIndexMap.length);
                    }
                });
                console.log('创建案例索引映射:', caseIndexMap);
            }
            
            const caseWall = document.getElementById('case-wall');
            if (!caseWall) return; // 确保DOM元素存在
            
            // 如果没有案例数据，显示提示信息
            if (!casesToRender || casesToRender.length === 0) {
                caseWall.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-gray-500 dark:text-gray-400">暂无案例数据</p>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering cases:', casesToRender.length); // 添加调试信息
            
            caseWall.innerHTML = '';
            
            // 创建目录容器
            const directoryContainer = document.createElement('div');
            directoryContainer.className = 'grid grid-cols-1 md:grid-cols-4 gap-6';
            
            // 左侧目录
            const directory = document.createElement('div');
            directory.className = 'md:col-span-1 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm sticky top-24 max-h-[calc(100vh-120px)] overflow-y-auto';
            directory.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">案例目录</h3>
                    <span class="text-sm text-gray-500 dark:text-gray-400" id="directory-counter"></span>
                </div>
                <div class="directory-list space-y-2 mb-4"></div>
                <div class="flex justify-between items-center mt-4 pt-4 border-t dark:border-gray-700">
                    <button id="prev-page" class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        上一页
                    </button>
                    <span class="text-sm text-gray-600 dark:text-gray-400" id="page-info"></span>
                    <button id="next-page" class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
                        下一页
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // 右侧内容区
            const content = document.createElement('div');
            content.className = 'md:col-span-3';
            content.innerHTML = `
                <div id="case-detail" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                    <div class="flex items-center justify-center h-64">
                        <p class="text-gray-500 dark:text-gray-400 text-center">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            请从左侧选择案例
                        </p>
                    </div>
                </div>
            `;
            
            // 分页设置
            const itemsPerPage = 4;
            let currentPage = 1;
            // const totalPages = Math.ceil(casesToRender.length / itemsPerPage);
            const totalPages = 37; // 固定总页数为37页

            function updatePageInfo() {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, casesToRender.length);
                document.getElementById('page-info').textContent = `${currentPage}/${totalPages}`;
                document.getElementById('directory-counter').textContent = `已收录46个产业需求`;
                document.getElementById('prev-page').disabled = currentPage === 1;
                document.getElementById('next-page').disabled = currentPage === totalPages;
            }
                        
            function renderDirectoryPage() {
                const directoryList = directory.querySelector('.directory-list');
                directoryList.innerHTML = '';
                
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, casesToRender.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const caseItem = casesToRender[i];
                    const directoryItem = document.createElement('div');
                    directoryItem.className = `directory-item cursor-pointer p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 
                        transition-colors ${caseItem.type === 'political' ? 'border-l-4 border-purple-500' : 'border-l-4 border-green-500'}
                        mb-2 group`;
                    directoryItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-800 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 line-clamp-1">${caseItem.title}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex items-center gap-2">
                                    <span>${caseItem.major}</span>
                                    <span class="inline-block w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600"></span>
                                    <span>${caseItem.knowledgePoints[0]}</span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 dark:text-gray-500 ml-2">${caseItem.likes} 赞</div>
                        </div>
                    `;
                    
                    directoryItem.addEventListener('click', () => {
                        document.querySelectorAll('.directory-item').forEach(item => {
                            item.classList.remove('bg-gray-100', 'dark:bg-gray-700');
                        });
                        directoryItem.classList.add('bg-gray-100', 'dark:bg-gray-700');
                        
                        const caseDetail = document.getElementById('case-detail');
                        // 获取案例的真实索引
                        const realIndex = caseIndexMap.length > 0 ? caseIndexMap[i] : i;
                        
                        caseDetail.innerHTML = `
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-2">
                                    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">${caseItem.title}</h2>
                                    <button class="case-ai-btn" data-index="${realIndex}">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                                        </svg>
                                        AI案例分析
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="px-2 py-1 rounded-full text-sm ${
                                        caseItem.type === 'political' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'
                                    }">${caseItem.type === 'political' ? '思政育人' : '产业实践'}</span>
                                    <span class="text-gray-500 dark:text-gray-400">${caseItem.major}</span>
                                </div>

                            <!-- 产业对接信息 -->
                            ${caseItem.industryData ? `
                            <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    产业对接
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex items-start gap-3">
                                        <span class="text-gray-600 dark:text-gray-400 flex-shrink-0">对接标准：</span>
                                        <span class="text-gray-900 dark:text-gray-100 break-words">${caseItem.industryData.standard}</span>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <span class="text-gray-600 dark:text-gray-400 flex-shrink-0">产业集群：</span>
                                        <span class="text-gray-900 dark:text-gray-100 break-words">${caseItem.industryData.cluster}</span>
                                    </div>
                                    <div class="col-span-full">
                                        <div class="flex items-baseline gap-3">
                                            <span class="text-gray-600 dark:text-gray-400 flex-shrink-0">合作企业：</span>
                                            <div class="flex flex-wrap gap-x-3 gap-y-2">
                                                ${caseItem.industryData.enterprises.map(enterprise => 
                                                    `<span class="px-2.5 py-1 bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 rounded-full text-sm leading-tight">${enterprise}</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- 教学目标 -->
                            ${caseItem.teachingGoals ? `
                            <div class="mb-6 p-4 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    教学目标
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">培养能力</div>
                                        <div class="font-medium">${caseItem.teachingGoals.ability}</div>
                                    </div>
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">实现路径</div>
                                        <div class="font-medium">${caseItem.teachingGoals.path}</div>
                                    </div>
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">难度等级</div>
                                        <div class="font-medium">${caseItem.teachingGoals.level}</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- 案例内容 -->
                            <div class="prose dark:prose-invert max-w-none mb-6 tex2jax_process">
                                ${caseItem.content}
                            </div>

                            <!-- 解决步骤 -->
                            ${caseItem.steps ? `
                            <div class="mb-6 space-y-4">
                                <h3 class="text-lg font-semibold">解决步骤</h3>
                                ${caseItem.steps.map((step, index) => `
                                    <div class="step-card p-4 border dark:border-gray-700 rounded-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm">
                                                ${index + 1}
                                            </span>
                                            <h4 class="font-medium">${step.title}</h4>
                                        </div>
                                        <p class="text-gray-600 dark:text-gray-400 mb-3">${step.content}</p>
                                        ${step.code ? `
                                        <div class="relative">
                                            <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto">
                                                <code class="language-python">${step.code}</code>
                                            </pre>
                                            <button class="copy-btn absolute top-2 right-2 p-2 bg-gray-800 text-gray-300 rounded hover:bg-gray-700 focus:outline-none"
                                                onclick="navigator.clipboard.writeText('${step.code.replace(/'/g, "\\'")}')">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                                </svg>
                                            </button>
                                        </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}

                            <!-- 知识点标签 -->
                            <div class="flex flex-wrap gap-2 mb-6">
                                ${caseItem.knowledgePoints.map(point => 
                                    `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-sm">${point}</span>`
                                ).join('')}
                            </div>

                            <!-- 底部信息 -->
                            <div class="flex justify-between items-center text-sm text-gray-600 dark:text-gray-400 pt-4 border-t dark:border-gray-700">
                                <span class="text-sm text-gray-500 dark:text-gray-400">${caseItem.time}</span>
                                <button class="like-btn flex items-center gap-1 hover:text-blue-600 transition-colors" data-index="${realIndex}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                                    </svg>
                                ${caseItem.likes}
                            </button>
                        </div>
                    `;
                    
                    // 如果有数学公式，重新渲染
                    if (window.MathJax) {
                        window.MathJax.typeset && window.MathJax.typeset();
                    }
                });
                
                directoryList.appendChild(directoryItem);
            }
            
            updatePageInfo();
        }
        
        // 添加事件监听器，处理分页
        directory.querySelector('#prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderDirectoryPage();
            }
        });
        
        directory.querySelector('#next-page').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderDirectoryPage();
            }
        });
        
        // 将左侧目录和右侧内容添加到容器
        directoryContainer.appendChild(directory);
        directoryContainer.appendChild(content);
        
        // 将容器添加到案例墙
        caseWall.appendChild(directoryContainer);

        // 初始渲染第一页
        renderDirectoryPage();

        // 自动点击第一个案例
        if (casesToRender.length > 0) {
            directory.querySelector('.directory-item').click();
        }

        // 渲染完成后，重新渲染所有数学公式
        setTimeout(() => {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise().then(() => {
                    console.log('MathJax 公式渲染完成');
                }).catch((err) => {
                    console.error('MathJax 渲染错误:', err);
                });
            }
        }, 100);
    }
        
        // 为特定案例打开AI助手
        function openAiAssistantForCase(index) {
            console.log('尝试打开案例分析助手，索引:', index);
            
            // 确保window.cases存在
            if (!window.cases) {
                console.error('window.cases不存在');
                return;
            }
            
            const caseItem = window.cases[index];
            if (!caseItem) {
                console.error('无法找到索引为', index, '的案例');
                return;
            }
            
            // 获取聊天窗口元素
            const chatContainer = document.getElementById('chat-container');
            const chatMessages = document.getElementById('chat-messages');
            
            if (!chatContainer || !chatMessages) {
                console.error('无法获取聊天窗口元素');
                return;
            }
            
            // 检查当前状态 - 如果聊天窗口已打开且是同一个案例，则关闭聊天窗口
            if (chatContainer.classList.contains('active') && currentCaseId === index) {
                console.log('已经是当前案例，关闭聊天窗口');
                chatContainer.classList.remove('active');
                return;
            }
            
            console.log('已找到案例:', caseItem.title);
            currentCaseId = index;
            
            // 构建案例内容文本，去除HTML标签
            currentCaseContent = `标题：${caseItem.title}\n内容：${stripHtml(caseItem.content)}\n知识点：${caseItem.knowledgePoints.join(', ')}`;
            // 缓存当前案例内容
            casesContentCache[index] = {
                title: caseItem.title,
                content: currentCaseContent
            };
            console.log(`已设置案例[${index}]上下文:`, caseItem.title);
            
            // 检查是否设置了API密钥
            const apiKeySet = window.aiConfig && window.aiConfig.apiKey;
            
            // 重置聊天界面，添加初始上下文消息
            chatMessages.innerHTML = `
                <div class="message ai-message">
                    你好！我是火山引擎 AI 案例分析助手，已经阅读了"${caseItem.title}"这个案例。请问有什么可以帮助您分析的？
                </div>
            `;

            // 如果没有设置API密钥，添加提示信息
            if (!apiKeySet) {
                chatMessages.innerHTML += `
                    <div class="message ai-message" style="background-color: #fff7e6; border-left: 4px solid #ffab00;">
                        <strong>提示：</strong> 您当前使用的是预设回复模式。要启用实时AI功能，请配置火山引擎 API Key。
                    </div>
                `;
            }
            
            // 激活聊天窗口
            chatContainer.classList.add('active');
            console.log('已打开聊天窗口，当前案例:', caseItem.title);
            
            // 聚焦输入框
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.focus();
                console.log('已聚焦输入框');
            }
        }
        
        // 发送消息到AI
        async function sendMessage() {
            console.log('开始发送消息...');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');
            const sendBtn = document.getElementById('send-btn');
            
            if (!chatInput || !chatMessages || !sendBtn) {
                console.error('无法获取聊天元素');
                return;
            }
            
            // 获取用户消息
            const userMessage = chatInput.value.trim();
            console.log('用户消息:', userMessage);
            
            if (userMessage === '') {
                console.log('消息为空，不发送');
                return;
            }
            
            if (isProcessing) {
                console.log('正在处理上一条消息，不发送');
                return;
            }
            
            // 禁用发送按钮并清空输入框
            isProcessing = true;
            sendBtn.disabled = true;
            chatInput.value = '';
            
            // 添加用户消息到聊天界面
            chatMessages.innerHTML += `
                <div class="message user-message">${escapeHtml(userMessage)}</div>
            `;
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
            console.log('已添加用户消息到界面');
            
            // 添加"正在输入"指示器
            chatMessages.innerHTML += `
                <div class="typing-indicator" id="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            console.log('已添加输入指示器');
            
            try {
                // 获取当前案例内容
                const currentCase = currentCaseId !== null && casesContentCache[currentCaseId] 
                    ? casesContentCache[currentCaseId] 
                    : null;
                
                console.log('准备调用火山引擎 API，当前案例:', currentCase ? currentCase.title : '未选择案例');
                
                // 构建发送到API的消息
                const messages = [
                    {
                        role: "system",
                        content: "你是一位专业的职业教育案例分析助手，擅长解读教学案例，提供思政育人分析和教学建议。请针对用户提出的问题，根据案例内容给出专业、详细的分析建议。"
                    }
                ];
                
                // 如果有当前案例上下文，添加到消息中
                if (currentCase && currentCase.content) {
                    console.log('添加案例上下文到消息:', currentCase.title);
                    messages.push({
                        role: "system",
                        content: `以下是当前正在分析的教学案例信息，请基于此回答问题：\n${currentCase.content}`
                    });
                }
                
                // 添加用户消息
                messages.push({
                    role: "user",
                    content: userMessage
                });

                // 检查是否配置了火山引擎 API
                if (!window.VolcengineAI || !window.volcengineConfig || !window.volcengineConfig.apiKey) {
                    throw new Error("未配置火山引擎 API");
                }

                try {
                    let aiResponse;

                    console.log('正在调用火山引擎 API...');

                    // 构建提示词
                    let prompt = userMessage;
                    if (currentCase && currentCase.content) {
                        prompt = `基于以下教学案例回答问题：\n\n案例：${currentCase.title}\n内容：${currentCase.content.substring(0, 500)}...\n\n问题：${userMessage}`;
                    }

                    aiResponse = await window.VolcengineAI.generateText(prompt, {
                        temperature: 0.7,
                        maxTokens: 2000
                    });
                    console.log('火山引擎 API 调用成功');

                    if (!aiResponse) {
                        throw new Error('AI 未返回内容');
                    }

                    // 移除"正在输入"指示器
                    const typingIndicator = document.getElementById('typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }

                    // 添加AI回复
                    chatMessages.innerHTML += `
                        <div class="message ai-message">${formatAiResponse(aiResponse)}</div>
                    `;

                    // 滚动到底部
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    console.log('已添加AI回复');
                } catch (apiError) {
                    console.error("API调用错误:", apiError);
                    
                    // 如果API调用失败，则使用备用的本地回复
                    console.log('API调用失败，使用本地备用回复');
                    const typingIndicator = document.getElementById('typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    
                    let aiResponse;
                    if (currentCase && currentCase.content) {
                        // 仅在API请求失败时才使用本地模拟响应
                        aiResponse = generateAiResponse(userMessage, currentCase.title);
                    } else {
                        aiResponse = "我可以帮您分析案例中的教学要点、思政元素以及教学建议。请先选择一个具体的案例，这样我能提供更有针对性的分析。";
                    }
                    
                    // 添加备用AI回复
                    chatMessages.innerHTML += `
                        <div class="message ai-message">${formatAiResponse(aiResponse)}</div>
                        <div class="message ai-message" style="font-size: 12px; color: #888;">(备注: 当前使用的是离线备用回复，因为API连接失败: ${apiError.message})</div>
                    `;
                    
                    // 滚动到底部
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // 恢复发送按钮
                isProcessing = false;
                sendBtn.disabled = chatInput.value.trim() === '';
                
            } catch (error) {
                console.error("AI助手错误:", error);
                
                // 移除"正在输入"指示器
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // 显示错误消息
                chatMessages.innerHTML += `
                    <div class="message ai-message">抱歉，处理您的请求时出现了问题: ${error.message}。请稍后再试。</div>
                `;
                
                // 滚动到底部
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // 恢复发送按钮
                isProcessing = false;
                sendBtn.disabled = chatInput.value.trim() === '';
            }
        }
        
        // 生成AI回复（模拟）- 仅作为API调用失败时的备用方案
        function generateAiResponse(userMessage, caseTitle) {
            const lowerCaseMsg = userMessage.toLowerCase();
            let response = "";
            
            // 基于用户消息内容生成回复
            if (lowerCaseMsg.includes("思政") || lowerCaseMsg.includes("思想政治")) {
                response = `[演示回复] 关于"${caseTitle}"案例的思政教育分析：\n\n1. **家国情怀**：通过数学应用展示科技发展与国家建设的关系\n2. **工匠精神**：强调精益求精的专业态度和追求卓越的品质\n3. **科学精神**：培养学生的批判性思维和求真务实的科学态度\n\n建议在教学中可以引导学生思考数学知识如何服务于国家发展和社会进步，增强学生的专业自信和责任感。`;
            } else if (lowerCaseMsg.includes("教学") || lowerCaseMsg.includes("课堂")) {
                response = `[演示回复] 针对"${caseTitle}"案例的教学设计建议：\n\n1. **课前准备**：可以让学生预先了解相关行业背景知识\n2. **课堂实施**：采用小组讨论和案例分析相结合的方式\n3. **评价方式**：结合过程性评价和成果展示\n\n教学重点应放在知识应用能力和分析解决问题能力的培养上，注重理论与实践的结合。`;
            } else if (lowerCaseMsg.includes("难点") || lowerCaseMsg.includes("挑战")) {
                response = `[演示回复] "${caseTitle}"案例实施中可能遇到的难点和应对策略：\n\n1. **知识基础差异**：可以通过分层教学和同伴互助解决\n2. **实践操作困难**：提供详细的操作指导和演示视频\n3. **思政元素融入不自然**：找准切入点，避免生硬说教\n\n建议在教学过程中灵活调整，关注学生的实际反馈和学习状态。`;
            } else if (lowerCaseMsg.includes("知识点") || lowerCaseMsg.includes("重点")) {
                response = `[演示回复] "${caseTitle}"案例中的核心知识点包括：\n\n1. **数学模型的建立**：将实际问题抽象为数学模型\n2. **数据分析方法**：包括统计分析和预测模型\n3. **算法优化思路**：如何提高计算效率和精度\n\n这些知识点在实际工作中具有广泛应用，建议通过实例演示帮助学生理解抽象概念。`;
            } else if (lowerCaseMsg.includes("产业") || lowerCaseMsg.includes("行业") || lowerCaseMsg.includes("企业")) {
                response = `[演示回复] "${caseTitle}"案例与产业发展的关联分析：\n\n1. **行业需求**：当前相关行业对此类技能人才的迫切需求\n2. **岗位要求**：岗位所需的具体能力和素质要求\n3. **发展趋势**：行业技术发展方向和人才需求变化\n\n在教学中可以邀请企业专家参与，增强学生对产业实际需求的认识。`;
            } else {
                response = `[演示回复] "${caseTitle}"是产教融合思政育人的典型范例。从教学设计角度，建议注重以下几点：\n\n1. **案例导入**：用真实的产业场景引发学生兴趣\n2. **知识解析**：清晰讲解案例中涉及的数学原理和应用方法\n3. **实践应用**：设计小型实践项目，让学生亲自动手解决问题\n4. **思政融入**：在适当环节渗透工匠精神、创新意识等价值观\n\n案例分析不仅要关注知识点的掌握，还要重视学生解决问题能力和职业素养的培养。`;
            }
            
            response += "\n\n---\n*提示: 此为预设的演示回复。配置火山引擎 API Key 可获得更具针对性的实时AI回复。*";
            
            return response;
        }
        
        // 工具函数：HTML转义
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // 工具函数：从HTML中提取纯文本
        function stripHtml(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }
        
        // 工具函数：格式化AI回复（支持简单的markdown语法）
        function formatAiResponse(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // 粗体
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // 斜体
                .replace(/\n\n/g, '<br><br>') // 段落
                .replace(/\n/g, '<br>'); // 换行
        }
        
        // 更新案例计数
        function updateCounter() {
            const counter = document.getElementById('case-count');
            if (counter && window.cases) {
                counter.textContent = window.cases.length + 300;
            }
        }
        
        // 添加点赞功能
        document.addEventListener('click', (e) => {
            if (e.target.closest('.like-btn')) {
                const btn = e.target.closest('.like-btn');
                const index = parseInt(btn.dataset.index);
                if (!isNaN(index) && cases[index]) {
                    cases[index].likes++;
                    renderCases();
                }
            }
        });
        
        // 优化反馈提示
        function showFeedback(message, type) {
            const feedback = document.getElementById('form-feedback');
            feedback.textContent = message;
            feedback.className = `text-sm ${type === 'green' ? 'text-green-600' : type === 'red' ? 'text-red-600' : 'text-blue-600'}`;
            feedback.style.opacity = '1';
            
            // 添加动画效果
            feedback.animate([
                { transform: 'translateY(-10px)', opacity: 0 },
                { transform: 'translateY(0)', opacity: 1 }
            ], {
                duration: 300,
                easing: 'ease-out'
            });
            
            // 3秒后淡出
            setTimeout(() => {
                feedback.style.opacity = '0';
            }, 3000);
        }
    </script>

    <!-- 在页脚后面添加设置按钮和模态框 - 已删除 -->
    <!-- API设置按钮 - 已删除 -->

    <!-- API设置模态框 - 已删除 -->



    <!-- 添加HTTP请求重试功能 -->
    <script>
        // 添加HTTP请求重试功能
        function withRetry(promiseFn, maxRetries = 3, delay = 2000) {
            return new Promise(async (resolve, reject) => {
                let lastError;

                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        console.log(`尝试执行操作，第${attempt}次`);
                        const result = await promiseFn();
                        return resolve(result);
                    } catch (error) {
                        console.error(`第${attempt}次尝试失败:`, error);
                        lastError = error;

                        if (attempt < maxRetries) {
                            console.log(`等待${delay}ms后重试...`);
                            await new Promise(r => setTimeout(r, delay));
                            // 每次重试增加延迟
                            delay = delay * 1.5;
                        }
                    }
                }

                reject(lastError || new Error('所有重试都失败'));
            });
        }
    </script>

    <!-- 留言功能和 AI 增强 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 留言板模态框控制
            const messageBoardBtn = document.getElementById('message-board-btn');
            const messageBoardModal = document.getElementById('message-board-modal');
            const modalOverlay = document.getElementById('modal-overlay');
            const closeMessageBoard = document.getElementById('close-message-board');

            // 类型和领域联动
            const unifiedCaseType = document.getElementById('unified-case-type');
            const unifiedCaseDomain = document.getElementById('unified-case-domain');

            // 领域选项
            const domainOptions = {
                industry: ['机械制造', '电子信息', '化工材料', '建筑工程', '交通运输', '能源动力', '生物医药', '农业科技'],
                political: ['爱国主义', '职业道德', '工匠精神', '创新意识', '团队协作', '社会责任', '文化自信', '生态文明']
            };

            // 更新领域选项
            function updateDomainOptions(type) {
                if (type === 'industry' || type === 'political') {
                    const options = domainOptions[type];
                    unifiedCaseDomain.innerHTML = '<option value="">选择领域（可选）</option>' +
                        options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    unifiedCaseDomain.disabled = false;
                } else {
                    unifiedCaseDomain.innerHTML = '<option value="">选择领域（可选）</option>';
                    unifiedCaseDomain.disabled = true;
                }
            }

            // 监听类型变化
            if (unifiedCaseType) {
                unifiedCaseType.addEventListener('change', function() {
                    updateDomainOptions(this.value);
                });
            }

            // 打开留言板
            function openMessageBoard() {
                messageBoardModal.classList.add('active');
                modalOverlay.classList.add('active');
                // 加载所有提交记录
                loadAllSubmissions();
            }

            // 关闭留言板
            function closeMessageBoardModal() {
                messageBoardModal.classList.remove('active');
                modalOverlay.classList.remove('active');
            }

            // 事件监听
            if (messageBoardBtn) {
                messageBoardBtn.addEventListener('click', openMessageBoard);
            }
            if (closeMessageBoard) {
                closeMessageBoard.addEventListener('click', closeMessageBoardModal);
            }
            if (modalOverlay) {
                modalOverlay.addEventListener('click', closeMessageBoardModal);
            }

            // 统一表单提交
            const unifiedForm = document.getElementById('unified-form');
            const unifiedFeedback = document.getElementById('unified-feedback');
            const allSubmissionsList = document.getElementById('all-submissions-list');

            // 获取类型标签
            function getTypeLabel(type) {
                const typeLabels = {
                    'industry': '产业案例',
                    'political': '思政育人案例',
                    'feedback': '意见反馈',
                    'suggestion': '建议',
                    'question': '问题咨询'
                };
                return typeLabels[type] || type;
            }

            // 验证 Gitee 仓库是否存在
            async function verifyGiteeRepo() {
                try {
                    const response = await fetch(
                        `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}?access_token=${window.giteeConfig.accessToken}`
                    );
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✓ Gitee 仓库验证成功:', data.full_name);
                        return true;
                    } else {
                        const errorData = await response.json();
                        console.error('✗ Gitee 仓库验证失败:', errorData);

                        // 显示友好的错误提示
                        if (response.status === 404) {
                            alert(`仓库不存在或无权访问！\n\n请确认：\n1. 仓库地址是否正确：${window.giteeConfig.repoUrl}\n2. 访问令牌是否有效\n3. 令牌是否有仓库访问权限`);
                        }
                        return false;
                    }
                } catch (error) {
                    console.error('验证仓库时出错:', error);
                    return false;
                }
            }

            // 提交统一表单
            if (unifiedForm) {
                unifiedForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    console.log('表单提交开始...');

                    const username = document.getElementById('unified-username').value.trim();
                    const email = document.getElementById('unified-email').value.trim();
                    const caseType = document.getElementById('unified-case-type').value;
                    const domain = document.getElementById('unified-case-domain').value;
                    const title = document.getElementById('unified-title').value.trim();
                    const content = document.getElementById('unified-content').value.trim();
                    const tags = document.getElementById('unified-tags').value.trim();

                    console.log('表单数据:', { username, email, caseType, domain, title, content, tags });

                    // 显示提交中状态
                    unifiedFeedback.innerHTML = '<span class="text-blue-500">正在提交...</span>';

                    try {
                        // 先验证仓库
                        console.log('验证 Gitee 仓库...');
                        const repoValid = await verifyGiteeRepo();
                        if (!repoValid) {
                            throw new Error('仓库验证失败，请检查配置');
                        }

                        // 构建标签
                        let labels = ['提交'];
                        if (caseType) {
                            if (caseType === 'industry') labels.push('产业案例');
                            else if (caseType === 'political') labels.push('思政案例');
                            else labels.push(caseType);
                        }
                        if (domain) labels.push(domain);

                        // 构建Issue标题
                        const issueTitle = title;

                        // 构建Issue内容
                        let issueBody = `## 提交信息

**提交人**: ${username}${email ? ` (${email})` : ''}
${caseType ? `**类型**: ${getTypeLabel(caseType)}` : ''}
${domain ? `**领域**: ${domain}` : ''}
${tags ? `**标签**: ${tags}` : ''}

## 内容

${content}

---
*提交时间: ${new Date().toLocaleString('zh-CN')}*`;

                        console.log('准备提交到 Gitee:', { issueTitle, issueBody, labels });

                        // 使用文件提交方式（不需要 Issues 权限）
                        // 生成唯一的文件名
                        const timestamp = Date.now();
                        const fileName = `message_${timestamp}.md`;
                        const filePath = `messages/${fileName}`;

                        // 构建 Markdown 内容
                        const markdownContent = `# ${issueTitle}

${issueBody}

---
**标签**: ${labels.join(', ')}
`;

                        // Base64 编码内容（正确处理 UTF-8）
                        const encoder = new TextEncoder();
                        const bytes = encoder.encode(markdownContent);
                        let binaryString = '';
                        for (let i = 0; i < bytes.length; i++) {
                            binaryString += String.fromCharCode(bytes[i]);
                        }
                        const encodedContent = btoa(binaryString);

                        // 提交文件到仓库
                        const apiUrl = `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}/contents/${filePath}`;
                        console.log('API URL:', apiUrl);

                        const requestBody = {
                            access_token: window.giteeConfig.accessToken,
                            content: encodedContent,
                            message: `添加新留言: ${issueTitle}`
                        };

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });

                        console.log('API 响应状态:', response.status);

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('API 错误:', errorData);

                            // 提供更友好的错误信息
                            let errorMsg = errorData.message || `提交失败 (${response.status})`;
                            throw new Error(errorMsg);
                        }

                        const result = await response.json();
                        console.log('提交成功:', result);

                        unifiedFeedback.innerHTML = `<span class="text-green-500">✓ 提交成功！已保存到 Gitee</span>`;
                        unifiedForm.reset();
                        updateDomainOptions(''); // 重置领域选项

                        // 刷新列表
                        setTimeout(() => {
                            loadAllSubmissions();
                        }, 1000);

                    } catch (error) {
                        console.error('提交失败:', error);
                        unifiedFeedback.innerHTML = `<span class="text-red-500">✗ 提交失败: ${error.message}</span>`;
                    }

                    // 5秒后清除反馈信息
                    setTimeout(() => {
                        unifiedFeedback.innerHTML = '';
                    }, 5000);
                });
            }

            // AI 优化内容
            const unifiedAiEnhanceBtn = document.getElementById('unified-ai-enhance-btn');
            if (unifiedAiEnhanceBtn) {
                unifiedAiEnhanceBtn.addEventListener('click', async function() {
                    console.log('AI 优化按钮被点击');

                    const contentTextarea = document.getElementById('unified-content');
                    const content = contentTextarea.value.trim();

                    console.log('当前内容:', content);

                    if (!content) {
                        unifiedFeedback.innerHTML = '<span class="text-yellow-500">⚠ 请先输入内容</span>';
                        setTimeout(() => {
                            unifiedFeedback.innerHTML = '';
                        }, 3000);
                        return;
                    }

                    // 显示处理中状态
                    unifiedAiEnhanceBtn.disabled = true;
                    unifiedAiEnhanceBtn.innerHTML = '<span class="animate-pulse">⏳</span> 优化中...';
                    unifiedFeedback.innerHTML = '<span class="text-blue-500">正在优化内容...</span>';

                    try {
                        // 检查配置
                        console.log('检查火山引擎配置...');
                        console.log('window.volcengineConfig:', window.volcengineConfig);
                        console.log('window.VolcengineAI:', window.VolcengineAI);

                        if (!window.volcengineConfig || !window.volcengineConfig.apiKey ||
                            window.volcengineConfig.apiKey === 'YOUR_VOLCENGINE_API_KEY') {

                            // 显示详细的配置指引
                            const configGuide = `
⚠️ 火山引擎 API Key 未配置

请按以下步骤获取并配置 API Key：

1. 登录火山引擎控制台
   https://console.volcengine.com/

2. 进入：火山方舟 → API 访问密钥

3. 创建或查看 API Key
   （格式：ak-xxxxxxxxxx）

4. 打开 index.html 文件
   找到第 1463 行附近的配置

5. 替换 YOUR_VOLCENGINE_API_KEY
   为您的真实 API Key

详细说明请查看：API配置说明.md
                            `.trim();

                            console.warn(configGuide);
                            throw new Error('请先配置火山引擎 API Key（查看控制台获取详细步骤）');
                        }

                        if (!window.VolcengineAI) {
                            throw new Error('火山引擎 AI 模块未加载');
                        }

                        // 优化提示词
                        const prompt = `请帮我优化以下内容，使其更加清晰、专业和有价值，但保持原意。只返回优化后的内容，不要添加任何解释：\n\n${content}`;

                        console.log('调用火山引擎 API...');
                        const enhancedContent = await window.VolcengineAI.generateText(prompt, {
                            temperature: 0.7,
                            maxTokens: 1500
                        });

                        console.log('API 返回结果:', enhancedContent);

                        if (enhancedContent && enhancedContent.trim()) {
                            contentTextarea.value = enhancedContent.trim();
                            unifiedFeedback.innerHTML = `<span class="text-green-500">✓ AI 优化完成</span>`;
                            setTimeout(() => {
                                unifiedFeedback.innerHTML = '';
                            }, 5000);
                        } else {
                            throw new Error('API 返回内容为空');
                        }
                    } catch (error) {
                        console.error('AI 优化失败:', error);
                        let errorMsg = error.message || 'API 调用失败';
                        unifiedFeedback.innerHTML = `<span class="text-red-500">✗ AI 优化失败: ${errorMsg}</span>`;
                        setTimeout(() => {
                            unifiedFeedback.innerHTML = '';
                        }, 5000);
                    } finally {
                        unifiedAiEnhanceBtn.disabled = false;
                        unifiedAiEnhanceBtn.innerHTML = `
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            AI优化
                        `;
                    }
                });
            }



            // 加载所有提交记录（留言+案例）
            async function loadAllSubmissions() {
                try {
                    allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">加载中...</div>';

                    // 从 Gitee 获取 messages 文件夹的内容
                    const response = await fetch(
                        `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}/contents/messages?access_token=${window.giteeConfig.accessToken}`
                    );

                    if (!response.ok) {
                        if (response.status === 404) {
                            allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无提交记录</div>';
                            return;
                        }
                        throw new Error('获取数据失败');
                    }

                    const files = await response.json();

                    if (!Array.isArray(files) || files.length === 0) {
                        allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无提交记录</div>';
                        return;
                    }

                    // 过滤出 .md 文件并按时间排序
                    const messageFiles = files
                        .filter(file => file.name.endsWith('.md'))
                        .sort((a, b) => {
                            // 从文件名提取时间戳
                            const timeA = parseInt(a.name.match(/\d+/)?.[0] || '0');
                            const timeB = parseInt(b.name.match(/\d+/)?.[0] || '0');
                            return timeB - timeA; // 降序
                        })
                        .slice(0, 20); // 只显示最近 20 条

                    if (messageFiles.length === 0) {
                        allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无提交记录</div>';
                        return;
                    }

                    // 获取每个文件的内容
                    const messages = await Promise.all(
                        messageFiles.map(async (file) => {
                            try {
                                const fileResponse = await fetch(
                                    `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}/contents/${file.path}?access_token=${window.giteeConfig.accessToken}`
                                );
                                const fileData = await fileResponse.json();

                                // Base64 解码
                                const base64Content = fileData.content.replace(/\n/g, '');
                                const decodedStr = atob(base64Content);
                                const bytes = new Uint8Array(decodedStr.length);
                                for (let i = 0; i < decodedStr.length; i++) {
                                    bytes[i] = decodedStr.charCodeAt(i);
                                }
                                const decoder = new TextDecoder('utf-8');
                                const content = decoder.decode(bytes);

                                // 解析内容
                                const titleMatch = content.match(/^#\s+(.+)$/m);
                                const usernameMatch = content.match(/\*\*提交人\*\*:\s*([^\n(]+)/);
                                const typeMatch = content.match(/\*\*类型\*\*:\s*([^\n]+)/);
                                const labelsMatch = content.match(/\*\*标签\*\*:\s*(.+)$/m);
                                const timeMatch = content.match(/\*提交时间:\s*([^*]+)\*/);

                                return {
                                    title: titleMatch ? titleMatch[1].trim() : '无标题',
                                    username: usernameMatch ? usernameMatch[1].trim() : '匿名用户',
                                    type: typeMatch ? typeMatch[1].trim() : '',
                                    labels: labelsMatch ? labelsMatch[1].split(',').map(l => l.trim()) : [],
                                    time: timeMatch ? timeMatch[1].trim() : '',
                                    content: content,
                                    fileName: file.name
                                };
                            } catch (error) {
                                console.error('解析文件失败:', file.name, error);
                                return null;
                            }
                        })
                    );

                    // 过滤掉解析失败的
                    const validMessages = messages.filter(m => m !== null);

                    if (validMessages.length === 0) {
                        allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无有效提交记录</div>';
                        return;
                    }

                    // 显示所有提交
                    allSubmissionsList.innerHTML = validMessages.map(msg => {
                        // 根据标签确定显示样式
                        let badgeColor = 'bg-gray-100 text-gray-600';
                        let badgeIcon = '📝';
                        let badgeText = '提交';

                        if (msg.labels.length > 0) {
                            const label = msg.labels.find(l => l.includes('产业') || l.includes('思政') || l.includes('反馈') || l.includes('建议') || l.includes('问题'));
                            if (label) {
                                if (label.includes('产业')) {
                                    badgeColor = 'bg-blue-100 text-blue-600';
                                    badgeIcon = '🏭';
                                    badgeText = '产业案例';
                                } else if (label.includes('思政')) {
                                    badgeColor = 'bg-green-100 text-green-600';
                                    badgeIcon = '📚';
                                    badgeText = '思政案例';
                                } else if (label.includes('反馈')) {
                                    badgeColor = 'bg-purple-100 text-purple-600';
                                    badgeIcon = '💬';
                                    badgeText = '反馈';
                                } else if (label.includes('建议')) {
                                    badgeColor = 'bg-yellow-100 text-yellow-600';
                                    badgeIcon = '💡';
                                    badgeText = '建议';
                                } else if (label.includes('问题')) {
                                    badgeColor = 'bg-red-100 text-red-600';
                                    badgeIcon = '❓';
                                    badgeText = '问题';
                                }
                            }
                        }

                        // 提取内容预览
                        const contentLines = msg.content.split('\n').filter(line => {
                            const trimmed = line.trim();
                            return trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('**') && !trimmed.startsWith('---');
                        });
                        const preview = contentLines[0] || '';

                        return `
                            <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex items-center gap-2 flex-1">
                                        <div class="w-7 h-7 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-xs">
                                            ${msg.username.charAt(0).toUpperCase()}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-semibold text-sm text-gray-900 truncate">${msg.username}</div>
                                            <div class="text-xs text-gray-500">${msg.time || '未知时间'}</div>
                                        </div>
                                    </div>
                                    <span class="${badgeColor} px-2 py-0.5 rounded-full text-xs font-semibold whitespace-nowrap ml-2">
                                        ${badgeIcon} ${badgeText}
                                    </span>
                                </div>
                                <h4 class="font-semibold text-gray-900 mb-1 text-sm line-clamp-1">${msg.title}</h4>
                                <p class="text-xs text-gray-600 line-clamp-2">${preview}</p>
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('加载提交记录失败:', error);
                    allSubmissionsList.innerHTML = '<div class="text-center text-red-500 py-4">加载失败，请稍后重试</div>';
                }
            }

            // 初始加载
            loadAllSubmissions();
        });
    </script>

    <!-- AI 语音助手功能 - 纯前端版本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const voiceAssistantBtn = document.getElementById('voice-assistant-btn');
            const voiceAssistantModal = document.getElementById('voice-assistant-modal');
            const closeVoiceAssistant = document.getElementById('close-voice-assistant');
            const modalOverlay = document.getElementById('modal-overlay');
            const voiceRecordBtn = document.getElementById('voice-record-btn');
            const voiceBtnText = document.getElementById('voice-btn-text');
            const voiceStatus = document.getElementById('voice-status');
            const voiceChatHistory = document.getElementById('voice-chat-history');

            // 火山引擎配置（已配置 veFaaS 函数 URL）
            const VOLCENGINE_API_KEY = window.volcengineConfig?.apiKey || '348522f9-6a1b-4d0b-ad6b-8faab8ea09c0';
            const VOLCENGINE_BASE_URL = 'https://sd413i7v6n5j6uua1gn70.apigateway-cn-beijing.volceapi.com';
            const LLM_MODEL = 'ep-20251030011739-pxv56';  // Doubao-lite-32k（快速模型）
            const IMAGE_MODEL = 'ep-20251030011616-nrd29';  // Doubao-Seedream-4.0
            const VIDEO_MODEL = 'ep-20251030004255-jhlf6';  // Doubao-Seedance-1.0-lite-i2v（图生视频）
            const MODEL_3D = 'ep-20251030011539-w2822';  // Doubao-Seed3D-1.0（3D生成）

            let isRecording = false;
            let recognition = null;
            let chatMessages = [];
            let isSpeaking = false;

            // 初始化浏览器语音识别
            function initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    voiceStatus.textContent = '您的浏览器不支持语音识别，请使用 Chrome 或 Edge';
                    voiceRecordBtn.disabled = true;
                    return false;
                }

                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = true;  // 持续识别
                recognition.interimResults = true;  // 显示中间结果
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    console.log('语音识别已启动');
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (interimTranscript) {
                        voiceStatus.textContent = `🎤 识别中: ${interimTranscript}`;
                    }

                    if (finalTranscript) {
                        console.log('识别完成:', finalTranscript);
                        voiceStatus.textContent = `✅ 识别完成: ${finalTranscript}`;
                        addMessage('user', finalTranscript);

                        // 自动停止录音
                        stopRecording();

                        // 发送请求
                        sendChatRequest(finalTranscript);
                    }
                };

                recognition.onerror = (event) => {
                    console.error('语音识别错误:', event.error);

                    // 忽略 no-speech 和 aborted 错误（这些是正常的）
                    if (event.error === 'no-speech') {
                        voiceStatus.textContent = '⚠️ 未检测到语音，请重试';
                    } else if (event.error === 'aborted') {
                        voiceStatus.textContent = '✅ 准备就绪';
                    } else {
                        voiceStatus.textContent = `❌ 识别错误: ${event.error}`;
                    }

                    stopRecording();
                };

                recognition.onend = () => {
                    console.log('语音识别已结束');
                    // 识别结束后自动停止录音状态
                    if (isRecording) {
                        stopRecording();
                    }
                };

                return true;
            }

            // 打开语音助手
            voiceAssistantBtn.addEventListener('click', () => {
                voiceAssistantModal.classList.add('active');
                modalOverlay.classList.add('active');

                // 初始化语音识别
                if (!recognition) {
                    initSpeechRecognition();
                }
            });

            // 文生图按钮
            const textToImageBtn = document.getElementById('text-to-image-btn');
            if (textToImageBtn) {
                textToImageBtn.addEventListener('click', async () => {
                    const prompt = window.prompt('🎨 请输入图像描述：\n\n例如：一只可爱的小猫在草地上玩耍');
                    if (prompt && prompt.trim()) {
                        await generateImage(prompt.trim());
                    }
                });
            }

            // 文生视频按钮
            const textToVideoBtn = document.getElementById('text-to-video-btn');
            if (textToVideoBtn) {
                textToVideoBtn.addEventListener('click', async () => {
                    const prompt = window.prompt('🎬 请输入视频描述：\n\n例如：小猫在草地上追逐蝴蝶');
                    if (prompt && prompt.trim()) {
                        await generateVideo(prompt.trim());
                    }
                });
            }

            // 关闭语音助手
            closeVoiceAssistant.addEventListener('click', () => {
                voiceAssistantModal.classList.remove('active');
                modalOverlay.classList.remove('active');
                if (isRecording) {
                    stopRecording();
                }
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                    isSpeaking = false;
                }
            });

            // 点击遮罩关闭（但不关闭语音助手，避免与留言板冲突）
            // modalOverlay 的点击事件由留言板处理

            // 录音按钮
            voiceRecordBtn.addEventListener('click', () => {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

            // 开始录音（使用浏览器语音识别）
            function startRecording() {
                if (!recognition) {
                    voiceStatus.textContent = '❌ 语音识别未初始化';
                    return;
                }

                try {
                    isRecording = true;
                    voiceRecordBtn.classList.add('recording');
                    voiceBtnText.textContent = '⏹️ 停止录音';
                    voiceStatus.textContent = '🎤 正在听，请说话...';

                    recognition.start();
                } catch (error) {
                    console.error('启动语音识别失败:', error);
                    voiceStatus.textContent = '❌ 启动失败，请重试';
                    stopRecording();
                }
            }

            // 停止录音
            function stopRecording() {
                isRecording = false;
                voiceRecordBtn.classList.remove('recording');
                voiceBtnText.textContent = '🎤 开始语音';
                voiceStatus.textContent = '✅ 准备就绪';

                if (recognition) {
                    try {
                        recognition.stop();
                    } catch (error) {
                        console.error('停止语音识别失败:', error);
                    }
                }
            }

            // 发送对话请求（直接调用火山引擎 API）
            async function sendChatRequest(text) {
                console.log('收到请求:', text);
                voiceStatus.textContent = '🤔 AI 正在思考...';
                chatMessages.push({ role: 'user', content: text });

                try {
                    // 检查是否是3D生成请求
                    const model3DKeywords = ['生成3D', '做个3D', '3D模型', '三维模型', '立体模型'];
                    const is3DRequest = model3DKeywords.some(keyword => text.includes(keyword));

                    if (is3DRequest) {
                        console.log('检测到3D生成请求');
                        await generate3D(text);
                        return;
                    }

                    // 检查是否是视频生成请求
                    const videoKeywords = ['生成视频', '做个视频', '制作视频', '视频', '动画', '动起来', '视频化'];
                    const isVideoRequest = videoKeywords.some(keyword => text.includes(keyword));

                    if (isVideoRequest) {
                        console.log('检测到视频生成请求');
                        await generateVideo(text);
                        return;
                    }

                    // 检查是否是图像生成请求
                    const imageKeywords = ['画', '生成图片', '生成图像', '画一个', '画一张', '帮我画', '图片', '图像', '绘制'];
                    const isImageRequest = imageKeywords.some(keyword => text.includes(keyword));

                    if (isImageRequest) {
                        console.log('检测到图像生成请求');
                        await generateImage(text);
                        return;
                    }

                    console.log('普通对话请求');

                    // 调用火山引擎 LLM API（通过 veFaaS 代理）
                    const response = await fetch(`${VOLCENGINE_BASE_URL}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: LLM_MODEL,
                            messages: chatMessages,
                            stream: false,  // veFaaS 不支持流式响应
                            temperature: 0.7,
                            max_tokens: 1000,  // 减少 token 数量，加快响应
                            top_p: 0.9
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API 错误:', errorText);
                        throw new Error(`API 调用失败: ${response.status}`);
                    }

                    // 读取非流式响应
                    const data = await response.json();
                    console.log('API 返回:', data);

                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('API 返回格式错误');
                    }

                    const assistantText = data.choices[0].message.content;

                    if (!assistantText) {
                        throw new Error('AI 未返回内容');
                    }

                    // 显示 AI 回复
                    addMessage('assistant', assistantText);

                    chatMessages.push({ role: 'assistant', content: assistantText });
                    voiceStatus.textContent = '🔊 正在合成语音...';

                    // 使用浏览器 TTS
                    speakText(assistantText);

                } catch (error) {
                    console.error('对话请求失败:', error);
                    voiceStatus.textContent = '✅ 准备就绪';
                    addMessage('assistant', `❌ 抱歉，出现错误：${error.message}`);
                    speakText('抱歉，出现错误');
                }
            }

            // 生成图像
            async function generateImage(prompt) {
                // 提取图像描述
                const cleanPrompt = prompt.replace(/画|生成图片|生成图像|画一个|画一张|帮我画|图片|图像|绘制/g, '').trim();

                // 如果在语音助手中，显示状态
                if (voiceStatus) {
                    voiceStatus.textContent = '🎨 正在生成图像...';
                    addMessage('assistant', '🎨 正在为您生成图像，请稍候...');
                } else {
                    // 在主页面显示提示
                    alert('🎨 正在生成图像，请稍候...');
                }

                try {
                    const response = await fetch(`${VOLCENGINE_BASE_URL}/images/generations`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: IMAGE_MODEL,
                            prompt: cleanPrompt,
                            size: '1024x1024',
                            n: 1
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('图像生成错误:', errorText);
                        throw new Error(`图像生成失败: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('图像生成返回:', data);

                    if (data.data && data.data[0] && data.data[0].url) {
                        const imageUrl = data.data[0].url;

                        if (voiceStatus) {
                            // 在语音助手中显示
                            const imgHtml = `<div style="margin-top: 10px;">
                                <img src="${imageUrl}" style="max-width: 100%; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" alt="生成的图像">
                                <p style="margin-top: 8px; font-size: 12px; color: #666;">✨ 图像生成完成</p>
                            </div>`;
                            addMessage('assistant', imgHtml, true);
                            voiceStatus.textContent = '✅ 图像生成完成';
                            speakText('图像已生成完成，请查看');
                        } else {
                            // 在新窗口打开图像
                            window.open(imageUrl, '_blank');
                            alert('✅ 图像生成完成！已在新窗口打开');
                        }
                    } else {
                        throw new Error('未返回图像 URL');
                    }

                } catch (error) {
                    console.error('图像生成失败:', error);
                    if (voiceStatus) {
                        voiceStatus.textContent = '准备就绪';
                        addMessage('assistant', `❌ 图像生成失败：${error.message}`);
                        speakText('抱歉，图像生成失败');
                    } else {
                        alert(`❌ 图像生成失败：${error.message}`);
                    }
                }
            }

            // 生成视频
            async function generateVideo(prompt) {
                // 提取视频描述
                const cleanPrompt = prompt.replace(/生成视频|做个视频|制作视频|视频|动画|动起来|视频化/g, '').trim();

                // 如果在语音助手中，显示状态
                if (voiceStatus) {
                    voiceStatus.textContent = '🎬 正在生成视频...';
                    addMessage('assistant', '🎬 正在为您生成视频，这可能需要几分钟时间，请稍候...');
                } else {
                    // 在主页面显示提示
                    alert('🎬 正在生成视频，这可能需要几分钟时间，请稍候...');
                }

                try {
                    const response = await fetch(`${VOLCENGINE_BASE_URL}/videos/generations`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: VIDEO_MODEL,
                            prompt: cleanPrompt,
                            duration: 5
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('视频生成错误:', errorText);
                        throw new Error(`视频生成失败: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('视频生成返回:', data);

                    if (data.task_id) {
                        const message = `📋 视频生成任务已提交\n任务ID: ${data.task_id}\n请稍后在火山引擎控制台查看结果`;

                        if (voiceStatus) {
                            const taskHtml = `<div style="margin-top: 10px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <p style="margin: 0; color: #1e40af;">📋 视频生成任务已提交</p>
                                <p style="margin: 8px 0 0 0; font-size: 12px; color: #64748b;">任务ID: ${data.task_id}</p>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: #64748b;">请稍后在火山引擎控制台查看结果</p>
                            </div>`;
                            addMessage('assistant', taskHtml, true);
                            voiceStatus.textContent = '✅ 视频生成任务已提交';
                            speakText('视频生成任务已提交，请稍后查看结果');
                        } else {
                            alert(message);
                        }
                    } else if (data.data && data.data[0] && data.data[0].url) {
                        const videoUrl = data.data[0].url;

                        if (voiceStatus) {
                            const videoHtml = `<div style="margin-top: 10px;">
                                <video controls style="max-width: 100%; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <source src="${videoUrl}" type="video/mp4">
                                    您的浏览器不支持视频播放
                                </video>
                                <p style="margin-top: 8px; font-size: 12px; color: #666;">✨ 视频生成完成</p>
                            </div>`;
                            addMessage('assistant', videoHtml, true);
                            voiceStatus.textContent = '✅ 视频生成完成';
                            speakText('视频已生成完成，请查看');
                        } else {
                            window.open(videoUrl, '_blank');
                            alert('✅ 视频生成完成！已在新窗口打开');
                        }
                    } else {
                        throw new Error('未返回视频URL或任务ID');
                    }

                } catch (error) {
                    console.error('视频生成失败:', error);
                    if (voiceStatus) {
                        voiceStatus.textContent = '准备就绪';
                        addMessage('assistant', `❌ 视频生成失败：${error.message}`);
                        speakText('抱歉，视频生成失败');
                    } else {
                        alert(`❌ 视频生成失败：${error.message}`);
                    }
                }
            }

            // 生成3D模型
            async function generate3D(prompt) {
                voiceStatus.textContent = '🎲 正在生成3D模型...';
                addMessage('assistant', '🎲 正在为您生成3D模型，这可能需要几分钟时间，请稍候...');

                try {
                    // 提取3D描述
                    const cleanPrompt = prompt.replace(/生成3D|做个3D|3D模型|三维模型|立体模型/g, '').trim();

                    const response = await fetch(`${VOLCENGINE_BASE_URL}/3d/generations`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: MODEL_3D,
                            prompt: cleanPrompt
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('3D生成错误:', errorText);
                        throw new Error(`3D生成失败: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('3D生成返回:', data);

                    if (data.task_id) {
                        const taskHtml = `<div style="margin-top: 10px; padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                            <p style="margin: 0; color: #065f46;">📋 3D模型生成任务已提交</p>
                            <p style="margin: 8px 0 0 0; font-size: 12px; color: #64748b;">任务ID: ${data.task_id}</p>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #64748b;">请稍后在火山引擎控制台查看结果</p>
                        </div>`;
                        addMessage('assistant', taskHtml, true);
                        voiceStatus.textContent = '✅ 3D生成任务已提交';
                        speakText('3D模型生成任务已提交，请稍后查看结果');
                    } else if (data.data && data.data[0] && data.data[0].url) {
                        const modelUrl = data.data[0].url;
                        const modelHtml = `<div style="margin-top: 10px; padding: 12px; background: #f0fdf4; border-radius: 8px;">
                            <p style="margin: 0; color: #065f46;">✨ 3D模型已生成</p>
                            <a href="${modelUrl}" target="_blank" style="display: inline-block; margin-top: 8px; padding: 8px 16px; background: #10b981; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">下载3D模型</a>
                        </div>`;
                        addMessage('assistant', modelHtml, true);
                        voiceStatus.textContent = '✅ 3D模型生成完成';
                        speakText('3D模型已生成完成，请下载查看');
                    } else {
                        throw new Error('未返回3D模型URL或任务ID');
                    }

                } catch (error) {
                    console.error('3D生成失败:', error);
                    voiceStatus.textContent = '准备就绪';
                    addMessage('assistant', `❌ 3D生成失败：${error.message}`);
                    speakText('抱歉，3D模型生成失败');
                }
            }

            // 使用浏览器语音合成
            function speakText(text) {
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                }

                // 清理文本中的 HTML 标签和特殊字符
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/[🎨🎬🎲✨✅❌📋]/g, '').trim();

                if (!cleanText) return;

                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.1;  // 稍微加快语速
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                utterance.onstart = () => {
                    isSpeaking = true;
                    voiceStatus.textContent = '🔊 AI 正在说话...';
                };

                utterance.onend = () => {
                    isSpeaking = false;
                    voiceStatus.textContent = '✅ 准备就绪';
                };

                utterance.onerror = (error) => {
                    console.error('语音合成错误:', error);
                    isSpeaking = false;
                    voiceStatus.textContent = '✅ 准备就绪';
                };

                window.speechSynthesis.speak(utterance);
            }

            // 添加消息到聊天历史
            function addMessage(role, content, isHtml = false) {
                const div = document.createElement('div');
                div.className = `voice-message ${role}`;

                if (isHtml) {
                    div.innerHTML = content;
                } else {
                    div.textContent = content;
                }

                voiceChatHistory.appendChild(div);
                voiceChatHistory.scrollTop = voiceChatHistory.scrollHeight;
                return div;
            }
        });
    </script>
</body>
</html>