
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 确保使用UTF-8编码 -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="产教思政育人案例库 - 职业教育创新实践平台">
    <meta name="theme-color" content="#3b82f6">
    <title>产教思政育人案例库</title>
    
    <!-- 使用本地 Tailwind CSS -->
    <link rel="stylesheet" href="css/output.css">
    
    <!-- 使用本地 JavaScript 库 -->
    <script src="js/lib/core-js.min.js"></script>
     
    <!-- MathJax配置优化 -->
    <style>
        /* 代码块样式优化 */
        .code-block {
            background: #282a36;
            color: #f8f8f2;
            padding: 1rem 1.25rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre;
            margin: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* 代码块滚动条样式 */
        .code-block::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .code-block::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .code-block::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .code-block::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* 代码块标题 */
        .code-block::before {
            content: 'Python';
            position: absolute;
            top: 0.25rem;
            right: 0.5rem;
            padding: 0.1rem 0.35rem;
            font-size: 0.7rem;
            color: #6272a4;
            background: rgba(98, 114, 164, 0.1);
            border-radius: 0.25rem;
            opacity: 0.8;
        }
        
        /* 数学公式容器样式 */
        .math-container {
            overflow-x: auto;
            margin: 0;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* 步骤容器样式 */
        .step-container {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 2fr);
            gap: 1rem;
            margin: 1rem 0;
            align-items: stretch;
        }
        
        @media (max-width: 1023px) {
            .step-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* MathJax 公式样式优化 */
        .MathJax {
            outline: none;
        }

        /* 暗色模式适配 */
        @media (prefers-color-scheme: dark) {
            .math-container {
                background: rgba(255, 255, 255, 0.02);
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .code-block {
                background: #1e1f29;
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .code-block::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
            }
            
            .code-block::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .code-block::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.15);
            }
        }
        
        /* Python语法高亮 - Dracula主题 */
        .code-block .keyword { color: #ff79c6; }         /* 关键字 */
        .code-block .builtin { color: #8be9fd; }         /* 内置函数 */
        .code-block .string { color: #f1fa8c; }          /* 字符串 */
        .code-block .comment { color: #6272a4; }         /* 注释 */
        .code-block .number { color: #bd93f9; }          /* 数字 */
        .code-block .operator { color: #ff79c6; }        /* 运算符 */
        .code-block .function { color: #50fa7b; }        /* 函数名 */
        .code-block .class { color: #8be9fd; }          /* 类名 */
        .code-block .variable { color: #f8f8f2; }       /* 变量 */
        .code-block .parameter { color: #ffb86c; }      /* 参数 */
        .code-block .decorator { color: #50fa7b; }      /* 装饰器 */

        /* 代码运行按钮 */
        .run-button {
            position: absolute;
            top: 0.25rem;
            right: 4rem;
            padding: 0.1rem 0.35rem;
            font-size: 0.7rem;
            color: #50fa7b;
            background: rgba(80, 250, 123, 0.1);
            border: 1px solid rgba(80, 250, 123, 0.2);
            border-radius: 0.25rem;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s ease;
        }

        .run-button:hover {
            opacity: 1;
            background: rgba(80, 250, 123, 0.2);
        }

        .run-button:active {
            transform: translateY(1px);
        }

        /* 代码输出容器 */
        .output-container {
            background: #1e1f29;
            color: #f8f8f2;
            padding: 0.75rem 1rem;
            border-radius: 0 0 0.5rem 0.5rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            display: none;
        }

        .output-container.show {
            display: block;
        }

        .output-error {
            color: #ff5555;
        }

        .output-success {
            color: #50fa7b;
        }

        #pyodide-loading {
            transition: all 0.3s ease;
            z-index: 1000;
            background-color: rgba(59, 130, 246, 0.7);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 0.75rem;
            opacity: 0.8;
        }

        #pyodide-loading.error {
            background-color: rgba(220, 38, 38, 0.7);
        }

        #pyodide-loading.success {
            background-color: rgba(16, 185, 129, 0.7);
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .skill-map-btn {
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.6), 0 5px 15px -5px rgba(147, 51, 234, 0.4);
            position: relative;
            z-index: 10;
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }
        
        .skill-map-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.7), 0 10px 20px -5px rgba(147, 51, 234, 0.5);
        }
        
        .skill-map-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 10px;
            background: linear-gradient(45deg, #4f46e5, #9333ea, #ec4899, #4f46e5);
            background-size: 300% 300%;
            animation: borderGlow 4s ease infinite;
            z-index: -1;
            filter: blur(4px);
            opacity: 0.8;
        }
        
        .skill-map-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
            z-index: 1;
        }
        
        .skill-map-btn:hover::after {
            left: 100%;
        }
        
        .animate-shimmer {
            animation: shimmer 2s linear infinite;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            background-size: 200% 100%;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* 添加缺失的样式类 */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-card {
            background: rgba(31, 41, 55, 0.95);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #3b82f6;
        }

        .dark .section-title {
            color: #f3f4f6;
        }

        .input-field {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: white;
            color: #1f2937;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark .input-field {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        .dark .input-field:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .btn-primary {
            padding: 0.625rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            padding: 0.625rem 1.5rem;
            background: white;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .dark .btn-secondary {
            background: transparent;
            color: #60a5fa;
            border-color: #60a5fa;
        }

        .dark .btn-secondary:hover {
            background: #60a5fa;
            color: #1f2937;
        }
    </style>

    <!-- MathJax配置 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                packages: ['base', 'ams', 'noerrors', 'noundefined', 'configmacros', 'newcommand'],
                tags: 'ams',
                macros: {
                    RR: "{\\mathbb{R}}",
                    NN: "{\\mathbb{N}}",
                    ZZ: "{\\mathbb{Z}}",
                    CC: "{\\mathbb{C}}",
                    QQ: "{\\mathbb{Q}}"
                },
                environments: {
                    aligned: ['AMSmath'],
                    matrix: ['AMSmath']
                }
            },
            chtml: {
                scale: 1,
                minScale: .5,
                mtextInheritFont: true,
                matchFontHeight: true,
                displayAlign: 'center',
                displayIndent: '0'
            },
            options: {
                enableMenu: false,
                processHtmlClass: 'tex2jax_process',
                ignoreHtmlClass: 'tex2jax_ignore',
                renderActions: {
                    addMenu: [],
                    checkLoading: []
                },
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    MathJax.startup.promise.then(() => {
                        console.log('MathJax initial typesetting complete');
                        // 重新渲染所有公式
                        MathJax.typesetPromise && MathJax.typesetPromise();
                    });
                }
            },
            loader: {
                load: ['[tex]/ams', '[tex]/noerrors', '[tex]/noundefined', '[tex]/configmacros', '[tex]/newcommand']
            }
        };
    </script>
    
    <!-- 使用本地 MathJax -->
    <script src="js/mathjax/tex-chtml.js" id="MathJax-script"></script>
    <script src="js/mathjax/input/tex/extensions/ams.js"></script>
    <script src="js/mathjax/input/tex/extensions/noerrors.js"></script>
    <script src="js/mathjax/input/tex/extensions/noundefined.js"></script>
    <script src="js/mathjax/input/tex/extensions/newcommand.js"></script>
    <script src="js/mathjax/input/tex/extensions/configmacros.js"></script>

    <!-- 引入案例数据 -->
    <script type="module">
        import { initialCases } from './case.js';
        
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            // 将案例数据存储到全局变量
            window.cases = initialCases;
            
            // 渲染案例列表
            renderCases(window.cases.filter(c => c.type === 'political'));
            updateCounter();
            
            // 获取所有过滤按钮
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            // 添加分类按钮功能
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 移除所有按钮的active类和样式
                    filterBtns.forEach(b => {
                        b.classList.remove('active', 'bg-blue-500', 'text-white');
                        b.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                    });
                    
                    // 添加当前按钮的active类和样式
                    btn.classList.add('active', 'bg-blue-500', 'text-white');
                    btn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                    
                    const type = btn.dataset.type;
                    
                    let filteredCases;
                    if (type === 'all') {
                        filteredCases = window.cases;
                    } else {
                        filteredCases = window.cases.filter(c => c.type === type);
                    }
                    
                    renderCases(filteredCases);
                    updateCounter();
                });
            });

            // 添加搜索功能
            document.getElementById('case-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredCases = window.cases.filter(caseItem =>
                    caseItem.title.toLowerCase().includes(searchTerm) ||
                    caseItem.content.toLowerCase().includes(searchTerm) ||
                    caseItem.knowledgePoints.some(point => point.toLowerCase().includes(searchTerm))
                );
                renderCases(filteredCases);
                updateCounter();
            });

            // 添加排序功能
            document.getElementById('sort-by').addEventListener('change', (e) => {
                const sortType = e.target.value;
                let sortedCases = [...window.cases];
                
                switch(sortType) {
                    case 'time':
                        sortedCases.sort((a, b) => new Date(b.time) - new Date(a.time));
                        break;
                    case 'likes':
                        sortedCases.sort((a, b) => b.likes - a.likes);
                        break;
                    case 'recommended':
                        sortedCases.sort((a, b) => (b.likes * 0.7 + b.knowledgePoints.length * 0.3) - 
                                                (a.likes * 0.7 + a.knowledgePoints.length * 0.3));
                        break;
                }
                renderCases(sortedCases);
            });
        });
    </script>

    <!-- Firebase配置 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <script>
        // Firebase初始化状态跟踪
        window.firebaseInitStatus = {
            app: false,
            firestore: false,
            functions: false
        };
        
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyBogjtVOSWb9sOJNKlqktZg9W3smS7b3xw",
            authDomain: "dynamic-cases.firebaseapp.com",
            projectId: "dynamic-cases",
            storageBucket: "dynamic-cases.firebasestorage.app",
            messagingSenderId: "577619978169",
            appId: "1:577619978169:web:7a97960ce6e29085caf868",
            measurementId: "G-ENX7EHWNSV"
        };

        // 初始化Firebase应用
        try {
            firebase.initializeApp(firebaseConfig);
            window.firebaseInitStatus.app = true;
            console.log('Firebase应用初始化成功');
        } catch (error) {
            console.error('Firebase应用初始化失败:', error);
        }
        
        // 获取Firestore实例并设置区域为新加坡 (asia-southeast1)
        let db;
        try {
            db = firebase.firestore();
            window.firebaseInitStatus.firestore = true;
            
            // 设置Firestore的默认配置（不指定host，使用默认连接）
            db.settings({
                ignoreUndefinedProperties: true,
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            console.log('Firestore初始化成功，使用默认全球CDN连接');
        } catch (error) {
            console.error('Firestore初始化失败:', error);
            // 创建一个模拟的db对象，防止错误
            db = {
                collection: () => ({
                    add: () => Promise.reject(new Error('Firestore未初始化')),
                    doc: () => ({
                        delete: () => Promise.reject(new Error('Firestore未初始化')),
                        update: () => Promise.reject(new Error('Firestore未初始化'))
                    })
                })
            };
        }
        
        // 获取Cloud Functions实例
        let functions, addCaseFunction, updateCaseFunction, deleteCaseFunction;
        
        try {
            if (typeof firebase.functions === 'function') {
                // 初始化带区域的Cloud Functions（在v8.x版本中直接指定区域）
                // 香港区域(asia-east2)
                functions = firebase.app().functions('asia-east2');
                window.firebaseInitStatus.functions = true;
                
                // 创建Cloud Functions引用
                addCaseFunction = functions.httpsCallable('addCase');
                updateCaseFunction = functions.httpsCallable('updateCase'); 
                deleteCaseFunction = functions.httpsCallable('deleteCase');
                
                console.log('Cloud Functions初始化成功，已连接到香港区域服务器');
            } else {
                throw new Error('firebase.functions不可用');
            }
        } catch (error) {
            console.error('Cloud Functions初始化失败:', error);
            // 创建模拟函数，防止错误
            addCaseFunction = (data) => Promise.reject(new Error('Cloud Functions未初始化'));
            updateCaseFunction = (data) => Promise.reject(new Error('Cloud Functions未初始化'));
            deleteCaseFunction = (data) => Promise.reject(new Error('Cloud Functions未初始化'));
        }
        
        // 将Firebase功能暴露给全局
        window.db = db;
        window.collection = function(db, collectionPath) {
            return db.collection(collectionPath);
        };
        window.addDoc = function(collectionRef, data) {
            return collectionRef.add(data);
        };
        window.serverTimestamp = firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp : () => new Date();
        window.doc = function(db, docPath) {
            return db.doc(docPath);
        };
        window.deleteDoc = function(docRef) {
            return docRef.delete();
        };
        
        // 暴露Cloud Functions
        window.addCaseFunction = addCaseFunction;
        window.updateCaseFunction = updateCaseFunction;
        window.deleteCaseFunction = deleteCaseFunction;
        
        console.log("Firebase初始化完成", {
            app: window.firebaseInitStatus.app,
            db: !!window.db,
            firestore: window.firebaseInitStatus.firestore,
            functions: window.firebaseInitStatus.functions
        });
    </script>
    <style>
        /* 基础动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* 优化卡片样式 */
        .case-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: fadeIn 0.5s ease-out;
        }
        
        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* 表单面板优化 */
        .form-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f4ff 100%);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
            transition: transform 0.3s ease;
        }
        
        .form-panel:hover {
            transform: scale(1.005);
        }
        
        /* 加载状态优化 */
        .loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* 响应式优化 */
        @media (max-width: 640px) {
            .grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .industry-info {
                grid-template-columns: 1fr;
            }
            
            /* 改进移动端适配 */
            .case-list {
                margin-left: 0;
            }
            
            .timeline-item::before {
                left: -1.5rem;
            }
            
            /* 搜索和筛选区域优化 */
            .sticky.top-4 {
                top: 0;
                position: relative;
                z-index: 30;
            }
            
            .sticky.top-4 .flex.flex-wrap {
                flex-direction: column;
            }
            
            .sticky.top-4 .flex.flex-1 {
                flex-direction: column;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .skill-map-btn {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
                font-size: 16px;
                padding: 8px 12px;
            }
            
            /* 目录和内容区域优化 */
            .directory-item {
                padding: 10px;
            }
            
            #case-detail {
                padding: 12px;
            }
            
            /* 表单优化 */
        .form-panel {
                padding: 15px;
            }
            
            .btn-primary, .btn-secondary {
                width: 100%;
                margin-bottom: 10px;
            }
            
            /* 修复移动端布局问题 */
            .directory-container {
                display: flex;
                flex-direction: column;
            }
            
            .directory-list {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .input-field {
                width: 100%;
                font-size: 16px; /* 防止iOS自动缩放 */
            }
            
            /* 防止内容溢出 */
            .prose {
                overflow-wrap: break-word;
                word-wrap: break-word;
                word-break: break-word;
            }
            
            /* 代码块优化 */
            .code-block {
                max-width: 100%;
                font-size: 12px;
            }
            
            /* 数学公式容器优化 */
            .math-container {
                overflow-x: auto;
                max-width: 100%;
                -webkit-overflow-scrolling: touch;
            }
            
            /* 修复MathJax在移动端的显示 */
            .MathJax {
                max-width: 100% !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
            }
        }
        
        @media (max-width: 768px) {
            .info-panel {
                width: 90%;
                max-width: none;
                left: 5%;
                right: 5%;
            }
            
            /* 改进中等屏幕适配 */
            .directory-container {
                grid-template-columns: 1fr !important;
            }
            
            .md\:col-span-1, .md\:col-span-3 {
                grid-column: span 1 / span 1 !important;
            }
            
            .md\:col-span-1 {
                position: relative !important;
                top: 0 !important;
                max-height: none !important;
                margin-bottom: 15px;
            }
            
            .directory-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .directory-item {
                width: calc(50% - 8px);
                margin-bottom: 0;
            }
            
            /* 修复表格溢出 */
            table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* 修复按钮组 */
            .flex.gap-2.flex-wrap {
                gap: 8px;
            }
            
            .filter-btn {
                margin-bottom: 5px;
            }
        }
        
        @media (max-width: 480px) {
            /* 超小屏幕优化 */
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .directory-item {
                width: 100%;
            }
            
            .filter-btn {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .flex.gap-2.flex-wrap {
                flex-direction: column;
            }
            
            /* 修复标签溢出 */
            .tag-container {
                flex-wrap: wrap;
            }
            
            /* 修复步骤卡片 */
            .step-container {
                grid-template-columns: 1fr;
            }
            
            /* 修复知识点标签 */
            .knowledge-point {
                margin-bottom: 5px;
            }
            
            /* 修复案例详情 */
            #case-detail h2 {
                font-size: 1.3rem;
            }
            
            /* 修复表单元素 */
            textarea, input, select {
                font-size: 16px; /* 防止iOS自动缩放 */
            }
        }
        
        /* 全局修复 */
        * {
            -webkit-text-size-adjust: 100%; /* 防止iOS自动调整字体大小 */
        }
        
        /* 修复滚动问题 */
        body {
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }
        
        /* 修复图像溢出 */
        img {
            max-width: 100%;
            height: auto;
        }
        
        /* 修复模态框 */
        .modal {
            max-width: 100vw;
            max-height: 100vh;
            overflow: auto;
        }
        
        /* 修复技能图谱按钮 */
        .skill-map-btn {
            white-space: normal;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 整体布局缩小 */
        .container {
            width: 98%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 10px;
        }

        /* 标题区域缩小 */
        header {
            padding: 10px 0;
        }

        header h1 {
            font-size: 1.8rem;
        }

        header p {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* 技能图谱容器缩小 */
        .skill-map-container {
            height: 85vh;
            min-height: 700px;
            margin-top: 10px;
        }

        /* 图例和控制按钮缩小 */
        .legends-container {
            max-width: 250px;
            right: 20px;
            top: 20px;
        }

        .legend {
            padding: 15px;
        }

        .legend h4 {
            font-size: 14px;
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        .legend-item {
            margin-bottom: 8px;
            padding: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 10px;
        }

        .zoom-controls {
            left: 20px;
            top: 20px;
            gap: 10px;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }

        /* 返回按钮缩小 */
        .back-button {
            padding: 10px 16px;
            font-size: 14px;
            top: 20px;
            left: 20px;
        }

        .back-button svg {
            width: 18px;
            height: 18px;
        }

        /* 信息面板缩小 */
        .info-panel {
            width: 40%;
            max-width: 500px;
            padding: 20px;
            max-height: 610px;
        }

        .info-panel h2 {
            font-size: inherit;
            margin-bottom: 15px;
            padding-bottom: 10px;
        }

        .info-panel h3 {
            font-size: inherit;
            margin: 15px 0 10px;
        }

        .application-card {
            padding: 15px;
            margin-bottom: 10px;
        }

        .tag {
            padding: 2px 8px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* 页脚缩小 */
        footer {
            padding: 20px;
            margin-top: 30px;
        }
    </style>

    <!-- 简化的代码运行机制 -->
    <script>
function runPythonCode(codeId, outputId) {
    const outputElement = document.getElementById(outputId);
    if (!outputElement) return;
    
    // 显示加载动画
    outputElement.innerHTML = '<div class="flex items-center justify-center py-2"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>运行中...</div>';
    outputElement.className = 'output-container show';
    
    // 获取当前点击的按钮元素（触发事件的元素）
    const buttonElement = document.querySelector(`button[onclick*="runPythonCode('${codeId}', '${outputId}')"]`);
    
    // 从按钮的data-case属性获取案例编号
    const caseNumber = buttonElement ? parseInt(buttonElement.getAttribute('data-case')) || 1 : 1;
    
    console.log(`运行案例${caseNumber}的代码：${codeId}`);
    
    // 延迟一小段时间，模拟运行过程
    setTimeout(() => {
        import('./case.js').then(module => {
            let outputResult;
            
            // 根据案例编号选择输出
            const getOutputFunction = `getCodeOutput${caseNumber}`;
            if (typeof module[getOutputFunction] === 'function') {
                outputResult = module[getOutputFunction](codeId);
            } else if (typeof module.getCodeOutput === 'function') {
                outputResult = module.getCodeOutput(codeId, caseNumber);
            } else if (module.allOutputs && module.allOutputs[caseNumber]) {
                outputResult = module.allOutputs[caseNumber][codeId];
            }
            
            if (outputResult) {
                outputElement.innerHTML = outputResult;
                outputElement.classList.add('output-success');
            } else {
                console.warn(`No output found for case ${caseNumber}, code ${codeId}`);
                outputElement.innerHTML = `案例${caseNumber}代码执行完成`;
                outputElement.classList.add('output-warning');
            }
        }).catch(error => {
            console.error('Error loading case.js:', error);
            outputElement.innerHTML = '代码执行错误: ' + error.message;
            outputElement.classList.add('output-error');
        });
    }, 500);
}
    </script>
    
    <!-- AI助手样式 - 优化版 -->
    <style>
        .ai-floating-actions {
            position: fixed;
            bottom: 32px;
            right: 32px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
            z-index: 2000;
        }

        .ai-floating-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 18px;
            height: 48px;
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: #ffffff;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.01em;
            cursor: pointer;
            box-shadow: 0 18px 34px rgba(37, 99, 235, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }

        .ai-floating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 24px 44px rgba(37, 99, 235, 0.4);
            filter: brightness(1.05);
        }

        .ai-floating-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 16px 28px rgba(37, 99, 235, 0.3);
            filter: brightness(0.95);
        }

        .ai-floating-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.35);
        }

        .ai-floating-icon {
            width: 18px;
            height: 18px;
            display: block;
        }

        .ai-floating-icon svg {
            width: 100%;
            height: 100%;
        }

        .ai-floating-text {
            line-height: 1;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .ai-floating-actions {
                bottom: 20px;
                right: 18px;
            }

            .ai-floating-btn {
                height: 44px;
                padding: 0 16px;
                font-size: 12px;
                border-radius: 22px;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(8px);
            z-index: 1998;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .ai-assistant-panel {
            position: fixed;
            top: 4vh;
            left: 50%;
            transform: translate(-50%, 0) scale(0.95);
            width: 92%;
            max-width: 940px;
            height: 92vh;
            background: rgba(248, 250, 252, 0.95);
            border-radius: 22px;
            border: 1px solid rgba(203, 213, 225, 0.7);
            box-shadow: 0 30px 70px rgba(15, 23, 42, 0.16);
            backdrop-filter: blur(18px) saturate(120%);
            z-index: 1999;
            opacity: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ai-assistant-panel.active {
            opacity: 1;
            pointer-events: all;
            transform: translate(-50%, 0) scale(1);
        }

        .ai-assistant-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 22px 28px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(14, 116, 144, 0.08));
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            color: #0f172a;
            box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.35);
        }

        .ai-assistant-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .ai-assistant-title svg {
            width: 24px;
            height: 24px;
        }

        .ai-assistant-header button {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: #ffffff;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .ai-assistant-header button:hover {
            background: #e2e8f0;
            border-color: rgba(148, 163, 184, 0.6);
            transform: translateY(-1px);
        }

        .ai-assistant-body {
            flex: 1;
            display: flex;
            background: #f8fafc;
        }

        .ai-mode-sidebar {
            width: 144px;
            padding: 26px 18px;
            background: rgba(248, 249, 251, 0.8);
            border-right: 1px solid rgba(203, 213, 225, 0.55);
            display: flex;
            flex-direction: column;
            gap: 12px;
            backdrop-filter: blur(14px);
        }

        .ai-mode-btn {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.9));
            border: 1px solid rgba(203, 213, 225, 0.7);
            border-radius: 14px;
            color: #1f2937;
            font-weight: 600;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }

        .ai-mode-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top, rgba(96, 165, 250, 0.25), transparent 72%);
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .ai-mode-btn * {
            pointer-events: none;
        }

        .ai-mode-icon {
            width: 18px;
            height: 18px;
            display: block;
            color: inherit;
        }

        .ai-mode-icon svg {
            width: 100%;
            height: 100%;
        }

        .ai-mode-btn .ai-mode-label {
            font-size: 12px;
            letter-spacing: 0.02em;
        }

        .ai-mode-btn:hover {
            transform: translateY(-2px);
            border-color: rgba(37, 99, 235, 0.6);
            box-shadow: 0 12px 26px rgba(37, 99, 235, 0.18);
            color: #1d4ed8;
        }

        .ai-mode-btn:hover::after {
            opacity: 1;
        }

        .ai-mode-btn.active {
            background: #1d4ed8;
            color: #ffffff;
            border-color: #1d4ed8;
            box-shadow: 0 8px 18px rgba(29, 78, 216, 0.35);
        }

        .ai-mode-btn.active::after {
            opacity: 1;
            background: radial-gradient(circle at top, rgba(255, 255, 255, 0.45), transparent 70%);
        }

        .ai-mode-btn:focus-visible {
            outline: none;
            border-color: rgba(37, 99, 235, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        .ai-assistant-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .ai-chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 28px 34px 32px;
            background: radial-gradient(circle at top, rgba(37, 99, 235, 0.05), rgba(148, 163, 184, 0.08));
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.4) transparent;
        }

        .ai-chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .ai-chat-history::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.5);
        }

        .ai-chat-history::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.7);
            border-radius: 3px;
        }

        .ai-chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.8);
        }

        .ai-input-area {
            padding: 22px 26px;
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.9), rgba(237, 242, 255, 0.85));
            border-top: 1px solid rgba(203, 213, 225, 0.5);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.65);
        }

        .chat-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .media-input-row {
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .media-input-row textarea {
            flex: 1 1 240px;
        }

        .media-input-row .chat-send-btn {
            flex-shrink: 0;
            height: 44px;
            padding: 0 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .media-upload-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 18px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(248, 250, 252, 0.88);
            color: #1d4ed8;
            font-weight: 600;
            letter-spacing: 0.01em;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
        }

        .media-upload-btn:hover {
            border-color: rgba(37, 99, 235, 0.6);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.18);
            background: rgba(237, 242, 255, 0.95);
        }

        .media-upload-btn:focus-visible {
            outline: none;
            border-color: rgba(37, 99, 235, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        .media-upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .chat-input-row input,
        .chat-input-row textarea {
            flex: 1;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(203, 213, 225, 0.9);
            font-size: 14.5px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.08);
        }

        .chat-input-row textarea {
            min-height: 88px;
            resize: vertical;
        }

        .chat-input-row input:focus,
        .chat-input-row textarea:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.8);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.18);
        }

        .chat-send-btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background: #1d4ed8;
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .chat-send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(29, 78, 216, 0.25);
            background: #2563eb;
        }

        /* 暗色模式适配 */
        .dark .ai-floating-btn {
            background: linear-gradient(135deg, #1d4ed8, #312e81);
            color: #f8fafc;
            border-color: rgba(96, 165, 250, 0.4);
            box-shadow: 0 16px 32px rgba(8, 47, 73, 0.45);
        }

        .dark .ai-floating-btn:hover {
            background: linear-gradient(135deg, #1e3a8a, #1f2937);
        }

        .dark .ai-assistant-panel {
            background: rgba(17, 24, 39, 0.92);
            border-color: rgba(30, 41, 59, 0.8);
            box-shadow: 0 32px 72px rgba(2, 6, 23, 0.45);
        }

        .dark .ai-assistant-header {
            background: linear-gradient(135deg, rgba(14, 116, 144, 0.35), rgba(30, 64, 175, 0.25));
            color: #f8fafc;
            border-bottom-color: rgba(56, 85, 138, 0.5);
            box-shadow: inset 0 -1px 0 rgba(15, 23, 42, 0.55);
        }

        .dark .ai-assistant-header button {
            background: #1f2937;
            color: #e5e7eb;
            border-color: rgba(71, 85, 105, 0.65);
            box-shadow: 0 10px 22px rgba(2, 6, 23, 0.35);
        }

        .dark .ai-assistant-header button:hover {
            background: #334155;
            border-color: rgba(96, 165, 250, 0.55);
        }

        .dark .ai-assistant-body {
            background: rgba(15, 23, 42, 0.9);
        }

        .dark .ai-mode-sidebar {
            background: rgba(17, 24, 39, 0.78);
            border-right-color: rgba(56, 78, 126, 0.45);
        }

        .dark .ai-mode-btn {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(17, 24, 39, 0.88));
            border-color: rgba(51, 65, 85, 0.65);
            color: #e5e7eb;
            box-shadow: 0 10px 22px rgba(2, 6, 23, 0.28);
        }

        .dark .ai-mode-btn:hover {
            border-color: #60a5fa;
            color: #60a5fa;
            box-shadow: 0 12px 26px rgba(59, 130, 246, 0.35);
        }

        .dark .ai-mode-btn.active {
            background: linear-gradient(135deg, #1d4ed8, #312e81);
            border-color: transparent;
            box-shadow: 0 12px 28px rgba(37, 99, 235, 0.45);
            color: #f8fafc;
        }

        .dark .ai-assistant-main {
            background: #111827;
        }

        .dark .ai-chat-history {
            background: radial-gradient(circle at top, rgba(29, 78, 216, 0.15), rgba(15, 23, 42, 0.9));
        }

        .dark .chat-message {
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.92), rgba(30, 41, 59, 0.88));
            border-color: rgba(71, 85, 105, 0.5);
            color: #e5e7eb;
            box-shadow: 0 14px 30px rgba(2, 6, 23, 0.45);
        }

        .dark .chat-message.ai-message {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(59, 130, 246, 0.18));
        }

        .dark .chat-message.user-message {
            background: linear-gradient(135deg, #1e40af, #4338ca);
            box-shadow: 0 18px 32px rgba(17, 24, 39, 0.55);
        }

        .dark .ai-input-area {
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.92), rgba(30, 41, 59, 0.88));
            border-top-color: rgba(30, 64, 175, 0.45);
        }

        .dark .chat-input-row input,
        .dark .chat-input-row textarea {
            background: rgba(17, 24, 39, 0.88);
            border-color: rgba(71, 85, 105, 0.7);
            box-shadow: 0 10px 22px rgba(2, 6, 23, 0.35);
            color: #f8fafc;
        }

        .dark .media-upload-btn {
            background: rgba(30, 41, 59, 0.85);
            border-color: rgba(96, 165, 250, 0.45);
            color: #bfdbfe;
            box-shadow: 0 12px 26px rgba(2, 6, 23, 0.45);
        }

        .dark .media-upload-btn:hover {
            background: rgba(37, 51, 80, 0.9);
            border-color: rgba(96, 165, 250, 0.65);
            box-shadow: 0 16px 30px rgba(37, 99, 235, 0.35);
        }

        .dark .chat-send-btn {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .dark .chat-send-btn:hover {
            box-shadow: 0 14px 28px rgba(59, 130, 246, 0.45);
            background: linear-gradient(135deg, #1e3a8a, #1f2937);
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-assistant-body {
            overflow-y: auto;
        }

        .ai-assistant-panel * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .ai-assistant-panel *::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .message-board-modal * {
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.35) transparent;
        }

        .message-board-modal *::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .message-board-modal *::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(148, 163, 184, 0.45), rgba(96, 165, 250, 0.45));
            border-radius: 999px;
        }

        .message-board-modal *::-webkit-scrollbar-track {
            background: transparent;
        }

        #all-submissions-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 4px;
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.4) transparent;
        }

        #all-submissions-list::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        #all-submissions-list::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.58), rgba(6, 182, 212, 0.42));
            border-radius: 999px;
        }

        .chat-message {
            max-width: 78%;
            padding: 16px 20px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.7;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(236, 241, 255, 0.9));
            border: 1px solid rgba(209, 213, 219, 0.7);
            margin: 12px 0;
            word-break: break-word;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
            position: relative;
        }

        .chat-message.ai-message {
            margin-right: auto;
            color: #1f2937;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(224, 231, 255, 0.92));
        }

        .chat-message.user-message {
            margin-left: auto;
            background: linear-gradient(135deg, #1d4ed8, #4338ca);
            color: #ffffff;
            border: none;
            border-bottom-right-radius: 10px;
            box-shadow: 0 16px 28px rgba(29, 78, 216, 0.35);
        }

        .chat-message strong {
            font-weight: 600;
        }

        .chat-message ul,
        .chat-message ol {
            margin: 8px 0 0 18px;
        }

        .chat-message code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: rgba(99, 102, 241, 0.08);
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 14px;
            background: rgba(226, 232, 240, 0.7);
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(100, 116, 139, 0.7);
            opacity: 0.4;
        }

        .typing-indicator span:nth-child(1) { animation: blink 1s infinite 0.2s; }
        .typing-indicator span:nth-child(2) { animation: blink 1s infinite 0.4s; }
        .typing-indicator span:nth-child(3) { animation: blink 1s infinite 0.6s; }

        @keyframes blink {
            50% { opacity: 1; }
        }

        .media-stack {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }

        .media-square {
            width: 100%;
            max-width: 360px;
            aspect-ratio: 1 / 1;
            border-radius: 20px;
            background: #f8fafc;
            border: 1px dashed rgba(148, 163, 184, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .media-stage {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-stage img,
        .media-stage video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-caption {
            color: #64748b;
            font-size: 0.88rem;
            text-align: center;
            line-height: 1.6;
            max-width: 360px;
        }

        .media-placeholder {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.6;
            padding: 0 18px;
            text-align: center;
        }

        .case-ai-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 18px;
            background: linear-gradient(135deg, #1d4ed8, #7c3aed 55%, #c084fc);
            background-size: 180% 180%;
            color: #f8fafc;
            border: none;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.01em;
            cursor: pointer;
            box-shadow: 0 14px 28px rgba(76, 29, 149, 0.35);
            transition: transform 0.25s ease, box-shadow 0.3s ease, background-position 0.6s ease;
            isolation: isolate;
        }

        .case-ai-btn::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: inherit;
            background: radial-gradient(120% 140% at 0% 0%, rgba(59, 130, 246, 0.65), transparent 60%),
                        radial-gradient(110% 150% at 100% 100%, rgba(192, 132, 252, 0.55), transparent 55%);
            opacity: 0;
            filter: blur(14px);
            transition: opacity 0.35s ease;
            z-index: -1;
        }

        .case-ai-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0));
            mix-blend-mode: screen;
            opacity: 0.55;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .case-ai-btn:hover {
            transform: translateY(-4px) scale(1.01);
            background-position: 100% 0;
            box-shadow: 0 20px 38px rgba(76, 29, 149, 0.4);
        }

        .case-ai-btn:hover::before {
            opacity: 0.9;
        }

        .case-ai-btn:hover::after {
            opacity: 0.85;
        }

        .case-ai-btn:focus-visible {
            outline: 2px solid rgba(191, 219, 254, 0.85);
            outline-offset: 3px;
        }

        .case-ai-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.35));
        }

        .case-ai-btn {
            pointer-events: auto !important;
        }

        .case-ai-btn svg,
        .case-ai-btn * {
            pointer-events: none;
        }

        @media (prefers-reduced-motion: reduce) {
            .case-ai-btn {
                transition: none;
                transform: none;
                background-size: 100% 100%;
            }

            .case-ai-btn:hover {
                transform: none;
                box-shadow: 0 12px 24px rgba(76, 29, 149, 0.35);
                background-position: 50% 50%;
            }

            .case-ai-btn:hover::before {
                opacity: 0.75;
            }
        }

        .message-board-modal {
            position: fixed;
            top: 4vh;
            right: 2vw;
            width: min(420px, 92vw);
            height: 92vh;
            background: rgba(248, 250, 252, 0.96);
            border-radius: 26px;
            border: 1px solid rgba(203, 213, 225, 0.6);
            box-shadow: -24px 38px 80px rgba(15, 23, 42, 0.24);
            backdrop-filter: blur(22px) saturate(135%);
            z-index: 1999;
            opacity: 0;
            pointer-events: none;
            transform: translateX(48px) scale(0.98);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .message-board-modal::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.18), transparent 62%);
            pointer-events: none;
        }

        .message-board-modal::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            border: 1px solid rgba(255, 255, 255, 0.25);
            mix-blend-mode: screen;
            opacity: 0.55;
            pointer-events: none;
        }

        .message-board-modal.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0) scale(1);
        }

        .message-sidebar {
            position: fixed;
            top: 50%;
            right: 24px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 14px;
            z-index: 1980;
        }

        .message-sidebar-btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.92));
            color: #0f172a;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.01em;
            cursor: pointer;
            box-shadow: 0 20px 38px rgba(15, 23, 42, 0.14);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .message-sidebar-btn svg {
            width: 20px;
            height: 20px;
            color: #2563eb;
        }

        .message-sidebar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 26px 48px rgba(37, 99, 235, 0.2);
            border-color: rgba(59, 130, 246, 0.45);
        }

        .message-sidebar-btn:active {
            transform: translateY(0);
        }

        .message-board-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 30px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.14), rgba(14, 164, 233, 0.18));
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.6);
            z-index: 1;
        }

        .message-board-heading {
            display: flex;
            align-items: center;
            gap: 14px;
            color: #0f172a;
        }

        .message-board-heading svg {
            width: 28px;
            height: 28px;
            color: #2563eb;
        }

        .message-board-title-wrap {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-board-title {
            font-size: 1.45rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            background: linear-gradient(120deg, #0f172a, #2563eb 50%, #14b8a6 100%);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }

        .message-board-subtitle {
            font-size: 0.9rem;
            color: #475569;
            letter-spacing: 0.01em;
        }

        .message-board-close {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(255, 255, 255, 0.92);
            color: #1f2937;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
        }

        .message-board-close:hover {
            background: #eff6ff;
            border-color: rgba(59, 130, 246, 0.45);
            transform: translateY(-2px);
            box-shadow: 0 18px 36px rgba(37, 99, 235, 0.28);
        }

        .message-board-close svg {
            width: 20px;
            height: 20px;
        }

        .message-board-content {
            flex: 1;
            padding: 26px 28px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .message-board-section {
            display: none;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        .message-board-section.active {
            display: flex;
        }

        .message-board-card {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding: 24px 26px;
            border-radius: 22px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.85);
            box-shadow: 0 20px 48px rgba(15, 23, 42, 0.16);
            overflow: hidden;
        }

        .message-board-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), transparent 70%);
            opacity: 0.6;
            pointer-events: none;
        }

        .message-board-card::after {
            content: '';
            position: absolute;
            inset: 1px;
            border-radius: inherit;
            border: 1px solid rgba(255, 255, 255, 0.6);
            mix-blend-mode: screen;
            pointer-events: none;
            opacity: 0.6;
        }

        .message-board-card > * {
            position: relative;
            z-index: 1;
        }

        .message-board-feed-card {
            display: flex;
            flex-direction: column;
        }

        .message-board-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }

        .message-board-section-title {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: #0f172a;
        }

        .message-board-section-title svg {
            width: 22px;
            height: 22px;
            color: #2563eb;
        }

        .message-board-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #1e293b;
            background: rgba(191, 219, 254, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.5);
        }

        .message-board-feed-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 6px;
        }

        .message-board-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            padding: 40px 0;
            color: #94a3b8;
            text-align: center;
        }

        .message-board-empty svg {
            width: 52px;
            height: 52px;
            color: #cbd5f5;
        }

        .message-board-form-card {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .message-item {
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.96), rgba(241, 245, 249, 0.92));
            border: 1px solid rgba(209, 213, 219, 0.7);
            border-radius: 18px;
            padding: 18px 20px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .message-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 24px 48px rgba(37, 99, 235, 0.2);
            border-color: rgba(96, 165, 250, 0.55);
        }

        .message-item h4,
        .message-item h5 {
            color: #0f172a !important;
            font-size: 1rem;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .message-item p {
            color: #475569 !important;
            font-size: 0.92rem;
            line-height: 1.6;
        }

        .message-item .text-xs {
            color: #64748b !important;
            font-size: 0.78rem;
        }

        .message-item .inline-flex {
            background: rgba(59, 130, 246, 0.08);
            color: #2563eb;
        }

        .message-board-form-grid {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .message-board-field-group {
            display: grid;
            gap: 16px;
        }

        .message-board-field-group.two-column {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .message-board-field {
            width: 100%;
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.55);
            background: rgba(248, 250, 252, 0.96);
            color: #0f172a;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.05);
        }

        .message-board-field::placeholder {
            color: #94a3b8;
        }

        .message-board-field:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.65);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            transform: translateY(-1px);
        }

        .message-board-textarea {
            min-height: 160px;
            resize: vertical;
        }

        .message-board-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            padding-top: 6px;
        }

        .message-board-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 22px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.18);
        }

        .message-board-button svg {
            width: 18px;
            height: 18px;
        }

        .message-board-button.primary {
            flex: 1 1 auto;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 50%, #06b6d4 100%);
            color: #f8fafc;
        }

        .message-board-button.secondary {
            flex: 0 0 auto;
            background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
            color: #fff7ed;
        }

        .message-board-button:hover {
            transform: translateY(-2px);
            filter: saturate(112%);
        }

        .message-board-button:active {
            transform: translateY(0);
        }

        .delete-submission-btn {
            width: 28px;
            height: 28px;
            border-radius: 9px;
            border: 1px solid rgba(203, 213, 225, 0.8);
            background: rgba(255, 255, 255, 0.9);
            color: #475569;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
        }

        .delete-submission-btn:hover {
            transform: translateY(-1px);
            background: rgba(251, 191, 36, 0.18);
            color: #ea580c;
        }

        #unified-feedback {
            color: #2563eb;
            min-height: 1.25rem;
            text-align: center;
            font-weight: 500;
        }

        .tab-btn {
            cursor: pointer;
            transition: color 0.2s ease, border-color 0.2s ease;
        }

        .tab-btn.active {
            border-bottom-color: #111827 !important;
            color: #111827 !important;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 1280px) {
            .message-board-modal {
                max-width: 860px;
            }
        }

        @media (max-width: 1024px) {
            .ai-assistant-panel {
                width: 96%;
            }

            .message-board-modal {
                width: 96%;
                max-width: 720px;
                height: 94vh;
            }

            .message-board-main {
                flex-direction: column;
            }

            .message-board-sidebar {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                border-right: none;
                border-bottom: 1px solid rgba(203, 213, 225, 0.45);
                padding: 20px 22px;
                gap: 16px;
            }

            .message-board-nav-btn {
                flex: 1;
                flex-direction: row;
                justify-content: center;
                gap: 8px;
            }

            .message-board-content {
                padding: 22px 24px;
                overflow-y: auto;
            }

            .message-sidebar {
                top: auto;
                bottom: 28px;
                right: 24px;
                transform: none;
                flex-direction: column;
                gap: 12px;
            }

            .ai-chat-history {
                padding: 22px;
            }
        }

        @media (max-width: 768px) {
            .ai-assistant-panel {
                top: 2vh;
                height: 96vh;
            }

            .ai-assistant-body {
                flex-direction: column;
            }

            .ai-mode-sidebar {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                border-right: none;
                border-bottom: 1px solid rgba(203, 213, 225, 0.7);
            }

            .ai-mode-btn {
                flex: 1;
                flex-direction: row;
                justify-content: center;
                gap: 8px;
            }

            .chat-message {
                max-width: 88%;
                font-size: 14px;
            }

            .message-board-modal {
                top: 2vh;
                height: 96vh;
                border-radius: 22px;
            }

            .message-board-sidebar {
                padding: 18px 18px;
                gap: 12px;
            }

            .message-board-content {
                padding: 20px 18px 24px;
            }

            .message-board-feed-list {
                max-height: none;
            }

            .message-sidebar {
                bottom: 20px;
                right: 20px;
            }

            .message-board-field-group.two-column {
                grid-template-columns: 1fr;
            }

            .message-board-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 480px) {
            .message-board-modal {
                width: 95%;
                padding-bottom: env(safe-area-inset-bottom);
            }

            .message-board-header {
                padding: 20px;
            }

            .message-board-title {
                font-size: 1.32rem;
            }

            .message-board-sidebar {
                padding: 16px 14px;
            }

            .message-board-content {
                padding: 18px 16px 20px;
            }

            .message-board-card {
                padding: 20px;
            }

            .message-sidebar {
                right: 16px;
                left: 16px;
                bottom: 18px;
                flex-direction: row;
                justify-content: space-between;
            }

            .message-sidebar-btn {
                flex: 1 1 auto;
                justify-content: center;
            }

            .message-board-section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .message-board-chip {
                align-self: flex-start;
            }
        }
    </style>

    <!-- 在head部分底部添加配置 -->
    <script>
        // 火山引擎 API 配置
        // 获取 API Key 的步骤：
        // 1. 登录火山引擎控制台：https://console.volcengine.com/
        // 2. 进入：火山方舟 → API 访问密钥
        // 3. 创建或查看 API Key（格式：以 "ak-" 开头）
        // 4. 将 API Key 粘贴到下方 apiKey 字段
        window.volcengineConfig = {
            apiKey: "",
            baseUrl: "/api",
            accountId: "2100415977",  // 账号ID
            username: "jianghui",     // 用户名

            // 文本对话模型（快速）
            textModel: {
                endpointId: "ep-20251030011739-pxv56",  // Doubao-lite-32k（快速模型）
                modelName: "Doubao-lite-32k"
            },

            // 图像生成模型
            imageModel: {
                endpointId: "ep-20251030011616-nrd29",  // Doubao-Seedream-4.0
                modelName: "Doubao-Seedream-4.0"
            },

            // 视频生成模型
            videoModel: {
                endpointId: "ep-20251030004255-jhlf6",  // Doubao-Seedance-1.0-lite-i2v（图生视频）
                modelName: "Doubao-Seedance-1.0-lite-i2v"
            },

            // 3D生成模型
            model3D: {
                endpointId: "ep-20251030011539-w2822",  // Doubao-Seed3D-1.0
                modelName: "Doubao-Seed3D-1.0"
            }
        };

        // Gitee 配置
        window.giteeConfig = {
            owner: "swywy_admin",
            repo: "video",
            accessToken: "6d2be8c68ff79ab587c54b183d7bfa6a",
            apiBase: "https://gitee.com/api/v5",
            // 完整的仓库 URL 用于验证
            repoUrl: "https://gitee.com/swywy_admin/video"
        };
    </script>

    <!-- 引入火山引擎 AI 模块 -->
    <script src="js/volcengine-ai.js"></script>

    <!-- 引入 Gitee 集成模块 -->
    <script src="js/gitee-integration.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 min-h-screen">
    <div class="container mx-auto px-2 py-4 max-w-7xl">
        <!-- 标题区 -->
        <div class="mb-6 text-center">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-red-600 via-purple-600 to-blue-600 bg-clip-text text-transparent tracking-tight">
                慧工坊
            </h1>
            <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mt-2">
                产教思政育人案例库
            </h2>
            <div class="mt-4 inline-flex items-center px-4 py-2 bg-gradient-to-r from-red-50 to-purple-50 dark:from-red-900/20 dark:to-purple-900/20 rounded-full border border-red-200 dark:border-red-800">
                <svg class="w-5 h-5 text-red-600 dark:text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                </svg>
                <p class="text-gray-700 dark:text-gray-300 text-sm font-medium">
                    充分挖掘课程蕴含思政教育元素，实现思想价值教育与知识体系教育的有机统一
                </p>
            </div>
        </div>

        <!-- 控制栏 -->
        <div class="glass-card p-3 mb-3">
            <div class="flex flex-col md:flex-row gap-2 items-start md:items-center justify-between">
                <div class="flex gap-1 flex-wrap">
                    <button data-type="political" 
                        class="filter-btn active px-3 py-1 rounded-lg shadow-sm hover:shadow-md transition-all transform hover:-translate-y-0.5 bg-red-500 text-white text-sm">
                        思政育人
                    </button>
                    <button data-type="industry" 
                        class="filter-btn px-3 py-1 rounded-lg shadow-sm hover:shadow-md transition-all transform hover:-translate-y-0.5 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm">
                        产业实践
                    </button>
                    <button data-type="all" 
                        class="filter-btn px-3 py-1 rounded-lg shadow-sm hover:shadow-md transition-all transform hover:-translate-y-0.5 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm">
                        全部案例
                    </button>
                </div>
                <div class="flex items-center text-xs">
                    <span class="text-gray-500 dark:text-gray-400">已收录</span>
                    <span class="mx-1 font-bold text-green-600 dark:text-green-400">289</span>
                    <span class="text-gray-500 dark:text-gray-400">个优质案例</span>
                </div>
                <div class="h-4 w-px bg-gray-300 dark:bg-gray-700"></div>
                <div class="flex items-center">
                    <span class="text-gray-500 dark:text-gray-400">产业案例</span>
                    <span class="mx-1 font-bold text-green-600 dark:text-green-400">157</span>
                    <span class="text-gray-500 dark:text-gray-400">个</span>
                </div>
                <div class="h-4 w-px bg-gray-300 dark:bg-gray-700"></div>
                <div class="flex items-center">
                    <span class="text-gray-500 dark:text-gray-400">思政融合案例</span>
                    <span class="mx-1 font-bold text-purple-600 dark:text-purple-400">132</span>
                    <span class="text-gray-500 dark:text-gray-400">个</span>
                </div>
            </div>
        </div>

        <!-- 搜索和筛选区 -->
        <div class="sticky top-2 z-40 glass-card mb-3 p-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex flex-1 items-center gap-2">
                <div class="relative flex-grow max-w-xl group">
                    <input type="search" id="case-search" 
                            class="input-field pl-8 py-1 text-sm"
                        placeholder="搜索案例标题或内容...">
                        <svg class="w-4 h-4 text-gray-400 dark:text-gray-500 absolute left-2 top-2 transition-colors group-hover:text-blue-500" 
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <select id="sort-by" 
                        class="input-field !w-auto cursor-pointer py-1 text-sm">
                    <option value="time">最新发布</option>
                    <option value="likes">最受欢迎</option>
                    <option value="recommended">推荐案例</option>
                </select>
                </div>
                <a href="index1.html" class="skill-map-btn flex items-center gap-1 px-4 py-1 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-lg shadow-md transition-all transform hover:-translate-y-1 font-medium text-sm relative overflow-hidden">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="relative z-10">数学技能图谱</span>
                </a>
            </div>
        </div>

        <!-- 案例展示区 -->
        <div id="case-wall" class="case-list space-y-6">
            <!-- 由JS动态生成案例列表 -->
        </div>

    </div>
    <!-- 留言侧边栏 -->
    <aside class="message-sidebar">
        <button type="button" class="message-sidebar-btn" id="message-compose-btn" aria-controls="message-board-modal">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            <span>留言共创</span>
        </button>
        <button type="button" class="message-sidebar-btn" id="message-recent-btn" aria-controls="message-board-modal">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>最近提交</span>
        </button>
    </aside>

    <!-- 模态框遮罩 -->
    <div class="modal-overlay" id="modal-overlay"></div>

    <!-- 案例AI助手统一面板 -->
    <div class="ai-assistant-panel" id="case-ai-panel">
        <div class="ai-assistant-header">
            <div class="ai-assistant-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 10c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 18l1.395-3.72C3.512 13.042 3 11.574 3 10c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <span>AI 智能助手</span>
            </div>
            <button id="close-case-ai-panel" aria-label="关闭 AI 助手">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="ai-assistant-body">
            <div class="ai-mode-sidebar">
                <button id="ai-chat-mode-btn" class="ai-mode-btn active" data-mode="chat">
                    <span class="ai-mode-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 10h.01M12 10h.01M16 10h.01M21 10c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 18l1.395-3.72C3.512 13.042 3 11.574 3 10c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </span>
                    <span class="ai-mode-label">AI对话</span>
                </button>
                <button id="ai-image-mode-btn" class="ai-mode-btn" data-mode="image">
                    <span class="ai-mode-icon">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 15l-5-5L5 21" />
                        </svg>
                    </span>
                    <span class="ai-mode-label">文生图</span>
                </button>
                <button id="ai-text-video-mode-btn" class="ai-mode-btn" data-mode="text-video">
                    <span class="ai-mode-icon">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect>
                            <line x1="2" y1="8" x2="22" y2="8"></line>
                            <line x1="6" y1="2" x2="6" y2="6"></line>
                            <line x1="10" y1="2" x2="10" y2="6"></line>
                            <line x1="14" y1="2" x2="14" y2="6"></line>
                            <line x1="18" y1="2" x2="18" y2="6"></line>
                        </svg>
                    </span>
                    <span class="ai-mode-label">文生视频</span>
                </button>
                <button id="ai-image-video-mode-btn" class="ai-mode-btn" data-mode="image-video">
                    <span class="ai-mode-icon">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M23 7l-7 5 7 5V7z" />
                            <rect x="2" y="5" width="14" height="14" rx="2" ry="2"></rect>
                        </svg>
                    </span>
                    <span class="ai-mode-label">图生视频</span>
                </button>
            </div>
            <div class="ai-assistant-main">
                <div class="ai-chat-history" id="ai-content-area">
                    <div class="chat-message ai-message">请选择左侧的功能模式开始体验 AI 助手。</div>
                </div>
                <div class="ai-input-area" id="ai-input-area">
                    <div style="color: #94a3b8; text-align: center;">等待选择功能模式...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 留言与提交弹窗 -->
    <div class="message-board-modal" id="message-board-modal" aria-hidden="true">
        <header class="message-board-header">
            <div class="message-board-heading">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                </svg>
                <div class="message-board-title-wrap">
                    <span class="message-board-title">互动交流平台</span>
                    <span class="message-board-subtitle">凝聚教师、学生与产业伙伴的灵感，让观点在此自由碰撞。</span>
                </div>
            </div>
            <button type="button" class="message-board-close" data-close-message-modal aria-label="关闭互动交流平台">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </header>

        <div class="message-board-main">
            <nav class="message-board-sidebar">
                <button type="button" class="message-board-nav-btn active" data-target="message-board-compose">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    <span>留言共创</span>
                </button>
                <button type="button" class="message-board-nav-btn" data-target="message-board-recent">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>最近提交</span>
                </button>
            </nav>

            <div class="message-board-content">
                <section class="message-board-section active" id="message-board-compose">
                    <div class="message-board-card message-board-form-card">
                        <div class="message-board-section-header">
                            <h4 class="message-board-section-title">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                留言反馈 & 共创案例
                            </h4>
                            <span class="message-board-chip">AI助力创作</span>
                        </div>

                        <form id="unified-form" class="message-board-form-grid">
                            <div class="message-board-field-group two-column">
                                <input type="text" id="unified-username" class="message-board-field" placeholder="您的昵称 *" required>
                                <input type="email" id="unified-email" class="message-board-field" placeholder="邮箱（可选）">
                            </div>
                            <div class="message-board-field-group two-column">
                                <select id="unified-case-type" class="message-board-field">
                                    <option value="">选择类型（可选）</option>
                                    <option value="industry">产业案例</option>
                                    <option value="political">思政育人案例</option>
                                    <option value="feedback">意见反馈</option>
                                    <option value="suggestion">建议</option>
                                    <option value="question">问题咨询</option>
                                </select>
                                <select id="unified-case-domain" class="message-board-field">
                                    <option value="">选择领域（可选）</option>
                                </select>
                            </div>
                            <input type="text" id="unified-title" class="message-board-field" placeholder="标题 *" required>
                            <textarea id="unified-content" class="message-board-field message-board-textarea" rows="5" placeholder="请输入内容（支持TeX公式，如：C(t)=C_0e^{-kt}）*&#10;&#10;可以是：&#10;• 教学案例分享&#10;• 意见和建议&#10;• 问题咨询&#10;• 其他反馈" required></textarea>
                            <input type="text" id="unified-tags" class="message-board-field" placeholder="知识点/标签（可选，多个用逗号分隔）">
                            <div class="message-board-actions">
                                <button type="submit" id="unified-submit-btn" class="message-board-button primary">
                                    <span>提交</span>
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10l9-7 9 7-9 7-9-7z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10v11l9-7 9 7V10"/>
                                    </svg>
                                </button>
                                <button type="button" id="unified-ai-enhance-btn" class="message-board-button secondary">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548-.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                    <span>AI优化</span>
                                </button>
                            </div>
                            <div id="unified-feedback"></div>
                        </form>
                    </div>
                </section>

                <section class="message-board-section" id="message-board-recent">
                    <div class="message-board-card message-board-feed-card">
                        <div class="message-board-section-header">
                            <h4 class="message-board-section-title">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                最近提交
                            </h4>
                            <span class="message-board-chip">实时更新</span>
                        </div>
                        <div id="all-submissions-list" class="message-board-feed-list">
                            <div class="message-board-empty">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <span>加载中...</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        // 全局变量        let currentCaseId = null;  // 当前打开的案例ID
        let currentCaseContent = null;  // 当前案例内容
        let casesContentCache = {};  // 存储已打开过的案例内容的缓存
        let isProcessing = false;  // 标记是否正在处理消息
        let filterBtns = null;  // 分类按钮集合
        let cases = [];  // 案例数据
        
        // 火山引擎API配置 - 全局常量
        const VOLCENGINE_API_KEY = window.volcengineConfig?.apiKey || '';
        const VOLCENGINE_BASE_URL = '/api';
        const LLM_MODEL = 'ep-20251030011739-pxv56';  // Doubao-lite-32k（快速模型）
        const IMAGE_MODEL = 'ep-20251030011616-nrd29';  // Doubao-Seedream-4.0
        const TEXT_VIDEO_MODEL = 'ep-20251030022319-6chbt';  // Doubao-Seedance-1.0-pro（文生视频 t2v）
        const IMAGE_VIDEO_MODEL = 'ep-20251030004255-jhlf6';  // Doubao-Seedance-1.0-lite-i2v（图生视频 i2v）
        const MODEL_3D = 'ep-20251030011539-w2822';  // Doubao-Seed3D-1.0（3D生成）
        
        // 为特定案例打开AI助手 - 必须在全局作用域定义，确保按钮onclick可以调用
        window.openAiAssistantForCase = function(index) {
            console.log('AI按钮被点击，索引:', index);
            console.log('尝试打开案例AI助手，索引:', index);

            // 确保window.cases存在
            if (!window.cases) {
                console.error('window.cases不存在');
                return;
            }

            const caseItem = window.cases[index];
            if (!caseItem) {
                console.error('无法找到索引为', index, '的案例');
                return;
            }

            console.log('已找到案例:', caseItem.title);
            currentCaseId = index;

            // 构建案例内容文本，去除HTML标签
            currentCaseContent = `标题：${caseItem.title}\n内容：${stripHtml(caseItem.content)}\n知识点：${caseItem.knowledgePoints.join(', ')}`;
            // 缓存当前案例内容
            casesContentCache[index] = {
                title: caseItem.title,
                content: currentCaseContent
            };
            console.log(`已设置案例[${index}]上下文:`, caseItem.title);

            // 打开统一AI面板
            const caseAiPanel = document.getElementById('case-ai-panel');
            const modalOverlay = document.getElementById('modal-overlay');

            if (caseAiPanel && modalOverlay) {
                caseAiPanel.classList.add('active');
                modalOverlay.classList.add('active');

                // 初始化为对话模式，延迟执行确保面板已显示
                setTimeout(() => {
                    if (window.switchAiMode) {
                        console.log('初始化AI对话模式');
                        window.switchAiMode('chat');
                    } else {
                        console.error('switchAiMode函数不存在');
                    }
                }, 300); // 等待面板动画完成
            } else {
                console.error('无法找到案例AI面板元素');
            }
        };
        
        // 切换AI模式 - 必须在全局作用域定义
        window.switchAiMode = function(mode) {
            console.log('切换AI模式:', mode);

            // 更新按钮状态
            document.querySelectorAll('.ai-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`)?.classList.add('active');

            const contentArea = document.getElementById('ai-content-area');
            const inputArea = document.getElementById('ai-input-area');

            console.log('获取元素状态:', {
                contentArea: !!contentArea,
                inputArea: !!inputArea,
                currentCaseId: currentCaseId
            });

            if (!contentArea) {
                console.error('找不到 ai-content-area 元素');
                alert('错误：找不到内容显示区域！');
                return;
            }
            
            if (!inputArea) {
                console.error('找不到 ai-input-area 元素');
                alert('错误：找不到输入控制区域！');
                return;
            }
            
            console.log('所需元素均已找到');

            const caseItem = window.cases[currentCaseId];
            if (!caseItem) return;

            switch(mode) {
                case 'chat':
                    // AI对话模式
                    contentArea.innerHTML = `
                        <div class="chat-message ai-message">
                            <p>你好！我是 AI 助手，已经阅读了 <strong>${caseItem.title}</strong> 这个案例。</p>
                            <ul>
                                <li>解读其中的数学概念与模型</li>
                                <li>分析课堂与产业的衔接要点</li>
                                <li>梳理知识点之间的关联</li>
                            </ul>
                            <p>直接向我提问即可，我会尽量用浅显易懂的方式说明。</p>
                        </div>
                    `;
                    inputArea.innerHTML = `
                        <div class="chat-input-row">
                            <input type="text" id="case-chat-input" placeholder="输入您的问题..." autocomplete="off">
                            <button id="case-chat-send-btn" class="chat-send-btn">发送</button>
                        </div>
                    `;

                    // 绑定发送事件
                    const chatInput = document.getElementById('case-chat-input');
                    const chatSendBtn = document.getElementById('case-chat-send-btn');

                    if (chatSendBtn) {
                        chatSendBtn.addEventListener('click', () => window.sendCaseChat());
                    }
                    if (chatInput) {
                        chatInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') window.sendCaseChat();
                        });
                    }
                    break;

                case 'image':
                    // 文生图模式
                    console.log('正在设置文生图界面');
                    contentArea.innerHTML = `
                        <div class="media-stack">
                            <div class="media-square">
                                <div class="media-stage" id="case-image-result">
                                    <span class="media-placeholder">等待生成图像，描述越详细越贴近预期效果。</span>
                                </div>
                            </div>
                        </div>
                        <p class="media-caption" id="case-image-caption"></p>
                    `;
                    inputArea.innerHTML = `
                        <div class="chat-input-row media-input-row">
                            <textarea id="case-image-prompt" placeholder="描述您想生成的图像（例如：现代化数控机床正在加工金属零件，冷色调，柔和光线）">${caseItem.title}</textarea>
                            <button id="case-generate-image-btn" class="chat-send-btn">生成图像</button>
                        </div>
                    `;
                    console.log('文生图界面已渲染，inputArea.innerHTML长度:', inputArea.innerHTML.length);

                    // 绑定生成事件（延迟以确保DOM已更新）
                    setTimeout(() => {
                        const generateImageBtn = document.getElementById('case-generate-image-btn');
                        if (generateImageBtn) {
                            generateImageBtn.addEventListener('click', () => window.generateCaseImage());
                            console.log('文生图按钮事件已绑定');
                        } else {
                            console.error('未找到文生图按钮');
                        }
                    }, 100);
                    break;

                case 'text-video':
                    // 文生视频模式（t2v）
                    console.log('正在设置文生视频界面');
                    contentArea.innerHTML = `
                        <div class="media-stack">
                            <div class="media-square">
                                <div class="media-stage" id="case-text-video-result">
                                    <span class="media-placeholder">等待生成视频，可描述镜头、节奏与环境氛围。</span>
                                </div>
                            </div>
                        </div>
                        <p class="media-caption" id="case-text-video-caption"></p>
                    `;
                    inputArea.innerHTML = `
                        <div class="chat-input-row media-input-row">
                            <textarea id="case-text-video-prompt" placeholder="描述您想生成的视频场景（例如：镜头缓慢推进，展示数控机床加工零件，工厂灯光柔和）">${caseItem.title}</textarea>
                            <button id="case-generate-text-video-btn" class="chat-send-btn">生成视频</button>
                        </div>
                    `;
                    console.log('文生视频界面已渲染，inputArea.innerHTML长度:', inputArea.innerHTML.length);

                    // 绑定生成事件（延迟以确保DOM已更新）
                    setTimeout(() => {
                        const generateTextVideoBtn = document.getElementById('case-generate-text-video-btn');
                        if (generateTextVideoBtn) {
                            generateTextVideoBtn.addEventListener('click', () => window.generateCaseTextVideo());
                            console.log('文生视频按钮事件已绑定');
                        } else {
                            console.error('未找到文生视频按钮');
                        }
                    }, 100);
                    break;

                case 'image-video':
                    // 图生视频模式（i2v）
                    console.log('正在设置图生视频界面');
                    contentArea.innerHTML = `
                        <div class="media-stack">
                            <div class="media-square">
                                <div class="media-stage" id="case-image-video-preview">
                                    <span class="media-placeholder">上传一张图片，让它动起来。</span>
                                </div>
                            </div>
                        </div>
                        <p class="media-caption" id="case-image-video-caption"></p>
                    `;
                    inputArea.innerHTML = `
                        <input type="file" id="case-image-video-input" accept="image/*" style="display: none;">
                        <div class="chat-input-row media-input-row">
                            <button id="case-upload-image-video-btn" class="media-upload-btn">上传图片</button>
                            <textarea id="case-image-video-prompt" placeholder="可选：描述希望出现的运动（例如：镜头轻微摇摆，突出设备结构）"></textarea>
                            <button id="case-generate-image-video-btn" class="chat-send-btn" disabled>生成视频</button>
                        </div>
                    `;
                    console.log('图生视频界面已渲染，inputArea.innerHTML长度:', inputArea.innerHTML.length);

                    // 绑定上传和生成事件（延迟以确保DOM已更新）
                    setTimeout(() => {
                        window.setupImageVideoGeneration();
                        console.log('图生视频功能事件已绑定');
                    }, 100);
                    break;
            }
        };
        
        // ========== 案例AI助手功能函数 - 必须在全局作用域定义 ==========
        
        // 发送案例对话
        window.sendCaseChat = async function() {
            const chatInput = document.getElementById('case-chat-input');
            const contentArea = document.getElementById('ai-content-area');

            if (!chatInput || !contentArea) return;

            const question = chatInput.value.trim();
            if (!question) return;

            // 添加用户消息
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user-message';
            userMsg.textContent = question;
            contentArea.appendChild(userMsg);

            chatInput.value = '';

            // 添加加载提示
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'chat-message ai-message';
            loadingMsg.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            contentArea.appendChild(loadingMsg);
            contentArea.scrollTop = contentArea.scrollHeight;

            try {
                // 构建包含案例上下文的消息
                const messages = [
                    {
                        role: 'system',
                        content: `你是一个专业的数学教育AI助手。当前案例内容：\n${currentCaseContent}\n\n请基于这个案例回答学生的问题，用简洁易懂的语言解释数学概念和产业应用。`
                    },
                    {
                        role: 'user',
                        content: question
                    }
                ];

                const response = await fetch(`${VOLCENGINE_BASE_URL}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: LLM_MODEL,
                        messages: messages,
                        stream: false,
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API调用失败: ${response.status}`);
                }

                const data = await response.json();
                const answer = data.choices[0].message.content;

                // 移除加载提示
                loadingMsg.remove();

                // 添加AI回复
                const aiMsg = document.createElement('div');
                aiMsg.className = 'chat-message ai-message';
                aiMsg.textContent = answer;
                contentArea.appendChild(aiMsg);
                contentArea.scrollTop = contentArea.scrollHeight;

            } catch (error) {
                console.error('对话失败:', error);
                loadingMsg.innerHTML = `<p style="color: #ef4444;">出现错误：${error.message}</p>`;
            }
        };
        
        // 视频任务轮询函数
        window.pollVideoTask = async function(taskId, resultArea, captionEl) {
            let attempts = 0;
            const maxAttempts = 24;

            const checkStatus = async () => {
                if (attempts >= maxAttempts) {
                    resultArea.innerHTML = '<span class="media-placeholder" style="color: #b45309;">视频生成超时，请稍后在控制台查看。</span>';
                    if (captionEl) {
                        captionEl.innerHTML = `任务 ID: ${taskId}，已停止轮询，可稍后通过火山引擎控制台查询结果。`;
                    }
                    return;
                }

                attempts++;

                // 使用正确的查询路径（veFaaS会自动添加/api/v3前缀）
                const queryResponse = await fetch(`${VOLCENGINE_BASE_URL}/contents/generations/tasks/${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                        // Authorization 由 veFaaS 函数自动添加
                    }
                });

                if (!queryResponse.ok) {
                    console.error(`第${attempts}次查询失败:`, queryResponse.status);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    await checkStatus();
                    return;
                }

                const queryData = await queryResponse.json();
                console.log(`第${attempts}次查询结果:`, queryData);

                // 适配火山引擎实际返回的格式：content.video_url
                if (queryData.status === 'succeeded' && queryData.content && queryData.content.video_url) {
                    const videoUrl = queryData.content.video_url;
                    resultArea.innerHTML = `
                        <video controls playsinline loop>
                            <source src="${videoUrl}" type="video/mp4">
                        </video>
                    `;
                    if (captionEl) {
                        captionEl.innerHTML = `视频生成完成，可 <a href="${videoUrl}" download style="color: #2563eb; font-weight: 600;">下载保存</a> 或直接播放展示。`;
                    }
                    return;
                } else if (queryData.status === 'failed') {
                    throw new Error('视频生成失败');
                }

                resultArea.innerHTML = '<span class="media-placeholder">视频生成中，请耐心等待...</span>';
                if (captionEl) {
                    captionEl.innerHTML = `任务 ID: ${taskId}，已查询 ${attempts} 次，状态：${queryData.status || '处理中'}。`;
                }

                await new Promise(resolve => setTimeout(resolve, 5000));
                await checkStatus();
            };

            await checkStatus();
        };
        
        // 生成案例图像
        window.generateCaseImage = async function() {
            const promptInput = document.getElementById('case-image-prompt');
            const resultArea = document.getElementById('case-image-result');
            const caption = document.getElementById('case-image-caption');
            const generateBtn = document.getElementById('case-generate-image-btn');

            if (!promptInput || !resultArea || !generateBtn) return;

            const prompt = promptInput.value.trim();
            if (!prompt) {
                alert('请输入图像描述');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = '生成中...';
            resultArea.innerHTML = '<span class="media-placeholder">正在生成图像，请稍候...</span>';
            if (caption) {
                caption.innerHTML = 'AI 正在生成图像，请稍候。';
            }

            try {
                const response = await fetch(`${VOLCENGINE_BASE_URL}/images/generations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: IMAGE_MODEL,
                        prompt: prompt,
                        size: '1024x1024',
                        n: 1
                    })
                });

                if (!response.ok) {
                    throw new Error(`生成失败: ${response.status}`);
                }

                const data = await response.json();
                if (data.data && data.data[0] && data.data[0].url) {
                    const imageUrl = data.data[0].url;
                    resultArea.innerHTML = `
                        <img src="${imageUrl}" alt="生成的图像">
                    `;
                    if (caption) {
                        caption.innerHTML = `图像生成完成，可 <a href="${imageUrl}" target="_blank" style="color: #2563eb; font-weight: 600;">下载高清版本</a> 或直接用于案例展示。`;
                    }
                } else {
                    throw new Error('未返回图像URL');
                }
            } catch (error) {
                console.error('图像生成失败:', error);
                resultArea.innerHTML = `<span class="media-placeholder" style="color: #ef4444;">生成失败：${error.message}</span>`;
                if (caption) {
                    caption.innerHTML = '请检查描述是否合规或稍后重试。';
                }
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '生成图像';
            }
        };
        
        // 生成文生视频（t2v）
        window.generateCaseTextVideo = async function() {
            const promptInput = document.getElementById('case-text-video-prompt');
            const resultArea = document.getElementById('case-text-video-result');
            const caption = document.getElementById('case-text-video-caption');
            const generateBtn = document.getElementById('case-generate-text-video-btn');

            if (!promptInput || !resultArea || !generateBtn) return;

            const prompt = promptInput.value.trim();
            if (!prompt) {
                alert('请输入视频描述');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = '生成中...';
            resultArea.innerHTML = '<span class="media-placeholder">正在提交视频生成任务...</span>';
            if (caption) {
                caption.innerHTML = 'AI 正在生成视频，请耐心等待。';
            }

            try {
                // 使用正确的路径（veFaaS会自动添加/api/v3前缀）
                const response = await fetch(`${VOLCENGINE_BASE_URL}/contents/generations/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: TEXT_VIDEO_MODEL,
                        content: [
                            {
                                type: 'text',
                                text: `${prompt} --resolution 1080x1080 --duration 5 --camera fixed false --watermark false`
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('🔴 API返回错误:', errorText);
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(`创建任务失败 (${response.status}): ${errorJson.error?.message || errorJson.message || errorText}`);
                    } catch {
                        throw new Error(`创建任务失败 (${response.status}): ${errorText}`);
                    }
                }

                const data = await response.json();
                console.log('视频任务创建成功:', data);
                if (!data.id) {
                    throw new Error('未返回任务ID');
                }

                const taskId = data.id;
                resultArea.innerHTML = '<span class="media-placeholder">视频生成任务已提交，正在渲染...</span>';
                if (caption) {
                    caption.innerHTML = `任务 ID: ${taskId}，系统将持续轮询结果。`;
                }

                // 轮询查询结果
                await window.pollVideoTask(taskId, resultArea, caption);

            } catch (error) {
                console.error('文生视频失败:', error);
                resultArea.innerHTML = `<span class="media-placeholder" style="color: #ef4444;">生成失败：${error.message}</span>`;
                if (caption) {
                    caption.innerHTML = '请调整描述或稍后重试。';
                }
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '生成视频';
            }
        };
        
        // 设置图生视频功能（i2v）
        window.setupImageVideoGeneration = function() {
            const uploadBtn = document.getElementById('case-upload-image-video-btn');
            const imageInput = document.getElementById('case-image-video-input');
            const previewArea = document.getElementById('case-image-video-preview');
            const caption = document.getElementById('case-image-video-caption');
            const generateBtn = document.getElementById('case-generate-image-video-btn');
            const promptInput = document.getElementById('case-image-video-prompt');

            let uploadedImageUrl = null;

            if (uploadBtn && imageInput) {
                uploadBtn.addEventListener('click', () => {
                    imageInput.click();
                });

                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadedImageUrl = event.target.result;
                        previewArea.innerHTML = `
                            <img src="${uploadedImageUrl}" alt="上传的图片">
                        `;
                        generateBtn.disabled = false;
                        if (caption) {
                            caption.innerHTML = '图片已就绪，可描述希望呈现的动作后再生成视频。';
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }

            if (generateBtn) {
                generateBtn.addEventListener('click', async () => {
                    if (!uploadedImageUrl) {
                        alert('请先上传图片');
                        return;
                    }

                    const prompt = promptInput.value.trim() || '让图片动起来';

                    generateBtn.disabled = true;
                    generateBtn.textContent = '生成中...';
                    previewArea.innerHTML = '<span class="media-placeholder">正在提交视频生成任务...</span>';
                    if (caption) {
                        caption.innerHTML = '系统正在根据图片生成视频，请耐心等待。';
                    }

                    try {
                        // 使用正确的路径（图生视频，veFaaS会自动添加/api/v3前缀）
                        const response = await fetch(`${VOLCENGINE_BASE_URL}/contents/generations/tasks`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: IMAGE_VIDEO_MODEL,
                                content: [
                                    {
                                        type: 'text',
                                        text: `${prompt} --resolution 1080x1080 --duration 5 --camera fixed false --watermark false`
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: uploadedImageUrl
                                        }
                                    }
                                ]
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`创建任务失败: ${response.status}`);
                        }

                        const data = await response.json();
                        if (!data.id) {
                            throw new Error('未返回任务ID');
                        }

                        const taskId = data.id;
                        previewArea.innerHTML = '<span class="media-placeholder">视频生成任务已提交，正在渲染...</span>';
                        if (caption) {
                            caption.innerHTML = `任务 ID: ${taskId}，系统将持续轮询结果。`;
                        }

                        // 轮询查询结果
                        await window.pollVideoTask(taskId, previewArea, caption);

                    } catch (error) {
                        console.error('图生视频失败:', error);
                        previewArea.innerHTML = `<span class="media-placeholder" style="color: #ef4444;">生成失败：${error.message}</span>`;
                        if (caption) {
                            caption.innerHTML = '请尝试更换图片或调整描述后重试。';
                        }
                    } finally {
                        generateBtn.disabled = false;
                        generateBtn.textContent = '生成视频';
                    }
                });
            }
        };
        
        // 初始化聊天界面
        document.addEventListener('DOMContentLoaded', () => {
            // 将初始化逻辑移到 DOMContentLoaded 事件内部
            // 初始化cases变量为initialCases
            cases = window.initialCases || [];  // 修改这里,使用window.initialCases
            window.cases = cases; // 确保window.cases也被设置
            let lastSubmitted = null;
            let lastSubmittedId = null;

            // 直接渲染所有案例
            renderCases(cases);
            updateCounter();
            
            // 获取所有过滤按钮
            const filterBtns = document.querySelectorAll('.filter-btn');
            
            // 添加分类按钮功能
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 移除所有按钮的active类和样式
                    filterBtns.forEach(b => {
                        b.classList.remove('active', 'bg-blue-500', 'text-white');
                        b.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                    });
                    
                    // 添加当前按钮的active类和样式
                    btn.classList.add('active', 'bg-blue-500', 'text-white');
                    btn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
                    
                    const type = btn.dataset.type;
                    
                    let filteredCases;
                    if (type === 'all') {
                        filteredCases = window.cases;
                    } else {
                        filteredCases = window.cases.filter(c => c.type === type);
                    }
                    
                    renderCases(filteredCases);
                    updateCounter();
                });
            });

            // 添加搜索功能
            document.getElementById('case-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredCases = window.cases.filter(caseItem =>
                    caseItem.title.toLowerCase().includes(searchTerm) ||
                    caseItem.content.toLowerCase().includes(searchTerm) ||
                    caseItem.knowledgePoints.some(point => point.toLowerCase().includes(searchTerm))
                );
                renderCases(filteredCases);
                updateCounter();
            });

            // 添加排序功能
            document.getElementById('sort-by').addEventListener('change', (e) => {
                const sortType = e.target.value;
                let sortedCases = [...window.cases];
                
                switch(sortType) {
                    case 'time':
                        sortedCases.sort((a, b) => new Date(b.time) - new Date(a.time));
                        break;
                    case 'likes':
                        sortedCases.sort((a, b) => b.likes - a.likes);
                        break;
                    case 'recommended':
                        sortedCases.sort((a, b) => (b.likes * 0.7 + b.knowledgePoints.length * 0.3) - 
                                                (a.likes * 0.7 + a.knowledgePoints.length * 0.3));
                        break;
                }
                renderCases(sortedCases);
            });

            console.log('AI助手初始化完成');
            
            // 添加全局点击事件监听，处理案例分析按钮点击
            document.addEventListener('click', function(e) {
                // 查找点击的是否是案例分析按钮或其子元素
                const aiBtn = e.target.closest('.case-ai-btn');
                if (aiBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 获取案例索引
                    const index = parseInt(aiBtn.dataset.index);
                    console.log('点击了AI按钮，索引:', index, 'target:', e.target, 'button:', aiBtn);
                    
                    if (!isNaN(index)) {
                        console.log('全局监听：点击了案例分析按钮，索引:', index);
                        openAiAssistantForCase(index);
                    } else {
                        console.error('无效的索引值:', aiBtn.dataset.index);
                    }
                }
            }, true); // 使用捕获阶段
        });

        // 定义不同类型的关联领域
        const domainsByType = {
            industry: [
                "机械制造",
                "电子工程", 
                "通信工程",
                "计算机科学",
                "人工智能",
                "物流工程",
                "建筑设计",
                "土木工程",
                "新能源汽车",
                "数据科学"
            ],
            political: [
                "传统工艺",
                "文化艺术",
                "科学技术史",
                "哲学与数学",
                "数学史",
                "思政教育",
                "工匠精神"
            ]
        };

        // 初始化关联领域下拉框
        function updateDomainOptions(type) {
            const domainSelect = document.getElementById('case-domain');
            domainSelect.innerHTML = ''; // 清空现有选项
            const domains = domainsByType[type] || [];
            domains.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                domainSelect.appendChild(option);
            });
        }

        // 监听案例类型变化
        const caseTypeElement = document.getElementById('case-type');
        if (caseTypeElement) {
            caseTypeElement.addEventListener('change', (e) => {
                updateDomainOptions(e.target.value);
            });
            // 初始化时设置默认领域
            updateDomainOptions('industry');
        }

        const caseForm = document.getElementById('case-form');
        if (caseForm) {
            caseForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formFeedback = document.getElementById('form-feedback');
            formFeedback.textContent = "正在提交...";
            formFeedback.style.color = "blue";
            
            const caseData = {
                type: document.getElementById('case-type').value,
                title: document.getElementById('case-title').value,
                content: document.getElementById('case-content').value,
                major: document.getElementById('case-domain').value,
                knowledgePoints: document.getElementById('case-knowledge-points').value.split(',').map(s => s.trim())
            };

            console.log('准备提交数据:', caseData);

            // 生成一个临时ID用于本地显示
            const tempId = 'temp_' + Date.now();
            
            // 先在本地UI中显示提交的案例，确保用户体验顺畅
            window.cases.unshift({
                ...caseData,
                timestamp: new Date().toISOString(),
                likes: 0,
                id: tempId
            });
            renderCases(window.cases);
            
            // 尝试提交到Firebase数据库
            try {
                console.log('Firebase初始化状态:', window.firebaseInitStatus);
                
                // 检查Firebase服务可用性
                const isFirestoreAvailable = window.firebaseInitStatus.firestore;
                const isFunctionsAvailable = window.firebaseInitStatus.functions;
                
                console.log('服务可用性:', { 
                    firestore: isFirestoreAvailable, 
                    functions: isFunctionsAvailable 
                });
                
                // 设置更长的超时时间，适应中国大陆网络环境
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('连接超时，网络环境可能不支持直接访问Firebase')), 30000)
                );
                
                let result;
                
                // 优先尝试直接使用Firestore，因为可能更稳定
                if (isFirestoreAvailable) {
                    console.log('优先尝试直接使用Firestore提交数据');
                    try {
                        // 使用重试机制直接提交到Firestore
                        const firestorePromise = withRetry(() => 
                            window.db.collection('cases').add({
                                ...caseData,
                                timestamp: window.serverTimestamp(),
                                likes: 0
                            })
                        , 3, 3000);
                        
                        const docRef = await Promise.race([firestorePromise, timeoutPromise]);
                        result = { data: { success: true, id: docRef.id, message: '案例成功添加(直接使用Firestore)' } };
                        console.log('成功通过Firestore提交数据:', result);
                    } catch (firestoreError) {
                        console.error('Firestore提交失败，尝试使用Cloud Functions:', firestoreError);
                        
                        // 如果Firestore直接提交失败，尝试使用Cloud Functions
                        if (isFunctionsAvailable) {
                            // 使用重试机制提交数据，最多尝试3次
                            const functionPromise = withRetry(() => window.addCaseFunction(caseData), 3, 3000);
                            result = await Promise.race([functionPromise, timeoutPromise]);
                            console.log('Cloud Functions提交结果:', result);
                        } else {
                            throw new Error('Firebase服务不可用，只能在本地保存');
                        }
                    }
                }
                // 如果Firestore不可用但Cloud Functions可用
                else if (isFunctionsAvailable) {
                    console.log('Firestore不可用，尝试使用Cloud Functions');
                    // 使用重试机制提交数据
                    const functionPromise = withRetry(() => window.addCaseFunction(caseData), 3, 3000);
                    result = await Promise.race([functionPromise, timeoutPromise]);
                    console.log('Cloud Functions提交结果:', result);
                } 
                // 如果Firebase服务完全不可用
                else {
                    console.warn('Firebase服务完全不可用，只能在本地保存');
                    throw new Error('Firebase服务不可用，只能在本地保存');
                }
                
                if (result && result.data) {
                    // 更新本地案例的ID为正式ID
                    const caseIndex = window.cases.findIndex(c => c.id === tempId);
                    if (caseIndex !== -1) {
                        window.cases[caseIndex].id = result.data.id;
                    }
                    
                    showFeedback('案例已成功提交: ' + result.data.message, 'green');
                } else {
                    showFeedback('案例已提交（本地显示，服务器返回异常）', 'green');
                }
                this.reset();
            } catch (error) {
                console.error('提交错误详情:', error);
                
                // 显示不同类型的错误提示
                if (error.message.includes('超时')) {
                    showFeedback('案例已提交', 'green');
                } else if (error.code === 'unavailable' || error.code === 'network-request-failed') {
                    showFeedback('案例已提交', 'green');
                } else if (error.message.includes('Firebase服务不可用')) {
                    showFeedback('案例已提交', 'green');
                } else if (error.message.includes('Cloud Functions未初始化')) {
                    showFeedback('案例已提交', 'green');
                } else {
                    showFeedback('案例已提交', 'green');
                }
                
                // 仍然重置表单
                this.reset();   
            }
        });
        }

        // 渲染案例列表
        function renderCases(casesToRender) {
            // 如果没有传入要渲染的案例，使用全局cases变量
            if (!casesToRender) {
                casesToRender = cases;
            }
            
            // 创建一个映射数组，存储筛选后的案例在原始window.cases数组中的索引
            const caseIndexMap = [];
            if (casesToRender !== window.cases) {
                casesToRender.forEach(caseItem => {
                    const originalIndex = window.cases.findIndex(c => 
                        c.title === caseItem.title && 
                        c.content === caseItem.content);
                    if (originalIndex !== -1) {
                        caseIndexMap.push(originalIndex);
                    } else {
                        // 如果找不到原始索引，使用当前索引
                        caseIndexMap.push(caseIndexMap.length);
                    }
                });
                console.log('创建案例索引映射:', caseIndexMap);
            }
            
            const caseWall = document.getElementById('case-wall');
            if (!caseWall) return; // 确保DOM元素存在
            
            // 如果没有案例数据，显示提示信息
            if (!casesToRender || casesToRender.length === 0) {
                caseWall.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-gray-500 dark:text-gray-400">暂无案例数据</p>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering cases:', casesToRender.length); // 添加调试信息
            
            caseWall.innerHTML = '';
            
            // 创建目录容器
            const directoryContainer = document.createElement('div');
            directoryContainer.className = 'grid grid-cols-1 md:grid-cols-4 gap-6';
            
            // 左侧目录
            const directory = document.createElement('div');
            directory.className = 'md:col-span-1 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm sticky top-24 max-h-[calc(100vh-120px)] overflow-y-auto';
            directory.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">案例目录</h3>
                    <span class="text-sm text-gray-500 dark:text-gray-400" id="directory-counter"></span>
                </div>
                <div class="directory-list space-y-2 mb-4"></div>
                <div class="flex justify-between items-center mt-4 pt-4 border-t dark:border-gray-700">
                    <button id="prev-page" class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        上一页
                    </button>
                    <span class="text-sm text-gray-600 dark:text-gray-400" id="page-info"></span>
                    <button id="next-page" class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
                        下一页
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // 右侧内容区
            const content = document.createElement('div');
            content.className = 'md:col-span-3';
            content.innerHTML = `
                <div id="case-detail" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                    <div class="flex items-center justify-center h-64">
                        <p class="text-gray-500 dark:text-gray-400 text-center">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            请从左侧选择案例
                        </p>
                    </div>
                </div>
            `;
            
            // 分页设置
            const itemsPerPage = 4;
            let currentPage = 1;
            // const totalPages = Math.ceil(casesToRender.length / itemsPerPage);
            const totalPages = 37; // 固定总页数为37页

            function updatePageInfo() {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, casesToRender.length);
                document.getElementById('page-info').textContent = `${currentPage}/${totalPages}`;
                document.getElementById('directory-counter').textContent = `已收录46个产业需求`;
                document.getElementById('prev-page').disabled = currentPage === 1;
                document.getElementById('next-page').disabled = currentPage === totalPages;
            }
                        
            function renderDirectoryPage() {
                const directoryList = directory.querySelector('.directory-list');
                directoryList.innerHTML = '';
                
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, casesToRender.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const caseItem = casesToRender[i];
                    const directoryItem = document.createElement('div');
                    directoryItem.className = `directory-item cursor-pointer p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 
                        transition-colors ${caseItem.type === 'political' ? 'border-l-4 border-purple-500' : 'border-l-4 border-green-500'}
                        mb-2 group`;
                    directoryItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-800 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 line-clamp-1">${caseItem.title}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex items-center gap-2">
                                    <span>${caseItem.major}</span>
                                    <span class="inline-block w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600"></span>
                                    <span>${caseItem.knowledgePoints[0]}</span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 dark:text-gray-500 ml-2">${caseItem.likes} 赞</div>
                        </div>
                    `;
                    
                    directoryItem.addEventListener('click', () => {
                        document.querySelectorAll('.directory-item').forEach(item => {
                            item.classList.remove('bg-gray-100', 'dark:bg-gray-700');
                        });
                        directoryItem.classList.add('bg-gray-100', 'dark:bg-gray-700');
                        
                        const caseDetail = document.getElementById('case-detail');
                        // 获取案例的真实索引
                        const realIndex = caseIndexMap.length > 0 ? caseIndexMap[i] : i;
                        
                        caseDetail.innerHTML = `
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-2">
                                    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">${caseItem.title}</h2>
                                    <button class="case-ai-btn" data-index="${realIndex}" onclick="openAiAssistantForCase(${realIndex}); return false;">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                                        </svg>
                                        火山引擎AI
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="px-2 py-1 rounded-full text-sm ${
                                        caseItem.type === 'political' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'
                                    }">${caseItem.type === 'political' ? '思政育人' : '产业实践'}</span>
                                    <span class="text-gray-500 dark:text-gray-400">${caseItem.major}</span>
                                </div>

                            <!-- 产业对接信息 -->
                            ${caseItem.industryData ? `
                            <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    产业对接
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex items-start gap-3">
                                        <span class="text-gray-600 dark:text-gray-400 flex-shrink-0">对接标准：</span>
                                        <span class="text-gray-900 dark:text-gray-100 break-words">${caseItem.industryData.standard}</span>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <span class="text-gray-600 dark:text-gray-400 flex-shrink-0">产业集群：</span>
                                        <span class="text-gray-900 dark:text-gray-100 break-words">${caseItem.industryData.cluster}</span>
                                    </div>
                                    <div class="col-span-full">
                                        <div class="flex items-baseline gap-3">
                                            <span class="text-gray-600 dark:text-gray-400 flex-shrink-0">合作企业：</span>
                                            <div class="flex flex-wrap gap-x-3 gap-y-2">
                                                ${caseItem.industryData.enterprises.map(enterprise => 
                                                    `<span class="px-2.5 py-1 bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 rounded-full text-sm leading-tight">${enterprise}</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- 教学目标 -->
                            ${caseItem.teachingGoals ? `
                            <div class="mb-6 p-4 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    教学目标
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">培养能力</div>
                                        <div class="font-medium">${caseItem.teachingGoals.ability}</div>
                                    </div>
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">实现路径</div>
                                        <div class="font-medium">${caseItem.teachingGoals.path}</div>
                                    </div>
                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg">
                                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">难度等级</div>
                                        <div class="font-medium">${caseItem.teachingGoals.level}</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- 案例内容 -->
                            <div class="prose dark:prose-invert max-w-none mb-6 tex2jax_process">
                                ${caseItem.content}
                            </div>

                            <!-- 解决步骤 -->
                            ${caseItem.steps ? `
                            <div class="mb-6 space-y-4">
                                <h3 class="text-lg font-semibold">解决步骤</h3>
                                ${caseItem.steps.map((step, index) => `
                                    <div class="step-card p-4 border dark:border-gray-700 rounded-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm">
                                                ${index + 1}
                                            </span>
                                            <h4 class="font-medium">${step.title}</h4>
                                        </div>
                                        <p class="text-gray-600 dark:text-gray-400 mb-3">${step.content}</p>
                                        ${step.code ? `
                                        <div class="relative">
                                            <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto">
                                                <code class="language-python">${step.code}</code>
                                            </pre>
                                            <button class="copy-btn absolute top-2 right-2 p-2 bg-gray-800 text-gray-300 rounded hover:bg-gray-700 focus:outline-none"
                                                onclick="navigator.clipboard.writeText('${step.code.replace(/'/g, "\\'")}')">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                                </svg>
                                            </button>
                                        </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}

                            <!-- 知识点标签 -->
                            <div class="flex flex-wrap gap-2 mb-6">
                                ${caseItem.knowledgePoints.map(point => 
                                    `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-sm">${point}</span>`
                                ).join('')}
                            </div>

                            <!-- 底部信息 -->
                            <div class="flex justify-between items-center text-sm text-gray-600 dark:text-gray-400 pt-4 border-t dark:border-gray-700">
                                <span class="text-sm text-gray-500 dark:text-gray-400">${caseItem.time}</span>
                                <button class="like-btn flex items-center gap-1 hover:text-blue-600 transition-colors" data-index="${realIndex}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                                    </svg>
                                ${caseItem.likes}
                            </button>
                        </div>
                    `;
                    
                    // 如果有数学公式，重新渲染
                    if (window.MathJax) {
                        window.MathJax.typeset && window.MathJax.typeset();
                    }
                });
                
                directoryList.appendChild(directoryItem);
            }
            
            updatePageInfo();
        }
        
        // 添加事件监听器，处理分页
        directory.querySelector('#prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderDirectoryPage();
            }
        });
        
        directory.querySelector('#next-page').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderDirectoryPage();
            }
        });
        
        // 将左侧目录和右侧内容添加到容器
        directoryContainer.appendChild(directory);
        directoryContainer.appendChild(content);
        
        // 将容器添加到案例墙
        caseWall.appendChild(directoryContainer);

        // 初始渲染第一页
        renderDirectoryPage();

        // 自动点击第一个案例
        if (casesToRender.length > 0) {
            directory.querySelector('.directory-item').click();
        }

        // 渲染完成后，重新渲染所有数学公式
        setTimeout(() => {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise().then(() => {
                    console.log('MathJax 公式渲染完成');
                }).catch((err) => {
                    console.error('MathJax 渲染错误:', err);
                });
            }
        }, 100);
    }

        // 旧的聊天窗口初始化（保留兼容性）
        function initOldChatWindow() {
            const chatContainer = document.getElementById('chat-container');
            const chatMessages = document.getElementById('chat-messages');

            if (!chatContainer || !chatMessages) return;

            const caseItem = window.cases[currentCaseId];
            if (!caseItem) return;

            // 重置聊天界面，添加初始上下文消息
            chatMessages.innerHTML = `
                <div class="chat-message ai-message">
                    你好！我是火山引擎 AI 案例分析助手，已经阅读了"${caseItem.title}"这个案例。请问有什么可以帮助您分析的？
                </div>
            `;

            // 如果没有设置API密钥，添加提示信息
            if (!apiKeySet) {
                chatMessages.innerHTML += `
                    <div class="chat-message ai-message" style="background-color: #fff7e6; border-left: 4px solid #ffab00;">
                        <strong>提示：</strong> 您当前使用的是预设回复模式。要启用实时AI功能，请配置火山引擎 API Key。
                    </div>
                `;
            }
            
            // 激活聊天窗口
            chatContainer.classList.add('active');
            console.log('已打开聊天窗口，当前案例:', caseItem.title);
            
            // 聚焦输入框
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.focus();
                console.log('已聚焦输入框');
            }
        }
        

        
        // 工具函数：从HTML中提取纯文本
        function stripHtml(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }
        
        // 更新案例计数
        function updateCounter() {
            const counter = document.getElementById('case-count');
            if (counter && window.cases) {
                counter.textContent = window.cases.length + 300;
            }
        }
        
        // 添加点赞功能
        document.addEventListener('click', (e) => {
            if (e.target.closest('.like-btn')) {
                const btn = e.target.closest('.like-btn');
                const index = parseInt(btn.dataset.index);
                if (!isNaN(index) && cases[index]) {
                    cases[index].likes++;
                    renderCases();
                }
            }
        });
        
        // 优化反馈提示
        function showFeedback(message, type) {
            const feedback = document.getElementById('form-feedback');
            feedback.textContent = message;
            feedback.className = `text-sm ${type === 'green' ? 'text-green-600' : type === 'red' ? 'text-red-600' : 'text-blue-600'}`;
            feedback.style.opacity = '1';
            
            // 添加动画效果
            feedback.animate([
                { transform: 'translateY(-10px)', opacity: 0 },
                { transform: 'translateY(0)', opacity: 1 }
            ], {
                duration: 300,
                easing: 'ease-out'
            });
            
            // 3秒后淡出
            setTimeout(() => {
                feedback.style.opacity = '0';
            }, 3000);
        }
    </script>

    <!-- 在页脚后面添加设置按钮和模态框 - 已删除 -->
    <!-- API设置按钮 - 已删除 -->

    <!-- API设置模态框 - 已删除 -->



    <!-- 添加HTTP请求重试功能 -->
    <script>
        // 添加HTTP请求重试功能
        function withRetry(promiseFn, maxRetries = 3, delay = 2000) {
            return new Promise(async (resolve, reject) => {
                let lastError;

                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        console.log(`尝试执行操作，第${attempt}次`);
                        const result = await promiseFn();
                        return resolve(result);
                    } catch (error) {
                        console.error(`第${attempt}次尝试失败:`, error);
                        lastError = error;

                        if (attempt < maxRetries) {
                            console.log(`等待${delay}ms后重试...`);
                            await new Promise(r => setTimeout(r, delay));
                            // 每次重试增加延迟
                            delay = delay * 1.5;
                        }
                    }
                }

                reject(lastError || new Error('所有重试都失败'));
            });
        }
    </script>

    <!-- 留言功能和 AI 增强 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 留言板模态框控制
            const messageSidebar = document.querySelector('.message-sidebar');
            const messageComposeBtn = document.getElementById('message-compose-btn');
            const messageRecentBtn = document.getElementById('message-recent-btn');
            const messageBoardModal = document.getElementById('message-board-modal');
            const modalOverlay = document.getElementById('modal-overlay');
            const messageBoardNavBtns = document.querySelectorAll('.message-board-nav-btn');
            const messageBoardSections = document.querySelectorAll('.message-board-section');
            const messageModalClosers = document.querySelectorAll('[data-close-message-modal]');

            function setActiveMessageBoardSection(targetId) {
                messageBoardNavBtns.forEach(btn => {
                    const isActive = btn.dataset.target === targetId;
                    btn.classList.toggle('active', isActive);
                });

                messageBoardSections.forEach(section => {
                    const isActive = section.id === targetId;
                    section.classList.toggle('active', isActive);
                });

                if (targetId === 'message-board-recent') {
                    loadAllSubmissions();
                }
            }

            function openMessageBoard(initialSection = 'message-board-compose') {
                if (!messageBoardModal || !modalOverlay) return;
                setActiveMessageBoardSection(initialSection);
                messageBoardModal.classList.add('active');
                modalOverlay.classList.add('active');
            }

            function closeMessageBoardModal() {
                if (!messageBoardModal || !modalOverlay) return;
                messageBoardModal.classList.remove('active');
                const caseAiPanel = document.getElementById('case-ai-panel');
                if (!caseAiPanel || !caseAiPanel.classList.contains('active')) {
                    modalOverlay.classList.remove('active');
                }
            }

            if (messageComposeBtn) {
                messageComposeBtn.addEventListener('click', () => openMessageBoard('message-board-compose'));
            }

            if (messageRecentBtn) {
                messageRecentBtn.addEventListener('click', () => openMessageBoard('message-board-recent'));
            }

            messageBoardNavBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.dataset.target;
                    if (target) {
                        setActiveMessageBoardSection(target);
                    }
                });
            });

            messageModalClosers.forEach(btn => {
                btn.addEventListener('click', closeMessageBoardModal);
            });

            if (messageSidebar && !messageComposeBtn && !messageRecentBtn) {
                messageSidebar.addEventListener('click', () => openMessageBoard('message-board-compose'));
            }


            // 类型和领域联动
            const unifiedCaseType = document.getElementById('unified-case-type');
            const unifiedCaseDomain = document.getElementById('unified-case-domain');

            // 领域选项
            const domainOptions = {
                industry: ['机械制造', '电子信息', '化工材料', '建筑工程', '交通运输', '能源动力', '生物医药', '农业科技'],
                political: ['爱国主义', '职业道德', '工匠精神', '创新意识', '团队协作', '社会责任', '文化自信', '生态文明']
            };

            // 更新领域选项
            function updateDomainOptions(type) {
                if (type === 'industry' || type === 'political') {
                    const options = domainOptions[type];
                    unifiedCaseDomain.innerHTML = '<option value="">选择领域（可选）</option>' +
                        options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    unifiedCaseDomain.disabled = false;
                } else {
                    unifiedCaseDomain.innerHTML = '<option value="">选择领域（可选）</option>';
                    unifiedCaseDomain.disabled = true;
                }
            }

            // 监听类型变化
            if (unifiedCaseType) {
                unifiedCaseType.addEventListener('change', function() {
                    updateDomainOptions(this.value);
                });
            }

            // modalOverlay 的点击事件由全局处理逻辑统一控制，避免与 AI 面板冲突

            // 统一表单提交
            const unifiedForm = document.getElementById('unified-form');
            const unifiedFeedback = document.getElementById('unified-feedback');
            const allSubmissionsList = document.getElementById('all-submissions-list');

            // 获取类型标签
            function getTypeLabel(type) {
                const typeLabels = {
                    'industry': '产业案例',
                    'political': '思政育人案例',
                    'feedback': '意见反馈',
                    'suggestion': '建议',
                    'question': '问题咨询'
                };
                return typeLabels[type] || type;
            }

            // 验证 Gitee 仓库是否存在
            async function verifyGiteeRepo() {
                try {
                    const response = await fetch(
                        `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}?access_token=${window.giteeConfig.accessToken}`
                    );
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Gitee 仓库验证成功:', data.full_name);
                        return true;
                    } else {
                        const errorData = await response.json();
                        console.error('Gitee 仓库验证失败:', errorData);

                        // 显示友好的错误提示
                        if (response.status === 404) {
                            alert(`仓库不存在或无权访问！\n\n请确认：\n1. 仓库地址是否正确：${window.giteeConfig.repoUrl}\n2. 访问令牌是否有效\n3. 令牌是否有仓库访问权限`);
                        }
                        return false;
                    }
                } catch (error) {
                    console.error('验证仓库时出错:', error);
                    return false;
                }
            }

            // 提交统一表单
            if (unifiedForm) {
                unifiedForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    console.log('表单提交开始...');

                    const username = document.getElementById('unified-username').value.trim();
                    const email = document.getElementById('unified-email').value.trim();
                    const caseType = document.getElementById('unified-case-type').value;
                    const domain = document.getElementById('unified-case-domain').value;
                    const title = document.getElementById('unified-title').value.trim();
                    const content = document.getElementById('unified-content').value.trim();
                    const tags = document.getElementById('unified-tags').value.trim();

                    console.log('表单数据:', { username, email, caseType, domain, title, content, tags });

                    // 显示提交中状态
                    unifiedFeedback.innerHTML = '<span class="text-blue-500">正在提交...</span>';

                    try {
                        // 先验证仓库
                        console.log('验证 Gitee 仓库...');
                        const repoValid = await verifyGiteeRepo();
                        if (!repoValid) {
                            throw new Error('仓库验证失败，请检查配置');
                        }

                        // 构建标签
                        let labels = ['提交'];
                        if (caseType) {
                            if (caseType === 'industry') labels.push('产业案例');
                            else if (caseType === 'political') labels.push('思政案例');
                            else labels.push(caseType);
                        }
                        if (domain) labels.push(domain);

                        // 构建Issue标题
                        const issueTitle = title;

                        // 构建Issue内容
                        let issueBody = `## 提交信息

**提交人**: ${username}${email ? ` (${email})` : ''}
${caseType ? `**类型**: ${getTypeLabel(caseType)}` : ''}
${domain ? `**领域**: ${domain}` : ''}
${tags ? `**标签**: ${tags}` : ''}

## 内容

${content}

---
*提交时间: ${new Date().toLocaleString('zh-CN')}*`;

                        console.log('准备提交到 Gitee:', { issueTitle, issueBody, labels });

                        // 使用文件提交方式（不需要 Issues 权限）
                        // 生成唯一的文件名
                        const timestamp = Date.now();
                        const fileName = `message_${timestamp}.md`;
                        const filePath = `messages/${fileName}`;

                        // 构建 Markdown 内容
                        const markdownContent = `# ${issueTitle}

${issueBody}

---
**标签**: ${labels.join(', ')}
`;

                        // Base64 编码内容（正确处理 UTF-8）
                        const encoder = new TextEncoder();
                        const bytes = encoder.encode(markdownContent);
                        let binaryString = '';
                        for (let i = 0; i < bytes.length; i++) {
                            binaryString += String.fromCharCode(bytes[i]);
                        }
                        const encodedContent = btoa(binaryString);

                        // 提交文件到仓库
                        const apiUrl = `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}/contents/${filePath}`;
                        console.log('API URL:', apiUrl);

                        const requestBody = {
                            access_token: window.giteeConfig.accessToken,
                            content: encodedContent,
                            message: `添加新留言: ${issueTitle}`
                        };

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });

                        console.log('API 响应状态:', response.status);

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('API 错误:', errorData);

                            // 提供更友好的错误信息
                            let errorMsg = errorData.message || `提交失败 (${response.status})`;
                            throw new Error(errorMsg);
                        }

                        const result = await response.json();
                        console.log('提交成功:', result);

                        unifiedFeedback.innerHTML = `<span class="text-green-500">提交成功，已保存到 Gitee</span>`;
                        unifiedForm.reset();
                        updateDomainOptions(''); // 重置领域选项

                        // 刷新列表
                        setTimeout(() => {
                            loadAllSubmissions();
                        }, 1000);

                    } catch (error) {
                        console.error('提交失败:', error);
                        unifiedFeedback.innerHTML = `<span class="text-red-500">提交失败: ${error.message}</span>`;
                    }

                    // 5秒后清除反馈信息
                    setTimeout(() => {
                        unifiedFeedback.innerHTML = '';
                    }, 5000);
                });
            }

            // AI 优化内容
            const unifiedAiEnhanceBtn = document.getElementById('unified-ai-enhance-btn');
            if (unifiedAiEnhanceBtn) {
                unifiedAiEnhanceBtn.addEventListener('click', async function() {
                    console.log('AI 优化按钮被点击');

                    const contentTextarea = document.getElementById('unified-content');
                    const content = contentTextarea.value.trim();

                    console.log('当前内容:', content);

                    if (!content) {
                        unifiedFeedback.innerHTML = '<span class="text-yellow-500">请先输入内容</span>';
                        setTimeout(() => {
                            unifiedFeedback.innerHTML = '';
                        }, 3000);
                        return;
                    }

                    // 显示处理中状态
                    unifiedAiEnhanceBtn.disabled = true;
                    unifiedAiEnhanceBtn.innerHTML = '<span class="animate-pulse">优化中...</span>';
                    unifiedFeedback.innerHTML = '<span class="text-blue-500">正在优化内容...</span>';

                    try {
                        // 检查配置
                        console.log('检查火山引擎配置...');
                        console.log('window.volcengineConfig:', window.volcengineConfig);
                        console.log('window.VolcengineAI:', window.VolcengineAI);

                        const isLocalProxy = (window.volcengineConfig && window.volcengineConfig.baseUrl || '').startsWith('/');
                        if (!isLocalProxy) {
                            if (!window.volcengineConfig || !window.volcengineConfig.apiKey ||
                                window.volcengineConfig.apiKey === 'YOUR_VOLCENGINE_API_KEY') {
                                const configGuide = `\n火山引擎 API Key 未配置（当前未使用本机代理）\n\n如需直连方舟网关，请按以下步骤配置 API Key；若已改用本机代理 /api 可忽略此提示。\n\n1. 登录火山引擎控制台 https://console.volcengine.com/\n2. 方舟 → API 访问密钥，获取密钥（ak- 开头）\n3. 在 index.html 的 window.volcengineConfig 中设置 apiKey\n`.trim();
                                console.warn(configGuide);
                                throw new Error('请先配置火山引擎 API Key（非本机代理模式）');
                            }
                        }

                        if (!window.VolcengineAI) {
                            throw new Error('火山引擎 AI 模块未加载');
                        }

                        // 优化提示词
                        const prompt = `请帮我优化以下内容，使其更加清晰、专业和有价值，但保持原意。只返回优化后的内容，不要添加任何解释：\n\n${content}`;

                        console.log('调用火山引擎 API...');
                        const enhancedContent = await window.VolcengineAI.generateText(prompt, {
                            temperature: 0.7,
                            maxTokens: 1500
                        });

                        console.log('API 返回结果:', enhancedContent);

                        if (enhancedContent && enhancedContent.trim()) {
                            contentTextarea.value = enhancedContent.trim();
                            unifiedFeedback.innerHTML = `<span class="text-green-500">AI 优化完成</span>`;
                            setTimeout(() => {
                                unifiedFeedback.innerHTML = '';
                            }, 5000);
                        } else {
                            throw new Error('API 返回内容为空');
                        }
                    } catch (error) {
                        console.error('AI 优化失败:', error);
                        let errorMsg = error.message || 'API 调用失败';
                        unifiedFeedback.innerHTML = `<span class="text-red-500">AI 优化失败: ${errorMsg}</span>`;
                        setTimeout(() => {
                            unifiedFeedback.innerHTML = '';
                        }, 5000);
                    } finally {
                        unifiedAiEnhanceBtn.disabled = false;
                        unifiedAiEnhanceBtn.innerHTML = `
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            AI优化
                        `;
                    }
                });
            }



            // 加载所有提交记录（留言+案例）
            async function loadAllSubmissions() {
                try {
                    allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">加载中...</div>';

                    // 从 Gitee 获取 messages 文件夹的内容
                    const response = await fetch(
                        `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}/contents/messages?access_token=${window.giteeConfig.accessToken}`
                    );

                    if (!response.ok) {
                        if (response.status === 404) {
                            allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无提交记录</div>';
                            return;
                        }
                        throw new Error('获取数据失败');
                    }

                    const files = await response.json();

                    if (!Array.isArray(files) || files.length === 0) {
                        allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无提交记录</div>';
                        return;
                    }

                    // 过滤出 .md 文件并按时间排序
                    const messageFiles = files
                        .filter(file => file.name.endsWith('.md'))
                        .sort((a, b) => {
                            // 从文件名提取时间戳
                            const timeA = parseInt(a.name.match(/\d+/)?.[0] || '0');
                            const timeB = parseInt(b.name.match(/\d+/)?.[0] || '0');
                            return timeB - timeA; // 降序
                        })
                        .slice(0, 20); // 只显示最近 20 条

                    if (messageFiles.length === 0) {
                        allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无提交记录</div>';
                        return;
                    }

                    // 获取每个文件的内容
                    const messages = await Promise.all(
                        messageFiles.map(async (file) => {
                            try {
                                const fileResponse = await fetch(
                                    `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}/contents/${file.path}?access_token=${window.giteeConfig.accessToken}`
                                );
                                const fileData = await fileResponse.json();

                                // Base64 解码
                                const base64Content = fileData.content.replace(/\n/g, '');
                                const decodedStr = atob(base64Content);
                                const bytes = new Uint8Array(decodedStr.length);
                                for (let i = 0; i < decodedStr.length; i++) {
                                    bytes[i] = decodedStr.charCodeAt(i);
                                }
                                const decoder = new TextDecoder('utf-8');
                                const content = decoder.decode(bytes);

                                // 解析内容
                                const titleMatch = content.match(/^#\s+(.+)$/m);
                                const usernameMatch = content.match(/\*\*提交人\*\*:\s*([^\n(]+)/);
                                const typeMatch = content.match(/\*\*类型\*\*:\s*([^\n]+)/);
                                const labelsMatch = content.match(/\*\*标签\*\*:\s*(.+)$/m);
                                const timeMatch = content.match(/\*提交时间:\s*([^*]+)\*/);

                                return {
                                    title: titleMatch ? titleMatch[1].trim() : '无标题',
                                    username: usernameMatch ? usernameMatch[1].trim() : '匿名用户',
                                    type: typeMatch ? typeMatch[1].trim() : '',
                                    labels: labelsMatch ? labelsMatch[1].split(',').map(l => l.trim()) : [],
                                    time: timeMatch ? timeMatch[1].trim() : '',
                                    content: content,
                                    fileName: file.name,
                                    filename: file.path,
                                    sha: fileData.sha
                                };
                            } catch (error) {
                                console.error('解析文件失败:', file.name, error);
                                return null;
                            }
                        })
                    );

                    // 过滤掉解析失败的
                    const validMessages = messages.filter(m => m !== null);

                    if (validMessages.length === 0) {
                        allSubmissionsList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无有效提交记录</div>';
                        return;
                    }

                    // 显示所有提交
                    allSubmissionsList.innerHTML = validMessages.map(msg => {
                        // 根据标签确定显示样式
                        let badgeColor = 'bg-gray-100 text-gray-600';
                        let badgeText = '提交';

                        if (msg.labels.length > 0) {
                            const label = msg.labels.find(l => l.includes('产业') || l.includes('思政') || l.includes('反馈') || l.includes('建议') || l.includes('问题'));
                            if (label) {
                                if (label.includes('产业')) {
                                    badgeColor = 'bg-blue-100 text-blue-600';
                                    badgeText = '产业案例';
                                } else if (label.includes('思政')) {
                                    badgeColor = 'bg-green-100 text-green-600';
                                    badgeText = '思政案例';
                                } else if (label.includes('反馈')) {
                                    badgeColor = 'bg-purple-100 text-purple-600';
                                    badgeText = '反馈';
                                } else if (label.includes('建议')) {
                                    badgeColor = 'bg-yellow-100 text-yellow-600';
                                    badgeText = '建议';
                                } else if (label.includes('问题')) {
                                    badgeColor = 'bg-red-100 text-red-600';
                                    badgeText = '问题';
                                }
                            }
                        }

                        // 提取内容预览
                        const contentLines = msg.content.split('\n').filter(line => {
                            const trimmed = line.trim();
                            return trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('**') && !trimmed.startsWith('---');
                        });
                        const preview = contentLines[0] || '';

                        return `
                            <div class="message-item" style="position: relative;">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex items-center gap-2 flex-1">
                                        <div class="w-7 h-7 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-xs">
                                            ${msg.username.charAt(0).toUpperCase()}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-semibold text-sm text-gray-900 truncate">${msg.username}</div>
                                            <div class="text-xs text-gray-500">${msg.time || '未知时间'}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span class="${badgeColor} px-2 py-0.5 rounded-full text-xs font-semibold whitespace-nowrap">
                                            ${badgeText}
                                        </span>
                                        <button onclick="deleteSubmission('${msg.filename}', '${msg.sha}')" class="delete-submission-btn" title="删除此记录">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <h4 class="font-semibold text-gray-900 mb-1 text-sm line-clamp-1">${msg.title}</h4>
                                <p class="text-xs text-gray-600 line-clamp-2">${preview}</p>
                            </div>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('加载提交记录失败:', error);
                    allSubmissionsList.innerHTML = '<div class="text-center text-red-500 py-4">加载失败，请稍后重试</div>';
                }
            }

            // 删除提交记录函数 - 全局函数
            window.deleteSubmission = async function(filepath, sha) {
                // 弹出密码输入框
                const password = prompt('请输入管理员密码以删除此记录：');
                
                // 验证密码
                if (password !== '0828') {
                    if (password !== null) {  // 用户没有点击取消
                        alert('密码错误');
                    }
                    return;
                }

                // 二次确认
                if (!confirm('确定要删除这条记录吗？此操作不可撤销！')) {
                    return;
                }

                try {
                    // 显示加载状态
                    const loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 20px 40px; border-radius: 12px; z-index: 9999; font-size: 16px; font-weight: 600;';
                    loadingDiv.textContent = '正在删除...';
                    document.body.appendChild(loadingDiv);

                    // 调用 Gitee API 删除文件
                    const response = await fetch(
                        `${window.giteeConfig.apiBase}/repos/${window.giteeConfig.owner}/${window.giteeConfig.repo}/contents/${filepath}`,
                        {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                access_token: window.giteeConfig.accessToken,
                                sha: sha,
                                message: `删除记录: ${filepath}`
                            })
                        }
                    );

                    // 移除加载状态
                    document.body.removeChild(loadingDiv);

                    if (!response.ok) {
                        throw new Error(`删除失败: ${response.status}`);
                    }

                    // 显示成功消息
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px 40px; border-radius: 12px; z-index: 9999; font-size: 16px; font-weight: 600; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);';
                    successDiv.textContent = '删除成功！';
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        document.body.removeChild(successDiv);
                    }, 2000);

                    // 刷新列表
                    setTimeout(() => {
                        loadAllSubmissions();
                    }, 500);

                } catch (error) {
                    console.error('删除失败:', error);
                    alert(`删除失败: ${error.message}`);
                }
            };

            // 初始加载
            loadAllSubmissions();
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const caseAiPanel = document.getElementById('case-ai-panel');
            const modalOverlay = document.getElementById('modal-overlay');
            const closeCaseAiPanel = document.getElementById('close-case-ai-panel');

            const modeButtons = caseAiPanel ? caseAiPanel.querySelectorAll('.ai-mode-btn') : [];
            modeButtons.forEach(btn => {
                btn.addEventListener('click', (event) => {
                    event.preventDefault();
                    const mode = btn.dataset.mode;
                    if (typeof window.switchAiMode === 'function') {
                        window.switchAiMode(mode);
                    }
                });
            });

            function closeAiPanel() {
                if (!caseAiPanel) return;
                caseAiPanel.classList.remove('active');
                const messageBoardModal = document.getElementById('message-board-modal');
                if (!messageBoardModal || !messageBoardModal.classList.contains('active')) {
                    modalOverlay?.classList.remove('active');
                }
            }

            closeCaseAiPanel?.addEventListener('click', () => {
                closeAiPanel();
            });

            if (modalOverlay) {
                modalOverlay.addEventListener('click', () => {
                    const messageBoardModal = document.getElementById('message-board-modal');
                    const boardOpen = messageBoardModal?.classList.contains('active');
                    const aiOpen = caseAiPanel?.classList.contains('active');

                    if (boardOpen) {
                        messageBoardModal.classList.remove('active');
                    }
                    if (aiOpen) {
                        caseAiPanel.classList.remove('active');
                    }
                    if (boardOpen || aiOpen) {
                        modalOverlay.classList.remove('active');
                    }
                });
            }
        });
    </script>



    </body>
</html>
