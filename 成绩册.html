<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿ</title>
    <script src="common-assets/js/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 0 5px; font-size: 13px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .control-bar { background: white; padding: 10px; border-bottom: 2px solid #34495e; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .table-container { max-height: calc(100vh - 200px); overflow: auto; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #34495e; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10; font-size: 13px; }
        td { padding: 8px; text-align: center; border-bottom: 1px solid #ddd; }
        tr:hover { background: #f8f9fa; }
        tr.yingdian-class1 { background: #fff; }
        tr.yingdian-class2 { background: #f0f8ff; }
        tr.yingdian-class1:hover { background: #e8f4f8; }
        tr.yingdian-class2:hover { background: #e0efff; }
        .class-indicator { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px; }
        .class1-badge { background: #e3f2fd; color: #1565c0; }
        .class2-badge { background: #fce4ec; color: #c2185b; }
        .editable { cursor: pointer; padding: 2px 5px; border-radius: 3px; }
        .editable:hover { background: #e3f2fd; }
        .stats { background: white; padding: 10px 20px; border-top: 2px solid #34495e; display: flex; gap: 30px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; min-width: 400px; max-width: 600px; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input[type="text"], .form-group input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .group-badge { padding: 2px 8px; border-radius: 3px; font-size: 12px; background: #e3f2fd; color: #1976d2; }
        .score-good { color: #27ae60; font-weight: bold; }
        .score-warn { color: #f39c12; font-weight: bold; }
        .score-bad { color: #e74c3c; font-weight: bold; }
        .score-negative { color: #9c27b0; font-weight: bold; }
        .select-range { background: #bbdefb !important; }
        .suffix-hit { box-shadow: inset 0 0 0 2px #ffb74d; background: #fff8e1 !important; }
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.85); color: white; padding: 15px 30px; border-radius: 8px; font-size: 14px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideDown 0.3s ease-out; max-width: 80%; text-align: center; }
        .toast.success { background: rgba(46, 125, 50, 0.95); }
        .toast.error { background: rgba(211, 47, 47, 0.95); }
        .toast.warning { background: rgba(245, 124, 0, 0.95); }
        .toast.info { background: rgba(2, 136, 209, 0.95); }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body>
    <div class="header">
        <div style="display:flex; align-items:center; gap:20px;">
            <span style="font-size: 18px; font-weight: bold;">å­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿ</span>
            <span>
                <select id="classSelector" onchange="selectClassFromDropdown()" style="padding: 8px 15px; font-size: 14px; border: 2px solid #fff; border-radius: 4px; background: #34495e; color: white; cursor: pointer;">
                    <option value="">-- è¯·é€‰æ‹©ç­çº§ --</option>
                    <option value="25æ— äººæœºä¸‰ç­">25æ— äººæœºä¸‰ç­ï¼ˆé™†å†›ï¼‰- 40äºº</option>
                    <option value="25æ¶²å‹ä¸‰ç­">25æ¶²å‹ä¸‰ç­ï¼ˆé™†å†›ï¼‰- 30äºº</option>
                    <option value="25æ— äººæœºå››ç­">25æ— äººæœºå››ç­ï¼ˆç©ºå†›ï¼‰- 40äºº</option>
                    <option value="25åº”ç”µ12ç­">25åº”ç”µ1-2ç­ - 86äºº</option>
                </select>
            </span>
            <button class="btn btn-primary" onclick="openCloudRestore(); return false;" style="margin-left: 30px; font-weight:bold; background: #8e44ad;">â˜ï¸ ä»äº‘ç«¯æ¢å¤</button>
        </div>
        <div>
            <button class="btn btn-success" onclick="pushToGitee(); return false;" style="font-weight:bold;">ğŸ’¾ ä¿å­˜åˆ°äº‘ç«¯</button>
            <button class="btn btn-warning" onclick="pushToGiteeAsBackup(); return false;" style="font-weight:bold; margin-left: 10px;">ğŸ“¦ ä¿å­˜ä¸ºå¤‡ä»½</button>
        </div>
    </div>
    <input type="file" id="fileInput" style="display:none;" accept=".xlsx,.xls" onchange="loadFile(event)">
    
    <div id="main">
        <div class="control-bar">
            <button class="btn btn-primary" onclick="showHistoryModal()">ğŸ“œ æŸ¥çœ‹å†å²è®°å½•</button>
            <button class="btn btn-success" onclick="showRandomPickModal()">ğŸ² éšæœºæŠ½å·</button>
            <select id="groupFilter" onchange="filterGroup()"><option value="">å…¨éƒ¨ç»„åˆ«</option></select>
            <button class="btn btn-primary" onclick="selectCurrentGroup()">é€‰ä¸­å½“å‰ç»„</button>
            <button class="btn btn-primary" onclick="invertSelection()">åé€‰</button>
            <button class="btn btn-danger" onclick="clearSelection()">æ¸…é™¤é€‰æ‹©</button>
            <select id="batchType">
                <option value="1">è¯¾å ‚è¡¨ç°</option>
                <option value="2">å°ç»„æ´»åŠ¨</option>
                <option value="3">ç¬”è®°æ£€æŸ¥</option>
            </select>
            <input type="number" id="batchScore" value="1" min="-20" max="20" style="width:80px;">
            <button class="btn btn-success" onclick="batchAdd()">æ‰¹é‡åŠ åˆ†</button>
            <button class="btn btn-warning" onclick="batchDeduct()">æ‰¹é‡æ‰£åˆ†</button>
            <input type="text" id="search" placeholder="æœç´¢å­¦å·æˆ–å§“å" onkeyup="doSearch()">
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleAll()"></th>
                        <th>åºå·</th><th>å­¦å·</th><th>å§“å</th><th>ç»„åˆ«</th>
                        <th>è¯¾å ‚è¡¨ç°(20)</th><th>å°ç»„æ´»åŠ¨(20)</th><th>ç¬”è®°æ£€æŸ¥(10)</th>
                        <th>å¹³æ—¶æ€»åˆ†(50)</th><th>è€ƒè¯•æˆç»©(50)</th><th>æ€»åˆ†(100)</th>
                        <th>æ“ä½œ <span id="opBackupBadge" style="display:none; margin-left:6px; padding:2px 6px; font-size:11px; border-radius:10px; background:#fff3cd; color:#856404; border:1px solid #ffe08a;">è¯·å¤‡ä»½</span></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        
        <div class="stats">
            <span>æ€»äººæ•°: <b id="total">0</b></span>
            <span>å·²é€‰æ‹©: <b id="selected">0</b></span>
            <span>å¹³å‡åˆ†: <b id="avg">0</b></span>
            <span>åŠæ ¼ç‡: <b id="pass">0%</b></span>
            <span style="margin-left:20px;color:#666;">å…±20æ¬¡è¯¾ï¼Œ16æ¬¡å°ç»„ä»»åŠ¡</span>
        </div>
    </div>
    
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <h3>ç¬”è®°æ£€æŸ¥ - <span id="noteName"></span></h3>
            <p style="color: #666; margin: 10px 0;">æ¯æ¬¡æ£€æŸ¥5åˆ†ï¼Œå…±2æ¬¡ï¼Œæ»¡åˆ†10åˆ†</p>
            <div class="form-group"><label><input type="checkbox" id="note1"> ç¬¬ä¸€æ¬¡æ£€æŸ¥ (5åˆ†)</label></div>
            <div class="form-group"><label><input type="checkbox" id="note2"> ç¬¬äºŒæ¬¡æ£€æŸ¥ (5åˆ†)</label></div>
            <button class="btn btn-success" onclick="saveNote()">ä¿å­˜</button>
            <button class="btn btn-danger" onclick="closeNote()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <h3>ğŸ“œ å†å²è®°å½•ä¸äº‘ç«¯ç‰ˆæœ¬</h3>
            <div style="display:flex; gap:10px; margin:15px 0;">
                <button id="historyTabLocal" class="btn btn-primary" style="flex:1;" onclick="setHistoryTab('local')">ğŸ—ƒï¸ æœ¬åœ°å†å²</button>
                <button id="historyTabCloud" class="btn btn-warning" style="flex:1;" onclick="setHistoryTab('cloud')">â˜ï¸ äº‘ç«¯ç‰ˆæœ¬</button>
            </div>
            <div id="historyLocalPanel">
                <div style="background: #f8f9fa; padding: 12px; margin-bottom: 12px; border-radius: 5px; text-align: center;">
                    <strong>æœ¬åœ°å†å²è®°å½•æ€»æ•°ï¼š</strong><span id="historyCount" style="font-size: 20px; color: #2196f3;">0</span>æ¡
                </div>
                <div style="max-height: 460px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%;">
                        <thead><tr style="background: #f5f5f5; position: sticky; top: 0;">
                            <th style="padding: 10px;">æ—¶é—´</th><th style="padding: 10px;">ç­çº§</th>
                            <th style="padding: 10px;">æ“ä½œç±»å‹</th><th style="padding: 10px;">å½±å“äººæ•°</th><th style="padding: 10px;">æ“ä½œ</th>
                        </tr></thead>
                        <tbody id="historyTableBody"><tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">æš‚æ— å†å²è®°å½•</td></tr></tbody>
                    </table>
                </div>
                <div style="margin-top: 18px; display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-danger" onclick="clearAllHistory()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å†å²</button>
                    <div>
                        <button class="btn btn-success" onclick="exportHistory()">ğŸ’¾ å¯¼å‡ºå†å²è®°å½•</button>
                        <button class="btn btn-danger" onclick="closeHistoryModal()">å…³é—­</button>
                    </div>
                </div>
            </div>
            <div id="historyCloudPanel" style="display:none;">
                <div style="background: #e8f5e9; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; align-items: center; gap: 15px;">
                    <span>ğŸ—‚ï¸ ä¿ç•™å¤‡ä»½æ•°é‡ï¼š</span>
                    <select id="maxBackupCount" onchange="saveBackupSettings()" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="5">æœ€è¿‘ 5 ä¸ª</option>
                        <option value="10" selected>æœ€è¿‘ 10 ä¸ª</option>
                        <option value="20">æœ€è¿‘ 20 ä¸ª</option>
                        <option value="50">æœ€è¿‘ 50 ä¸ª</option>
                        <option value="0">ä¸è‡ªåŠ¨åˆ é™¤</option>
                    </select>
                    <span style="color: #666; font-size: 12px;">ï¼ˆè¶…å‡ºæ•°é‡çš„æ—§å¤‡ä»½å°†åœ¨ä¿å­˜æ–°å¤‡ä»½æ—¶è‡ªåŠ¨åˆ é™¤ï¼‰</span>
                </div>
                <div id="cloudFileListStatus" style="background: #f0f4ff; padding: 12px; margin-bottom: 12px; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 13px;">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%; font-size: 13px;">
                        <thead><tr style="background: #f5f5f5; position: sticky; top: 0;">
                            <th style="padding: 8px;">æ–‡ä»¶ / æ—¶é—´</th><th style="padding: 8px; width: 110px;">å¤§å°</th>
                            <th style="padding: 8px; width: 170px;">æ—¶é—´æˆ³</th><th style="padding: 8px; width: 250px;">æ“ä½œ</th>
                        </tr></thead>
                        <tbody id="cloudFileTableBody"><tr><td colspan="4" style="text-align:center; padding: 25px; color: #999;">æ­£åœ¨åŠ è½½...</td></tr></tbody>
                    </table>
                </div>
                <div style="margin-top: 18px; display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-primary" onclick="refreshGiteeFileList(true)">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                    <button class="btn btn-danger" onclick="closeHistoryModal()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <div id="randomPickModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <h3>ğŸ² éšæœºæŠ½å·å™¨</h3>
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; margin: 20px 0; border-radius: 10px; color: white;">
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-size: 14px; display: block; margin-bottom: 8px;">å·ç èŒƒå›´ï¼š</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="randomRangeStart" min="1" value="1" onchange="updateRandomPickStats()" style="width: 80px; padding: 10px; font-size: 18px; border: none; border-radius: 5px; font-weight: bold;">
                            <span style="font-size: 20px; font-weight: bold;">ï½</span>
                            <input type="number" id="randomRangeEnd" min="1" value="40" onchange="updateRandomPickStats()" style="width: 80px; padding: 10px; font-size: 18px; border: none; border-radius: 5px; font-weight: bold;">
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label style="font-size: 14px; display: block; margin-bottom: 8px;">æŠ½å–æ•°é‡ï¼š</label>
                        <input type="number" id="randomPickCount" min="1" value="1" style="width: 100px; padding: 10px; font-size: 18px; border: none; border-radius: 5px; font-weight: bold;">
                    </div>
                </div>
                <button class="btn btn-success" onclick="doRandomPick()" style="width: 100%; margin-top: 20px; font-size: 20px; padding: 15px; background: #28a745; font-weight: bold;">ğŸ¯ å¼€å§‹æŠ½å·</button>
            </div>
            <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; text-align: center;">
                <strong>æ€»å·ç æ•°ï¼š</strong><span id="randomTotalCount">40</span> | 
                <strong>å·²æŠ½å–ï¼š</strong><span id="randomPickedCount" style="color: #dc3545;">0</span> | 
                <strong>å‰©ä½™ï¼š</strong><span id="randomRemainingCount" style="color: #28a745;">40</span>
            </div>
            <div id="randomPickResult" style="margin: 20px 0; display: none;">
                <h4 style="color: #2196f3; border-bottom: 2px solid #2196f3; padding-bottom: 10px; margin-bottom: 15px;">ğŸŠ æŠ½å–ç»“æœ</h4>
                <div id="randomPickResultList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: space-between;">
                <button class="btn btn-warning" onclick="resetRandomPick()">ğŸ”„ é‡ç½®</button>
                <button class="btn btn-danger" onclick="closeRandomPickModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <script>
    // â­ Gitee äº‘åŒæ­¥é…ç½®
    const GITEE_CONFIG = {
        owner: 'swywy_admin',
        repo: '123',
        token: 'fcef0a1c75d0e5b4cbbb91a398735e11',
        branch: 'master',
        filePath: 'grades-data.json'
    };

    // â­ å¤‡ä»½æ¸…ç†é…ç½®
    const BACKUP_CONFIG = {
        maxBackupCount: 10,  // é»˜è®¤ä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½
        backupFilePattern: /^grades-data-\d{8}-\d{6}\.json$/  // å¤‡ä»½æ–‡ä»¶ååŒ¹é…æ¨¡å¼
    };

    // å…¨å±€å˜é‡
    let students = [];
    let currentClass = '';
    let currentNoteIndex = -1;
    let currentFilter = '';
    let allClassesData = {};
    let suffixMatches = [];
    let historyRecords = [];
    let pickedNumbers = [];
    let currentNumberRange = { start: 1, end: 40 };
    let lastPulledCloudData = null;
    let lastPulledFileMeta = null;
    let giteeFileListCache = null;
    let giteeFileListLoading = false;
    let giteeConfig = loadGiteeConfigFromStorage();
    let syncInProgress = false;
    let lastSyncTime = null;
    let isSelecting = false;
    let startSelectIndex = -1;
    let endSelectIndex = -1;
    let lastClickedIndex = -1;

    // ç­çº§æ•°æ®
    const classesData = {
        '25æ— äººæœºä¸‰ç­': [
            ['25090300301', 'å®‰å¿ ç¿'], ['25090300302', 'æ›¹å…†é›„'], ['25090300303', 'é™ˆç‚³è‡»'],
            ['25090300304', 'æˆç¡•'], ['25090300305', 'æ¨Šç¨¼ä¹'], ['25090300306', 'ä½•å…†æ–‡'],
            ['25090300307', 'è´ºæ–‡éŸ¬'], ['25090300308', 'ä¾¯ç¬‘å®‡'], ['25090300309', 'ä¾¯å¥•è¾°'],
            ['25090300310', 'å§œé‰´ç½¡'], ['25090300311', 'å§œæ‰æ³½'], ['25090300312', 'æ™¯åšæ¥·'],
            ['25090300313', 'åº·å®¶è±ª'], ['25090300314', 'é›·é”é˜³'], ['25090300315', 'ææ–Œ'],
            ['25090300316', 'æå­”æˆŸ'], ['25090300317', 'æéª‘ä¸œ'], ['25090300318', 'æ—ç¦¹è¾°é˜³'],
            ['25090300319', 'åˆ˜æµ©å›­'], ['25090300320', 'åˆ˜ä½³ç¥ˆ'], ['25090300321', 'å•å»¶åš'],
            ['25090300322', 'é©¬å­æ°'], ['25090300323', 'æ½˜æ”¿æ—­'], ['25090300324', 'è’²å²©æ¾'],
            ['25090300325', 'ä»»å˜‰é‘«'], ['25090300326', 'è‹å…†å®‡'], ['25090300327', 'å”æ£®æ—'],
            ['25090300328', 'ç‹å¸…'], ['25090300329', 'ç‹æ™“ä¸œ'], ['25090300330', 'ç‹å“æ‚¦'],
            ['25090300331', 'é­æ¯…é˜³'], ['25090300332', 'å¾å­è½©'], ['25090300333', 'è¢æµ©'],
            ['25090300334', 'è¢å­è±ª'], ['25090300335', 'å¼ åšæ£®'], ['25090300336', 'å¼ ä¼Ÿç„¶'],
            ['25090300337', 'éƒ‘å¸…æ¶›'], ['25090300338', 'æœ±ç§¦ä¸œé˜³'], ['25090300339', 'æœ±æ€¡å‡¡'],
            ['25090300340', 'å·¦å¤©é›¨']
        ],
        '25æ¶²å‹ä¸‰ç­': [
            ['25090200301', 'é™ˆæ¶¦é¾™'], ['25090200302', 'é™ˆæ¥ '], ['25090200303', 'æ®µå®‡è½©'],
            ['25090200304', 'ä¾¯ä¸€è¯º'], ['25090200305', 'é»„ä½³å¼º'], ['25090200306', 'å†€å¿—è¿œ'],
            ['25090200307', 'é‡‘æ—­é˜³'], ['25090200308', 'é‡‘å­èˆª'], ['25090200309', 'ä¹æ€ç‚'],
            ['25090200310', 'æèŒ‚æº'], ['25090200311', 'æé“ å›'], ['25090200312', 'åˆ˜å´‡æ™º'],
            ['25090200313', 'å•ä¸€é“­'], ['25090200314', 'éª†ç ”å®‡'], ['25090200315', 'çŸ³é–æ¥ '],
            ['25090200316', 'å®‹æµ©ç„¶'], ['25090200317', 'å®‹ä¸–æ°'], ['25090200318', 'è°­æ€ç¿°'],
            ['25090200319', 'æ±¤è¯‘åš'], ['25090200320', 'ç‹å¾·ç¦'], ['25090200321', 'é­æºåŸ¹'],
            ['25090200322', 'å´è¿ª'], ['25090200323', 'å´æ¾ç¿'], ['25090200324', 'å¸­å­è¾°'],
            ['25090200325', 'æ›¾åœ£ä¿Š'], ['25090200326', 'å¼ å®¶è±ª'], ['25090200327', 'å¼ æ–‡è¯‘'],
            ['25090200328', 'å‘¨ç§¦å®‡'], ['25090200329', 'æœ±ä¼¯æ©'], ['25090200330', 'æœ±å°å®‡']
        ],
        '25æ— äººæœºå››ç­': [
            ['25090300401', 'ç™½çŸ³æƒ'], ['25090300402', 'è”¡å®‡è½©'], ['25090300403', 'é™ˆå®šåŸº'],
            ['25090300404', 'é™ˆç§‘æ—©'], ['25090300405', 'é™ˆç»æ­¦'], ['25090300406', 'é™ˆå¤©ä¸€'],
            ['25090300407', 'é™ˆå®‡æ¶µ'], ['25090300408', 'é™ˆé‘«'], ['25090300409', 'å´”å³»å†‰'],
            ['25090300410', 'ä¸æ–‡é¾™'], ['25090300411', 'æœå¶æ™¨'], ['25090300412', 'æ¨Šé•‡å®‡'],
            ['25090300413', 'èŒƒä¸€å“²'], ['25090300414', 'éƒç‰æ´'], ['25090300415', 'æ´ªå…¶è£'],
            ['25090300416', 'èƒ¡é”¦ç†™'], ['25090300417', 'é»„è€€æ°'], ['25090300418', 'å­”æƒª'],
            ['25090300419', 'æå½¦è‡»'], ['25090300420', 'æç¿åº·'], ['25090300421', 'æ¢å®¶è¾‰'],
            ['25090300422', 'åˆ˜æµ©å±•'], ['25090300423', 'åˆ˜æ™¯æ™–'], ['25090300424', 'ç½—æ¯…æ¶›'],
            ['25090300425', 'éª†å²³å®'], ['25090300426', 'ç‰Ÿå˜‰è±ª'], ['25090300427', 'å®ä¿Šç†™'],
            ['25090300428', 'é‚±ä¸–æ˜¾'], ['25090300429', 'æ–½æ–Œè±ª'], ['25090300430', 'å”æ–‡æ°'],
            ['25090300431', 'æ¨æµç®'], ['25090300432', 'æ¨æŸ é“–'], ['25090300433', 'å‘˜æ™¨é˜³'],
            ['25090300434', 'å¼ é”¦ç¨‹'], ['25090300435', 'å¼ æ™“å®'], ['25090300436', 'å¼ å±•é¹'],
            ['25090300437', 'å¼ å¿—æ°'], ['25090300438', 'å¼ é‘«é¹'], ['25090300439', 'å‘¨æ°'],
            ['25090300440', 'å‘¨é€š']
        ],
        '25åº”ç”µ12ç­': [
            ['25010030101', 'å®‰æ–‡å¨œ'], ['25010030102', 'é™ˆèƒœ'], ['25010030103', 'å•å¤©ç’'],
            ['25010030104', 'æ®µå¤©å®‡'], ['25010030105', 'èŒƒæ™¨å¸Œ'], ['25010030106', 'é«˜ç¡•æœ'],
            ['25010030107', 'éƒ­ä¸–é›„'], ['25010030108', 'é»„ä¿Šå®'], ['25010030109', 'é‡‘æ¬£é›¨'],
            ['25010030110', 'äº•é”èˆª'], ['25010030111', 'äº¢é‘«é’°'], ['25010030112', 'ææœé˜³'],
            ['25010030113', 'æç™»è¾‰'], ['25010030114', 'æèŠ¬ç«¹'], ['25010030115', 'æå¸Œè¨€'],
            ['25010030116', 'æå§¿æ€¡'], ['25010030117', 'åˆ˜æ€å½¤'], ['25010030118', 'åˆ˜æ¯…å¤'],
            ['25010030119', 'æ¯›é‘«å†°'], ['25010030120', 'å½­å½©ç²'], ['25010030121', 'é½å›­æ˜'],
            ['25010030122', 'ä»»æ€æº'], ['25010030123', 'å­™é¹¤å¿'], ['25010030124', 'å­™æ˜å“²'],
            ['25010030125', 'ç‹é”¦æ¥ '], ['25010030126', 'ç‹æ€æ°'], ['25010030127', 'é­æ™¨æ€¡'],
            ['25010030128', 'é­æ—­å²©'], ['25010030129', 'æ¸©ç‰è£'], ['25010030130', 'ä¹ŒÂ·ç‰¹å°¼æ ¼å°”'],
            ['25010030131', 'è–›æ·‡æ–‡'], ['25010030132', 'æ¨ç‘œæ³½'], ['25010030133', 'å§šé”¦è‰'],
            ['25010030134', 'æ˜“å°é›¨'], ['25010030135', 'è¢ç¨‹å†›'], ['25010030136', 'å¼ æ™¨'],
            ['25010030137', 'å¼ ç¾è±ª'], ['25010030138', 'å¼ å¿ƒæº'], ['25010030139', 'å¼ äºšå·'],
            ['25010030140', 'å¼ å®‡è½©'], ['25010030141', 'å¼ å­æ€¡'], ['25010030142', 'èµµä½³å®¾'],
            ['25010030143', 'èµµå­æ€¡'], ['25010030201', 'å®‰æ©¦æ©¦'], ['25010030202', 'é™ˆå¤'],
            ['25010030203', 'ç¨‹å¿—è¿œ'], ['25010030204', 'ä»£éŸ¶æ¶µ'], ['25010030205', 'æ‡‚é˜³å®'],
            ['25010030206', 'å†¯å­é’'], ['25010030207', 'ä»˜å­Ÿç’'], ['25010030208', 'é«˜å»¶æ°'],
            ['25010030209', 'éƒæ˜Ÿå®‡'], ['25010030210', 'è’‹ç§¦æ¹˜'], ['25010030211', 'é³æƒ çª'],
            ['25010030212', 'åº·è½¶'], ['25010030213', 'é›·æ™ºæµ©'], ['25010030214', 'é»å«æ˜•'],
            ['25010030215', 'ææ‰¿æ³½'], ['25010030216', 'æé”®'], ['25010030217', 'æçŸ¥è±'],
            ['25010030218', 'åˆ˜å‡Œé£'], ['25010030219', 'åˆ˜è'], ['25010030220', 'åˆ˜é¢–ç„¶'],
            ['25010030221', 'é©¬æ™¨ä¸œ'], ['25010030222', 'å­Ÿæˆå¤'], ['25010030223', 'ç§¦è¯šè¯š'],
            ['25010030224', 'å°šæ˜'], ['25010030225', 'é‚µæ¬£æ€¡'], ['25010030226', 'å­™å˜‰æµ©'],
            ['25010030227', 'å­™å®‡æ™¨'], ['25010030228', 'ç‹é¹ç£Š'], ['25010030229', 'ç‹å®‡ç¿”'],
            ['25010030230', 'é­æŒ¯é©°'], ['25010030231', 'è®¸ä½³ä¹'], ['25010030232', 'è–›åšæ–‡'],
            ['25010030233', 'æ¨å˜‰ç‘¶'], ['25010030234', 'æ¨é‘«å®‡'], ['25010030235', 'å°¹é›ªé½'],
            ['25010030236', 'å¼ éå‡¡'], ['25010030237', 'å¼ ç‘å˜‰'], ['25010030238', 'å¼ æ°´æ¶µ'],
            ['25010030239', 'å¼ æ¯…èˆª'], ['25010030240', 'å¼ è‚²èŒ'], ['25010030241', 'å¼ æ³½è±ª'],
            ['25010030242', 'èµµç„•å½¤'], ['25010030243', 'å·¦é˜³']
        ]
    };

    // å·¥å…·å‡½æ•°
    function escapeHtml(str = '') {
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function formatFileSize(bytes) {
        if (!Number.isFinite(bytes)) return '-';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function formatDateTime(value) {
        if (!value) return '-';
        try {
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) return typeof value === 'string' ? value : '-';
            return date.toLocaleString('zh-CN', { hour12: false });
        } catch (e) { return typeof value === 'string' ? value : '-'; }
    }

    function normalizeGroupName(groupName) {
        if (!groupName) return '';
        const chineseNumbers = {'ä¸€': '1', 'äºŒ': '2', 'ä¸‰': '3', 'å››': '4', 'äº”': '5', 
                               'å…­': '6', 'ä¸ƒ': '7', 'å…«': '8', 'ä¹': '9', 'å': '10',
                               'åä¸€': '11', 'åäºŒ': '12', 'åä¸‰': '13', 'åå››': '14', 'åäº”': '15'};
        let normalized = groupName;
        for (const [cn, num] of Object.entries(chineseNumbers)) {
            normalized = normalized.replace(cn, num);
        }
        return normalized;
    }

    function getSubClass(studentId) {
        if (studentId.startsWith('250100301')) return 'åº”ç”µ1ç­';
        if (studentId.startsWith('250100302')) return 'åº”ç”µ2ç­';
        return '';
    }

    function getGroupForStudent(className, index) {
        if (className === '25æ¶²å‹ä¸‰ç­') return 'ç¬¬' + (Math.floor(index / 2) + 1) + 'ç»„';
        if (className === '25æ— äººæœºä¸‰ç­' || className === '25æ— äººæœºå››ç­') {
            if (index < 36) return 'ç¬¬' + (Math.floor(index / 3) + 1) + 'ç»„';
            return 'ç¬¬13ç»„';
        }
        if (className === '25åº”ç”µ12ç­') {
            if (index < 42) return 'ç¬¬' + (Math.floor(index / 6) + 1) + 'ç»„';
            return 'ç¬¬' + (Math.floor((index - 42) / 6.3) + 8) + 'ç»„';
        }
        return 'æœªåˆ†ç»„';
    }

    function getGroupForYingDian(index) {
        if (index < 6) return 'ç¬¬1ç»„';
        if (index < 12) return 'ç¬¬2ç»„';
        if (index < 18) return 'ç¬¬3ç»„';
        if (index < 24) return 'ç¬¬4ç»„';
        if (index < 30) return 'ç¬¬5ç»„';
        if (index < 36) return 'ç¬¬6ç»„';
        if (index < 42) return 'ç¬¬7ç»„';
        if (index < 48) return 'ç¬¬8ç»„';
        if (index < 54) return 'ç¬¬9ç»„';
        if (index < 60) return 'ç¬¬10ç»„';
        if (index < 66) return 'ç¬¬11ç»„';
        if (index < 72) return 'ç¬¬12ç»„';
        if (index < 79) return 'ç¬¬13ç»„';
        return 'ç¬¬14ç»„';
    }

    function loadGiteeConfigFromStorage() {
        try {
            const saved = localStorage.getItem('giteeConfig_v1');
            if (saved) {
                const config = JSON.parse(saved);
                config.autoSync = false;
                return config;
            }
        } catch (e) { console.error('åŠ è½½Giteeé…ç½®å¤±è´¥:', e); }
        return {
            owner: GITEE_CONFIG.owner, repo: GITEE_CONFIG.repo, token: GITEE_CONFIG.token,
            branch: GITEE_CONFIG.branch, filePath: GITEE_CONFIG.filePath,
            autoSync: false, pollingInterval: 30000, lastSyncTime: null, sha: null
        };
    }

    function saveGiteeConfigToStorage() {
        try { localStorage.setItem('giteeConfig_v1', JSON.stringify(giteeConfig)); }
        catch (e) { console.error('ä¿å­˜Giteeé…ç½®å¤±è´¥:', e); }
    }

    // â­ å¤‡ä»½è®¾ç½®ä¿å­˜å’ŒåŠ è½½
    function loadBackupSettings() {
        try {
            const saved = localStorage.getItem('backupConfig_v1');
            if (saved) {
                const config = JSON.parse(saved);
                BACKUP_CONFIG.maxBackupCount = config.maxBackupCount || 10;
            }
        } catch (e) { console.error('åŠ è½½å¤‡ä»½é…ç½®å¤±è´¥:', e); }
        
        // æ›´æ–°UI
        const select = document.getElementById('maxBackupCount');
        if (select) {
            select.value = BACKUP_CONFIG.maxBackupCount;
        }
    }

    function saveBackupSettings() {
        const select = document.getElementById('maxBackupCount');
        if (select) {
            BACKUP_CONFIG.maxBackupCount = parseInt(select.value) || 10;
        }
        try {
            localStorage.setItem('backupConfig_v1', JSON.stringify({
                maxBackupCount: BACKUP_CONFIG.maxBackupCount
            }));
            showToast('âœ… å¤‡ä»½è®¾ç½®å·²ä¿å­˜', 'success', 2000);
        } catch (e) { console.error('ä¿å­˜å¤‡ä»½é…ç½®å¤±è´¥:', e); }
    }

    // Toasté€šçŸ¥
    function showToast(message, type = 'info', duration = 3000) {
        const syncMessages = ['æ­£åœ¨æ¨é€', 'æ­£åœ¨ä»Gitee', 'æ­£åœ¨æ‹‰å–', 'æ¨é€åˆ°Gitee', 'ä»Giteeæ‹‰å–', 'æ•°æ®å·²åŒæ­¥', 'è‡ªåŠ¨åŒæ­¥', 'Gitee'];
        if (syncMessages.some(msg => message.includes(msg))) {
            updateSyncStatus(message, type);
            return;
        }
        const existingToast = document.querySelector('.toast');
        if (existingToast) existingToast.remove();
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideDown 0.3s ease-out reverse';
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 300);
        }, duration);
    }

    function updateSyncStatus(message, type = 'info') {
        let statusBar = document.getElementById('syncStatusBar');
        if (!statusBar) {
            statusBar = document.createElement('div');
            statusBar.id = 'syncStatusBar';
            statusBar.style.cssText = 'position: fixed; bottom: 0; left: 0; right: 0; background: #f8f9fa; color: #6c757d; padding: 4px 10px; font-size: 11px; text-align: center; border-top: 1px solid #dee2e6; z-index: 999; opacity: 0.8;';
            document.body.appendChild(statusBar);
        }
        const colors = { 'info': '#6c757d', 'success': '#28a745', 'warning': '#ffc107', 'error': '#dc3545' };
        statusBar.style.color = colors[type] || colors.info;
        statusBar.textContent = message;
        setTimeout(() => {
            statusBar.style.opacity = '0';
            setTimeout(() => { if (statusBar.textContent === message) { statusBar.textContent = ''; statusBar.style.opacity = '0.8'; } }, 500);
        }, 3000);
    }

    function showBackupReminder() {
        updateSyncStatus('ğŸ’¡ å·²ä¿®æ”¹æ•°æ®ï¼Œè¯·åŠæ—¶ç‚¹å‡»"ğŸ“¦ ä¿å­˜ä¸ºå¤‡ä»½"', 'warning');
        showOperationBackupBadge();
    }

    function showOperationBackupBadge() {
        const el = document.getElementById('opBackupBadge');
        if (el) el.style.display = 'inline-block';
    }

    function hideOperationBackupBadge() {
        const el = document.getElementById('opBackupBadge');
        if (el) el.style.display = 'none';
    }

    // è®¡ç®—åˆ†æ•°
    function calc(i) {
        const s = students[i];
        s.è¯¾å ‚è¡¨ç° = parseFloat(s.è¯¾å ‚è¡¨ç°) || 0;
        s.å°ç»„æ´»åŠ¨ = parseFloat(s.å°ç»„æ´»åŠ¨) || 0;
        s.è€ƒè¯•æˆç»© = Math.min(50, Math.max(0, parseFloat(s.è€ƒè¯•æˆç»©) || 0));
        s.ç¬”è®°æ€»åˆ† = (s.ç¬”è®°1 ? 5 : 0) + (s.ç¬”è®°2 ? 5 : 0);
        s.å¹³æ—¶æ€»åˆ† = s.è¯¾å ‚è¡¨ç° + s.å°ç»„æ´»åŠ¨ + s.ç¬”è®°æ€»åˆ†;
        s.æ€»åˆ† = s.å¹³æ—¶æ€»åˆ† + s.è€ƒè¯•æˆç»©;
    }

    function calcStudent(s) {
        s.è¯¾å ‚è¡¨ç° = parseFloat(s.è¯¾å ‚è¡¨ç°) || 0;
        s.å°ç»„æ´»åŠ¨ = parseFloat(s.å°ç»„æ´»åŠ¨) || 0;
        s.è€ƒè¯•æˆç»© = Math.min(50, Math.max(0, parseFloat(s.è€ƒè¯•æˆç»©) || 0));
        s.ç¬”è®°æ€»åˆ† = (s.ç¬”è®°1 ? 5 : 0) + (s.ç¬”è®°2 ? 5 : 0);
        s.å¹³æ—¶æ€»åˆ† = s.è¯¾å ‚è¡¨ç° + s.å°ç»„æ´»åŠ¨ + s.ç¬”è®°æ€»åˆ†;
        s.æ€»åˆ† = s.å¹³æ—¶æ€»åˆ† + s.è€ƒè¯•æˆç»©;
        return s;
    }

    function selectClass(className) {
        if (!classesData[className] && !allClassesData[className]) {
            showToast('âŒ æœªçŸ¥ç­çº§ï¼š' + className, 'error');
            return;
        }
        if (currentClass && students.length > 0) {
            allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
            saveToLocalStorage();
        }
        currentClass = className;
        
        if (allClassesData[className] && allClassesData[className].length > 0) {
            students = JSON.parse(JSON.stringify(allClassesData[className]));
        } else if (classesData[className]) {
            const data = classesData[className];
            students = data.map((item, i) => {
                let group = className === '25åº”ç”µ12ç­' ? getGroupForYingDian(i) : getGroupForStudent(className, i);
                return {
                    å­¦å·: item[0], å§“å: item[1], ç»„åˆ«: group,
                    å­ç­çº§: className === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                    è¯¾å ‚è¡¨ç°: 0, å°ç»„æ´»åŠ¨: 0, ç¬”è®°1: false, ç¬”è®°2: false,
                    ç¬”è®°æ€»åˆ†: 0, è€ƒè¯•æˆç»©: 0, å¹³æ—¶æ€»åˆ†: 0, æ€»åˆ†: 0, selected: false
                };
            });
        } else {
            students = JSON.parse(JSON.stringify(allClassesData[className] || []));
        }
        
        students.forEach((s, i) => calc(i));
        currentFilter = '';
        
        const selector = document.getElementById('classSelector');
        if (selector) selector.value = className;
        
        showMain();
        updateGroups();
        render();
        updateClassStatus();
        localStorage.setItem('currentClass', className);
        
        if (students.length > 0) {
            showToast('âœ… å·²åŠ è½½ ' + className + 'ï¼Œå…± ' + students.length + ' åå­¦ç”Ÿ', 'success', 2000);
        }
    }

    function selectClassFromDropdown() {
        const selector = document.getElementById('classSelector');
        const className = selector.value;
        if (!className) { showToast('è¯·é€‰æ‹©ç­çº§', 'warning'); return; }
        selectClass(className);
    }

    function showMain() {
        const main = document.getElementById('main');
        if (main) main.style.display = 'block';
    }

    // æ¸²æŸ“è¡¨æ ¼
    function render() {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        
        let visibleStudents = students;
        if (currentFilter) {
            const normalizedFilter = normalizeGroupName(currentFilter);
            visibleStudents = students.filter(s => normalizeGroupName(s.ç»„åˆ«) === normalizedFilter);
        }
        
        visibleStudents.forEach((s, displayIndex) => {
            const i = students.indexOf(s);
            const tr = tbody.insertRow();
            
            let scoreClass = 'score-bad';
            if (s.æ€»åˆ† < 0) scoreClass = 'score-negative';
            else if (s.æ€»åˆ† >= 85) scoreClass = 'score-good';
            else if (s.æ€»åˆ† >= 60) scoreClass = 'score-warn';
            
            let rowClass = '';
            if (currentClass === '25åº”ç”µ12ç­') {
                if (s.å­ç­çº§ === 'åº”ç”µ1ç­') rowClass = 'yingdian-class1';
                else if (s.å­ç­çº§ === 'åº”ç”µ2ç­') rowClass = 'yingdian-class2';
            }
            
            tr.className = rowClass;
            if (s.selected) tr.classList.add('selected');
            if (suffixMatches.includes(i)) tr.classList.add('suffix-hit');
            
            let ketangClass = s.è¯¾å ‚è¡¨ç° < 0 ? 'score-negative' : (s.è¯¾å ‚è¡¨ç° >= 18 ? 'score-good' : (s.è¯¾å ‚è¡¨ç° >= 12 ? 'score-warn' : 'score-bad'));
            let xiaozuClass = s.å°ç»„æ´»åŠ¨ < 0 ? 'score-negative' : (s.å°ç»„æ´»åŠ¨ >= 18 ? 'score-good' : (s.å°ç»„æ´»åŠ¨ >= 12 ? 'score-warn' : 'score-bad'));
            let pingshiClass = s.å¹³æ—¶æ€»åˆ† < 0 ? 'score-negative' : (s.å¹³æ—¶æ€»åˆ† >= 45 ? 'score-good' : (s.å¹³æ—¶æ€»åˆ† >= 30 ? 'score-warn' : 'score-bad'));
            
            tr.innerHTML = '<td><input type="checkbox" ' + (s.selected ? 'checked' : '') + ' onchange="toggle(' + i + ')"></td>' +
                '<td>' + (displayIndex + 1) + '</td>' +
                '<td>' + s.å­¦å· + (s.å­ç­çº§ ? '<span class="class-indicator ' + (s.å­ç­çº§ === 'åº”ç”µ1ç­' ? 'class1-badge' : 'class2-badge') + '">' + s.å­ç­çº§.replace('åº”ç”µ', '') + '</span>' : '') + '</td>' +
                '<td>' + s.å§“å + '</td>' +
                '<td><span class="group-badge">' + s.ç»„åˆ« + '</span></td>' +
                '<td class="editable ' + ketangClass + '" contenteditable onblur="update(' + i + ',\'è¯¾å ‚è¡¨ç°\',this.textContent)">' + s.è¯¾å ‚è¡¨ç° + '</td>' +
                '<td class="editable ' + xiaozuClass + '" contenteditable onblur="update(' + i + ',\'å°ç»„æ´»åŠ¨\',this.textContent)">' + s.å°ç»„æ´»åŠ¨ + '</td>' +
                '<td>' + s.ç¬”è®°æ€»åˆ† + ' <button class="btn btn-primary" onclick="editNote(' + i + ')" style="padding:2px 8px;font-size:12px;">ç¼–è¾‘</button></td>' +
                '<td class="' + pingshiClass + '">' + s.å¹³æ—¶æ€»åˆ† + '</td>' +
                '<td class="editable" contenteditable onblur="update(' + i + ',\'è€ƒè¯•æˆç»©\',this.textContent)">' + s.è€ƒè¯•æˆç»© + '</td>' +
                '<td class="' + scoreClass + '">' + s.æ€»åˆ† + '</td>' +
                '<td><button class="btn btn-success" onclick="quickAdd(' + i + ')" style="padding:2px 6px;font-size:12px;">+1</button>' +
                '<button class="btn btn-danger" onclick="quickDeduct(' + i + ')" style="padding:2px 6px;font-size:12px;">-1</button></td>';
        });
        
        updateStats();
        updateSelectAll();
    }

    function updateGroups() {
        const groups = [...new Set(students.map(s => s.ç»„åˆ«))];
        const select = document.getElementById('groupFilter');
        select.innerHTML = '<option value="">å…¨éƒ¨ç»„åˆ«</option>';
        groups.sort((a, b) => {
            const numA = parseInt(a.replace(/[^0-9]/g, '')) || 0;
            const numB = parseInt(b.replace(/[^0-9]/g, '')) || 0;
            return numA - numB;
        });
        groups.forEach(g => {
            const count = students.filter(s => s.ç»„åˆ« === g).length;
            select.innerHTML += '<option value="' + g + '">' + g + ' (' + count + 'äºº)</option>';
        });
    }

    function updateStats() {
        let visibleStudents = students;
        if (currentFilter) {
            const normalizedFilter = normalizeGroupName(currentFilter);
            visibleStudents = students.filter(s => normalizeGroupName(s.ç»„åˆ«) === normalizedFilter);
        }
        const total = visibleStudents.length;
        const selected = visibleStudents.filter(s => s.selected).length;
        const avg = total > 0 ? (visibleStudents.reduce((sum, s) => sum + s.æ€»åˆ†, 0) / total).toFixed(1) : 0;
        const pass = visibleStudents.filter(s => s.æ€»åˆ† >= 60).length;
        const passRate = total > 0 ? (pass / total * 100).toFixed(1) : 0;
        document.getElementById('total').textContent = total;
        document.getElementById('selected').textContent = selected;
        document.getElementById('avg').textContent = avg;
        document.getElementById('pass').textContent = passRate + '%';
    }

    function updateClassStatus() {
        ['25æ— äººæœºä¸‰ç­', '25æ¶²å‹ä¸‰ç­', '25æ— äººæœºå››ç­', '25åº”ç”µ12ç­'].forEach(className => {
            const statusEl = document.getElementById('status-' + className);
            if (statusEl && allClassesData[className] && allClassesData[className].length > 0) {
                const hasScores = allClassesData[className].some(s => s.è¯¾å ‚è¡¨ç° !== 0 || s.å°ç»„æ´»åŠ¨ !== 0 || s.è€ƒè¯•æˆç»© !== 0);
                statusEl.textContent = hasScores ? 'æœ‰æ•°æ®' : 'å·²åŠ è½½';
                statusEl.className = 'class-status status-loaded';
            }
        });
    }

    function update(i, field, value) {
        const v = parseFloat(value) || 0;
        students[i][field] = field === 'è€ƒè¯•æˆç»©' ? Math.min(50, Math.max(0, v)) : v;
        calc(i);
        render();
        saveToLocalStorage();
        showBackupReminder();
    }

    function toggle(i) { students[i].selected = !students[i].selected; updateSelectAll(); updateStats(); }

    function toggleAll() {
        const checked = document.getElementById('selectAll').checked;
        if (currentFilter) {
            const normalizedFilter = normalizeGroupName(currentFilter);
            students.forEach(s => { if (normalizeGroupName(s.ç»„åˆ«) === normalizedFilter) s.selected = checked; });
        } else {
            students.forEach(s => s.selected = checked);
        }
        render();
    }

    function updateSelectAll() {
        let visibleStudents = students;
        if (currentFilter) {
            const normalizedFilter = normalizeGroupName(currentFilter);
            visibleStudents = students.filter(s => normalizeGroupName(s.ç»„åˆ«) === normalizedFilter);
        }
        document.getElementById('selectAll').checked = visibleStudents.length > 0 && visibleStudents.every(s => s.selected);
    }

    function clearSelection() {
        students.forEach(s => s.selected = false);
        document.getElementById('selectAll').checked = false;
        lastClickedIndex = -1;
        render();
    }

    function invertSelection() {
        if (currentFilter) {
            const normalizedFilter = normalizeGroupName(currentFilter);
            students.forEach(s => { if (normalizeGroupName(s.ç»„åˆ«) === normalizedFilter) s.selected = !s.selected; });
        } else {
            students.forEach(s => s.selected = !s.selected);
        }
        render();
    }

    function selectCurrentGroup() {
        if (currentFilter) {
            const normalizedFilter = normalizeGroupName(currentFilter);
            students.forEach(s => s.selected = (normalizeGroupName(s.ç»„åˆ«) === normalizedFilter));
        } else {
            students.forEach(s => s.selected = true);
        }
        render();
    }

    function quickAdd(i) {
        students[i].è¯¾å ‚è¡¨ç° += 1;
        calc(i);
        addHistory('å•ä¸ªå­¦ç”ŸåŠ åˆ†', 1, { 'å­¦ç”Ÿ': students[i].å§“å, 'å­¦å·': students[i].å­¦å·, 'é¡¹ç›®': 'è¯¾å ‚è¡¨ç°', 'åˆ†å€¼': '+1' });
        render();
        saveToLocalStorage();
        showBackupReminder();
    }

    function quickDeduct(i) {
        students[i].è¯¾å ‚è¡¨ç° -= 1;
        calc(i);
        addHistory('å•ä¸ªå­¦ç”Ÿæ‰£åˆ†', 1, { 'å­¦ç”Ÿ': students[i].å§“å, 'å­¦å·': students[i].å­¦å·, 'é¡¹ç›®': 'è¯¾å ‚è¡¨ç°', 'åˆ†å€¼': '-1' });
        render();
        saveToLocalStorage();
        showBackupReminder();
    }

    function batchAdd() {
        const type = document.getElementById('batchType').value;
        const score = Math.abs(parseFloat(document.getElementById('batchScore').value) || 1);
        const selected = students.filter(s => s.selected);
        if (selected.length === 0) { alert('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ'); return; }
        const typeNames = { '1': 'è¯¾å ‚è¡¨ç°', '2': 'å°ç»„æ´»åŠ¨', '3': 'ç¬”è®°æ£€æŸ¥' };
        selected.forEach(s => {
            const i = students.indexOf(s);
            if (type === '1') s.è¯¾å ‚è¡¨ç° += score;
            else if (type === '2') s.å°ç»„æ´»åŠ¨ += score;
            else if (type === '3') { if (!s.ç¬”è®°1) s.ç¬”è®°1 = true; else if (!s.ç¬”è®°2) s.ç¬”è®°2 = true; }
            calc(i);
        });
        addHistory('æ‰¹é‡åŠ åˆ†', selected.length, { 'ç±»å‹': typeNames[type], 'åˆ†å€¼': score });
        clearSelection();
        saveToLocalStorage();
        showToast('âœ… æˆåŠŸä¸º' + selected.length + 'åå­¦ç”ŸåŠ åˆ†', 'success');
        showBackupReminder();
    }

    function batchDeduct() {
        const type = document.getElementById('batchType').value;
        const score = Math.abs(parseFloat(document.getElementById('batchScore').value) || 1);
        const selected = students.filter(s => s.selected);
        if (selected.length === 0) { alert('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ'); return; }
        if (!confirm('ç¡®å®šè¦ä¸º' + selected.length + 'åå­¦ç”Ÿæ‰£' + score + 'åˆ†å—ï¼Ÿ')) return;
        const typeNames = { '1': 'è¯¾å ‚è¡¨ç°', '2': 'å°ç»„æ´»åŠ¨', '3': 'ç¬”è®°æ£€æŸ¥' };
        selected.forEach(s => {
            const i = students.indexOf(s);
            if (type === '1') s.è¯¾å ‚è¡¨ç° -= score;
            else if (type === '2') s.å°ç»„æ´»åŠ¨ -= score;
            else if (type === '3') { if (s.ç¬”è®°2) s.ç¬”è®°2 = false; else if (s.ç¬”è®°1) s.ç¬”è®°1 = false; }
            calc(i);
        });
        addHistory('æ‰¹é‡æ‰£åˆ†', selected.length, { 'ç±»å‹': typeNames[type], 'åˆ†å€¼': score });
        clearSelection();
        saveToLocalStorage();
        showToast('âœ… æˆåŠŸä¸º' + selected.length + 'åå­¦ç”Ÿæ‰£åˆ†', 'success');
        showBackupReminder();
    }

    function editNote(i) {
        currentNoteIndex = i;
        document.getElementById('noteName').textContent = students[i].å§“å;
        document.getElementById('note1').checked = students[i].ç¬”è®°1;
        document.getElementById('note2').checked = students[i].ç¬”è®°2;
        document.getElementById('noteModal').classList.add('show');
    }

    function saveNote() {
        students[currentNoteIndex].ç¬”è®°1 = document.getElementById('note1').checked;
        students[currentNoteIndex].ç¬”è®°2 = document.getElementById('note2').checked;
        calc(currentNoteIndex);
        closeNote();
        render();
        saveToLocalStorage();
        showBackupReminder();
    }

    function closeNote() { document.getElementById('noteModal').classList.remove('show'); }
    function filterGroup() { currentFilter = document.getElementById('groupFilter').value; clearSelection(); render(); }

    function doSearch() {
        const term = document.getElementById('search').value.toLowerCase();
        const tbody = document.getElementById('tbody');
        const rows = tbody.rows;
        let visibleStudents = students;
        if (currentFilter) {
            const normalizedFilter = normalizeGroupName(currentFilter);
            visibleStudents = students.filter(s => normalizeGroupName(s.ç»„åˆ«) === normalizedFilter);
        }
        for (let i = 0; i < rows.length; i++) {
            const s = visibleStudents[i];
            rows[i].style.display = (s.å­¦å·.includes(term) || s.å§“å.includes(term)) ? '' : 'none';
        }
    }

    // ==================== å†å²è®°å½•åŠŸèƒ½ ====================
    
    function addHistory(actionType, affectedStudents, details = {}) {
        if (!currentClass) return;
        if (students.length > 0) allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
        
        const record = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            className: currentClass,
            actionType: actionType,
            affectedCount: affectedStudents,
            details: details,
            snapshot: JSON.parse(JSON.stringify(allClassesData[currentClass] || [])),
            fullSnapshot: JSON.parse(JSON.stringify(allClassesData))
        };
        
        historyRecords.unshift(record);
        if (historyRecords.length > 100) historyRecords = historyRecords.slice(0, 100);
        saveHistoryToStorage();
    }

    function saveHistoryToStorage() {
        try { localStorage.setItem('gradeHistory_v1', JSON.stringify(historyRecords)); }
        catch (e) {
            if (e.name === 'QuotaExceededError') {
                historyRecords = historyRecords.slice(0, 50);
                try { localStorage.setItem('gradeHistory_v1', JSON.stringify(historyRecords)); } catch (e2) {}
            }
        }
    }

    function loadHistoryFromStorage() {
        try {
            const saved = localStorage.getItem('gradeHistory_v1');
            historyRecords = saved ? JSON.parse(saved) : [];
        } catch (e) { historyRecords = []; }
    }

    function showHistoryModal(tab = 'local') {
        renderHistoryTable();
        document.getElementById('historyModal').classList.add('show');
        setHistoryTab(tab);
    }

    function setHistoryTab(tab = 'local') {
        const showLocal = tab !== 'cloud';
        document.getElementById('historyLocalPanel').style.display = showLocal ? 'block' : 'none';
        document.getElementById('historyCloudPanel').style.display = showLocal ? 'none' : 'block';
        document.getElementById('historyTabLocal').style.opacity = showLocal ? '1' : '0.7';
        document.getElementById('historyTabCloud').style.opacity = showLocal ? '0.7' : '1';
        if (!showLocal) {
            loadBackupSettings();  // åŠ è½½å¤‡ä»½è®¾ç½®
            refreshGiteeFileList(true);
        }
    }

    function renderHistoryTable() {
        document.getElementById('historyCount').textContent = historyRecords.length;
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        
        if (historyRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">æš‚æ— å†å²è®°å½•</td></tr>';
        } else {
            historyRecords.forEach(record => {
                const row = tbody.insertRow();
                const date = new Date(record.timestamp);
                const timeStr = date.toLocaleString('zh-CN');
                const hasFullSnapshot = record.fullSnapshot ? '(å®Œæ•´)' : '(å•ç­çº§)';
                
                row.innerHTML = '<td style="padding: 10px;">' + timeStr + '</td>' +
                    '<td style="padding: 10px; font-weight: bold; color: #2196f3;">' + record.className + ' <small style="color:#999;">' + hasFullSnapshot + '</small></td>' +
                    '<td style="padding: 10px;">' + record.actionType + '</td>' +
                    '<td style="padding: 10px;">' + record.affectedCount + 'äºº</td>' +
                    '<td style="padding: 10px;"><button class="btn btn-primary" onclick="viewHistorySnapshot(' + record.id + ')" style="padding: 4px 8px; font-size: 12px;">æŸ¥çœ‹</button>' +
                    '<button class="btn btn-success" onclick="restoreHistorySnapshot(' + record.id + ')" style="padding: 4px 8px; font-size: 12px;">æ¢å¤</button>' +
                    '<button class="btn btn-danger" onclick="deleteHistoryRecord(' + record.id + ')" style="padding: 4px 8px; font-size: 12px;">åˆ é™¤</button></td>';
            });
        }
    }

    function viewHistorySnapshot(recordId) {
        const record = historyRecords.find(r => r.id === recordId);
        if (!record) { alert('æœªæ‰¾åˆ°è¯¥å†å²è®°å½•'); return; }
        const date = new Date(record.timestamp).toLocaleString('zh-CN');
        let message = 'å†å²å¿«ç…§è¯¦æƒ…\n\næ—¶é—´ï¼š' + date + '\nç­çº§ï¼š' + record.className + '\næ“ä½œï¼š' + record.actionType + '\nå½±å“å­¦ç”Ÿï¼š' + record.affectedCount + 'äºº\n';
        if (record.details) {
            message += '\nè¯¦ç»†ä¿¡æ¯ï¼š\n';
            for (let key in record.details) message += '  ' + key + ': ' + record.details[key] + '\n';
        }
        message += '\nå½“å‰ç­çº§å­¦ç”Ÿæ•°ï¼š' + record.snapshot.length + 'äºº';
        if (record.fullSnapshot) message += '\n\nå®Œæ•´å¿«ç…§åŒ…å«ç­çº§ï¼š' + Object.keys(record.fullSnapshot).join('ã€');
        alert(message);
    }

    function restoreHistorySnapshot(recordId) {
        const record = historyRecords.find(r => r.id === recordId);
        if (!record) { alert('æœªæ‰¾åˆ°è¯¥å†å²è®°å½•'); return; }
        
        const date = new Date(record.timestamp).toLocaleString('zh-CN');
        const hasFullSnapshot = !!record.fullSnapshot;
        let confirmMsg = 'ç¡®å®šè¦æ¢å¤åˆ°ä»¥ä¸‹æ—¶é—´ç‚¹çš„æ•°æ®å—ï¼Ÿ\n\næ—¶é—´ï¼š' + date + '\nç­çº§ï¼š' + record.className + '\n\n';
        if (hasFullSnapshot) {
            confirmMsg += 'æ­¤å¿«ç…§åŒ…å«æ‰€æœ‰ç­çº§çš„æ•°æ®ï¼Œæ¢å¤åå°†è¦†ç›–æ‰€æœ‰ç­çº§çš„å½“å‰æ•°æ®ï¼\n\nåŒ…å«ç­çº§ï¼š' + Object.keys(record.fullSnapshot).join('ã€');
        } else {
            confirmMsg += 'æ­¤å¿«ç…§ä»…åŒ…å« ' + record.className + ' çš„æ•°æ®ã€‚';
        }
        
        if (!confirm(confirmMsg)) return;
        
        if (hasFullSnapshot) {
            allClassesData = JSON.parse(JSON.stringify(record.fullSnapshot));
        } else {
            allClassesData[record.className] = JSON.parse(JSON.stringify(record.snapshot));
        }
        
        if (currentClass && allClassesData[currentClass]) {
            students = JSON.parse(JSON.stringify(allClassesData[currentClass]));
            render();
        } else if (currentClass && !allClassesData[currentClass]) {
            const firstClass = Object.keys(allClassesData)[0];
            if (firstClass) selectClass(firstClass);
            else { students = []; currentClass = ''; render(); }
        }
        
        saveToLocalStorage();
        refreshClassSelectorOptions();
        updateClassStatus();
        closeHistoryModal();
        showToast('âœ… æ•°æ®å·²æ¢å¤åˆ°å†å²å¿«ç…§', 'success');
    }

    function deleteHistoryRecord(recordId) {
        const record = historyRecords.find(r => r.id === recordId);
        if (!record) { alert('æœªæ‰¾åˆ°è¯¥å†å²è®°å½•'); return; }
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) return;
        const index = historyRecords.findIndex(r => r.id === recordId);
        if (index > -1) { historyRecords.splice(index, 1); saveHistoryToStorage(); renderHistoryTable(); showToast('å†å²è®°å½•å·²åˆ é™¤', 'success'); }
    }

    function clearAllHistory() {
        if (historyRecords.length === 0) { alert('å½“å‰æ²¡æœ‰å†å²è®°å½•'); return; }
        if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿå…±æœ‰ ' + historyRecords.length + ' æ¡è®°å½•')) return;
        historyRecords = [];
        saveHistoryToStorage();
        renderHistoryTable();
        showToast('æ‰€æœ‰å†å²è®°å½•å·²æ¸…é™¤', 'success');
    }

    function exportHistory() {
        try {
            const dataStr = JSON.stringify({ version: '1.0', exportTime: new Date().toISOString(), records: historyRecords }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'æˆç»©å†å²è®°å½•_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
            showToast('å†å²è®°å½•å¯¼å‡ºæˆåŠŸ', 'success');
        } catch (error) { alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message); }
    }

    function closeHistoryModal() { document.getElementById('historyModal').classList.remove('show'); }
    function openCloudRestore() { showHistoryModal('cloud'); }

    function refreshClassSelectorOptions(preserveValue = true) {
        const selector = document.getElementById('classSelector');
        if (!selector) return;
        const baseOrder = Object.keys(classesData);
        const remoteNames = allClassesData ? Object.keys(allClassesData) : [];
        const extras = remoteNames.filter(name => !baseOrder.includes(name)).sort();
        const ordered = baseOrder.concat(extras);
        const previousValue = preserveValue ? selector.value : '';
        let optionsHtml = '<option value="">-- è¯·é€‰æ‹©ç­çº§ --</option>';
        ordered.forEach(name => {
            const count = Array.isArray(allClassesData?.[name]) ? allClassesData[name].length : (Array.isArray(classesData?.[name]) ? classesData[name].length : 0);
            optionsHtml += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + (count ? ' - ' + count + 'äºº' : '') + '</option>';
        });
        selector.innerHTML = optionsHtml;
        if (previousValue && ordered.includes(previousValue)) selector.value = previousValue;
    }

    // éšæœºæŠ½å·
    function showRandomPickModal() {
        currentNumberRange = { start: parseInt(document.getElementById('randomRangeStart').value) || 1, end: parseInt(document.getElementById('randomRangeEnd').value) || 40 };
        updateRandomPickStats();
        document.getElementById('randomPickModal').classList.add('show');
    }
    function closeRandomPickModal() { document.getElementById('randomPickModal').classList.remove('show'); }
    function updateRandomPickStats() {
        const start = parseInt(document.getElementById('randomRangeStart').value) || 1;
        const end = parseInt(document.getElementById('randomRangeEnd').value) || 40;
        document.getElementById('randomTotalCount').textContent = end - start + 1;
        document.getElementById('randomPickedCount').textContent = pickedNumbers.length;
        document.getElementById('randomRemainingCount').textContent = end - start + 1 - pickedNumbers.length;
    }
    function doRandomPick() {
        const start = parseInt(document.getElementById('randomRangeStart').value);
        const end = parseInt(document.getElementById('randomRangeEnd').value);
        const count = parseInt(document.getElementById('randomPickCount').value);
        if (start > end) { alert('èµ·å§‹å·ç ä¸èƒ½å¤§äºç»“æŸå·ç '); return; }
        if (currentNumberRange.start !== start || currentNumberRange.end !== end) {
            if (pickedNumbers.length > 0 && !confirm('å·ç èŒƒå›´å·²æ”¹å˜ï¼Œæ˜¯å¦é‡ç½®ï¼Ÿ')) return;
            pickedNumbers = [];
            currentNumberRange = { start, end };
        }
        const available = [];
        for (let i = start; i <= end; i++) if (!pickedNumbers.includes(i)) available.push(i);
        if (available.length === 0) { alert('æ‰€æœ‰å·ç éƒ½å·²æŠ½å–å®Œæ¯•ï¼'); return; }
        if (count > available.length) { alert('å‰©ä½™å·ç ä¸è¶³ï¼'); return; }
        const picked = [];
        const tempAvailable = [...available];
        for (let i = 0; i < count; i++) {
            const idx = Math.floor(Math.random() * tempAvailable.length);
            picked.push(tempAvailable[idx]);
            tempAvailable.splice(idx, 1);
        }
        picked.sort((a, b) => a - b);
        pickedNumbers.push(...picked);
        pickedNumbers.sort((a, b) => a - b);
        displayRandomPickResult(picked);
        updateRandomPickStats();
    }
    function displayRandomPickResult(numbers) {
        document.getElementById('randomPickResult').style.display = 'block';
        const resultList = document.getElementById('randomPickResultList');
        resultList.innerHTML = '';
        numbers.forEach(num => {
            const badge = document.createElement('div');
            badge.style.cssText = 'display: inline-flex; align-items: center; justify-content: center; min-width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 24px; font-weight: bold; border-radius: 10px;';
            badge.textContent = num;
            resultList.appendChild(badge);
        });
    }
    function resetRandomPick() {
        if (pickedNumbers.length === 0) { alert('å½“å‰æ²¡æœ‰å·²æŠ½å–çš„å·ç '); return; }
        if (!confirm('ç¡®å®šè¦é‡ç½®å—ï¼Ÿ')) return;
        pickedNumbers = [];
        document.getElementById('randomPickResult').style.display = 'none';
        updateRandomPickStats();
        showToast('å·²é‡ç½®', 'success');
    }

    // ==================== Gitee äº‘åŒæ­¥åŠŸèƒ½ ====================
    
    function buildGiteeApiUrl(pathSegments = []) {
        const base = 'https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/contents';
        const cleaned = (pathSegments || []).filter(Boolean).map(seg => encodeURIComponent(seg));
        const path = cleaned.join('/');
        const suffix = path ? '/' + path : '';
        const branch = (giteeConfig.branch || 'master').trim() || 'master';
        return base + suffix + '?access_token=' + giteeConfig.token + '&ref=' + branch;
    }

    function parseTimestampFromName(name = '') {
        const match = name.match(/(20\d{2})(\d{2})(\d{2})[_-]?(\d{2})(\d{2})(\d{2})/);
        if (!match) return null;
        const [, y, m, d, hh, mm, ss] = match;
        const date = new Date(y + '-' + m + '-' + d + 'T' + hh + ':' + mm + ':' + ss);
        return Number.isNaN(date.getTime()) ? null : date;
    }

    // â­ åˆ¤æ–­æ˜¯å¦ä¸ºå¤‡ä»½æ–‡ä»¶ï¼ˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶ï¼‰
    function isBackupFile(fileName) {
        // åŒ¹é…æ ¼å¼: grades-data-YYYYMMDD-HHMMSS.json
        return /^grades-data-\d{8}-\d{6}\.json$/.test(fileName);
    }

    // â­ åˆ é™¤äº‘ç«¯æ–‡ä»¶
    async function deleteGiteeFile(filePath, sha) {
        const branch = giteeConfig.branch || GITEE_CONFIG.branch || 'master';
        const url = 'https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/contents/' + filePath;
        
        const response = await fetch(url, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                access_token: giteeConfig.token,
                sha: sha,
                message: 'è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½: ' + filePath,
                branch: branch
            })
        });
        
        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.message || 'HTTP ' + response.status);
        }
        
        return true;
    }

    // â­ è·å–æ–‡ä»¶çš„ SHAï¼ˆç”¨äºåˆ é™¤ï¼‰
    async function getFileSha(filePath) {
        const branch = giteeConfig.branch || GITEE_CONFIG.branch || 'master';
        const url = 'https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/contents/' + filePath + '?access_token=' + giteeConfig.token + '&ref=' + branch;
        
        const response = await fetch(url, { method: 'GET' });
        if (!response.ok) return null;
        
        const data = await response.json();
        return data.sha || null;
    }

    // â­ æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶ï¼ˆä¿ç•™æœ€è¿‘Nä¸ªï¼‰
    async function cleanupOldBackups() {
        const maxCount = BACKUP_CONFIG.maxBackupCount;
        
        // å¦‚æœè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºä¸è‡ªåŠ¨åˆ é™¤
        if (maxCount <= 0) {
            console.log('å¤‡ä»½æ¸…ç†å·²ç¦ç”¨');
            return { deleted: 0, kept: 0 };
        }
        
        try {
            // è·å–æ–‡ä»¶åˆ—è¡¨
            const branchName = encodeURIComponent(giteeConfig.branch || 'master');
            const branchUrl = 'https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/branches/' + branchName + '?access_token=' + giteeConfig.token;
            const branchResp = await fetch(branchUrl);
            if (!branchResp.ok) throw new Error('è·å–åˆ†æ”¯ä¿¡æ¯å¤±è´¥');
            const branchData = await branchResp.json();
            const sha = branchData.commit && branchData.commit.sha;
            if (!sha) throw new Error('åˆ†æ”¯ä¿¡æ¯ç¼ºå°‘ commit.sha');
            
            const treeUrl = 'https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/git/trees/' + sha + '?recursive=1&access_token=' + giteeConfig.token;
            const treeResp = await fetch(treeUrl);
            if (!treeResp.ok) throw new Error('è·å–æ–‡ä»¶æ ‘å¤±è´¥');
            const treeData = await treeResp.json();
            
            // ç­›é€‰å¤‡ä»½æ–‡ä»¶å¹¶æŒ‰æ—¶é—´æ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
            const backupFiles = treeData.tree
                .filter(node => node.type === 'blob' && isBackupFile(node.path.split('/').pop()))
                .map(node => ({
                    path: node.path,
                    name: node.path.split('/').pop(),
                    timestamp: parseTimestampFromName(node.path.split('/').pop())
                }))
                .filter(f => f.timestamp !== null)
                .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());  // æŒ‰æ—¶é—´é™åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
            
            console.log('æ‰¾åˆ° ' + backupFiles.length + ' ä¸ªå¤‡ä»½æ–‡ä»¶ï¼Œä¿ç•™æœ€è¿‘ ' + maxCount + ' ä¸ª');
            
            // ç¡®å®šè¦åˆ é™¤çš„æ–‡ä»¶ï¼ˆè¶…å‡ºä¿ç•™æ•°é‡çš„æ—§æ–‡ä»¶ï¼‰
            const filesToDelete = backupFiles.slice(maxCount);  // è·³è¿‡å‰ maxCount ä¸ªï¼ˆæœ€æ–°çš„ï¼‰ï¼Œåˆ é™¤å‰©ä½™çš„
            
            if (filesToDelete.length === 0) {
                console.log('æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ—§å¤‡ä»½');
                return { deleted: 0, kept: backupFiles.length };
            }
            
            console.log('å°†åˆ é™¤ ' + filesToDelete.length + ' ä¸ªæ—§å¤‡ä»½:');
            filesToDelete.forEach(f => console.log('  - ' + f.name + ' (' + f.timestamp.toLocaleString('zh-CN') + ')'));
            
            // é€ä¸ªåˆ é™¤æ—§æ–‡ä»¶
            let deletedCount = 0;
            for (const file of filesToDelete) {
                try {
                    const fileSha = await getFileSha(file.path);
                    if (fileSha) {
                        await deleteGiteeFile(file.path, fileSha);
                        deletedCount++;
                        console.log('å·²åˆ é™¤: ' + file.name);
                    }
                } catch (e) {
                    console.error('åˆ é™¤å¤±è´¥: ' + file.name, e);
                }
            }
            
            return { deleted: deletedCount, kept: maxCount };
            
        } catch (error) {
            console.error('æ¸…ç†æ—§å¤‡ä»½å¤±è´¥:', error);
            return { deleted: 0, kept: 0, error: error.message };
        }
    }

    // é€šç”¨çš„ Gitee æ¨é€å‡½æ•°
    async function pushToGiteeInternal(targetPath, message) {
        const branch = giteeConfig.branch || GITEE_CONFIG.branch || 'master';
        if (currentClass && students.length > 0) allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
        
        const jsonData = { version: '1.0', timestamp: new Date().toISOString(), lastModified: new Date().toLocaleString('zh-CN'), classes: allClassesData };
        const content = JSON.stringify(jsonData, null, 2);
        const base64Content = btoa(unescape(encodeURIComponent(content)));
        
        let sha = null;
        try {
            const getResponse = await fetch('https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/contents/' + targetPath + '?access_token=' + giteeConfig.token + '&ref=' + branch, { method: 'GET' });
            if (getResponse.ok) {
                const fileData = await getResponse.json();
                if (fileData && fileData.sha) sha = fileData.sha;
            }
        } catch (e) {}
        
        const url = 'https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/contents/' + targetPath;
        const body = { access_token: giteeConfig.token, content: base64Content, message: message, branch: branch };
        if (sha) body.sha = sha;
        
        const response = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        
        if (!response.ok) {
            let errorMsg = 'æ¨é€å¤±è´¥';
            try { const error = await response.json(); errorMsg = error.message || error.error || JSON.stringify(error); } catch (e) { errorMsg = 'HTTP ' + response.status; }
            throw new Error(errorMsg);
        }
        return await response.json();
    }

    async function pushToGitee() {
        if (syncInProgress) { showToast('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè¯·ç¨å€™...', 'warning'); return; }
        try {
            syncInProgress = true;
            showToast('æ­£åœ¨æ¨é€åˆ°Gitee...', 'info', 2000);
            const targetPath = giteeConfig.filePath || GITEE_CONFIG.filePath || 'grades-data.json';
            const result = await pushToGiteeInternal(targetPath, 'æ›´æ–°æˆç»©æ•°æ® - ' + new Date().toLocaleString('zh-CN'));
            if (result.content && result.content.sha) giteeConfig.sha = result.content.sha;
            giteeConfig.lastSyncTime = new Date().toISOString();
            saveGiteeConfigToStorage();
            hideOperationBackupBadge();
            const totalStudents = Object.values(allClassesData).reduce((sum, arr) => sum + arr.length, 0);
            showToast('âœ… å·²ä¿å­˜ ' + totalStudents + ' æ¡è®°å½•åˆ°äº‘ç«¯', 'success');
            giteeFileListCache = null;
            addHistory('ä¿å­˜åˆ°äº‘ç«¯', totalStudents, { 'æ—¶é—´': new Date().toLocaleString('zh-CN') });
        } catch (error) {
            showToast('âŒ æ¨é€å¤±è´¥: ' + error.message, 'error', 8000);
        } finally {
            syncInProgress = false;
        }
    }

    // â­ ä¿å­˜ä¸ºå¤‡ä»½ï¼ˆå¸¦è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ï¼‰
    async function pushToGiteeAsBackup() {
        if (syncInProgress) { showToast('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè¯·ç¨å€™...', 'warning'); return; }
        if (!giteeConfig.owner || !giteeConfig.repo || !giteeConfig.token) { showToast('âŒ Giteeé…ç½®ä¸å®Œæ•´', 'error'); return; }
        
        const now = new Date();
        const timestamp = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '-' + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0') + String(now.getSeconds()).padStart(2, '0');
        const originalPath = giteeConfig.filePath || GITEE_CONFIG.filePath || 'grades-data.json';
        const pathParts = originalPath.split('/');
        const fileName = pathParts.pop() || 'grades-data.json';
        const baseName = fileName.replace(/\.json$/, '');
        const directory = pathParts.length > 0 ? pathParts.join('/') + '/' : '';
        const backupPath = directory + baseName + '-' + timestamp + '.json';
        
        try {
            syncInProgress = true;
            showToast('æ­£åœ¨ä¿å­˜å¤‡ä»½...', 'info', 3000);
            
            // 1. å…ˆä¿å­˜æ–°å¤‡ä»½
            await pushToGiteeInternal(backupPath, 'ä¿å­˜å¤‡ä»½ - ' + now.toLocaleString('zh-CN'));
            
            hideOperationBackupBadge();
            const totalStudents = Object.values(allClassesData).reduce((sum, arr) => sum + arr.length, 0);
            showToast('âœ… å¤‡ä»½å·²ä¿å­˜: ' + baseName + '-' + timestamp + '.json', 'success', 4000);
            
            // 2. ç„¶åæ¸…ç†æ—§å¤‡ä»½
            if (BACKUP_CONFIG.maxBackupCount > 0) {
                showToast('ğŸ§¹ æ­£åœ¨æ¸…ç†æ—§å¤‡ä»½...', 'info', 2000);
                const cleanupResult = await cleanupOldBackups();
                if (cleanupResult.deleted > 0) {
                    showToast('ğŸ—‘ï¸ å·²æ¸…ç† ' + cleanupResult.deleted + ' ä¸ªæ—§å¤‡ä»½ï¼Œä¿ç•™æœ€è¿‘ ' + cleanupResult.kept + ' ä¸ª', 'success', 4000);
                }
            }
            
            giteeFileListCache = null;
            addHistory('ä¿å­˜å¤‡ä»½åˆ°äº‘ç«¯', totalStudents, { 'æ—¶é—´': now.toLocaleString('zh-CN'), 'å¤‡ä»½æ–‡ä»¶': baseName + '-' + timestamp + '.json' });
            
        } catch (error) {
            showToast('âŒ å¤‡ä»½å¤±è´¥: ' + error.message, 'error', 8000);
        } finally {
            syncInProgress = false;
        }
    }

    // ä»Giteeæ‹‰å–æ•°æ®
    async function pullFromGitee(options = {}) {
        const { silent = false, path = null, setDefault = false, apply = true } = options;
        const targetPath = (path || giteeConfig.filePath || '').trim();
        if (!targetPath || !giteeConfig.token || !giteeConfig.owner || !giteeConfig.repo) {
            if (!silent) showToast('âŒ Giteeé…ç½®ä¸å®Œæ•´', 'error');
            return false;
        }
        if (syncInProgress) { if (!silent) showToast('æ­£åœ¨åŒæ­¥ä¸­...', 'warning'); return false; }
        
        let success = false;
        try {
            syncInProgress = true;
            if (!silent) showToast('æ­£åœ¨ä» ' + targetPath + ' æ‹‰å–æ•°æ®...', 'info', 2500);
            
            const segments = targetPath.split('/').filter(Boolean);
            const url = buildGiteeApiUrl(segments);
            const response = await fetch(url, { method: 'GET' });
            
            if (!response.ok) {
                if (response.status === 404) { if (!silent) showToast('âš  äº‘ç«¯æœªæ‰¾åˆ°æ–‡ä»¶', 'warning'); return false; }
                throw new Error('æ‹‰å–å¤±è´¥ï¼ˆHTTP ' + response.status + 'ï¼‰');
            }
            
            const fileData = await response.json();
            if (!fileData || !fileData.content) throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
            
            const base64Content = (fileData.content || '').replace(/\s/g, '');
            const content = decodeURIComponent(escape(atob(base64Content)));
            const jsonData = JSON.parse(content);
            
            lastPulledCloudData = jsonData;
            lastPulledFileMeta = { path: targetPath, size: fileData.size, sha: fileData.sha, fetchedAt: new Date().toISOString(), applied: apply };
            
            if (apply && jsonData.classes) {
                allClassesData = jsonData.classes;
                refreshClassSelectorOptions();
                
                if (currentClass && allClassesData[currentClass]) {
                    students = JSON.parse(JSON.stringify(allClassesData[currentClass]));
                    render();
                } else if (currentClass && !allClassesData[currentClass]) {
                    const availableClasses = Object.keys(allClassesData);
                    if (availableClasses.length > 0) {
                        currentClass = availableClasses[0];
                        students = JSON.parse(JSON.stringify(allClassesData[currentClass]));
                        const selector = document.getElementById('classSelector');
                        if (selector) selector.value = currentClass;
                        render();
                        showToast('âš  åŸç­çº§ä¸å­˜åœ¨ï¼Œå·²åˆ‡æ¢åˆ° ' + currentClass, 'warning', 3000);
                    } else {
                        students = [];
                        currentClass = '';
                        render();
                    }
                } else if (!currentClass && Object.keys(allClassesData).length > 0) {
                    selectClass(Object.keys(allClassesData)[0]);
                }
                
                updateClassStatus();
                saveToLocalStorage({ skipDirty: true, skipAutoSync: true });
                giteeConfig.lastSyncTime = new Date().toISOString();
                saveGiteeConfigToStorage();
                
                const totalStudents = Object.values(allClassesData).reduce((sum, arr) => sum + arr.length, 0);
                if (!silent) showToast('âœ… å·²ä» ' + targetPath + ' æ¢å¤ ' + totalStudents + ' æ¡è®°å½•', 'success');
                success = true;
            } else {
                if (!silent) showToast('ğŸ‘€ å·²é¢„è§ˆ ' + targetPath, 'info');
                success = true;
            }
            
            giteeFileListCache = null;
            if (apply && setDefault) { giteeConfig.filePath = targetPath; giteeConfig.sha = fileData.sha; saveGiteeConfigToStorage(); }
            
        } catch (error) {
            if (!silent) showToast('âŒ æ‹‰å–å¤±è´¥: ' + error.message, 'error');
            success = false;
        } finally {
            syncInProgress = false;
        }
        return success;
    }

    async function refreshGiteeFileList(force = false) {
        if (force) giteeFileListCache = null;
        const statusEl = document.getElementById('cloudFileListStatus');
        const tbody = document.getElementById('cloudFileTableBody');
        if (statusEl) statusEl.textContent = 'æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...';
        if (tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 25px; color: #999;">æ­£åœ¨åŠ è½½...</td></tr>';
        
        if (!giteeConfig.owner || !giteeConfig.repo || !giteeConfig.token) {
            if (statusEl) statusEl.textContent = 'é…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•è·å–æ–‡ä»¶åˆ—è¡¨';
            return;
        }
        
        try {
            const branchName = encodeURIComponent(giteeConfig.branch || 'master');
            const branchUrl = 'https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/branches/' + branchName + '?access_token=' + giteeConfig.token;
            const branchResp = await fetch(branchUrl);
            if (!branchResp.ok) throw new Error('è·å–åˆ†æ”¯ä¿¡æ¯å¤±è´¥');
            const branchData = await branchResp.json();
            const sha = branchData.commit && branchData.commit.sha;
            if (!sha) throw new Error('åˆ†æ”¯ä¿¡æ¯ç¼ºå°‘ commit.sha');
            
            const treeUrl = 'https://gitee.com/api/v5/repos/' + giteeConfig.owner + '/' + giteeConfig.repo + '/git/trees/' + sha + '?recursive=1&access_token=' + giteeConfig.token;
            const treeResp = await fetch(treeUrl);
            if (!treeResp.ok) throw new Error('è·å–æ–‡ä»¶æ ‘å¤±è´¥');
            const treeData = await treeResp.json();
            
            const list = treeData.tree
                .filter(node => node.type === 'blob' && node.path && node.path.toLowerCase().endsWith('.json'))
                .map(node => ({ name: node.path.split('/').pop(), path: node.path, size: node.size }))
                .sort((a, b) => {
                    const dateA = parseTimestampFromName(a.name);
                    const dateB = parseTimestampFromName(b.name);
                    return (dateB ? dateB.getTime() : 0) - (dateA ? dateA.getTime() : 0);
                });
            
            giteeFileListCache = list;
            
            // ç»Ÿè®¡å¤‡ä»½æ–‡ä»¶æ•°é‡
            const backupCount = list.filter(f => isBackupFile(f.name)).length;
            const statusText = 'å…±æ‰¾åˆ° <strong>' + list.length + '</strong> ä¸ªæ–‡ä»¶';
            const backupInfo = backupCount > 0 ? 'ï¼ˆå…¶ä¸­ <strong style="color:#f39c12;">' + backupCount + '</strong> ä¸ªå¤‡ä»½ï¼‰' : '';
            if (statusEl) statusEl.innerHTML = statusText + backupInfo;
            
            renderGiteeFileList(list);
        } catch (error) {
            if (statusEl) statusEl.innerHTML = '<span style="color:#c0392b;">è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š' + escapeHtml(error.message) + '</span>';
        }
    }

    function renderGiteeFileList(list = []) {
        const tbody = document.getElementById('cloudFileTableBody');
        if (!tbody) return;
        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 25px; color: #999;">æš‚æ— æ–‡ä»¶</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        list.forEach((item, index) => {
            const tr = document.createElement('tr');
            const isDefault = item.path === giteeConfig.filePath;
            const isBackup = isBackupFile(item.name);
            
            if (isDefault) tr.style.background = '#fff7e6';
            else if (isBackup) tr.style.background = '#f0fff0';
            
            const parsedTime = parseTimestampFromName(item.name);
            
            // æ ‡è®°å¤‡ä»½æ–‡ä»¶åºå·
            let nameDisplay = escapeHtml(item.name);
            if (isBackup) {
                const backupFiles = list.filter(f => isBackupFile(f.name));
                const backupIndex = backupFiles.findIndex(f => f.path === item.path) + 1;
                nameDisplay = '<span style="color:#27ae60;">ğŸ“¦</span> ' + nameDisplay;
                if (backupIndex <= BACKUP_CONFIG.maxBackupCount || BACKUP_CONFIG.maxBackupCount === 0) {
                    nameDisplay += ' <span style="color:#27ae60; font-size:11px;">(#' + backupIndex + ')</span>';
                } else {
                    nameDisplay += ' <span style="color:#e74c3c; font-size:11px;">(å°†è¢«æ¸…ç†)</span>';
                }
            }
            
            tr.innerHTML = '<td style="padding: 8px;">' + nameDisplay + 
                (isDefault ? '<div style="color:#d35400; font-size:12px;">â­ å½“å‰é»˜è®¤</div>' : '') + '</td>' +
                '<td style="padding: 8px;">' + formatFileSize(item.size) + '</td>' +
                '<td style="padding: 8px;">' + formatDateTime(parsedTime) + '</td>' +
                '<td style="padding: 8px;">' +
                '<button class="btn btn-primary" onclick="pullFromGitee({path:\'' + item.path + '\',apply:false,silent:true})" style="padding: 4px 8px; font-size:12px;">é¢„è§ˆ</button>' +
                '<button class="btn btn-success" onclick="pullFromGitee({path:\'' + item.path + '\',apply:true})" style="padding: 4px 8px; font-size:12px;">åŠ è½½</button>' +
                '<button class="btn btn-warning" onclick="pullFromGitee({path:\'' + item.path + '\',apply:true,setDefault:true})" style="padding: 4px 8px; font-size:12px;">è®¾ä¸ºé»˜è®¤</button>' +
                (isBackup ? '<button class="btn btn-danger" onclick="deleteCloudFile(\'' + item.path + '\')" style="padding: 4px 8px; font-size:12px;">åˆ é™¤</button>' : '') +
                '</td>';
            tbody.appendChild(tr);
        });
    }

    // â­ æ‰‹åŠ¨åˆ é™¤äº‘ç«¯å¤‡ä»½æ–‡ä»¶
    async function deleteCloudFile(filePath) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤äº‘ç«¯æ–‡ä»¶å—ï¼Ÿ\n\n' + filePath + '\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        
        try {
            showToast('æ­£åœ¨åˆ é™¤...', 'info', 2000);
            const sha = await getFileSha(filePath);
            if (!sha) {
                showToast('âŒ æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯', 'error');
                return;
            }
            await deleteGiteeFile(filePath, sha);
            showToast('âœ… æ–‡ä»¶å·²åˆ é™¤: ' + filePath.split('/').pop(), 'success');
            giteeFileListCache = null;
            refreshGiteeFileList(true);
        } catch (error) {
            showToast('âŒ åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    // ==================== æœ¬åœ°å­˜å‚¨ ====================
    
    function saveToLocalStorage(options = {}) {
        try {
            if (currentClass && students.length > 0) allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
            localStorage.setItem('allClassesData_v3', JSON.stringify(allClassesData));
            localStorage.setItem('currentClass_v3', currentClass);
        } catch (e) { console.error('ä¿å­˜å¤±è´¥:', e); }
    }

    function loadFromLocalStorage() {
        try {
            const saved = localStorage.getItem('allClassesData_v3');
            const savedClass = localStorage.getItem('currentClass_v3');
            if (saved) {
                allClassesData = JSON.parse(saved);
                Object.keys(allClassesData).forEach(className => {
                    if (classesData[className]) {
                        const expectedCount = classesData[className].length;
                        const actualCount = allClassesData[className].length;
                        if (actualCount !== expectedCount) {
                            delete allClassesData[className];
                        } else {
                            allClassesData[className].forEach((s, i) => {
                                if (s.å¹³æ—¶è¡¨ç° !== undefined && s.è¯¾å ‚è¡¨ç° === undefined) {
                                    s.è¯¾å ‚è¡¨ç° = s.å¹³æ—¶è¡¨ç°;
                                    delete s.å¹³æ—¶è¡¨ç°;
                                }
                                if (className === '25åº”ç”µ12ç­' && !s.å­ç­çº§) s.å­ç­çº§ = getSubClass(classesData[className][i][0]);
                                if (s.ç»„åˆ«) s.ç»„åˆ« = normalizeGroupName(s.ç»„åˆ«);
                            });
                        }
                    }
                });
                updateClassStatus();
            }
            if (savedClass && allClassesData[savedClass]) selectClass(savedClass);
        } catch (e) { console.error('åŠ è½½å¤±è´¥:', e); }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹...');
        loadFromLocalStorage();
        loadHistoryFromStorage();
        loadBackupSettings();  // åŠ è½½å¤‡ä»½è®¾ç½®
        updateClassStatus();
        setInterval(() => saveToLocalStorage({ skipDirty: true, skipAutoSync: true }), 5000);
        showToast('â˜ï¸ è¯·ç‚¹å‡»"â˜ï¸ ä»äº‘ç«¯æ¢å¤"è·å–äº‘ç«¯æ•°æ®ï¼Œæˆ–å…ˆé€‰æ‹©ç­çº§åå¼€å§‹å½•å…¥', 'info', 6000);
        updateSyncStatus('å°šæœªåŠ è½½äº‘ç«¯æ•°æ®ï¼Œè¯·ç‚¹å‡»"â˜ï¸ ä»äº‘ç«¯æ¢å¤"æŒ‰é’®', 'warning');
        if (!currentClass) setTimeout(() => showToast('ğŸ‘† è¯·ä»é¡¶éƒ¨ä¸‹æ‹‰æ¡†é€‰æ‹©ç­çº§å¼€å§‹', 'info', 5000), 2000);
        window.addEventListener('pagehide', function(e) { saveToLocalStorage({ skipDirty: true, skipAutoSync: true }); });
        console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    });

    // å…¨å±€é¼ æ ‡äº‹ä»¶
    document.addEventListener('mouseup', function() { if (isSelecting) { isSelecting = false; } });
    </script>
</body>
</html>