<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿ</title>
    <script src="common-assets/js/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 13px;
        }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        
        .control-bar {
            background: #ecf0f1;
            padding: 15px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
                .suffix-tools {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #fff;
            border: 1px solid #dcdfe6;
            border-radius: 6px;
        }

        .suffix-tools label {
            font-size: 13px;
            color: #555;
        }

        .suffix-tools input[type="text"],
        .suffix-tools input[type="number"],
        .suffix-tools select {
            padding: 6px 8px;
            border: 1px solid #cfd4da;
            border-radius: 4px;
            font-size: 13px;
            min-width: 90px;
        }

        .suffix-hit {
            box-shadow: inset 0 0 0 2px #ffb74d;
            background: #fff8e1 !important;
        }

        .table-container {
            max-height: calc(100vh - 200px);
            overflow: auto;
            background: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
        }
        
        td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover { background: #f8f9fa; }
        
        /* åº”ç”µ1ç­å’Œåº”ç”µ2ç­çš„é¢œè‰²åŒºåˆ† */
        tr.yingdian-class1 {
            background: #fff;
        }
        
        tr.yingdian-class2 {
            background: #f0f8ff;
        }
        
        tr.yingdian-class1:hover {
            background: #e8f4f8;
        }
        
        tr.yingdian-class2:hover {
            background: #e0efff;
        }
        
        .class-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .class1-badge {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .class2-badge {
            background: #fce4ec;
            color: #c2185b;
        }
        
        .editable {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .editable:hover { background: #e3f2fd; }
        
        .welcome {
            padding: 100px 20px;
            text-align: center;
        }
        
        .class-grid {
            display: grid;
            grid-template-columns: repeat(2, 300px);
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .class-btn {
            padding: 30px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .class-btn:hover {
            background: #3498db;
            color: white;
        }
        
        .stats {
            background: white;
            padding: 10px 20px;
            border-top: 2px solid #34495e;
            display: flex;
            gap: 30px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            min-width: 400px;
            max-width: 600px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .group-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .score-good { color: #27ae60; font-weight: bold; }
        .score-warn { color: #f39c12; font-weight: bold; }
        .score-bad { color: #e74c3c; font-weight: bold; }
        .score-negative { color: #9c27b0; font-weight: bold; }
        
        .score-info {
            background: #fff3cd;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border-left: 4px solid #f39c12;
        }
        
        .select-range {
            background: #bbdefb !important;
        }
        
        .class-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 10px;
        }
        
        .status-loaded { background: #d4edda; color: #155724; }
        .status-empty { background: #f8d7da; color: #721c24; }
        
        .sub-class-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* (å·²ç§»é™¤ WPS ç›¸å…³æ ·å¼) */
        
        .control-bar {
            background: white;
            padding: 10px;
            border-bottom: 2px solid #34495e;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-indicator.synced { background: #28a745; }
        .sync-indicator.syncing { background: #ffc107; animation: pulse 1s infinite; }
        .sync-indicator.error { background: #dc3545; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Toasté€šçŸ¥æ ·å¼ */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
            max-width: 80%;
            text-align: center;
        }
        
        .toast.success {
            background: rgba(46, 125, 50, 0.95);
        }
        
        .toast.error {
            background: rgba(211, 47, 47, 0.95);
        }
        
        .toast.warning {
            background: rgba(245, 124, 0, 0.95);
        }
        
        .toast.info {
            background: rgba(2, 136, 209, 0.95);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display:flex; align-items:center; gap:20px;">
            <span style="font-size: 18px; font-weight: bold;">å­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿ</span>
            <span>
                <select id="classSelector" onchange="selectClassFromDropdown()" style="padding: 8px 15px; font-size: 14px; border: 2px solid #fff; border-radius: 4px; background: #34495e; color: white; cursor: pointer;">
                    <option value="">-- è¯·é€‰æ‹©ç­çº§ --</option>
                    <option value="25æ— äººæœºä¸‰ç­">25æ— äººæœºä¸‰ç­ï¼ˆé™†å†›ï¼‰- 40äºº</option>
                    <option value="25æ¶²å‹ä¸‰ç­">25æ¶²å‹ä¸‰ç­ï¼ˆé™†å†›ï¼‰- 30äºº</option>
                    <option value="25æ— äººæœºå››ç­">25æ— äººæœºå››ç­ï¼ˆç©ºå†›ï¼‰- 40äºº</option>
                    <option value="25åº”ç”µ12ç­">25åº”ç”µ1-2ç­ - 86äºº</option>
                </select>
            </span>
            <button class="btn btn-primary" onclick="openCloudRestore(); return false;" style="margin-left: 30px; font-weight:bold; background: #8e44ad; border-color: #8e44ad; color: #fff;">â˜ï¸ ä»äº‘ç«¯æ¢å¤</button>
        </div>
        <div>
            <button class="btn btn-success" onclick="pushToGitee(); return false;" style="font-weight:bold;">ğŸ’¾ ä¿å­˜åˆ°äº‘ç«¯</button>
            <button class="btn btn-warning" onclick="pushToGiteeAsBackup(); return false;" style="font-weight:bold; margin-left: 10px;">ğŸ“¦ ä¿å­˜ä¸ºå¤‡ä»½</button>
        </div>
    </div>
    <input type="file" id="fileInput" style="display:none;" accept=".xlsx,.xls" onchange="loadFile(event)">
    
    
    <div id="main">
        <div class="control-bar">
            <button class="btn btn-primary" onclick="showHistoryModal()">ğŸ“œ æŸ¥çœ‹å†å²è®°å½•</button>
            <button class="btn btn-success" onclick="showRandomPickModal()">ğŸ² éšæœºæŠ½å·</button>
            
            
            <select id="groupFilter" onchange="filterGroup()">
                <option value="">å…¨éƒ¨ç»„åˆ«</option>
            </select>
            <button class="btn btn-primary" onclick="selectCurrentGroup()">é€‰ä¸­å½“å‰ç»„</button>
            <button class="btn btn-primary" onclick="invertSelection()">åé€‰</button>
            <button class="btn btn-danger" onclick="clearSelection()">æ¸…é™¤é€‰æ‹©</button>
            
            <select id="batchType">
                <option value="1">è¯¾å ‚è¡¨ç°</option>
                <option value="2">å°ç»„æ´»åŠ¨</option>
                <option value="3">ç¬”è®°æ£€æŸ¥</option>
            </select>
            <input type="number" id="batchScore" value="1" min="-20" max="20" style="width:80px;">
            <button class="btn btn-success" onclick="batchAdd()">æ‰¹é‡åŠ åˆ†</button>
            <button class="btn btn-warning" onclick="batchDeduct()">æ‰¹é‡æ‰£åˆ†</button>
            
            <input type="text" id="search" placeholder="æœç´¢å­¦å·æˆ–å§“å" onkeyup="doSearch()">
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleAll()"></th>
                        <th>åºå·</th>
                        <th>å­¦å·</th>
                        <th>å§“å</th>
                        <th>ç»„åˆ«</th>
                        <th>è¯¾å ‚è¡¨ç°(20)</th>
                        <th>å°ç»„æ´»åŠ¨(20)</th>
                        <th>ç¬”è®°æ£€æŸ¥(10)</th>
                        <th>å¹³æ—¶æ€»åˆ†(50)</th>
                        <th>è€ƒè¯•æˆç»©(50)</th>
                        <th>æ€»åˆ†(100)</th>
                        <th>æ“ä½œ <span id="opBackupBadge" style="display:none; margin-left:6px; padding:2px 6px; font-size:11px; border-radius:10px; background:#fff3cd; color:#856404; border:1px solid #ffe08a; vertical-align:middle;">è¯·å¤‡ä»½</span></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        
        <div class="stats">
            <span>æ€»äººæ•°: <b id="total">0</b></span>
            <span>å·²é€‰æ‹©: <b id="selected">0</b></span>
            <span>å¹³å‡åˆ†: <b id="avg">0</b></span>
            <span>åŠæ ¼ç‡: <b id="pass">0%</b></span>
            <span style="margin-left:20px;color:#666;">å…±20æ¬¡è¯¾ï¼Œ16æ¬¡å°ç»„ä»»åŠ¡</span>
        </div>
    </div>
    
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <h3>ç¬”è®°æ£€æŸ¥ - <span id="noteName"></span></h3>
            <p style="color: #666; margin: 10px 0;">æ¯æ¬¡æ£€æŸ¥5åˆ†ï¼Œå…±2æ¬¡ï¼Œæ»¡åˆ†10åˆ†</p>
            <div class="form-group">
                <label><input type="checkbox" id="note1"> ç¬¬ä¸€æ¬¡æ£€æŸ¥ (5åˆ†)</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="note2"> ç¬¬äºŒæ¬¡æ£€æŸ¥ (5åˆ†)</label>
            </div>
            <button class="btn btn-success" onclick="saveNote()">ä¿å­˜</button>
            <button class="btn btn-danger" onclick="closeNote()">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h3>é€‰æ‹©å¯¼å‡ºé€‰é¡¹</h3>
            <p style="margin: 20px 0;">è¯·é€‰æ‹©è¦å¯¼å‡ºçš„æ•°æ®èŒƒå›´ï¼š</p>
            <button id="exportCurrentBtn" class="btn btn-primary" onclick="exportCurrentClass()" style="width: 100%; margin: 10px 0; padding: 15px;">
                å¯¼å‡ºå½“å‰ç­çº§
            </button>
            <button class="btn btn-success" onclick="exportAllClasses()" style="width: 100%; margin: 10px 0; padding: 15px;">
                å¯¼å‡ºæ‰€æœ‰ç­çº§ (4ä¸ªç­çº§)
            </button>
            <button class="btn btn-danger" onclick="closeExportModal()" style="width: 100%; margin: 10px 0;">
                å–æ¶ˆ
            </button>
            <div style="margin-top: 20px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                <strong>æ•°æ®çŠ¶æ€ï¼š</strong><br>
                <span id="exportDebugInfo">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
    </div>
    
    <!-- ç²˜è´´å¯¼å…¥æ¨¡æ€çª—å£ -->
    <div id="pasteImportModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“‹ ä»WPSç²˜è´´å¯¼å…¥</h3>
            <div style="background: #e8f5e9; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #4caf50;">
                <strong><i class="fa-solid fa-book"></i> ä¸‰æ­¥å¯¼å…¥ï¼š</strong><br>
                <i class="fa-solid fa-circle-1"></i> æ‰“å¼€ <a href="https://www.kdocs.cn/l/cvodF5Uw2mxZ" target="_blank">WPSè¡¨æ ¼</a>ï¼Œåœ¨"ç­çº§æ±‡æ€»"ä¸­ <kbd>Ctrl+A</kbd> å…¨é€‰ â†’ <kbd>Ctrl+C</kbd> å¤åˆ¶<br>
                <i class="fa-solid fa-circle-2"></i> åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡† <kbd>Ctrl+V</kbd> ç²˜è´´<br>
                <i class="fa-solid fa-circle-3"></i> ç‚¹å‡»"å¯¼å…¥æ•°æ®"ï¼Œå®Œæˆï¼âœ¨
            </div>
            <textarea id="pasteTextarea" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´ä»WPSå¤åˆ¶çš„æ•°æ®...&#10;&#10;æ ¼å¼ç¤ºä¾‹ï¼š&#10;ç­çº§	å­¦å·	å§“å	ç»„åˆ«	è¯¾å ‚è¡¨ç°	å°ç»„æ´»åŠ¨	ç¬”è®°1	ç¬”è®°2	ç¬”è®°æ€»åˆ†	å¹³æ—¶æ€»åˆ†	è€ƒè¯•æˆç»©	æ€»åˆ†&#10;25æ— äººæœºä¸‰ç­	25090300301	å®‰å¿ ç¿	ç¬¬1ç»„	0	19			0	19	0	19&#10;..." 
                style="width: 100%; height: 300px; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; border: 2px solid #ddd; border-radius: 4px; resize: vertical;"
            ></textarea>
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="processPasteImport()" style="padding: 12px 30px; font-size: 16px;">
                    âœ… å¯¼å…¥æ•°æ®
                </button>
                <button class="btn btn-warning" onclick="clearPasteTextarea()" style="padding: 12px 30px; margin-left: 10px;">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
                <button class="btn btn-danger" onclick="closePasteImport()" style="padding: 12px 30px; margin-left: 10px;">
                    âŒ å–æ¶ˆ
                </button>
            </div>
            <div id="pasteImportResult" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                <strong>å¯¼å…¥ç»“æœï¼š</strong><br>
                <span id="pasteImportResultText"></span>
            </div>
        </div>
    </div>
    
    
    
    <!-- å†å²è®°å½• / äº‘ç«¯ç‰ˆæœ¬ æ¨¡æ€çª—å£ -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <h3>ğŸ“œ å†å²è®°å½•ä¸äº‘ç«¯ç‰ˆæœ¬</h3>

            <div style="display:flex; gap:10px; margin:15px 0;">
                <button id="historyTabLocal" class="btn btn-primary" style="flex:1;" onclick="setHistoryTab('local')">ğŸ—ƒï¸ æœ¬åœ°å†å²</button>
                <button id="historyTabCloud" class="btn btn-warning" style="flex:1;" onclick="setHistoryTab('cloud')">â˜ï¸ äº‘ç«¯ç‰ˆæœ¬</button>
            </div>

            <div id="historyLocalPanel">
                <div style="background: #f8f9fa; padding: 12px; margin-bottom: 12px; border-radius: 5px; text-align: center; font-size: 14px;">
                    <strong>æœ¬åœ°å†å²è®°å½•æ€»æ•°ï¼š</strong><span id="historyCount" style="font-size: 20px; color: #2196f3; margin: 0 5px;">0</span>æ¡
                </div>
                <div style="max-height: 460px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%;">
                        <thead>
                            <tr style="background: #f5f5f5; position: sticky; top: 0;">
                                <th style="padding: 10px;">æ—¶é—´</th>
                                <th style="padding: 10px;">ç­çº§</th>
                                <th style="padding: 10px;">æ“ä½œç±»å‹</th>
                                <th style="padding: 10px;">å½±å“äººæ•°</th>
                                <th style="padding: 10px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                                    æš‚æ— å†å²è®°å½•
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 18px; display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-danger" onclick="clearAllHistory()" style="background: #dc3545;">
                        ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å†å²
                    </button>
                    <div>
                        <button class="btn btn-success" onclick="exportHistory()">
                            ğŸ’¾ å¯¼å‡ºå†å²è®°å½•
                        </button>
                        <button class="btn btn-danger" onclick="closeHistoryModal()">
                            å…³é—­
                        </button>
                    </div>
                </div>
            </div>

            <div id="historyCloudPanel" style="display:none;">
                <div id="cloudFileListStatus" style="background: #f0f4ff; padding: 12px; margin-bottom: 12px; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 13px; color: #1b4f72;">
                    æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...
                </div>
                <div style="max-height: 460px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%; font-size: 13px;">
                        <thead>
                            <tr style="background: #f5f5f5; position: sticky; top: 0;">
                                <th style="padding: 8px;">æ–‡ä»¶ / æ—¶é—´</th>
                                <th style="padding: 8px; width: 110px;">å¤§å°</th>
                                <th style="padding: 8px; width: 170px;">æ—¶é—´æˆ³</th>
                                <th style="padding: 8px; width: 220px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="cloudFileTableBody">
                            <tr>
                                <td colspan="4" style="text-align:center; padding: 25px; color: #999;">æ­£åœ¨åŠ è½½...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 18px; display: flex; gap: 10px; justify-content: space-between;">
                    <div>
                        <button class="btn btn-primary" onclick="refreshGiteeFileList(true)">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                        <button class="btn btn-primary" onclick="showCloudDataModal()" style="background:#607d8b; border-color:#607d8b;">ğŸ‘€ é¢„è§ˆæœ€è¿‘åŠ è½½</button>
                    </div>
                    <button class="btn btn-danger" onclick="closeHistoryModal()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éšæœºæŠ½å·æ¨¡æ€çª—å£ -->
    <div id="randomPickModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <h3>ğŸ² éšæœºæŠ½å·å™¨</h3>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; margin: 20px 0; border-radius: 10px; color: white;">
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-size: 14px; display: block; margin-bottom: 8px;">å·ç èŒƒå›´ï¼š</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="randomRangeStart" min="1" value="1" 
                                   onchange="updateRandomPickStats()"
                                   style="width: 80px; padding: 10px; font-size: 18px; border: none; border-radius: 5px; font-weight: bold;">
                            <span style="font-size: 20px; font-weight: bold;">ï½</span>
                            <input type="number" id="randomRangeEnd" min="1" value="40" 
                                   onchange="updateRandomPickStats()"
                                   style="width: 80px; padding: 10px; font-size: 18px; border: none; border-radius: 5px; font-weight: bold;">
                        </div>
                    </div>
                    
                    <div style="flex: 1; min-width: 150px;">
                        <label style="font-size: 14px; display: block; margin-bottom: 8px;">æŠ½å–æ•°é‡ï¼š</label>
                        <input type="number" id="randomPickCount" min="1" value="1" 
                               style="width: 100px; padding: 10px; font-size: 18px; border: none; border-radius: 5px; font-weight: bold;">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="doRandomPick()" 
                        style="width: 100%; margin-top: 20px; font-size: 20px; padding: 15px; background: #28a745; font-weight: bold;">
                    ğŸ¯ å¼€å§‹æŠ½å·
                </button>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; text-align: center;">
                <strong>æ€»å·ç æ•°ï¼š</strong><span id="randomTotalCount">40</span> | 
                <strong>å·²æŠ½å–ï¼š</strong><span id="randomPickedCount" style="color: #dc3545;">0</span> | 
                <strong>å‰©ä½™ï¼š</strong><span id="randomRemainingCount" style="color: #28a745;">40</span>
            </div>
            
            <div id="randomPickResult" style="margin: 20px 0; display: none;">
                <h4 style="color: #2196f3; border-bottom: 2px solid #2196f3; padding-bottom: 10px; margin-bottom: 15px;">
                    ğŸŠ æŠ½å–ç»“æœ
                </h4>
                <div id="randomPickResultList" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: space-between;">
                <button class="btn btn-warning" onclick="resetRandomPick()" style="padding: 10px 20px; font-size: 14px;">
                    ğŸ”„ é‡ç½®
                </button>
                <button class="btn btn-danger" onclick="closeRandomPickModal()" style="padding: 10px 20px; font-size: 14px;">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>
    
    <script>
    // â­ Gitee äº‘åŒæ­¥é…ç½®ï¼ˆå¿…é¡»æœ€å…ˆå®šä¹‰ï¼‰
    const GITEE_CONFIG = {
        owner: 'swywy_admin',
        repo: '123',
        token: 'fcef0a1c75d0e5b4cbbb91a398735e11',
        branch: 'master',
        filePath: 'grades-data.json'
    };

    // å…¨å±€å˜é‡
    let students = [];
    let currentClass = '';
    let currentNoteIndex = -1;
    let currentFilter = '';
    let allClassesData = {};
    let suffixMatches = [];
    let historyRecords = []; // å†å²è®°å½•æ•°ç»„
    let pickedNumbers = []; // å·²æŠ½å–çš„å·ç ï¼ˆé˜²æ­¢é‡å¤ï¼‰
    let currentNumberRange = { start: 1, end: 40 }; // å½“å‰å·ç èŒƒå›´
    let lastPulledCloudData = null;
    let lastPulledFileMeta = null;
    let giteeFileListCache = null;
    let giteeFileListLoading = false;

    // GiteeåŒæ­¥ç›¸å…³å˜é‡
    let giteeConfig = loadGiteeConfigFromStorage();
    let syncInProgress = false;
    let lastSyncTime = null;



    function refreshClassSelectorOptions(preserveValue = true) {
        const selector = document.getElementById('classSelector');
        if (!selector) return;

        const baseOrder = Object.keys(classesData);
        const remoteNames = allClassesData ? Object.keys(allClassesData) : [];
        const extras = remoteNames.filter(name => !baseOrder.includes(name)).sort();
        const ordered = baseOrder.concat(extras);
        const previousValue = preserveValue ? selector.value : '';

        let optionsHtml = '<option value="">-- è¯·é€‰æ‹©ç­çº§ --</option>';
        ordered.forEach(name => {
            const count = Array.isArray(allClassesData?.[name])
                ? allClassesData[name].length
                : (Array.isArray(classesData?.[name]) ? classesData[name].length : 0);
            optionsHtml += `<option value="${escapeHtml(name)}">${escapeHtml(name)}${count ? ` - ${count}äºº` : ''}</option>`;
        });

        selector.innerHTML = optionsHtml;
        if (previousValue && ordered.includes(previousValue)) {
            selector.value = previousValue;
        }
    }


    function loadGiteeConfigFromStorage() {
        try {
            const saved = localStorage.getItem('giteeConfig_v1');
            if (saved) {
                const config = JSON.parse(saved);
                config.autoSync = false;
                return config;
            }
        } catch (e) {
            console.error('åŠ è½½Giteeé…ç½®å¤±è´¥:', e);
        }
        return {
            owner: GITEE_CONFIG.owner,
            repo: GITEE_CONFIG.repo,
            token: GITEE_CONFIG.token,
            branch: GITEE_CONFIG.branch,
            filePath: GITEE_CONFIG.filePath,
            autoSync: false,
            pollingInterval: 30000,
            lastSyncTime: null,
            sha: null
        };
    }

    function setHistoryTab(tab = 'local') {
        const localPanel = document.getElementById('historyLocalPanel');
        const cloudPanel = document.getElementById('historyCloudPanel');
        const localBtn = document.getElementById('historyTabLocal');
        const cloudBtn = document.getElementById('historyTabCloud');

        const showLocal = tab !== 'cloud';

        if (localPanel) localPanel.style.display = showLocal ? 'block' : 'none';
        if (cloudPanel) cloudPanel.style.display = showLocal ? 'none' : 'block';

        if (localBtn) {
            localBtn.style.boxShadow = showLocal ? '0 0 0 2px rgba(46,125,50,0.4) inset' : 'none';
            localBtn.style.opacity = showLocal ? '1' : '0.7';
        }
        if (cloudBtn) {
            cloudBtn.style.boxShadow = showLocal ? 'none' : '0 0 0 2px rgba(241,196,15,0.6) inset';
            cloudBtn.style.opacity = showLocal ? '0.7' : '1';
        }

        if (!showLocal) {
            refreshGiteeFileList(true);
        }
    }

    function saveGiteeConfigToStorage() {
        try {
            localStorage.setItem('giteeConfig_v1', JSON.stringify(giteeConfig));
        } catch (e) {
            console.error('ä¿å­˜Giteeé…ç½®å¤±è´¥:', e);
        }
    }

    function escapeHtml(str = '') {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatFileSize(bytes) {
        if (!Number.isFinite(bytes)) return '-';
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
    }

    function formatDateTime(value) {
        if (!value) return '-';
        try {
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) {
                return typeof value === 'string' ? value : '-';
            }
            return date.toLocaleString('zh-CN', { hour12: false });
        } catch (e) {
            return typeof value === 'string' ? value : '-';
        }
    }

    

    async function fetchJsonWithFallback(url, options = {}) {
        const tryFetch = async (target, note) => {
            try {
                const resp = await fetch(target, options);
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }
                return { data: await resp.json(), note };
            } catch (error) {
                console.warn('è¯·æ±‚å¤±è´¥:', target, error);
                throw error;
            }
        };

        try {
            return await tryFetch(url, '');
        } catch (error) {
            if (!(error instanceof TypeError)) {
                throw error;
            }
        }

        const proxies = [
            target => `https://cors.isomorphic-git.org/${target}`,
            target => `https://corsproxy.io/?${encodeURIComponent(target)}`
        ];

        for (const build of proxies) {
            const proxyUrl = build(url);
            try {
                return await tryFetch(proxyUrl, proxyUrl.includes('corsproxy.io') ? 'ï¼ˆé€šè¿‡ corsproxy.io ä»£ç†ï¼‰' : 'ï¼ˆé€šè¿‡ cors.isomorphic-git.org ä»£ç†ï¼‰');
            } catch (error) {
                continue;
            }
        }

        throw new Error('ç½‘ç»œè¯·æ±‚è¢«æµè§ˆå™¨æ‹¦æˆªï¼ˆå¯èƒ½æ˜¯CORSé™åˆ¶ï¼‰');
    }
    function buildGiteeApiUrl(pathSegments = []) {
        const base = `https://gitee.com/api/v5/repos/${giteeConfig.owner}/${giteeConfig.repo}/contents`;
        const cleaned = (pathSegments || []).filter(Boolean).map(seg => encodeURIComponent(seg));
        const path = cleaned.join('/');
        const suffix = path ? `/${path}` : '';
        const branch = (giteeConfig.branch || 'master').trim() || 'master';
        const params = new URLSearchParams({
            access_token: giteeConfig.token,
            ref: branch
        });
        return `${base}${suffix}?${params.toString()}`;
    }

    function getConfiguredDirectories() {
        const dirs = new Set();
        const manual = (giteeConfig.fileDirectory || '').trim().replace(/^\/+|\/+$/g, '');
        if (manual) dirs.add(manual);
        const filePath = (giteeConfig.filePath || '').trim();
        if (filePath.includes('/')) {
            const segments = filePath.split('/');
            segments.pop();
            const dir = segments.join('/');
            if (dir) dirs.add(dir);
        }
        dirs.add('');
        return Array.from(dirs);
    }

    function uniqueKeyFromFile(item) {
        if (!item) return Math.random().toString(36);
        if (item.path) return item.path;
        const dir = (item.__directory || '').replace(/^\/+|\/+$/g, '');
        const name = item.name || 'unknown.json';
        return dir ? `${dir}/${name}` : name;
    }

    function parseTimestampFromName(name = '') {
        const match = name.match(/(20\d{2})(\d{2})(\d{2})[_-]?(\d{2})(\d{2})(\d{2})/);
        if (!match) return null;
        const [, y, m, d, hh, mm, ss] = match;
        const iso = `${y}-${m}-${d}T${hh}:${mm}:${ss}`;
        const date = new Date(iso);
        return Number.isNaN(date.getTime()) ? null : date;
    }

    function formatFileEntryName(item) {
        const name = item?.name || item?.path || 'æœªçŸ¥æ–‡ä»¶';
        const timestamp = parseTimestampFromName(name) || (item?.last_commit?.committer?.date ? new Date(item.last_commit.committer.date) : null);
        const metaDate = item?.updated_at ? new Date(item.updated_at) : null;
        const parts = [];
        if (timestamp) {
            parts.push(formatDateTime(timestamp));
        } else if (metaDate) {
            parts.push(formatDateTime(metaDate));
        }
        if (item?.__directory) {
            const dirLabel = item.__directory || 'æ ¹ç›®å½•';
            parts.push(`ç›®å½•ï¼š${escapeHtml(dirLabel || 'æ ¹ç›®å½•')}`);
        }
        const prefix = parts.length ? `<span style="color:#555;font-size:12px;">${parts.join(' Â· ')}</span><br>` : '';
        return `${prefix}<span style="font-weight:600;">${escapeHtml(name)}</span>`;
    }

    // Toasté€šçŸ¥å‡½æ•°
    function showToast(message, type = 'info', duration = 3000) {
        // åŒæ­¥ç›¸å…³çš„æç¤ºæ”¹ä¸ºåº•éƒ¨å°å­—
        const syncMessages = ['æ­£åœ¨æ¨é€', 'æ­£åœ¨ä»Gitee', 'æ­£åœ¨æ‹‰å–', 'æ¨é€åˆ°Gitee', 'ä»Giteeæ‹‰å–', 'æ•°æ®å·²åŒæ­¥', 'è‡ªåŠ¨åŒæ­¥', 'Gitee'];
        const isSync = syncMessages.some(msg => message.includes(msg));

        if (isSync) {
            // åŒæ­¥æç¤ºï¼šåº•éƒ¨å°å­—
            updateSyncStatus(message, type);
            return;
        }

        // å…¶ä»–é‡è¦æç¤ºï¼šä¿ç•™åŸæ ·
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideDown 0.3s ease-out reverse';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, duration);
    }

    // åº•éƒ¨åŒæ­¥çŠ¶æ€æç¤º
    function updateSyncStatus(message, type = 'info') {
        let statusBar = document.getElementById('syncStatusBar');
        if (!statusBar) {
            statusBar = document.createElement('div');
            statusBar.id = 'syncStatusBar';
            statusBar.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #f8f9fa;
                color: #6c757d;
                padding: 4px 10px;
                font-size: 11px;
                text-align: center;
                border-top: 1px solid #dee2e6;
                z-index: 999;
                opacity: 0.8;
            `;
            document.body.appendChild(statusBar);
        }

        // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
        const colors = {
            'info': '#6c757d',
            'success': '#28a745',
            'warning': '#ffc107',
            'error': '#dc3545'
        };
        statusBar.style.color = colors[type] || colors.info;
        statusBar.textContent = message;

        // 3ç§’åæ·¡å‡º
        setTimeout(() => {
            statusBar.style.opacity = '0';
            setTimeout(() => {
                if (statusBar.textContent === message) {
                    statusBar.textContent = '';
                    statusBar.style.opacity = '0.8';
                }
            }, 500);
        }, 3000);
    }
    
    // ç»Ÿä¸€çš„ä¿®æ”¹æ•°æ®æé†’
    function showBackupReminder() {
        updateSyncStatus('ğŸ’¡ å·²ä¿®æ”¹æ•°æ®ï¼Œè¯·åŠæ—¶ç‚¹å‡»â€œğŸ“¦ ä¿å­˜ä¸ºå¤‡ä»½â€', 'warning');
        showOperationBackupBadge();
    }

    function showOperationBackupBadge() {
        const el = document.getElementById('opBackupBadge');
        if (el) el.style.display = 'inline-block';
    }

    function hideOperationBackupBadge() {
        const el = document.getElementById('opBackupBadge');
        if (el) el.style.display = 'none';
    }
    
    

    // æ‰¹é‡é€‰æ‹©ç›¸å…³å˜é‡
    let isSelecting = false;
    let startSelectIndex = -1;
    let endSelectIndex = -1;
    let lastClickedIndex = -1;
    
    // ç­çº§æ•°æ® - ç¡®ä¿æ•°æ®å‡†ç¡®
    const classesData = {
        '25æ— äººæœºä¸‰ç­': [
            ['25090300301', 'å®‰å¿ ç¿'], ['25090300302', 'æ›¹å…†é›„'], ['25090300303', 'é™ˆç‚³è‡»'],
            ['25090300304', 'æˆç¡•'], ['25090300305', 'æ¨Šç¨¼ä¹'], ['25090300306', 'ä½•å…†æ–‡'],
            ['25090300307', 'è´ºæ–‡éŸ¬'], ['25090300308', 'ä¾¯ç¬‘å®‡'], ['25090300309', 'ä¾¯å¥•è¾°'],
            ['25090300310', 'å§œé‰´ç½¡'], ['25090300311', 'å§œæ‰æ³½'], ['25090300312', 'æ™¯åšæ¥·'],
            ['25090300313', 'åº·å®¶è±ª'], ['25090300314', 'é›·é”é˜³'], ['25090300315', 'ææ–Œ'],
            ['25090300316', 'æå­”æˆŸ'], ['25090300317', 'æéª‘ä¸œ'], ['25090300318', 'æ—ç¦¹è¾°é˜³'],
            ['25090300319', 'åˆ˜æµ©å›­'], ['25090300320', 'åˆ˜ä½³ç¥ˆ'], ['25090300321', 'å•å»¶åš'],
            ['25090300322', 'é©¬å­æ°'], ['25090300323', 'æ½˜æ”¿æ—­'], ['25090300324', 'è’²å²©æ¾'],
            ['25090300325', 'ä»»å˜‰é‘«'], ['25090300326', 'è‹å…†å®‡'], ['25090300327', 'å”æ£®æ—'],
            ['25090300328', 'ç‹å¸…'], ['25090300329', 'ç‹æ™“ä¸œ'], ['25090300330', 'ç‹å“æ‚¦'],
            ['25090300331', 'é­æ¯…é˜³'], ['25090300332', 'å¾å­è½©'], ['25090300333', 'è¢æµ©'],
            ['25090300334', 'è¢å­è±ª'], ['25090300335', 'å¼ åšæ£®'], ['25090300336', 'å¼ ä¼Ÿç„¶'],
            ['25090300337', 'éƒ‘å¸…æ¶›'], ['25090300338', 'æœ±ç§¦ä¸œé˜³'], ['25090300339', 'æœ±æ€¡å‡¡'],
            ['25090300340', 'å·¦å¤©é›¨']
        ],
        '25æ¶²å‹ä¸‰ç­': [
            ['25090200301', 'é™ˆæ¶¦é¾™'], ['25090200302', 'é™ˆæ¥ '], ['25090200303', 'æ®µå®‡è½©'],
            ['25090200304', 'ä¾¯ä¸€è¯º'], ['25090200305', 'é»„ä½³å¼º'], ['25090200306', 'å†€å¿—è¿œ'],
            ['25090200307', 'é‡‘æ—­é˜³'], ['25090200308', 'é‡‘å­èˆª'], ['25090200309', 'ä¹æ€ç‚'],
            ['25090200310', 'æèŒ‚æº'], ['25090200311', 'æé“ å›'], ['25090200312', 'åˆ˜å´‡æ™º'],
            ['25090200313', 'å•ä¸€é“­'], ['25090200314', 'éª†ç ”å®‡'], ['25090200315', 'çŸ³é–æ¥ '],
            ['25090200316', 'å®‹æµ©ç„¶'], ['25090200317', 'å®‹ä¸–æ°'], ['25090200318', 'è°­æ€ç¿°'],
            ['25090200319', 'æ±¤è¯‘åš'], ['25090200320', 'ç‹å¾·ç¦'], ['25090200321', 'é­æºåŸ¹'],
            ['25090200322', 'å´è¿ª'], ['25090200323', 'å´æ¾ç¿'], ['25090200324', 'å¸­å­è¾°'],
            ['25090200325', 'æ›¾åœ£ä¿Š'], ['25090200326', 'å¼ å®¶è±ª'], ['25090200327', 'å¼ æ–‡è¯‘'],
            ['25090200328', 'å‘¨ç§¦å®‡'], ['25090200329', 'æœ±ä¼¯æ©'], ['25090200330', 'æœ±å°å®‡']
        ],
        '25æ— äººæœºå››ç­': [
            ['25090300401', 'ç™½çŸ³æƒ'], ['25090300402', 'è”¡å®‡è½©'], ['25090300403', 'é™ˆå®šåŸº'],
            ['25090300404', 'é™ˆç§‘æ—©'], ['25090300405', 'é™ˆç»æ­¦'], ['25090300406', 'é™ˆå¤©ä¸€'],
            ['25090300407', 'é™ˆå®‡æ¶µ'], ['25090300408', 'é™ˆé‘«'], ['25090300409', 'å´”å³»å†‰'],
            ['25090300410', 'ä¸æ–‡é¾™'], ['25090300411', 'æœå¶æ™¨'], ['25090300412', 'æ¨Šé•‡å®‡'],
            ['25090300413', 'èŒƒä¸€å“²'], ['25090300414', 'éƒç‰æ´'], ['25090300415', 'æ´ªå…¶è£'],
            ['25090300416', 'èƒ¡é”¦ç†™'], ['25090300417', 'é»„è€€æ°'], ['25090300418', 'å­”æƒª'],
            ['25090300419', 'æå½¦è‡»'], ['25090300420', 'æç¿åº·'], ['25090300421', 'æ¢å®¶è¾‰'],
            ['25090300422', 'åˆ˜æµ©å±•'], ['25090300423', 'åˆ˜æ™¯æ™–'], ['25090300424', 'ç½—æ¯…æ¶›'],
            ['25090300425', 'éª†å²³å®'], ['25090300426', 'ç‰Ÿå˜‰è±ª'], ['25090300427', 'å®ä¿Šç†™'],
            ['25090300428', 'é‚±ä¸–æ˜¾'], ['25090300429', 'æ–½æ–Œè±ª'], ['25090300430', 'å”æ–‡æ°'],
            ['25090300431', 'æ¨æµç®'], ['25090300432', 'æ¨æŸ é“–'], ['25090300433', 'å‘˜æ™¨é˜³'],
            ['25090300434', 'å¼ é”¦ç¨‹'], ['25090300435', 'å¼ æ™“å®'], ['25090300436', 'å¼ å±•é¹'],
            ['25090300437', 'å¼ å¿—æ°'], ['25090300438', 'å¼ é‘«é¹'], ['25090300439', 'å‘¨æ°'],
            ['25090300440', 'å‘¨é€š']
        ],
        '25åº”ç”µ12ç­': [  // åŸé€šèˆªè¿ç»´ç­
            ['25010030101', 'å®‰æ–‡å¨œ'], ['25010030102', 'é™ˆèƒœ'], ['25010030103', 'å•å¤©ç’'],
            ['25010030104', 'æ®µå¤©å®‡'], ['25010030105', 'èŒƒæ™¨å¸Œ'], ['25010030106', 'é«˜ç¡•æœ'],
            ['25010030107', 'éƒ­ä¸–é›„'], ['25010030108', 'é»„ä¿Šå®'], ['25010030109', 'é‡‘æ¬£é›¨'],
            ['25010030110', 'äº•é”èˆª'], ['25010030111', 'äº¢é‘«é’°'], ['25010030112', 'ææœé˜³'],
            ['25010030113', 'æç™»è¾‰'], ['25010030114', 'æèŠ¬ç«¹'], ['25010030115', 'æå¸Œè¨€'],
            ['25010030116', 'æå§¿æ€¡'], ['25010030117', 'åˆ˜æ€å½¤'], ['25010030118', 'åˆ˜æ¯…å¤'],
            ['25010030119', 'æ¯›é‘«å†°'], ['25010030120', 'å½­å½©ç²'], ['25010030121', 'é½å›­æ˜'],
            ['25010030122', 'ä»»æ€æº'], ['25010030123', 'å­™é¹¤å¿'], ['25010030124', 'å­™æ˜å“²'],
            ['25010030125', 'ç‹é”¦æ¥ '], ['25010030126', 'ç‹æ€æ°'], ['25010030127', 'é­æ™¨æ€¡'],
            ['25010030128', 'é­æ—­å²©'], ['25010030129', 'æ¸©ç‰è£'], ['25010030130', 'ä¹ŒÂ·ç‰¹å°¼æ ¼å°”'],
            ['25010030131', 'è–›æ·‡æ–‡'], ['25010030132', 'æ¨ç‘œæ³½'], ['25010030133', 'å§šé”¦è‰'],
            ['25010030134', 'æ˜“å°é›¨'], ['25010030135', 'è¢ç¨‹å†›'], ['25010030136', 'å¼ æ™¨'],
            ['25010030137', 'å¼ ç¾è±ª'], ['25010030138', 'å¼ å¿ƒæº'], ['25010030139', 'å¼ äºšå·'],
            ['25010030140', 'å¼ å®‡è½©'], ['25010030141', 'å¼ å­æ€¡'], ['25010030142', 'èµµä½³å®¾'],
            ['25010030143', 'èµµå­æ€¡'], ['25010030201', 'å®‰æ©¦æ©¦'], ['25010030202', 'é™ˆå¤'],
            ['25010030203', 'ç¨‹å¿—è¿œ'], ['25010030204', 'ä»£éŸ¶æ¶µ'], ['25010030205', 'æ‡‚é˜³å®'],
            ['25010030206', 'å†¯å­é’'], ['25010030207', 'ä»˜å­Ÿç’'], ['25010030208', 'é«˜å»¶æ°'],
            ['25010030209', 'éƒæ˜Ÿå®‡'], ['25010030210', 'è’‹ç§¦æ¹˜'], ['25010030211', 'é³æƒ çª'],
            ['25010030212', 'åº·è½¶'], ['25010030213', 'é›·æ™ºæµ©'], ['25010030214', 'é»å«æ˜•'],
            ['25010030215', 'ææ‰¿æ³½'], ['25010030216', 'æé”®'], ['25010030217', 'æçŸ¥è±'],
            ['25010030218', 'åˆ˜å‡Œé£'], ['25010030219', 'åˆ˜è'], ['25010030220', 'åˆ˜é¢–ç„¶'],
            ['25010030221', 'é©¬æ™¨ä¸œ'], ['25010030222', 'å­Ÿæˆå¤'], ['25010030223', 'ç§¦è¯šè¯š'],
            ['25010030224', 'å°šæ˜'], ['25010030225', 'é‚µæ¬£æ€¡'], ['25010030226', 'å­™å˜‰æµ©'],
            ['25010030227', 'å­™å®‡æ™¨'], ['25010030228', 'ç‹é¹ç£Š'], ['25010030229', 'ç‹å®‡ç¿”'],
            ['25010030230', 'é­æŒ¯é©°'], ['25010030231', 'è®¸ä½³ä¹'], ['25010030232', 'è–›åšæ–‡'],
            ['25010030233', 'æ¨å˜‰ç‘¶'], ['25010030234', 'æ¨é‘«å®‡'], ['25010030235', 'å°¹é›ªé½'],
            ['25010030236', 'å¼ éå‡¡'], ['25010030237', 'å¼ ç‘å˜‰'], ['25010030238', 'å¼ æ°´æ¶µ'],
            ['25010030239', 'å¼ æ¯…èˆª'], ['25010030240', 'å¼ è‚²èŒ'], ['25010030241', 'å¼ æ³½è±ª'],
            ['25010030242', 'èµµç„•å½¤'], ['25010030243', 'å·¦é˜³']
        ]
    };
    
    // åˆ¤æ–­æ˜¯åº”ç”µ1ç­è¿˜æ˜¯åº”ç”µ2ç­
    function getSubClass(studentId) {
        if (studentId.startsWith('250100301')) {
            return 'åº”ç”µ1ç­';
        } else if (studentId.startsWith('250100302')) {
            return 'åº”ç”µ2ç­';
        }
        return '';
    }
    
    // è·å–åˆ†ç»„å‡½æ•° - æ ¹æ®å®é™…åˆ†ç»„è§„åˆ™
    function getGroupForStudent(className, index) {
        if (className === '25æ¶²å‹ä¸‰ç­') {
            // 30äººåˆ†15ç»„ï¼šæ¯ç»„2äºº
            return 'ç¬¬' + (Math.floor(index / 2) + 1) + 'ç»„';
        } else if (className === '25æ— äººæœºä¸‰ç­' || className === '25æ— äººæœºå››ç­') {
            // 40äººåˆ†13ç»„ï¼šå‰12ç»„æ¯ç»„3äºº(36äºº)ï¼Œç¬¬13ç»„4äºº
            if (index < 36) {
                return 'ç¬¬' + (Math.floor(index / 3) + 1) + 'ç»„';
            } else {
                return 'ç¬¬13ç»„';
            }
        } else if (className === '25åº”ç”µ12ç­') {
            // 86äººåˆ†14ç»„ï¼šå‰7ç»„æ¯ç»„6äºº(42äºº)ï¼Œç¬¬8-14ç»„åˆ†é…å‰©ä½™44äºº
            if (index < 42) {
                return 'ç¬¬' + (Math.floor(index / 6) + 1) + 'ç»„';
            } else {
                // ç¬¬8-14ç»„ï¼š44äººåˆ†7ç»„ï¼Œçº¦æ¯ç»„6-7äºº
                const remaining = index - 42;
                return 'ç¬¬' + (Math.floor(remaining / 6.3) + 8) + 'ç»„';
            }
        }
        return 'æœªåˆ†ç»„';
    }
    
    // æ ¹æ®æ‚¨æä¾›çš„è¡¨æ ¼è·å–å‡†ç¡®åˆ†ç»„ï¼ˆåº”ç”µ12ç­ï¼‰
    function getGroupForYingDian(index) {
        // æ ¹æ®æ‚¨çš„è¡¨æ ¼åˆ†ç»„
        if (index < 6) return 'ç¬¬ä¸€ç»„';
        else if (index < 12) return 'ç¬¬äºŒç»„';
        else if (index < 18) return 'ç¬¬ä¸‰ç»„';
        else if (index < 24) return 'ç¬¬å››ç»„';
        else if (index < 30) return 'ç¬¬äº”ç»„';
        else if (index < 36) return 'ç¬¬å…­ç»„';
        else if (index < 42) return 'ç¬¬ä¸ƒç»„';
        else if (index < 48) return 'ç¬¬8ç»„';
        else if (index < 54) return 'ç¬¬9ç»„';
        else if (index < 60) return 'ç¬¬10ç»„';
        else if (index < 66) return 'ç¬¬11ç»„';
        else if (index < 72) return 'ç¬¬12ç»„';
        else if (index < 79) return 'ç¬¬13ç»„';
        else return 'ç¬¬14ç»„';
    }
    
    // æ›´æ–°ç­çº§çŠ¶æ€æ˜¾ç¤º
    function updateClassStatus() {
        ['25æ— äººæœºä¸‰ç­', '25æ¶²å‹ä¸‰ç­', '25æ— äººæœºå››ç­', '25åº”ç”µ12ç­'].forEach(className => {
            const statusEl = document.getElementById('status-' + className);
            if (statusEl) {
                if (allClassesData[className] && allClassesData[className].length > 0) {
                    const hasScores = allClassesData[className].some(s => 
                        s.è¯¾å ‚è¡¨ç° !== 0 || s.å°ç»„æ´»åŠ¨ !== 0 || s.è€ƒè¯•æˆç»© !== 0
                    );
                    statusEl.textContent = hasScores ? 'æœ‰æ•°æ®' : 'å·²åŠ è½½';
                    statusEl.className = 'class-status status-loaded';
                } else {
                    statusEl.textContent = 'æœªåŠ è½½';
                    statusEl.className = 'class-status status-empty';
                }
            }
        });
    }
    
    // é€‰æ‹©ç­çº§
    function selectClass(className) {
        // ä¿å­˜å½“å‰ç­çº§æ•°æ®
        if (currentClass && students.length > 0) {
            allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
            saveToLocalStorage();
        }
        
        currentClass = className;
        
        console.log('âœ… å¼€å§‹åŠ è½½ç­çº§:', className);
        console.log('classesData:', Object.keys(classesData));
        console.log('allClassesData:', Object.keys(allClassesData));
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„æ•°æ®
        if (allClassesData[className] && allClassesData[className].length > 0) {
            students = JSON.parse(JSON.stringify(allClassesData[className]));
            console.log('âœ… åŠ è½½å·²ä¿å­˜çš„ç­çº§æ•°æ®:', className, 'å­¦ç”Ÿæ•°:', students.length);
        } else {
            // åˆ›å»ºæ–°çš„ç­çº§æ•°æ®
            console.log('<i class="fa-solid fa-file-pen"></i> åˆ›å»ºæ–°çš„ç­çº§æ•°æ®...');
            const data = classesData[className];
            
            if (!data) {
                console.error('âŒ classesDataä¸­æ²¡æœ‰è¿™ä¸ªç­çº§:', className);
                showToast('æ‰¾ä¸åˆ°è¯¥ç­çº§çš„æ•°æ®', 'error');
                return;
            }
            
            console.log('<i class="fa-solid fa-chart-bar"></i> åŸå§‹æ•°æ®æ•°é‡:', data.length);
            students = data.map((item, i) => {
                let group;
                if (className === '25åº”ç”µ12ç­') {
                    group = getGroupForYingDian(i);
                } else {
                    group = getGroupForStudent(className, i);
                }
                
                return {
                    å­¦å·: item[0],
                    å§“å: item[1],
                    ç»„åˆ«: group,
                    å­ç­çº§: className === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                    è¯¾å ‚è¡¨ç°: 0,  // æ”¹ä¸ºè¯¾å ‚è¡¨ç°
                    å°ç»„æ´»åŠ¨: 0,
                    ç¬”è®°1: false,
                    ç¬”è®°2: false,
                    ç¬”è®°æ€»åˆ†: 0,
                    è€ƒè¯•æˆç»©: 0,
                    å¹³æ—¶æ€»åˆ†: 0,
                    æ€»åˆ†: 0,
                    selected: false
                };
            });
            console.log('åˆ›å»ºæ–°çš„ç­çº§æ•°æ®:', className, 'å­¦ç”Ÿæ•°:', students.length);
        }
        
        // é‡æ–°è®¡ç®—æ‰€æœ‰åˆ†æ•°
        console.log('é‡æ–°è®¡ç®—åˆ†æ•°...');
        students.forEach((s, i) => calc(i));
        
        currentFilter = '';
        
        // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰ä¸­çŠ¶æ€
        const selector = document.getElementById('classSelector');
        if (selector) {
            selector.value = className;
        }
        
        console.log('æ˜¾ç¤ºä¸»ç•Œé¢...');
        showMain();
        
        console.log('æ›´æ–°ç»„åˆ«...');
        updateGroups();
        
        console.log('æ¸²æŸ“è¡¨æ ¼..., students.length=', students.length);
        render();
        
        console.log('æ›´æ–°ç­çº§çŠ¶æ€...');
        updateClassStatus();
        
        // ä¿å­˜é€‰æ‹©çš„ç­çº§
        localStorage.setItem('currentClass', className);
        
        console.log('=== ç­çº§åˆ‡æ¢å®Œæˆ ===', className, 'å­¦ç”Ÿæ•°:', students.length);
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        if (students.length > 0) {
            showToast(`âœ… å·²åŠ è½½ ${className}ï¼Œå…± ${students.length} åå­¦ç”Ÿ`, 'success', 2000);
        } else {
            showToast('<i class="fa-solid fa-triangle-exclamation"></i> è¯¥ç­çº§æš‚æ— æ•°æ®', 'warning');
        }
    }
    
    // ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ç­çº§
    function selectClassFromDropdown() {
        const selector = document.getElementById('classSelector');
        const className = selector.value;
        
        if (!className) {
            showToast('è¯·é€‰æ‹©ç­çº§', 'warning');
            return;
        }
        
        console.log('ä¸‹æ‹‰æ¡†é€‰æ‹©ç­çº§:', className);
        selectClass(className);
        showToast(`å·²åˆ‡æ¢åˆ° ${className}`, 'success');
    }
    
    // æ˜¾ç¤ºä¸»ç•Œé¢ï¼ˆå·²åˆ é™¤welcomeé¡µé¢ï¼Œç›´æ¥æ˜¾ç¤ºmainï¼‰
    function showMain() {
        const main = document.getElementById('main');
        if (main) main.style.display = 'block';
    }
    
    // æ¸²æŸ“è¡¨æ ¼
    function render() {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        
        let visibleStudents = students;
        if (currentFilter) {
            visibleStudents = students.filter(s => s.ç»„åˆ« === currentFilter);
        }
        
        visibleStudents.forEach((s, displayIndex) => {
            const i = students.indexOf(s);
            const tr = tbody.insertRow();
            
            // åˆ†æ•°é¢œè‰²ç±»
            let scoreClass = 'score-bad';
            if (s.æ€»åˆ† < 0) {
                scoreClass = 'score-negative';
            } else if (s.æ€»åˆ† >= 85) {
                scoreClass = 'score-good';
            } else if (s.æ€»åˆ† >= 60) {
                scoreClass = 'score-warn';
            }
            
            // åº”ç”µç­çº§çš„è¡ŒèƒŒæ™¯è‰²
            let rowClass = '';
            if (currentClass === '25åº”ç”µ12ç­') {
                if (s.å­ç­çº§ === 'åº”ç”µ1ç­') {
                    rowClass = 'yingdian-class1';
                } else if (s.å­ç­çº§ === 'åº”ç”µ2ç­') {
                    rowClass = 'yingdian-class2';
                }
            }
            
            tr.className = rowClass;
            if (s.selected) tr.classList.add('selected');
            
            // å¦‚æœæ˜¯åŒ¹é…çš„å­¦ç”Ÿï¼Œæ·»åŠ é«˜äº®
            if (suffixMatches.includes(i)) {
                tr.classList.add('suffix-hit');
            }
            
            // è¯¾å ‚è¡¨ç°åˆ†æ•°é¢œè‰²
            let ketangClass = '';
            if (s.è¯¾å ‚è¡¨ç° < 0) ketangClass = 'score-negative';
            else if (s.è¯¾å ‚è¡¨ç° >= 18) ketangClass = 'score-good';
            else if (s.è¯¾å ‚è¡¨ç° >= 12) ketangClass = 'score-warn';
            else ketangClass = 'score-bad';
            
            // å°ç»„æ´»åŠ¨åˆ†æ•°é¢œè‰²
            let xiaozuClass = '';
            if (s.å°ç»„æ´»åŠ¨ < 0) xiaozuClass = 'score-negative';
            else if (s.å°ç»„æ´»åŠ¨ >= 18) xiaozuClass = 'score-good';
            else if (s.å°ç»„æ´»åŠ¨ >= 12) xiaozuClass = 'score-warn';
            else xiaozuClass = 'score-bad';
            
            // å¹³æ—¶æ€»åˆ†é¢œè‰²
            let pingshiClass = '';
            if (s.å¹³æ—¶æ€»åˆ† < 0) pingshiClass = 'score-negative';
            else if (s.å¹³æ—¶æ€»åˆ† >= 45) pingshiClass = 'score-good';
            else if (s.å¹³æ—¶æ€»åˆ† >= 30) pingshiClass = 'score-warn';
            else pingshiClass = 'score-bad';
            
            tr.innerHTML = `
                <td><input type="checkbox" ${s.selected ? 'checked' : ''} onchange="toggle(${i})"></td>
                <td>${displayIndex + 1}</td>
                <td>${s.å­¦å·}${s.å­ç­çº§ ? `<span class="class-indicator ${s.å­ç­çº§ === 'åº”ç”µ1ç­' ? 'class1-badge' : 'class2-badge'}">${s.å­ç­çº§.replace('åº”ç”µ', '')}</span>` : ''}</td>
                <td>${s.å§“å}</td>
                <td><span class="group-badge">${s.ç»„åˆ«}</span></td>
                <td class="editable ${ketangClass}" contenteditable onblur="update(${i},'è¯¾å ‚è¡¨ç°',this.textContent)">${s.è¯¾å ‚è¡¨ç°}</td>
                <td class="editable ${xiaozuClass}" contenteditable onblur="update(${i},'å°ç»„æ´»åŠ¨',this.textContent)">${s.å°ç»„æ´»åŠ¨}</td>
                <td>${s.ç¬”è®°æ€»åˆ†} <button class="btn btn-primary" onclick="editNote(${i})" style="padding:2px 8px;font-size:12px;">ç¼–è¾‘</button></td>
                <td class="${pingshiClass}">${s.å¹³æ—¶æ€»åˆ†}</td>
                <td class="editable" contenteditable onblur="update(${i},'è€ƒè¯•æˆç»©',this.textContent)">${s.è€ƒè¯•æˆç»©}</td>
                <td class="${scoreClass}">${s.æ€»åˆ†}</td>
                <td>
                    <button class="btn btn-success" onclick="quickAdd(${i})" style="padding:2px 6px;font-size:12px;">+1</button>
                    <button class="btn btn-danger" onclick="quickDeduct(${i})" style="padding:2px 6px;font-size:12px;">-1</button>
                </td>
            `;
            
            // æ·»åŠ æ‹–æ‹½é€‰æ‹©äº‹ä»¶
            tr.addEventListener('mousedown', (e) => handleRowMouseDown(e, i));
            tr.addEventListener('mouseenter', (e) => handleRowMouseEnter(e, i));
            tr.addEventListener('mouseup', (e) => handleRowMouseUp(e, i));
            
            // é˜»æ­¢åœ¨å¯ç¼–è¾‘å…ƒç´ ä¸Šè§¦å‘é€‰æ‹©
            tr.querySelectorAll('.editable, button, input').forEach(el => {
                el.addEventListener('mousedown', (e) => e.stopPropagation());
            });
        });
        
        updateStats();
        updateSelectAll();
    }
    
    // æ›´æ–°ç»„åˆ«é€‰é¡¹
    function updateGroups() {
        const groups = [...new Set(students.map(s => s.ç»„åˆ«))];
        const select = document.getElementById('groupFilter');
        select.innerHTML = '<option value="">å…¨éƒ¨ç»„åˆ«</option>';
        
        // æŒ‰ç»„å·æ’åº
        groups.sort((a, b) => {
            const numA = parseInt(a.replace(/[^0-9]/g, '')) || 0;
            const numB = parseInt(b.replace(/[^0-9]/g, '')) || 0;
            return numA - numB;
        });
        
        groups.forEach(g => {
            const count = students.filter(s => s.ç»„åˆ« === g).length;
            select.innerHTML += `<option value="${g}">${g} (${count}äºº)</option>`;
        });
    }
    
    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
        let visibleStudents = students;
        if (currentFilter) {
            visibleStudents = students.filter(s => s.ç»„åˆ« === currentFilter);
        }
        
        const total = visibleStudents.length;
        const selected = visibleStudents.filter(s => s.selected).length;
        const avg = total > 0 ? (visibleStudents.reduce((sum, s) => sum + s.æ€»åˆ†, 0) / total).toFixed(1) : 0;
        const pass = visibleStudents.filter(s => s.æ€»åˆ† >= 60).length;
        const passRate = total > 0 ? (pass / total * 100).toFixed(1) : 0;
        
        document.getElementById('total').textContent = total;
        document.getElementById('selected').textContent = selected;
        document.getElementById('avg').textContent = avg;
        document.getElementById('pass').textContent = passRate + '%';
    }
    
    // è®¡ç®—åˆ†æ•° - å…è®¸è´Ÿåˆ†
    function calc(i) {
        const s = students[i];
        s.è¯¾å ‚è¡¨ç° = parseFloat(s.è¯¾å ‚è¡¨ç°) || 0;
        s.å°ç»„æ´»åŠ¨ = parseFloat(s.å°ç»„æ´»åŠ¨) || 0;
        s.è€ƒè¯•æˆç»© = Math.min(50, Math.max(0, parseFloat(s.è€ƒè¯•æˆç»©) || 0));
        s.ç¬”è®°æ€»åˆ† = (s.ç¬”è®°1 ? 5 : 0) + (s.ç¬”è®°2 ? 5 : 0);
        s.å¹³æ—¶æ€»åˆ† = s.è¯¾å ‚è¡¨ç° + s.å°ç»„æ´»åŠ¨ + s.ç¬”è®°æ€»åˆ†;
        s.æ€»åˆ† = s.å¹³æ—¶æ€»åˆ† + s.è€ƒè¯•æˆç»©;
    }
    
    // æ›´æ–°åˆ†æ•° - å…è®¸è´Ÿåˆ†
    function update(i, field, value) {
        const v = parseFloat(value) || 0;
        if (field === 'è€ƒè¯•æˆç»©') {
            students[i][field] = Math.min(50, Math.max(0, v));
        } else {
            students[i][field] = v;  // å…è®¸è´Ÿåˆ†
        }
        calc(i);
        render();
        saveToLocalStorage();
        
        
        showBackupReminder();
    }
    
    // åˆ‡æ¢é€‰æ‹©
    function toggle(i) {
        students[i].selected = !students[i].selected;
        updateSelectAll();
        updateStats();
    }
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleAll() {
        const checked = document.getElementById('selectAll').checked;
        
        if (currentFilter) {
            students.forEach(s => {
                if (s.ç»„åˆ« === currentFilter) {
                    s.selected = checked;
                }
            });
        } else {
            students.forEach(s => s.selected = checked);
        }
        
        render();
    }
    
    // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
    function updateSelectAll() {
        let visibleStudents = students;
        if (currentFilter) {
            visibleStudents = students.filter(s => s.ç»„åˆ« === currentFilter);
        }
        
        const allSelected = visibleStudents.length > 0 && visibleStudents.every(s => s.selected);
        document.getElementById('selectAll').checked = allSelected;
    }
    
    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
        students.forEach(s => s.selected = false);
        document.getElementById('selectAll').checked = false;
        lastClickedIndex = -1;
        render();
    }
    
    // åé€‰
    function invertSelection() {
        if (currentFilter) {
            students.forEach(s => {
                if (s.ç»„åˆ« === currentFilter) {
                    s.selected = !s.selected;
                }
            });
        } else {
            students.forEach(s => s.selected = !s.selected);
        }
        render();
    }
    
    // é€‰ä¸­å½“å‰ç»„
    function selectCurrentGroup() {
        if (currentFilter) {
            students.forEach(s => {
                s.selected = (s.ç»„åˆ« === currentFilter);
            });
        } else {
            students.forEach(s => s.selected = true);
        }
        render();
    }
    
    // å¿«é€ŸåŠ åˆ†
    function quickAdd(i) {
        students[i].è¯¾å ‚è¡¨ç° = students[i].è¯¾å ‚è¡¨ç° + 1;
        calc(i);
        
        // æ·»åŠ å†å²è®°å½•
        addHistory('å•ä¸ªå­¦ç”ŸåŠ åˆ†', 1, {
            'å­¦ç”Ÿ': students[i].å§“å,
            'å­¦å·': students[i].å­¦å·,
            'é¡¹ç›®': 'è¯¾å ‚è¡¨ç°',
            'åˆ†å€¼': '+1'
        });
        
        render();
        saveToLocalStorage();
        
        
        showBackupReminder();
    }
    
    // å¿«é€Ÿæ‰£åˆ† - å…è®¸æ‰£æˆè´Ÿåˆ†
    function quickDeduct(i) {
        students[i].è¯¾å ‚è¡¨ç° = students[i].è¯¾å ‚è¡¨ç° - 1;
        calc(i);
        
        // æ·»åŠ å†å²è®°å½•
        addHistory('å•ä¸ªå­¦ç”Ÿæ‰£åˆ†', 1, {
            'å­¦ç”Ÿ': students[i].å§“å,
            'å­¦å·': students[i].å­¦å·,
            'é¡¹ç›®': 'è¯¾å ‚è¡¨ç°',
            'åˆ†å€¼': '-1'
        });
        
        render();
        saveToLocalStorage();
        showBackupReminder();
    }
    
    // å…¼å®¹æ—§å‡½æ•°å
    function quick(i) {
        quickAdd(i);
    }
    
    // æ‰¹é‡åŠ åˆ†
    function batchAdd() {
        const type = document.getElementById('batchType').value;
        const score = Math.abs(parseFloat(document.getElementById('batchScore').value) || 1);
        const selected = students.filter(s => s.selected);
        
        if (selected.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ');
            return;
        }
        
        const typeNames = { '1': 'è¯¾å ‚è¡¨ç°', '2': 'å°ç»„æ´»åŠ¨', '3': 'ç¬”è®°æ£€æŸ¥' };
        
        selected.forEach(s => {
            const i = students.indexOf(s);
            if (type === '1') {
                s.è¯¾å ‚è¡¨ç° = s.è¯¾å ‚è¡¨ç° + score;
            } else if (type === '2') {
                s.å°ç»„æ´»åŠ¨ = s.å°ç»„æ´»åŠ¨ + score;
            } else if (type === '3') {
                if (!s.ç¬”è®°1) s.ç¬”è®°1 = true;
                else if (!s.ç¬”è®°2) s.ç¬”è®°2 = true;
            }
            calc(i);
        });
        
        // æ·»åŠ å†å²è®°å½•
        addHistory('æ‰¹é‡åŠ åˆ†', selected.length, {
            'ç±»å‹': typeNames[type],
            'åˆ†å€¼': score
        });
        
        clearSelection();
        saveToLocalStorage();
        showToast(`âœ… æˆåŠŸä¸º${selected.length}åå­¦ç”ŸåŠ åˆ†`, 'success');
        
        showBackupReminder();
    }
    
    // æ‰¹é‡æ‰£åˆ† - å…è®¸æ‰£æˆè´Ÿåˆ†
    function batchDeduct() {
        const type = document.getElementById('batchType').value;
        const score = Math.abs(parseFloat(document.getElementById('batchScore').value) || 1);
        const selected = students.filter(s => s.selected);
        
        if (selected.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦ä¸º${selected.length}åå­¦ç”Ÿæ‰£${score}åˆ†å—ï¼Ÿ`)) {
            return;
        }
        
        const typeNames = { '1': 'è¯¾å ‚è¡¨ç°', '2': 'å°ç»„æ´»åŠ¨', '3': 'ç¬”è®°æ£€æŸ¥' };
        
        selected.forEach(s => {
            const i = students.indexOf(s);
            if (type === '1') {
                s.è¯¾å ‚è¡¨ç° = s.è¯¾å ‚è¡¨ç° - score;  // å…è®¸è´Ÿåˆ†
            } else if (type === '2') {
                s.å°ç»„æ´»åŠ¨ = s.å°ç»„æ´»åŠ¨ - score;  // å…è®¸è´Ÿåˆ†
            } else if (type === '3') {
                if (s.ç¬”è®°2) s.ç¬”è®°2 = false;
                else if (s.ç¬”è®°1) s.ç¬”è®°1 = false;
            }
            calc(i);
        });
        
        // æ·»åŠ å†å²è®°å½•
        addHistory('æ‰¹é‡æ‰£åˆ†', selected.length, {
            'ç±»å‹': typeNames[type],
            'åˆ†å€¼': score
        });
        
        clearSelection();
        saveToLocalStorage();
        showToast(`âœ… æˆåŠŸä¸º${selected.length}åå­¦ç”Ÿæ‰£åˆ†`, 'success');
        
        showBackupReminder();
    }
    
    // ç¼–è¾‘ç¬”è®°
    function editNote(i) {
        currentNoteIndex = i;
        const s = students[i];
        document.getElementById('noteName').textContent = s.å§“å;
        document.getElementById('note1').checked = s.ç¬”è®°1;
        document.getElementById('note2').checked = s.ç¬”è®°2;
        document.getElementById('noteModal').classList.add('show');
    }
    
    // ä¿å­˜ç¬”è®°
    function saveNote() {
        const s = students[currentNoteIndex];
        s.ç¬”è®°1 = document.getElementById('note1').checked;
        s.ç¬”è®°2 = document.getElementById('note2').checked;
        calc(currentNoteIndex);
        closeNote();
        render();
        saveToLocalStorage();
        showBackupReminder();
    }
    
    // å…³é—­ç¬”è®°
    function closeNote() {
        document.getElementById('noteModal').classList.remove('show');
    }
    
    // ç­›é€‰ç»„åˆ«
    function filterGroup() {
        currentFilter = document.getElementById('groupFilter').value;
        clearSelection();
        render();
    }
    
    // æœç´¢
    function doSearch() {
        const term = document.getElementById('search').value.toLowerCase();
        const tbody = document.getElementById('tbody');
        const rows = tbody.rows;
        
        let visibleStudents = students;
        if (currentFilter) {
            visibleStudents = students.filter(s => s.ç»„åˆ« === currentFilter);
        }
        
        for (let i = 0; i < rows.length; i++) {
            const s = visibleStudents[i];
            const match = s.å­¦å·.includes(term) || s.å§“å.includes(term);
            rows[i].style.display = match ? '' : 'none';
        }
    }
    
     // ==================== å†å²è®°å½•åŠŸèƒ½ ====================
     
     // æ·»åŠ å†å²è®°å½•
     function addHistory(actionType, affectedStudents, details = {}) {
         if (!currentClass) {
             console.warn('âš  æœªé€‰æ‹©ç­çº§ï¼Œæ— æ³•è®°å½•å†å²');
             return;
         }
         
         // ç¡®ä¿å½“å‰ç­çº§æ•°æ®æ˜¯æœ€æ–°çš„
         if (students.length > 0) {
             allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
         }
         
         const record = {
             id: Date.now(),
             timestamp: new Date().toISOString(),
             className: currentClass,
             actionType: actionType,
             affectedCount: affectedStudents,
             details: details,
             snapshot: JSON.parse(JSON.stringify(allClassesData[currentClass] || []))
         };
         
        historyRecords.unshift(record); // æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
         
         saveHistoryToStorage();
         
         console.log('ğŸ“ å·²æ·»åŠ å†å²è®°å½•:', {
             æ“ä½œ: actionType,
             å½±å“å­¦ç”Ÿ: affectedStudents,
             ç­çº§: currentClass,
             æ—¶é—´: new Date().toLocaleString('zh-CN')
         });
     }
     
     // ä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
     function saveHistoryToStorage() {
         try {
             localStorage.setItem('gradeHistory_v1', JSON.stringify(historyRecords));
         } catch (e) {
             console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
         }
     }
     
     // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
     function loadHistoryFromStorage() {
         try {
             const saved = localStorage.getItem('gradeHistory_v1');
             if (saved) {
                 historyRecords = JSON.parse(saved);
                 console.log('âœ… å·²åŠ è½½å†å²è®°å½•:', historyRecords.length, 'æ¡');
             } else {
                 console.log('ğŸ“ æš‚æ— å†å²è®°å½•');
                 historyRecords = [];
             }
         } catch (e) {
             console.error('âŒ åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
             historyRecords = [];
         }
     }
     
     // æ˜¾ç¤ºå†å²è®°å½•æ¨¡æ€çª—å£
    function showHistoryModal(tab = 'local') {
        console.log('ğŸ“œ æ‰“å¼€å†å²è®°å½•çª—å£');
        console.log('å†å²è®°å½•æ€»æ•°:', historyRecords.length);

        renderHistoryTable();

        document.getElementById('historyModal').classList.add('show');
        setHistoryTab(tab);
        console.log('âœ… å†å²è®°å½•çª—å£å·²æ˜¾ç¤º');
    }
     
     // æ¸²æŸ“å†å²è®°å½•è¡¨æ ¼
     function renderHistoryTable() {
         // æ˜¾ç¤ºæ‰€æœ‰è®°å½•
         const displayRecords = historyRecords;
         
         console.log('æ˜¾ç¤ºè®°å½•æ•°:', displayRecords.length);
         
         document.getElementById('historyCount').textContent = displayRecords.length;
         
         const tbody = document.getElementById('historyTableBody');
         tbody.innerHTML = '';
         
         if (displayRecords.length === 0) {
             tbody.innerHTML = `
                 <tr>
                     <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                         æš‚æ— å†å²è®°å½•<br>
                         <small style="color: #aaa; margin-top: 10px; display: block;">
                             æ‰§è¡Œæ‰¹é‡åŠ åˆ†ã€æ‰¹é‡æ‰£åˆ†ç­‰æ“ä½œåä¼šè‡ªåŠ¨è®°å½•
                         </small>
                     </td>
                 </tr>
             `;
         } else {
             displayRecords.forEach((record, index) => {
                 const row = tbody.insertRow();
                 const date = new Date(record.timestamp);
                 const timeStr = date.toLocaleString('zh-CN', {
                     year: 'numeric',
                     month: '2-digit',
                     day: '2-digit',
                     hour: '2-digit',
                     minute: '2-digit',
                     second: '2-digit'
                 });
                 
                 row.innerHTML = `
                     <td style="padding: 10px; white-space: nowrap;">${timeStr}</td>
                     <td style="padding: 10px; font-weight: bold; color: #2196f3;">${record.className}</td>
                     <td style="padding: 10px;">${record.actionType}</td>
                     <td style="padding: 10px;">${record.affectedCount}äºº</td>
                     <td style="padding: 10px; white-space: nowrap;">
                         <button class="btn btn-primary" onclick="viewHistorySnapshot(${record.id})" style="padding: 4px 8px; font-size: 12px;">
                             æŸ¥çœ‹
                         </button>
                         <button class="btn btn-success" onclick="restoreHistorySnapshot(${record.id})" style="padding: 4px 8px; font-size: 12px;">
                             æ¢å¤
                         </button>
                         <button class="btn btn-danger" onclick="deleteHistoryRecord(${record.id})" style="padding: 4px 8px; font-size: 12px;">
                             åˆ é™¤
                         </button>
                     </td>
                 `;
             });
         }
     }
     
     // æŸ¥çœ‹å†å²å¿«ç…§
     function viewHistorySnapshot(recordId) {
         const record = historyRecords.find(r => r.id === recordId);
         if (!record) {
             alert('æœªæ‰¾åˆ°è¯¥å†å²è®°å½•');
             return;
         }

         // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æ•°æ®å±•ç¤º
         const snapshot = record.snapshot;
         const date = new Date(record.timestamp).toLocaleString('zh-CN');
         
         let message = `å†å²å¿«ç…§è¯¦æƒ…\n\n`;
         message += `æ—¶é—´ï¼š${date}\n`;
         message += `ç­çº§ï¼š${record.className}\n`;
         message += `æ“ä½œï¼š${record.actionType}\n`;
         message += `å½±å“å­¦ç”Ÿï¼š${record.affectedCount}äºº\n\n`;
         
         if (record.details && Object.keys(record.details).length > 0) {
             message += 'è¯¦ç»†ä¿¡æ¯ï¼š\n';
             for (let key in record.details) {
                 message += `  ${key}: ${record.details[key]}\n`;
             }
         }
         
         message += `\næ€»å­¦ç”Ÿæ•°ï¼š${snapshot.length}äºº\n`;
         message += `å¹³å‡åˆ†ï¼š${(snapshot.reduce((sum, s) => sum + s.æ€»åˆ†, 0) / snapshot.length).toFixed(2)}`;
         
         alert(message);
     }
     
     // æ¢å¤å†å²å¿«ç…§
     function restoreHistorySnapshot(recordId) {
         const record = historyRecords.find(r => r.id === recordId);
         if (!record) {
             alert('æœªæ‰¾åˆ°è¯¥å†å²è®°å½•');
             return;
         }
         
         const date = new Date(record.timestamp).toLocaleString('zh-CN');
         if (!confirm(`ç¡®å®šè¦æ¢å¤åˆ°ä»¥ä¸‹æ—¶é—´ç‚¹çš„æ•°æ®å—ï¼Ÿ\n\næ—¶é—´ï¼š${date}\nç­çº§ï¼š${record.className}\n\nå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼`)) {
            return;
        }
         
         // æ¢å¤æ•°æ®
         allClassesData[record.className] = JSON.parse(JSON.stringify(record.snapshot));
         
         // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥ç­çº§ï¼Œæ›´æ–°æ˜¾ç¤º
         if (currentClass === record.className) {
             students = JSON.parse(JSON.stringify(record.snapshot));
             render();
         }
         
         saveToLocalStorage();
         closeHistoryModal();
         
         showToast('âœ… æ•°æ®å·²æ¢å¤åˆ°å†å²å¿«ç…§', 'success');
         
         // æ·»åŠ æ¢å¤æ“ä½œçš„å†å²è®°å½•
         addHistory('æ¢å¤å†å²å¿«ç…§', record.snapshot.length, {
             'æ¢å¤æ—¶é—´': date
         });
     }
     
     // åˆ é™¤å•æ¡å†å²è®°å½•
     function deleteHistoryRecord(recordId) {
         const record = historyRecords.find(r => r.id === recordId);
         if (!record) {
             alert('æœªæ‰¾åˆ°è¯¥å†å²è®°å½•');
             return;
         }
         
         const date = new Date(record.timestamp).toLocaleString('zh-CN');
         if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ\n\næ—¶é—´ï¼š${date}\næ“ä½œï¼š${record.actionType}\nç­çº§ï¼š${record.className}`)) {
             return;
         }
         
         // ä»æ•°ç»„ä¸­åˆ é™¤
         const index = historyRecords.findIndex(r => r.id === recordId);
         if (index > -1) {
             historyRecords.splice(index, 1);
             saveHistoryToStorage();
             
             // åˆ·æ–°æ˜¾ç¤º
             renderHistoryTable();
             
             showToast('å†å²è®°å½•å·²åˆ é™¤', 'success');
             console.log('âœ… å·²åˆ é™¤å†å²è®°å½•:', recordId);
         }
     }
     
     // æ¸…é™¤æ‰€æœ‰å†å²è®°å½•
     function clearAllHistory() {
         if (historyRecords.length === 0) {
             alert('å½“å‰æ²¡æœ‰å†å²è®°å½•');
             return;
         }
         
         if (!confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ\n\nå…±æœ‰ ${historyRecords.length} æ¡è®°å½•\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
             return;
         }
         
         historyRecords = [];
         saveHistoryToStorage();
         
         // åˆ·æ–°æ˜¾ç¤º
         renderHistoryTable();
         
         showToast('æ‰€æœ‰å†å²è®°å½•å·²æ¸…é™¤', 'success');
    }

    // å¯¼å‡ºå†å²è®°å½•
    function exportHistory() {
        try {
            const exportData = {
                version: '1.0',
                exportTime: new Date().toISOString(),
                totalRecords: historyRecords.length,
                records: historyRecords
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `æˆç»©å†å²è®°å½•_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showToast('å†å²è®°å½•å¯¼å‡ºæˆåŠŸ', 'success');
        } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
        }
    }

    // ==================== äº‘ç«¯æ•°æ®é¢„è§ˆ / æ¢å¤ ====================

    function openCloudRestore() {
        showHistoryModal('cloud');
    }

    function showCloudDataModal() {
        if (!lastPulledCloudData) {
            alert('å°šæœªä»äº‘ç«¯åŠ è½½æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»â€œâ˜ï¸ ä»äº‘ç«¯æ¢å¤â€ã€‚');
            return;
        }
        const modal = document.getElementById('cloudDataModal');
        if (modal) {
            modal.classList.add('show');
            updateCloudDataPreview();
        }
    }

    function closeCloudDataModal() {
        const modal = document.getElementById('cloudDataModal');
        if (modal) {
            modal.classList.remove('show');
        }
    }

    function copyCloudData() {
        if (!lastPulledCloudData) {
            alert('æš‚æ— å¯å¤åˆ¶çš„äº‘ç«¯æ•°æ®ï¼Œè¯·å…ˆæ¢å¤æˆ–é¢„è§ˆäº‘ç«¯ç‰ˆæœ¬ã€‚');
            return;
        }
        const dataStr = JSON.stringify(lastPulledCloudData, null, 2);
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(dataStr)
                .then(() => showToast('âœ… å·²å¤åˆ¶äº‘ç«¯JSONæ•°æ®', 'success'))
                .catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopy(dataStr);
                });
        } else {
            fallbackCopy(dataStr);
        }
    }

    function fallbackCopy(text) {
        try {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('âœ… å·²å¤åˆ¶äº‘ç«¯JSONæ•°æ®', 'success');
        } catch (e) {
            console.error('å¤åˆ¶å¤±è´¥:', e);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰ä¸­åå¤åˆ¶ã€‚');
        }
    }

    function updateCloudDataPreview() {
        const summaryEl = document.getElementById('cloudDataSummary');
        const textarea = document.getElementById('cloudDataTextarea');
        if (!summaryEl || !textarea) return;

        if (!lastPulledCloudData) {
            summaryEl.textContent = 'å°šæœªåŠ è½½äº‘ç«¯æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»â€œâ˜ï¸ ä»äº‘ç«¯æ¢å¤â€ã€‚';
            textarea.value = '';
            return;
        }

        const classes = lastPulledCloudData.classes || {};
        const classNames = Object.keys(classes);
        const studentCount = classNames.reduce((sum, name) => {
            const arr = classes[name];
            return sum + (Array.isArray(arr) ? arr.length : 0);
        }, 0);
        const historyList = lastPulledCloudData.historyRecords || lastPulledCloudData.history || [];
        const historyCount = Array.isArray(historyList) ? historyList.length : 0;
        const timestamp = lastPulledCloudData.timestamp || lastPulledCloudData.lastModified || lastPulledCloudData.exportTime || '';
        const meta = lastPulledFileMeta || {};

        summaryEl.innerHTML = `
            <strong>äº‘ç«¯æ•°æ®æ¦‚è§ˆ</strong><br>
            ç­çº§ï¼š${classNames.length} ä¸ª | å­¦ç”Ÿè®°å½•ï¼š${studentCount} æ¡${historyCount ? ` | å†å²è®°å½•ï¼š${historyCount} æ¡` : ''}
            ${timestamp ? `<br>æ•°æ®æ—¶é—´ï¼š${timestamp}` : ''}
            ${meta.path ? `<br>æ¥æºæ–‡ä»¶ï¼š${escapeHtml(meta.path)}${meta.applied === false ? 'ï¼ˆä»…é¢„è§ˆï¼‰' : ''}` : ''}
            ${meta.size ? `<br>æ–‡ä»¶å¤§å°ï¼š${formatFileSize(meta.size)}` : ''}
            ${meta.fetchedAt ? `<br>æ‹‰å–æ—¶é—´ï¼š${formatDateTime(meta.fetchedAt)}` : ''}
            ${classNames.length > 0 ? `<br>ç­çº§åˆ—è¡¨ï¼š${classNames.map(escapeHtml).join('ã€')}` : ''}
        `;

        if (textarea) {
            textarea.value = JSON.stringify(lastPulledCloudData, null, 2);
            textarea.scrollTop = 0;
        }
    }

    async function refreshGiteeFileList(force = false) {
        if (force) {
            giteeFileListCache = null;
        }
        const statusEl = document.getElementById('cloudFileListStatus');
        const tbody = document.getElementById('cloudFileTableBody');
        if (statusEl) {
            statusEl.textContent = 'æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...';
        }
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 25px; color: #999;">æ­£åœ¨åŠ è½½...</td></tr>`;
        }
        const list = await fetchGiteeFileList();
        renderGiteeFileList(list);
    }

    async function fetchGiteeFileList() {
        if (giteeFileListCache && !giteeFileListLoading) {
            return giteeFileListCache;
        }
        if (giteeFileListLoading) {
            return giteeFileListCache || [];
        }

        if (!giteeConfig.owner || !giteeConfig.repo || !giteeConfig.token) {
            showToast('âŒ Giteeé…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•è·å–æ–‡ä»¶åˆ—è¡¨', 'error', 5000);
            return [];
        }

        giteeFileListLoading = true;

        const statusEl = document.getElementById('cloudFileListStatus');
        if (statusEl) {
            statusEl.textContent = 'æ­£åœ¨ä»äº‘ç«¯æ‹‰å–æ–‡ä»¶åˆ—è¡¨...';
        }

        try {
            const branchName = encodeURIComponent(giteeConfig.branch || 'master');
            const branchUrl = `https://gitee.com/api/v5/repos/${giteeConfig.owner}/${giteeConfig.repo}/branches/${branchName}?access_token=${giteeConfig.token}`;
            const { data: branchData, note: branchNote } = await fetchJsonWithFallback(branchUrl, { method: 'GET' });
            const sha = branchData.commit && branchData.commit.sha;
            if (!sha) {
                throw new Error('åˆ†æ”¯ä¿¡æ¯ç¼ºå°‘ commit.sha');
            }

            const treeUrl = `https://gitee.com/api/v5/repos/${giteeConfig.owner}/${giteeConfig.repo}/git/trees/${sha}?recursive=1&access_token=${giteeConfig.token}`;
            const { data: treeData, note: treeNote } = await fetchJsonWithFallback(treeUrl, { method: 'GET' });
            if (!treeData || !Array.isArray(treeData.tree)) {
                throw new Error('ä»“åº“æ–‡ä»¶æ ‘è¿”å›æ ¼å¼å¼‚å¸¸');
            }

            const fetchNote = branchNote || treeNote || '';
            const truncated = !!treeData.truncated;
            const directories = getConfiguredDirectories();
            const list = treeData.tree
                .filter(node => node.type === 'blob' && node.path && node.path.toLowerCase().endsWith('.json'))
                .filter(node => {
                    if (!directories || directories.length === 0) return true;
                    return directories.some(dir => {
                        const normalizedDir = (dir || '').replace(/^\/+/g, '').replace(/\/+$/g, '');
                        const prefix = normalizedDir ? `${normalizedDir}/` : '';
                        return node.path.startsWith(prefix);
                    });
                })
                .map(node => {
                    const dir = node.path.includes('/') ? node.path.substring(0, node.path.lastIndexOf('/')) : '';
                    return {
                        type: 'file',
                        name: node.path.split('/').pop(),
                        path: node.path,
                        size: node.size,
                        __directory: dir,
                        last_commit: null,
                        updated_at: null
                    };
                })
                .sort((a, b) => {
                    const dateA = parseTimestampFromName(a.name);
                    const dateB = parseTimestampFromName(b.name);
                    const timeA = dateA ? dateA.getTime() : 0;
                    const timeB = dateB ? dateB.getTime() : 0;
                    return timeB - timeA;
                });

            giteeFileListCache = list;

            if (statusEl) {
                const parts = [
                    `å…±æ‰¾åˆ° <strong>${list.length}</strong> ä¸ªæ–‡ä»¶${giteeConfig.filePath ? `ï¼ˆå½“å‰é»˜è®¤ï¼š${escapeHtml(giteeConfig.filePath)}ï¼‰` : ''}`
                ];
                const dirLabels = directories.map(dir => dir || 'æ ¹ç›®å½•').join('ã€');
                if (dirLabels) {
                    parts.push(`ç›®å½•ï¼š${escapeHtml(dirLabels)}`);
                }
                if (truncated) {
                    parts.push('<span style="color:#c0392b;">âš ï¸ è¿”å›æ•°æ®è¢«æˆªæ–­ï¼Œä»“åº“æ–‡ä»¶è¾ƒå¤šæ—¶å¯èƒ½é—æ¼ï¼Œè¯·è€ƒè™‘ç¼©å°ç›®å½•èŒƒå›´ã€‚</span>');
                }
                if (fetchNote) {
                    parts.push(`<span style="color:#34495e;">æ•°æ®æ¥æº${escapeHtml(fetchNote)}</span>`);
                }
                statusEl.innerHTML = parts.join('<br>');
            }

            return list;
        } catch (error) {
            console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
            showToast(`âŒ è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š${error.message}`, 'error', 6000);
            if (statusEl) {
                statusEl.innerHTML = `<span style="color:#c0392b;">è·å–äº‘ç«¯æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š${escapeHtml(error.message)}ã€‚è¯·ç¡®è®¤ token æƒé™ï¼Œæˆ–åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ˜¯å¦æœ‰è·¨åŸŸï¼ˆCORSï¼‰æŠ¥é”™ã€‚</span>`;
            }
            return [];
        } finally {
            giteeFileListLoading = false;
        }
    }


function renderGiteeFileList(list = []) {
        const statusEl = document.getElementById('cloudFileListStatus');
        const tbody = document.getElementById('cloudFileTableBody');
        if (!tbody) return;

        if (!list || list.length === 0) {
            if (statusEl) {
                statusEl.textContent = 'æœªæ‰¾åˆ°ä»»ä½•JSONæ–‡ä»¶ï¼Œè¯·ç¡®è®¤ä»“åº“ä¸­å·²ä¸Šä¼ æ•°æ®ã€‚';
            }
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align:center; padding: 25px; color: #999;">æš‚æ— æ–‡ä»¶</td>
                </tr>`;
            return;
        }

        if (statusEl) {
            const defaultInfo = giteeConfig.filePath ? `ï¼ˆå½“å‰é»˜è®¤ï¼š${escapeHtml(giteeConfig.filePath)}ï¼‰` : '';
            const dirLabels = getConfiguredDirectories().map(dir => dir || 'æ ¹ç›®å½•').join('ã€');
            statusEl.innerHTML = `å…±æ‰¾åˆ° <strong>${list.length}</strong> ä¸ªæ–‡ä»¶ï¼Œç‚¹å‡»â€œåŠ è½½â€å³å¯æ¢å¤åˆ°è¯¥ç‰ˆæœ¬ï¼Œæˆ–â€œé¢„è§ˆâ€æŸ¥çœ‹å†…å®¹ã€‚${defaultInfo}` +
                (dirLabels ? `<br>ç›®å½•ï¼š${escapeHtml(dirLabels)}` : '');
        }

        tbody.innerHTML = '';
        list.forEach(item => {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.style.padding = '8px';
            const displayNameHtml = formatFileEntryName(item);
            if (item.path === giteeConfig.filePath) {
                tr.style.background = '#fff7e6';
                nameTd.innerHTML = `${displayNameHtml}<div style="color:#d35400; font-size:12px; margin-top:4px;">å½“å‰é»˜è®¤æ–‡ä»¶</div>`;
            } else {
                nameTd.innerHTML = displayNameHtml;
            }

            const sizeTd = document.createElement('td');
            sizeTd.style.padding = '8px';
            sizeTd.textContent = formatFileSize(item.size);

            const dateTd = document.createElement('td');
            dateTd.style.padding = '8px';
            const parsedTime = parseTimestampFromName(item.name) || item.last_commit?.committer?.date || item.updated_at;
            dateTd.textContent = formatDateTime(parsedTime);

            const actionTd = document.createElement('td');
            actionTd.style.padding = '8px';
            actionTd.style.display = 'flex';
            actionTd.style.gap = '8px';
            actionTd.style.flexWrap = 'wrap';

            const previewBtn = document.createElement('button');
            previewBtn.className = 'btn btn-primary';
            previewBtn.textContent = 'é¢„è§ˆ';
            previewBtn.style.padding = '4px 10px';
            previewBtn.onclick = () => previewGiteeFile(item.path || uniqueKeyFromFile(item));

            const loadBtn = document.createElement('button');
            loadBtn.className = 'btn btn-success';
            loadBtn.textContent = 'åŠ è½½';
            loadBtn.style.padding = '4px 10px';
            loadBtn.onclick = () => loadGiteeFile(item.path || uniqueKeyFromFile(item), { setDefault: false });

            const setDefaultBtn = document.createElement('button');
            setDefaultBtn.className = 'btn btn-warning';
            setDefaultBtn.textContent = 'åŠ è½½å¹¶è®¾ä¸ºé»˜è®¤';
            setDefaultBtn.style.padding = '4px 10px';
            setDefaultBtn.onclick = () => loadGiteeFile(item.path || uniqueKeyFromFile(item), { setDefault: true });

            actionTd.appendChild(previewBtn);
            actionTd.appendChild(loadBtn);
            actionTd.appendChild(setDefaultBtn);

            tr.appendChild(nameTd);
            tr.appendChild(sizeTd);
            tr.appendChild(dateTd);
            tr.appendChild(actionTd);

            tbody.appendChild(tr);
        });
    }

    async function previewGiteeFile(path) {
        const success = await pullFromGitee({ path, apply: false, silent: true, reason: 'preview-file' });
        if (success) {
            showCloudDataModal();
            showToast(`ğŸ‘€ å·²é¢„è§ˆ ${path}`, 'info', 2200);
        }
    }

    async function loadGiteeFile(path, options = {}) {
        const { setDefault = false } = options;
        const success = await pullFromGitee({ path, setDefault, apply: true, silent: false, reason: 'manual-file-select' });
        if (success) {
            setHistoryTab('local');
        }
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').classList.remove('show');
    }

     // ==================== éšæœºæŠ½å·åŠŸèƒ½ ====================
     
     // æ˜¾ç¤ºéšæœºæŠ½å·çª—å£
     function showRandomPickModal() {
         console.log('ğŸ² æ‰“å¼€éšæœºæŠ½å·çª—å£');
         
         // è¯»å–å½“å‰è®¾ç½®
         const start = parseInt(document.getElementById('randomRangeStart').value) || 1;
         const end = parseInt(document.getElementById('randomRangeEnd').value) || 40;
         
         currentNumberRange = { start, end };
         updateRandomPickStats();
         
         document.getElementById('randomPickModal').classList.add('show');
     }
     
     // å…³é—­éšæœºæŠ½å·çª—å£
     function closeRandomPickModal() {
         document.getElementById('randomPickModal').classList.remove('show');
     }
     
     // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
     function updateRandomPickStats() {
         const start = parseInt(document.getElementById('randomRangeStart').value) || 1;
         const end = parseInt(document.getElementById('randomRangeEnd').value) || 40;
         
         const total = end - start + 1;
         const picked = pickedNumbers.length;
         const remaining = total - picked;
         
         document.getElementById('randomTotalCount').textContent = total;
         document.getElementById('randomPickedCount').textContent = picked;
         document.getElementById('randomRemainingCount').textContent = remaining;
     }
     
     // æ‰§è¡ŒéšæœºæŠ½å·
     function doRandomPick() {
         const start = parseInt(document.getElementById('randomRangeStart').value);
         const end = parseInt(document.getElementById('randomRangeEnd').value);
         const count = parseInt(document.getElementById('randomPickCount').value);
         
         // éªŒè¯è¾“å…¥
         if (!start || !end || start < 1 || end < 1) {
             alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å·ç èŒƒå›´ï¼ˆå¿…é¡»å¤§äº0ï¼‰');
             return;
         }
         
         if (start > end) {
             alert('èµ·å§‹å·ç ä¸èƒ½å¤§äºç»“æŸå·ç ');
             return;
         }
         
         if (!count || count < 1) {
             alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ½å–æ•°é‡ï¼ˆè‡³å°‘1ä¸ªï¼‰');
             return;
         }
         
         // æ£€æŸ¥èŒƒå›´æ˜¯å¦æ”¹å˜
         if (currentNumberRange.start !== start || currentNumberRange.end !== end) {
             if (pickedNumbers.length > 0) {
                 if (!confirm('å·ç èŒƒå›´å·²æ”¹å˜ï¼Œæ˜¯å¦é‡ç½®å·²æŠ½å–è®°å½•ï¼Ÿ')) {
                     return;
                 }
                 pickedNumbers = [];
             }
             currentNumberRange = { start, end };
         }
         
         // ç”Ÿæˆå¯ç”¨å·ç æ± 
         const available = [];
         for (let i = start; i <= end; i++) {
             if (!pickedNumbers.includes(i)) {
                 available.push(i);
             }
         }
         
         // æ£€æŸ¥å‰©ä½™æ•°é‡
         if (available.length === 0) {
             alert('æ‰€æœ‰å·ç éƒ½å·²æŠ½å–å®Œæ¯•ï¼\n\nè¯·ç‚¹å‡»"é‡ç½®"æŒ‰é’®å¼€å§‹æ–°ä¸€è½®æŠ½å·ã€‚');
             return;
         }
         
         if (count > available.length) {
             alert(`å‰©ä½™å·ç ä¸è¶³ï¼\n\nå¯æŠ½å–æ•°é‡ï¼š${available.length}ä¸ª\næ‚¨è¦æŠ½å–ï¼š${count}ä¸ª`);
             return;
         }
         
         // éšæœºæŠ½å–
         const picked = [];
         const tempAvailable = [...available];
         
         for (let i = 0; i < count; i++) {
             const randomIndex = Math.floor(Math.random() * tempAvailable.length);
             const number = tempAvailable[randomIndex];
             picked.push(number);
             tempAvailable.splice(randomIndex, 1);
         }
         
         // æ’åºï¼ˆä»å°åˆ°å¤§ï¼‰
         picked.sort((a, b) => a - b);
         
         // æ·»åŠ åˆ°å·²æŠ½å–åˆ—è¡¨
         pickedNumbers.push(...picked);
         pickedNumbers.sort((a, b) => a - b);
         
         // æ˜¾ç¤ºç»“æœ
         displayRandomPickResult(picked);
         updateRandomPickStats();
         
         console.log('âœ… æŠ½å–å®Œæˆ:', picked);
         console.log('å·²æŠ½å–:', pickedNumbers);
     }
     
     // æ˜¾ç¤ºæŠ½å–ç»“æœ
     function displayRandomPickResult(numbers) {
         const resultDiv = document.getElementById('randomPickResult');
         const resultList = document.getElementById('randomPickResultList');
         
         resultDiv.style.display = 'block';
         resultList.innerHTML = '';
         
         numbers.forEach(num => {
             const badge = document.createElement('div');
             badge.style.cssText = `
                 display: inline-flex;
                 align-items: center;
                 justify-content: center;
                 min-width: 60px;
                 height: 60px;
                 background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                 color: white;
                 font-size: 24px;
                 font-weight: bold;
                 border-radius: 10px;
                 box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                 animation: popIn 0.5s ease-out;
             `;
             badge.textContent = num;
             resultList.appendChild(badge);
         });
         
         // æ·»åŠ åŠ¨ç”»æ ·å¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
         if (!document.getElementById('randomPickAnimationStyle')) {
             const style = document.createElement('style');
             style.id = 'randomPickAnimationStyle';
             style.textContent = `
                 @keyframes popIn {
                     0% {
                         transform: scale(0);
                         opacity: 0;
                     }
                     50% {
                         transform: scale(1.2);
                     }
                     100% {
                         transform: scale(1);
                         opacity: 1;
                     }
                 }
             `;
             document.head.appendChild(style);
         }
     }
     
     // é‡ç½®æŠ½å·
     function resetRandomPick() {
         if (pickedNumbers.length === 0) {
             alert('å½“å‰æ²¡æœ‰å·²æŠ½å–çš„å·ç ');
             return;
         }
         
         if (!confirm(`ç¡®å®šè¦é‡ç½®å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤å·²æŠ½å–çš„ ${pickedNumbers.length} ä¸ªå·ç `)) {
             return;
         }
         
         pickedNumbers = [];
         document.getElementById('randomPickResult').style.display = 'none';
         updateRandomPickStats();
         
         showToast('å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°æŠ½å·', 'success');
     }

     
     // æŒ‰å­¦å·åç¼€æ‰¹é‡è°ƒæ•´åˆ†æ•°ï¼ˆæ”¹ä¸ºåŸºäºå¤é€‰æ¡†é€‰ä¸­ï¼‰
     function adjustSuffix(isAdd) {
         // è·å–æ‰€æœ‰å‹¾é€‰çš„å­¦ç”Ÿ
         const selected = students.filter(s => s.selected);
         
        if (selected.length === 0) {
            showToast('è¯·å…ˆå‹¾é€‰å­¦ç”Ÿï¼å¯ç”¨"å®šä½"æŒ‰é’®å¿«é€Ÿé€‰æ‹©', 'warning');
            return;
        }
         
         const field = document.getElementById('suffixField').value;
         const delta = parseFloat(document.getElementById('suffixDelta').value) || 1;
         const score = isAdd ? Math.abs(delta) : -Math.abs(delta);
         
         const fieldNames = {
             'ketang': 'è¯¾å ‚è¡¨ç°',
             'xiaozu': 'å°ç»„æ´»åŠ¨',
             'kaoshi': 'è€ƒè¯•æˆç»©'
         };
         
         const fieldName = fieldNames[field];
         const action = isAdd ? 'åŠ ' : 'å‡';
         
         if (!confirm(`ç¡®å®šè¦ä¸º${selected.length}åå­¦ç”Ÿçš„${fieldName}${action}${Math.abs(score)}åˆ†å—ï¼Ÿ`)) {
             return;
         }
         
         selected.forEach(s => {
             const idx = students.indexOf(s);
             if (field === 'ketang') {
                 s.è¯¾å ‚è¡¨ç° += score;
             } else if (field === 'xiaozu') {
                 s.å°ç»„æ´»åŠ¨ += score;
             } else if (field === 'kaoshi') {
                 s.è€ƒè¯•æˆç»© = Math.min(50, Math.max(0, s.è€ƒè¯•æˆç»© + score));
             }
             calc(idx);
         });
         
         // æ¸…é™¤é€‰ä¸­çŠ¶æ€
         clearSelection();
         render();
         saveToLocalStorage();
         
         showToast(`âœ… æˆåŠŸä¸º${selected.length}åå­¦ç”Ÿ${action}åˆ†ï¼`, 'success');
         
        showBackupReminder();
     }
     
     // æ¸…é™¤å­¦å·åç¼€é«˜äº®
     function clearSuffixHighlight() {
         suffixMatches = [];
         
         // é‡æ–°æ¸²æŸ“ä»¥æ¸…é™¤é«˜äº®
         render();
    }
    
    // é¼ æ ‡äº‹ä»¶å¤„ç†
    function handleRowMouseDown(e, index) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.contentEditable === 'true') {
            return;
        }
        
        e.preventDefault();
        
        if (e.shiftKey && lastClickedIndex !== -1) {
            selectRange(lastClickedIndex, index);
        } else if (e.ctrlKey || e.metaKey) {
            toggle(index);
            lastClickedIndex = index;
        } else {
            isSelecting = true;
            startSelectIndex = index;
            endSelectIndex = index;
            lastClickedIndex = index;
            
            if (!e.ctrlKey && !e.metaKey) {
                clearSelection();
            }
            
            students[index].selected = true;
            updateSelectAll();
            updateStats();
        }
    }
    
    function handleRowMouseEnter(e, index) {
        if (isSelecting && startSelectIndex !== -1) {
            endSelectIndex = index;
            updateSelectionVisual();
        }
    }
    
    function handleRowMouseUp(e, index) {
        if (isSelecting) {
            isSelecting = false;
            endSelectIndex = index;
            
            if (startSelectIndex !== -1) {
                selectRange(startSelectIndex, endSelectIndex);
            }
            
            clearSelectionVisual();
        }
    }
    
    function selectRange(start, end) {
        const startIdx = Math.min(start, end);
        const endIdx = Math.max(start, end);
        
        for (let i = startIdx; i <= endIdx; i++) {
            students[i].selected = true;
        }
        
        updateSelectAll();
        updateStats();
        render();
    }
    
    function updateSelectionVisual() {
        if (startSelectIndex === -1 || endSelectIndex === -1) return;
        
        const startIdx = Math.min(startSelectIndex, endSelectIndex);
        const endIdx = Math.max(startSelectIndex, endSelectIndex);
        
        const tbody = document.getElementById('tbody');
        const rows = tbody.rows;
        
        clearSelectionVisual();
        
        for (let i = startIdx; i <= endIdx; i++) {
            if (rows[i]) {
                rows[i].classList.add('select-range');
            }
        }
    }
    
    function clearSelectionVisual() {
        const tbody = document.getElementById('tbody');
        const rows = tbody.rows;
        
        for (let i = 0; i < rows.length; i++) {
            rows[i].classList.remove('select-range');
        }
    }
    
    // åˆ‡æ¢ç­çº§
    function switchClass() {
        // ä¿å­˜å½“å‰ç­çº§æ•°æ®
        if (currentClass && students.length > 0) {
            allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
            saveToLocalStorage();
        }
        
        document.getElementById('main').style.display = 'none';
        document.getElementById('welcome').style.display = 'block';
        currentFilter = '';
        document.getElementById('groupFilter').value = '';
        updateClassStatus();
    }
    
    // å¯¼å…¥Excel
    function importExcel() {
        document.getElementById('fileInput').click();
    }
    
    // åŠ è½½æ–‡ä»¶
    function loadFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                if (workbook.SheetNames.includes('æ‰€æœ‰ç­çº§æ±‡æ€»')) {
                    importAllClasses(workbook);
                } else {
                    importSingleClass(workbook);
                }
                
                alert('å¯¼å…¥æˆåŠŸï¼');
            } catch (error) {
                alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                console.error('å¯¼å…¥é”™è¯¯:', error);
            }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }
    
    // å¯¼å…¥å•ä¸ªç­çº§
    function importSingleClass(workbook) {
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        
        let className;
        if (json[0] && json[0]['ç­çº§']) {
            className = json[0]['ç­çº§'];
        } else {
            className = workbook.SheetNames[0];
        }
        
        // å¤„ç†ç­çº§åç§°å…¼å®¹æ€§
        if (className === '25é€šèˆªè¿ç»´ç­') {
            className = '25åº”ç”µ12ç­';
        }
        
        if (!classesData[className]) {
            alert('æœªçŸ¥çš„ç­çº§ï¼š' + className);
            return;
        }
        
        const originalData = classesData[className];
        students = originalData.map((item, i) => {
            const importedStudent = json.find(row => 
                row['å­¦å·'] === item[0] || row['å§“å'] === item[1]
            );
            
            let group;
            if (className === '25åº”ç”µ12ç­') {
                group = getGroupForYingDian(i);
            } else {
                group = getGroupForStudent(className, i);
            }
            
            // å…¼å®¹æ—§å­—æ®µå
            let ketangScore = 0;
            let xiaozuScore = 0;
            
            if (importedStudent) {
                ketangScore = parseFloat(importedStudent['è¯¾å ‚è¡¨ç°']) || 
                            parseFloat(importedStudent['å¹³æ—¶è¡¨ç°']) || 0;
                xiaozuScore = parseFloat(importedStudent['å°ç»„æ´»åŠ¨']) || 0;
            }
            
            return {
                å­¦å·: item[0],
                å§“å: item[1],
                ç»„åˆ«: group,
                å­ç­çº§: className === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                è¯¾å ‚è¡¨ç°: ketangScore,
                å°ç»„æ´»åŠ¨: xiaozuScore,
                ç¬”è®°1: importedStudent ? (importedStudent['ç¬”è®°1'] === 'âˆš' || importedStudent['ç¬”è®°1'] === true) : false,
                ç¬”è®°2: importedStudent ? (importedStudent['ç¬”è®°2'] === 'âˆš' || importedStudent['ç¬”è®°2'] === true) : false,
                ç¬”è®°æ€»åˆ†: 0,
                è€ƒè¯•æˆç»©: importedStudent ? (parseFloat(importedStudent['è€ƒè¯•æˆç»©']) || 0) : 0,
                å¹³æ—¶æ€»åˆ†: 0,
                æ€»åˆ†: 0,
                selected: false
            };
        });
        
        students.forEach((s, i) => calc(i));
        currentClass = className;
        allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
        
        currentFilter = '';
        showMain();
        updateGroups();
        render();
        updateClassStatus();
        saveToLocalStorage();
    }
    
    // å¯¼å…¥æ‰€æœ‰ç­çº§
    function importAllClasses(workbook) {
        allClassesData = {};
        let firstClass = null;
        let importCount = 0;
        
        // ä»æ±‡æ€»è¡¨å¯¼å…¥
        if (workbook.SheetNames.includes('æ‰€æœ‰ç­çº§æ±‡æ€»')) {
            const sheet = workbook.Sheets['æ‰€æœ‰ç­çº§æ±‡æ€»'];
            const json = XLSX.utils.sheet_to_json(sheet);
            
            // æŒ‰ç­çº§åˆ†ç»„å¤„ç†
            const classGroups = {};
            json.forEach(row => {
                let className = row['ç­çº§'];
                if (className === '25é€šèˆªè¿ç»´ç­') {
                    className = '25åº”ç”µ12ç­';
                }
                if (!className || !classesData[className]) return;
                
                if (!classGroups[className]) {
                    classGroups[className] = [];
                    if (!firstClass) firstClass = className;
                }
                
                classGroups[className].push(row);
            });
            
            // ä¸ºæ¯ä¸ªç­çº§å¤„ç†æ•°æ®
            Object.keys(classGroups).forEach(className => {
                const classRows = classGroups[className];
                const originalData = classesData[className];
                
                allClassesData[className] = originalData.map((item, i) => {
                    const importedStudent = classRows.find(row => 
                        row['å­¦å·'] === item[0] || row['å§“å'] === item[1]
                    );
                    
                    let group;
                    if (className === '25åº”ç”µ12ç­') {
                        group = getGroupForYingDian(i);
                    } else {
                        group = getGroupForStudent(className, i);
                    }
                    
                    let ketangScore = 0;
                    let xiaozuScore = 0;
                    
                    if (importedStudent) {
                        ketangScore = parseFloat(importedStudent['è¯¾å ‚è¡¨ç°']) || 
                                    parseFloat(importedStudent['å¹³æ—¶è¡¨ç°']) || 0;
                        xiaozuScore = parseFloat(importedStudent['å°ç»„æ´»åŠ¨']) || 0;
                    }
                    
                    return {
                        å­¦å·: item[0],
                        å§“å: item[1],
                        ç»„åˆ«: group,
                        å­ç­çº§: className === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                        è¯¾å ‚è¡¨ç°: ketangScore,
                        å°ç»„æ´»åŠ¨: xiaozuScore,
                        ç¬”è®°1: importedStudent ? (importedStudent['ç¬”è®°1'] === 'âˆš' || importedStudent['ç¬”è®°1'] === true) : false,
                        ç¬”è®°2: importedStudent ? (importedStudent['ç¬”è®°2'] === 'âˆš' || importedStudent['ç¬”è®°2'] === true) : false,
                        ç¬”è®°æ€»åˆ†: 0,
                        è€ƒè¯•æˆç»©: importedStudent ? (parseFloat(importedStudent['è€ƒè¯•æˆç»©']) || 0) : 0,
                        å¹³æ—¶æ€»åˆ†: 0,
                        æ€»åˆ†: 0,
                        selected: false
                    };
                });
                
                // é‡æ–°è®¡ç®—åˆ†æ•°
                allClassesData[className].forEach(s => {
                    s.ç¬”è®°æ€»åˆ† = (s.ç¬”è®°1 ? 5 : 0) + (s.ç¬”è®°2 ? 5 : 0);
                    s.å¹³æ—¶æ€»åˆ† = s.è¯¾å ‚è¡¨ç° + s.å°ç»„æ´»åŠ¨ + s.ç¬”è®°æ€»åˆ†;
                    s.æ€»åˆ† = s.å¹³æ—¶æ€»åˆ† + s.è€ƒè¯•æˆç»©;
                });
                
                importCount++;
            });
        }
        
        // æ˜¾ç¤ºç¬¬ä¸€ä¸ªç­çº§
        if (firstClass && allClassesData[firstClass]) {
            currentClass = firstClass;
            students = JSON.parse(JSON.stringify(allClassesData[firstClass]));
            
            currentFilter = '';
            showMain();
            updateGroups();
            render();
            updateClassStatus();
            saveToLocalStorage();
            
            alert(`æˆåŠŸå¯¼å…¥ ${importCount} ä¸ªç­çº§çš„æ•°æ®ï¼\nå½“å‰æ˜¾ç¤ºï¼š${currentClass}`);
        }
    }
    
    // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
    function showExportOptions() {
        // ä¿å­˜å½“å‰ç­çº§æ•°æ®
        if (currentClass && students.length > 0) {
            allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
            saveToLocalStorage();
        }
        
        const btn = document.getElementById('exportCurrentBtn');
        btn.innerHTML = `å¯¼å‡ºå½“å‰ç­çº§ (${currentClass || 'æœªé€‰æ‹©'})`;
        
        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        const debugInfo = document.getElementById('exportDebugInfo');
        const classInfo = ['25æ— äººæœºä¸‰ç­', '25æ¶²å‹ä¸‰ç­', '25æ— äººæœºå››ç­', '25åº”ç”µ12ç­'].map(className => {
            const data = allClassesData[className];
            if (data) {
                const hasScores = data.some(s => s.è¯¾å ‚è¡¨ç° !== 0 || s.å°ç»„æ´»åŠ¨ !== 0 || s.è€ƒè¯•æˆç»© !== 0);
                return `${className}: ${data.length}äºº ${hasScores ? '(æœ‰æˆç»©)' : '(æ— æˆç»©)'}`;
            } else {
                return `${className}: æœªåŠ è½½`;
            }
        });
        debugInfo.innerHTML = classInfo.join('<br>');
        
        document.getElementById('exportModal').classList.add('show');
    }
    
    // å…³é—­å¯¼å‡ºæ¨¡æ€çª—å£
    function closeExportModal() {
        document.getElementById('exportModal').classList.remove('show');
    }
    
    // å¯¼å‡ºå½“å‰ç­çº§
    function exportCurrentClass() {
        if (!currentClass || students.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­çº§');
            return;
        }
        
        const data = students.map(s => ({
            'ç­çº§': currentClass,
            'å­¦å·': s.å­¦å·,
            'å§“å': s.å§“å,
            'ç»„åˆ«': s.ç»„åˆ«,
            'è¯¾å ‚è¡¨ç°': s.è¯¾å ‚è¡¨ç°,
            'å°ç»„æ´»åŠ¨': s.å°ç»„æ´»åŠ¨,
            'ç¬”è®°1': s.ç¬”è®°1 ? 'âˆš' : '',
            'ç¬”è®°2': s.ç¬”è®°2 ? 'âˆš' : '',
            'ç¬”è®°æ€»åˆ†': s.ç¬”è®°æ€»åˆ†,
            'å¹³æ—¶æ€»åˆ†': s.å¹³æ—¶æ€»åˆ†,
            'è€ƒè¯•æˆç»©': s.è€ƒè¯•æˆç»©,
            'æ€»åˆ†': s.æ€»åˆ†
        }));
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, currentClass);
        
        const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
        XLSX.writeFile(wb, currentClass + '_æˆç»©_' + date + '.xlsx');
        
        console.log('å¯¼å‡ºå½“å‰ç­çº§:', currentClass, 'å­¦ç”Ÿæ•°:', data.length);
        closeExportModal();
    }
    
    // å¯¼å‡ºæ‰€æœ‰ç­çº§
    function exportAllClasses() {
        // ä¿å­˜å½“å‰ç­çº§æ•°æ®
        if (currentClass && students.length > 0) {
            allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
        }
        
        const wb = XLSX.utils.book_new();
        const allData = [];
        let totalExported = 0;
        
        // ç¡®ä¿æ‰€æœ‰ç­çº§éƒ½æœ‰æ•°æ®
        ['25æ— äººæœºä¸‰ç­', '25æ¶²å‹ä¸‰ç­', '25æ— äººæœºå››ç­', '25åº”ç”µ12ç­'].forEach(className => {
            let classStudents;
            
            // ä¼˜å…ˆä½¿ç”¨å·²ä¿å­˜çš„æ•°æ®
            if (allClassesData[className] && allClassesData[className].length > 0) {
                classStudents = allClassesData[className];
                console.log('ä½¿ç”¨å·²ä¿å­˜çš„æ•°æ®:', className, 'å­¦ç”Ÿæ•°:', classStudents.length);
            } else {
                // åˆ›å»ºåˆå§‹æ•°æ®
                const data = classesData[className];
                classStudents = data.map((item, i) => {
                    let group;
                    if (className === '25åº”ç”µ12ç­') {
                        group = getGroupForYingDian(i);
                    } else {
                        group = getGroupForStudent(className, i);
                    }
                    
                    return {
                        å­¦å·: item[0],
                        å§“å: item[1],
                        ç»„åˆ«: group,
                        å­ç­çº§: className === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                        è¯¾å ‚è¡¨ç°: 0,
                        å°ç»„æ´»åŠ¨: 0,
                        ç¬”è®°1: false,
                        ç¬”è®°2: false,
                        ç¬”è®°æ€»åˆ†: 0,
                        è€ƒè¯•æˆç»©: 0,
                        å¹³æ—¶æ€»åˆ†: 0,
                        æ€»åˆ†: 0
                    };
                });
                console.log('åˆ›å»ºåˆå§‹æ•°æ®:', className, 'å­¦ç”Ÿæ•°:', classStudents.length);
            }
            
            totalExported += classStudents.length;
            
            // æ·»åŠ åˆ°æ€»æ•°æ®ä¸­
            classStudents.forEach(s => {
                allData.push({
                    'ç­çº§': className,
                    'å­¦å·': s.å­¦å·,
                    'å§“å': s.å§“å,
                    'ç»„åˆ«': s.ç»„åˆ«,
                    'è¯¾å ‚è¡¨ç°': s.è¯¾å ‚è¡¨ç°,
                    'å°ç»„æ´»åŠ¨': s.å°ç»„æ´»åŠ¨,
                    'ç¬”è®°1': s.ç¬”è®°1 ? 'âˆš' : '',
                    'ç¬”è®°2': s.ç¬”è®°2 ? 'âˆš' : '',
                    'ç¬”è®°æ€»åˆ†': s.ç¬”è®°æ€»åˆ† || 0,
                    'å¹³æ—¶æ€»åˆ†': s.å¹³æ—¶æ€»åˆ†,
                    'è€ƒè¯•æˆç»©': s.è€ƒè¯•æˆç»© || 0,
                    'æ€»åˆ†': s.æ€»åˆ†
                });
            });
            
            // ä¸ºæ¯ä¸ªç­çº§åˆ›å»ºå•ç‹¬çš„sheet
            const sheetData = classStudents.map(s => ({
                'å­¦å·': s.å­¦å·,
                'å§“å': s.å§“å,
                'ç»„åˆ«': s.ç»„åˆ«,
                'è¯¾å ‚è¡¨ç°': s.è¯¾å ‚è¡¨ç°,
                'å°ç»„æ´»åŠ¨': s.å°ç»„æ´»åŠ¨,
                'ç¬”è®°1': s.ç¬”è®°1 ? 'âˆš' : '',
                'ç¬”è®°2': s.ç¬”è®°2 ? 'âˆš' : '',
                'ç¬”è®°æ€»åˆ†': s.ç¬”è®°æ€»åˆ† || 0,
                'å¹³æ—¶æ€»åˆ†': s.å¹³æ—¶æ€»åˆ†,
                'è€ƒè¯•æˆç»©': s.è€ƒè¯•æˆç»© || 0,
                'æ€»åˆ†': s.æ€»åˆ†
            }));
            
            const ws = XLSX.utils.json_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws, className);
        });
        
        // åˆ›å»ºæ±‡æ€»sheet
        const summaryWs = XLSX.utils.json_to_sheet(allData);
        XLSX.utils.book_append_sheet(wb, summaryWs, 'æ‰€æœ‰ç­çº§æ±‡æ€»');
        
        const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
        XLSX.writeFile(wb, 'å…¨éƒ¨ç­çº§æˆç»©_' + date + '.xlsx');
        
        console.log('å¯¼å‡ºæ‰€æœ‰ç­çº§å®Œæˆï¼Œæ€»äººæ•°:', totalExported);
        console.log('å„ç­çº§äººæ•°:', {
            '25æ— äººæœºä¸‰ç­': 40,
            '25æ¶²å‹ä¸‰ç­': 30,
            '25æ— äººæœºå››ç­': 40,
            '25åº”ç”µ12ç­': 86
        });
        
        closeExportModal();
        alert(`å¯¼å‡ºæˆåŠŸï¼\næ€»å…±å¯¼å‡º ${totalExported} åå­¦ç”Ÿçš„æ•°æ®\nåŒ…å«4ä¸ªç­çº§çš„å®Œæ•´åå•`);
    }
    
    // é‡ç½®å½“å‰ç­çº§
    function resetCurrentClass() {
        if (!currentClass) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­çº§');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦é‡ç½® ${currentClass} çš„æ‰€æœ‰æˆç»©å—ï¼Ÿ\nè¿™å°†æ¸…é™¤è¯¥ç­çº§çš„æ‰€æœ‰æˆç»©æ•°æ®ï¼`)) {
            return;
        }
        
        const data = classesData[currentClass];
        students = data.map((item, i) => {
            let group;
            if (currentClass === '25åº”ç”µ12ç­') {
                group = getGroupForYingDian(i);
            } else {
                group = getGroupForStudent(currentClass, i);
            }
            
            return {
                å­¦å·: item[0],
                å§“å: item[1],
                ç»„åˆ«: group,
                å­ç­çº§: currentClass === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                è¯¾å ‚è¡¨ç°: 0,
                å°ç»„æ´»åŠ¨: 0,
                ç¬”è®°1: false,
                ç¬”è®°2: false,
                ç¬”è®°æ€»åˆ†: 0,
                è€ƒè¯•æˆç»©: 0,
                å¹³æ—¶æ€»åˆ†: 0,
                æ€»åˆ†: 0,
                selected: false
            };
        });
        
        // æ·»åŠ å†å²è®°å½•
        addHistory('é‡ç½®ç­çº§', students.length, {
            'ç­çº§': currentClass
        });
        
        allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
        render();
        saveToLocalStorage();
        updateClassStatus();
        showBackupReminder();
        alert(`${currentClass} çš„æˆç»©å·²é‡ç½®ï¼`);
    }
    
    // æ£€æŸ¥æ•°æ®çŠ¶æ€
    function checkDataStatus() {
        let status = 'æ•°æ®çŠ¶æ€æ£€æŸ¥ï¼š\n\n';
        
        ['25æ— äººæœºä¸‰ç­', '25æ¶²å‹ä¸‰ç­', '25æ— äººæœºå››ç­', '25åº”ç”µ12ç­'].forEach(className => {
            const expectedCount = classesData[className].length;
            const actualData = allClassesData[className];
            
            if (actualData) {
                const hasScores = actualData.some(s => 
                    s.è¯¾å ‚è¡¨ç° !== 0 || s.å°ç»„æ´»åŠ¨ !== 0 || s.è€ƒè¯•æˆç»© !== 0
                );
                status += `${className}ï¼š\n`;
                status += `  - é¢„æœŸäººæ•°ï¼š${expectedCount}\n`;
                status += `  - å®é™…äººæ•°ï¼š${actualData.length}\n`;
                status += `  - çŠ¶æ€ï¼š${hasScores ? 'æœ‰æˆç»©æ•°æ®' : 'æ— æˆç»©æ•°æ®'}\n`;
                
                // ç»Ÿè®¡è´Ÿåˆ†æƒ…å†µ
                const negativeScores = actualData.filter(s => s.è¯¾å ‚è¡¨ç° < 0 || s.å°ç»„æ´»åŠ¨ < 0);
                if (negativeScores.length > 0) {
                    status += `  - è´Ÿåˆ†å­¦ç”Ÿï¼š${negativeScores.length}äºº\n`;
                }
                status += '\n';
            } else {
                status += `${className}ï¼šæœªåŠ è½½ï¼ˆé¢„æœŸ ${expectedCount} äººï¼‰\n\n`;
            }
        });
        
        status += '\næ€»è®¡ï¼š196äººï¼ˆ40+30+40+86ï¼‰';
        
        alert(status);
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    let localDirtyFlag = false;
    let autoPushTimer = null;

    function saveToLocalStorage(options = {}) {
        const { skipDirty = false, skipAutoSync = false } = options;
        try {
            if (currentClass && students.length > 0) {
                allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
            }
            localStorage.setItem('allClassesData_v3', JSON.stringify(allClassesData));
            localStorage.setItem('currentClass_v3', currentClass);
        } catch (e) {
            console.error('ä¿å­˜å¤±è´¥:', e);
        }

        // ã€å·²ç¦ç”¨ã€‘ä¸å†è‡ªåŠ¨æ¨é€åˆ°Giteeï¼Œåªèƒ½æ‰‹åŠ¨ç‚¹å‡»"ä¿å­˜åˆ°äº‘ç«¯"æŒ‰é’®
        // if (!skipDirty && !skipAutoSync && giteeConfig.autoSync) {
        //     scheduleAutoPushToGitee();
        // }
    }

    // å»¶è¿Ÿæ¨é€åˆ°Giteeï¼ˆé¿å…é¢‘ç¹æ¨é€ï¼‰- å·²ç¦ç”¨
    function scheduleAutoPushToGitee() {
        // å·²ç¦ç”¨è‡ªåŠ¨æ¨é€åŠŸèƒ½
        console.log('âš  è‡ªåŠ¨æ¨é€å·²ç¦ç”¨ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»"ä¿å­˜åˆ°äº‘ç«¯"æŒ‰é’®');
    }
    
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
    function loadFromLocalStorage() {
        try {
            const saved = localStorage.getItem('allClassesData_v3');
            const savedClass = localStorage.getItem('currentClass_v3');
            
            if (saved) {
                allClassesData = JSON.parse(saved);
                console.log('åŠ è½½ä¿å­˜çš„æ•°æ®ï¼Œç­çº§æ•°:', Object.keys(allClassesData).length);
                
                // éªŒè¯å¹¶ä¿®å¤æ•°æ®
                Object.keys(allClassesData).forEach(className => {
                    if (classesData[className]) {
                        const expectedCount = classesData[className].length;
                        const actualCount = allClassesData[className].length;
                        
                        if (actualCount !== expectedCount) {
                            console.warn(`${className} äººæ•°ä¸åŒ¹é…ï¼šé¢„æœŸ ${expectedCount}ï¼Œå®é™… ${actualCount}ï¼Œé‡æ–°åˆå§‹åŒ–`);
                            delete allClassesData[className];
                        } else {
                            // ç¡®ä¿å­—æ®µåæ­£ç¡®ï¼Œæ·»åŠ å­ç­çº§å­—æ®µ
                            allClassesData[className].forEach((s, i) => {
                                // å…¼å®¹æ—§å­—æ®µå
                                if (s.å¹³æ—¶è¡¨ç° !== undefined && s.è¯¾å ‚è¡¨ç° === undefined) {
                                    s.è¯¾å ‚è¡¨ç° = s.å¹³æ—¶è¡¨ç°;
                                    delete s.å¹³æ—¶è¡¨ç°;
                                }
                                // æ·»åŠ å­ç­çº§å­—æ®µ
                                if (className === '25åº”ç”µ12ç­' && !s.å­ç­çº§) {
                                    s.å­ç­çº§ = getSubClass(classesData[className][i][0]);
                                }
                            });
                        }
                    }
                });
                
                updateClassStatus();
            }
            
            if (savedClass && allClassesData[savedClass]) {
                selectClass(savedClass);
            }
        } catch (e) {
            console.error('åŠ è½½å¤±è´¥:', e);
        }
    }
    
    // å…¨å±€é¼ æ ‡äº‹ä»¶å¤„ç†
    document.addEventListener('mouseup', function() {
        if (isSelecting) {
            isSelecting = false;
            clearSelectionVisual();
        }
    });
    
    document.addEventListener('mouseleave', function() {
        if (isSelecting) {
            isSelecting = false;
            clearSelectionVisual();
        }
    });
    
    

    // ==================== Gitee äº‘åŒæ­¥åŠŸèƒ½ ====================

    // æ›´æ–°GiteeçŠ¶æ€æ˜¾ç¤º
    function updateGiteeStatus(status, color = '#666') {
        const statusEl = document.getElementById('giteeStatusText');
        if (statusEl) {
            statusEl.textContent = status;
            statusEl.style.color = color;
        }
    }

    // é€šç”¨çš„ Gitee æ¨é€å‡½æ•°ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
    async function pushToGiteeInternal(targetPath, message) {
        const branch = giteeConfig.branch || GITEE_CONFIG.branch || 'master';
        
        // ä¿å­˜å½“å‰ç­çº§æ•°æ®
        if (currentClass && students.length > 0) {
            allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
        }

        // å‡†å¤‡JSONæ•°æ®
        const jsonData = {
            version: '1.0',
            timestamp: new Date().toISOString(),
            lastModified: new Date().toLocaleString('zh-CN'),
            classes: allClassesData
        };

        const content = JSON.stringify(jsonData, null, 2);
        const base64Content = btoa(unescape(encodeURIComponent(content)));

        // è·å–æ–‡ä»¶SHA
        let sha = null;
        let fileExists = false;
        try {
            const getResponse = await fetch(
                `https://gitee.com/api/v5/repos/${giteeConfig.owner}/${giteeConfig.repo}/contents/${targetPath}?access_token=${giteeConfig.token}&ref=${branch}`,
                { method: 'GET' }
            );
            if (getResponse.ok) {
                const fileData = await getResponse.json();
                if (fileData && fileData.sha) {
                    sha = fileData.sha;
                    fileExists = true;
                }
            }
        } catch (e) {
            // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»ºæ–°æ–‡ä»¶
        }

        // æ„å»ºè¯·æ±‚
        const url = `https://gitee.com/api/v5/repos/${giteeConfig.owner}/${giteeConfig.repo}/contents/${targetPath}`;
        const body = {
            access_token: giteeConfig.token,
            content: base64Content,
            message: message,
            branch: branch
        };

        // ã€å…³é”®ä¿®å¤ã€‘æ ¹æ® Gitee API æ–‡æ¡£ï¼š
        // - åˆ›å»ºæ–°æ–‡ä»¶åº”ä½¿ç”¨ POST æ–¹æ³•ï¼Œä¸éœ€è¦ sha
        // - æ›´æ–°å·²å­˜åœ¨æ–‡ä»¶åº”ä½¿ç”¨ PUT æ–¹æ³•ï¼Œéœ€è¦æä¾› sha
        let response;
        if (sha) {
            // æ–‡ä»¶å·²å­˜åœ¨ï¼Œä½¿ç”¨ PUT æ›´æ–°ï¼ˆéœ€è¦æä¾› shaï¼‰
            body.sha = sha;
            console.log('ğŸ“ æ›´æ–°å·²å­˜åœ¨æ–‡ä»¶ï¼ŒSHA:', sha.substring(0, 8));
            response = await fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        } else {
            // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ POST åˆ›å»ºæ–°æ–‡ä»¶ï¼ˆä¸éœ€è¦ shaï¼‰
            console.log('ğŸ“ åˆ›å»ºæ–°æ–‡ä»¶ï¼ˆä½¿ç”¨POSTæ–¹æ³•ï¼‰');
            response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        }

        if (!response.ok) {
            let errorMsg = 'æ¨é€å¤±è´¥';
            try {
                const error = await response.json();
                console.error('âŒ APIé”™è¯¯è¯¦æƒ…:', error);
                errorMsg = error.message || error.error || JSON.stringify(error);
                
                // å¦‚æœæ˜¯ sha ç›¸å…³çš„é”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„æç¤º
                if (error.messages && Array.isArray(error.messages)) {
                    const shaError = error.messages.find(msg => msg.includes('sha'));
                    if (shaError) {
                        errorMsg = `Gitee APIè¦æ±‚æä¾›shaå­—æ®µ: ${shaError}\n\nè¿™å¯èƒ½æ˜¯å› ä¸ºé¦–æ¬¡åœ¨ä»“åº“ä¸­åˆ›å»ºæ–‡ä»¶æ—¶çš„ç‰¹æ®Šè¦æ±‚ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. å…ˆç‚¹å‡»"ğŸ’¾ ä¿å­˜åˆ°äº‘ç«¯"åˆ›å»ºé»˜è®¤æ–‡ä»¶ï¼ˆgrades-data.jsonï¼‰\n2. ç„¶åå†ä½¿ç”¨"ğŸ“¦ ä¿å­˜ä¸ºå¤‡ä»½"åŠŸèƒ½\n\nä¸€æ—¦ä»“åº“ä¸­æœ‰äº†ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œåç»­åˆ›å»ºå¤‡ä»½æ–‡ä»¶å°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚`;
                    }
                }
            } catch (e) {
                errorMsg = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMsg);
        }

        return await response.json();
    }

    // æ¨é€æ•°æ®åˆ°Giteeï¼ˆä½¿ç”¨é€šç”¨å‡½æ•°ï¼Œç¡®ä¿é€»è¾‘ä¸€è‡´ï¼‰
    async function pushToGitee() {
        console.log('ğŸ’¾ pushToGiteeå‡½æ•°è¢«è°ƒç”¨');

        if (syncInProgress) {
            showToast('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
            console.log('âš  å·²æœ‰åŒæ­¥è¿›è¡Œä¸­');
            return;
        }

        try {
            syncInProgress = true;
            updateGiteeStatus('æ¨é€ä¸­...', '#ff9800');
            showToast('æ­£åœ¨æ¨é€åˆ°Gitee...', 'info', 2000);
            console.log('ğŸš€ å¼€å§‹æ¨é€æ•°æ®');

            // ä½¿ç”¨é€šç”¨å‡½æ•°æ¨é€
            const targetPath = giteeConfig.filePath || GITEE_CONFIG.filePath || 'grades-data.json';
            const result = await pushToGiteeInternal(
                targetPath,
                `æ›´æ–°æˆç»©æ•°æ® - ${new Date().toLocaleString('zh-CN')}`
            );

            // æ›´æ–°é…ç½®
            if (result.content && result.content.sha) {
                giteeConfig.sha = result.content.sha;
            }
            giteeConfig.lastSyncTime = new Date().toISOString();
            saveGiteeConfigToStorage();
            lastSyncTime = new Date();

            const totalStudents = Object.values(allClassesData).reduce((sum, arr) => sum + arr.length, 0);
            updateSyncStatus(`å·²ä¿å­˜ ${totalStudents} æ¡è®°å½•åˆ°äº‘ç«¯ ${new Date().toLocaleTimeString()}`, 'success');
            updateGiteeStatus(`å·²åŒæ­¥ ${new Date().toLocaleTimeString()}`, '#4caf50');
            console.log('âœ… Giteeæ¨é€æˆåŠŸ');

            // æ›´æ–°é¢„è§ˆæ•°æ®
            const jsonData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                lastModified: new Date().toLocaleString('zh-CN'),
                classes: allClassesData
            };
            lastPulledCloudData = jsonData;
            lastPulledFileMeta = {
                path: targetPath,
                size: JSON.stringify(jsonData, null, 2).length,
                sha: giteeConfig.sha,
                fetchedAt: new Date().toISOString(),
                applied: true
            };
            updateCloudDataPreview();
            giteeFileListCache = null;
            
            // æ·»åŠ å†å²è®°å½•
            addHistory('ä¿å­˜åˆ°äº‘ç«¯', totalStudents, {
                'æ—¶é—´': new Date().toLocaleString('zh-CN')
            });

        } catch (error) {
            console.error('âŒ Giteeæ¨é€å¤±è´¥:', error);
            
            // æ›´è¯¦ç»†çš„é”™è¯¯æç¤º
            let userMessage = `æ¨é€å¤±è´¥: ${error.message}\n\n`;
            if (error.message.includes('Token')) {
                userMessage += 'è¯·æ£€æŸ¥ï¼š\n1. Tokenæ˜¯å¦æ­£ç¡®\n2. Tokenæ˜¯å¦æœ‰å†™å…¥æƒé™';
            } else if (error.message.includes('ä»“åº“')) {
                userMessage += 'è¯·æ£€æŸ¥ï¼š\n1. ä»“åº“åœ°å€æ˜¯å¦æ­£ç¡®\n2. ä»“åº“æ˜¯å¦å­˜åœ¨';
            } else if (error.message.includes('ç½‘ç»œ') || error.message.includes('Failed to fetch')) {
                userMessage += 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            } else {
                userMessage += 'è¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯';
            }
            
            showToast(`âŒ ${userMessage}`, 'error', 8000);
            updateGiteeStatus('æ¨é€å¤±è´¥', '#f44336');
        } finally {
            syncInProgress = false;
            console.log('ğŸ æ¨é€æµç¨‹ç»“æŸ');
        }
    }

    // ä¿å­˜ä¸ºå¤‡ä»½ï¼ˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶åï¼Œä¸è¦†ç›–é»˜è®¤æ–‡ä»¶ï¼‰
    async function pushToGiteeAsBackup() {
        console.log('ğŸ“¦ pushToGiteeAsBackupå‡½æ•°è¢«è°ƒç”¨');

        if (syncInProgress) {
            showToast('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
            console.log('âš  å·²æœ‰åŒæ­¥è¿›è¡Œä¸­');
            return;
        }

        // æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
        if (!giteeConfig.owner || !giteeConfig.repo || !giteeConfig.token) {
            showToast('âŒ Giteeé…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ä¿å­˜å¤‡ä»½\n\nè¯·æ£€æŸ¥ï¼š\n1. ä»“åº“æ‰€æœ‰è€…(owner)\n2. ä»“åº“åç§°(repo)\n3. Token', 'error', 6000);
            console.error('âŒ Giteeé…ç½®ä¸å®Œæ•´:', {
                owner: giteeConfig.owner,
                repo: giteeConfig.repo,
                token: giteeConfig.token ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'
            });
            return;
        }

        // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶åï¼Œæ ¼å¼ï¼šgrades-data-20241115-143022.json
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        
        // è·å–åŸæ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
        const originalPath = giteeConfig.filePath || GITEE_CONFIG.filePath || 'grades-data.json';
        const pathParts = originalPath.split('/');
        const fileName = pathParts.pop() || 'grades-data.json';
        const baseName = fileName.replace(/\.json$/, '');
        const directory = pathParts.length > 0 ? pathParts.join('/') + '/' : '';
        
        // ç”Ÿæˆå¤‡ä»½æ–‡ä»¶åï¼šgrades-data-20241115-143022.json
        const backupFileName = `${baseName}-${year}${month}${day}-${hour}${minute}${second}.json`;
        const backupPath = directory + backupFileName;
        
        console.log('ğŸ“ å¤‡ä»½é…ç½®:', {
            owner: giteeConfig.owner,
            repo: giteeConfig.repo,
            branch: giteeConfig.branch || 'master',
            backupPath: backupPath
        });

        try {
            syncInProgress = true;
            updateGiteeStatus('å¤‡ä»½ä¸­...', '#ff9800');
            showToast(`æ­£åœ¨ä¿å­˜å¤‡ä»½: ${backupFileName}...`, 'info', 3000);
            console.log('ğŸš€ å¼€å§‹ä¿å­˜å¤‡ä»½åˆ°:', backupPath);

            // ä½¿ç”¨é€šç”¨çš„æ¨é€å‡½æ•°ï¼Œç¡®ä¿é€»è¾‘å®Œå…¨ä¸€è‡´
            const result = await pushToGiteeInternal(
                backupPath,
                `ä¿å­˜å¤‡ä»½ - ${now.toLocaleString('zh-CN')} - åŒ…å«11æœˆæ•°æ®`
            );

            const totalStudents = Object.values(allClassesData).reduce((sum, arr) => sum + arr.length, 0);
            
            // æˆåŠŸå¤‡ä»½ï¼Œæ˜¾ç¤ºæç¤º
            updateSyncStatus(`å·²ä¿å­˜å¤‡ä»½ ${backupFileName} (${totalStudents}æ¡è®°å½•) ${now.toLocaleTimeString()}`, 'success');
            updateGiteeStatus(`å¤‡ä»½å®Œæˆ ${now.toLocaleTimeString()}`, '#4caf50');
            console.log('âœ… å¤‡ä»½ä¿å­˜æˆåŠŸ:', backupPath);
            
            showToast(`âœ… å¤‡ä»½å·²ä¿å­˜: ${backupFileName}\n\nå…± ${totalStudents} æ¡è®°å½•\n\nâš ï¸ è¿™æ˜¯å¤‡ä»½æ–‡ä»¶ï¼Œä¸ä¼šè¦†ç›–é»˜è®¤çš„ grades-data.json`, 'success', 6000);
            
            // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ç¼“å­˜ï¼Œä»¥ä¾¿åœ¨"äº‘ç«¯ç‰ˆæœ¬"ä¸­å¯ä»¥çœ‹åˆ°æ–°å¤‡ä»½
            giteeFileListCache = null;
            
            // æ·»åŠ å†å²è®°å½•
            addHistory('ä¿å­˜å¤‡ä»½åˆ°äº‘ç«¯', totalStudents, {
                'æ—¶é—´': now.toLocaleString('zh-CN'),
                'å¤‡ä»½æ–‡ä»¶': backupFileName
            });

        } catch (error) {
            console.error('âŒ å¤‡ä»½ä¿å­˜å¤±è´¥:', error);
            
            let userMessage = `å¤‡ä»½å¤±è´¥: ${error.message}\n\n`;
            if (error.message.includes('Token')) {
                userMessage += 'è¯·æ£€æŸ¥ï¼š\n1. Tokenæ˜¯å¦æ­£ç¡®\n2. Tokenæ˜¯å¦æœ‰å†™å…¥æƒé™';
            } else if (error.message.includes('ä»“åº“')) {
                userMessage += 'è¯·æ£€æŸ¥ï¼š\n1. ä»“åº“åœ°å€æ˜¯å¦æ­£ç¡®\n2. ä»“åº“æ˜¯å¦å­˜åœ¨';
            } else if (error.message.includes('ç½‘ç»œ') || error.message.includes('Failed to fetch')) {
                userMessage += 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            } else {
                userMessage += 'è¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯';
            }
            
            showToast(`âŒ ${userMessage}`, 'error', 8000);
            updateGiteeStatus('å¤‡ä»½å¤±è´¥', '#f44336');
        } finally {
            syncInProgress = false;
            console.log('ğŸ å¤‡ä»½æµç¨‹ç»“æŸ');
        }
    }

    // ä»Giteeæ‹‰å–æ•°æ®
    async function pullFromGitee(options = {}) {
        const {
            silent = false,
            reason = 'manual',
            path = null,
            setDefault = false,
            apply = true
        } = options;
        const targetPath = (path || giteeConfig.filePath || '').trim();
        console.log(`ğŸŒ pullFromGiteeè§¦å‘ (${silent ? 'silent' : 'manual'}, reason: ${reason}, path: ${targetPath || 'é»˜è®¤'})`);

        if (!targetPath) {
            if (!silent) {
                showToast('âŒ å°šæœªè®¾ç½®äº‘ç«¯æ–‡ä»¶è·¯å¾„ï¼Œæ— æ³•æ¢å¤æ•°æ®', 'error', 5000);
            }
            updateGiteeStatus('é…ç½®ä¸å®Œæ•´', '#f44336');
            return false;
        }

        if (!giteeConfig.token || !giteeConfig.owner || !giteeConfig.repo) {
            if (!silent) {
                showToast('âŒ Giteeé…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•æ‹‰å–æ•°æ®', 'error', 5000);
            }
            updateGiteeStatus('é…ç½®ä¸å®Œæ•´', '#f44336');
            return false;
        }

        if (syncInProgress) {
            if (!silent) {
                showToast('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
            } else {
                console.log('âš  è‡ªåŠ¨æ‹‰å–æ—¶æ£€æµ‹åˆ°åŒæ­¥è¿›è¡Œä¸­ï¼Œè·³è¿‡æœ¬æ¬¡');
            }
            return false;
        }

        let success = false;

        try {
            syncInProgress = true;
            updateGiteeStatus('æ‹‰å–ä¸­...', '#2196f3');
            const statusMsg = `æ­£åœ¨ä» ${targetPath} æ‹‰å–æ•°æ®...`;
            if (silent) {
                updateSyncStatus(statusMsg, 'info');
            } else {
                showToast(statusMsg, 'info', 2500);
            }

            const segments = targetPath.split('/').filter(Boolean);
            const url = buildGiteeApiUrl(segments);
            const response = await fetch(url, { method: 'GET' });

            if (!response.ok) {
                if (response.status === 404) {
                    const msg = `<i class="fa-solid fa-triangle-exclamation"></i> äº‘ç«¯æœªæ‰¾åˆ°æ–‡ä»¶ï¼š${targetPath}`;
                    if (!silent) {
                        showToast(msg, 'warning', 4000);
                    } else {
                        updateSyncStatus(msg, 'warning');
                    }
                    updateGiteeStatus('æ— æ•°æ®', '#ff9800');
                    return false;
                }
                throw new Error(`æ‹‰å–å¤±è´¥ï¼ˆHTTP ${response.status}ï¼‰`);
            }

            const fileData = await response.json();
            if (!fileData || !fileData.content) {
                throw new Error('Giteeè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘contentå­—æ®µ');
            }

            const base64Content = (fileData.content || '').replace(/\s/g, '');
            const content = decodeURIComponent(escape(atob(base64Content)));
            const jsonData = JSON.parse(content);
            console.log('âœ… æˆåŠŸè§£ç äº‘ç«¯æ•°æ®', { path: targetPath, size: fileData.size });

            lastPulledCloudData = jsonData;
            lastPulledFileMeta = {
                path: targetPath,
                size: fileData.size,
                sha: fileData.sha,
                fetchedAt: new Date().toISOString(),
                applied: apply
            };
            updateCloudDataPreview();

            if (apply && jsonData.classes) {
                allClassesData = jsonData.classes;
                refreshClassSelectorOptions();

                if (currentClass && allClassesData[currentClass]) {
                    students = JSON.parse(JSON.stringify(allClassesData[currentClass]));
                    render();
                } else if (!currentClass && Object.keys(allClassesData).length > 0) {
                    const firstClass = Object.keys(allClassesData)[0];
                    selectClass(firstClass);
                }

                updateClassStatus();
                saveToLocalStorage({ skipDirty: true, skipAutoSync: true });
                giteeConfig.lastSyncTime = new Date().toISOString();
                saveGiteeConfigToStorage();
                lastSyncTime = new Date();

                const totalStudents = Object.values(allClassesData).reduce((sum, arr) => sum + arr.length, 0);
                updateSyncStatus(`å·²ä» ${targetPath} åŠ è½½ ${totalStudents} æ¡è®°å½• ${new Date().toLocaleTimeString()}`, 'success');
                updateGiteeStatus(`å·²åŒæ­¥ ${new Date().toLocaleTimeString()}`, '#4caf50');
                if (!silent) {
                    showToast(`âœ… å·²ä» ${targetPath} æ¢å¤æ•°æ®`, 'success', 2600);
                }
                success = true;
            } else {
                updateSyncStatus(`å·²è·å– ${targetPath}ï¼ˆé¢„è§ˆæ¨¡å¼ï¼‰`, 'info');
                updateGiteeStatus('é¢„è§ˆå®Œæˆ', '#2196f3');
                if (!silent) {
                    showToast(`ğŸ‘€ å·²é¢„è§ˆ ${targetPath}`, 'info', 2200);
                }
                success = true;
            }

            giteeFileListCache = null;

            if (apply) {
                if (setDefault) {
                    giteeConfig.filePath = targetPath;
                    giteeConfig.sha = fileData.sha;
                    saveGiteeConfigToStorage();
                } else if (targetPath === giteeConfig.filePath) {
                    giteeConfig.sha = fileData.sha;
                    saveGiteeConfigToStorage();
                }
            } else if (setDefault) {
                giteeConfig.filePath = targetPath;
                giteeConfig.sha = fileData.sha;
                saveGiteeConfigToStorage();
            }

        } catch (error) {
            console.error('Giteeæ‹‰å–å¤±è´¥:', error);
            const msg = `æ‹‰å–å¤±è´¥: ${error.message}`;
            if (!silent) {
                showToast(`âŒ ${msg}`, 'error', 5000);
            } else {
                updateSyncStatus(msg, 'warning');
            }
            updateGiteeStatus('æ‹‰å–å¤±è´¥', '#f44336');
            success = false;
        } finally {
            syncInProgress = false;
        }

        return success;
    }


    // è‡ªåŠ¨åŒæ­¥ï¼ˆå®šæœŸæ‹‰å–ï¼‰- å·²ç¦ç”¨
    let autoSyncTimer = null;
    function startAutoSync() {
        // å·²ç¦ç”¨è‡ªåŠ¨åŒæ­¥åŠŸèƒ½
        console.log('âš  è‡ªåŠ¨åŒæ­¥å·²ç¦ç”¨ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»"â˜ï¸ ä»äº‘ç«¯æ¢å¤"æŒ‰é’®');
        return;
    }

    function stopAutoSync() {
        if (autoSyncTimer) {
            clearInterval(autoSyncTimer);
            autoSyncTimer = null;
        }
    }

    // åŒæ­¥åˆ°WPSï¼ˆä¿ç•™åŸåŠŸèƒ½ä½œä¸ºå¤‡ç”¨ï¼‰
    function syncToWPS() {
        // ä¿å­˜å½“å‰ç­çº§æ•°æ®
        if (currentClass && students.length > 0) {
            allClassesData[currentClass] = JSON.parse(JSON.stringify(students));
        }
        
        const allData = [];
        let totalRecords = 0;
        
        // æ”¶é›†æ‰€æœ‰ç­çº§æ•°æ®åˆ°æ±‡æ€»
        const classOrder = ['25æ— äººæœºä¸‰ç­', '25æ¶²å‹ä¸‰ç­', '25æ— äººæœºå››ç­', '25åº”ç”µ12ç­'];
        
        classOrder.forEach(className => {
            let classStudents;
            
            // è·å–ç­çº§æ•°æ®
            if (allClassesData[className] && allClassesData[className].length > 0) {
                classStudents = allClassesData[className];
            } else {
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºç©ºæ¨¡æ¿
                const data = classesData[className];
                classStudents = data.map((item, i) => {
                    let group;
                    if (className === '25åº”ç”µ12ç­') {
                        group = getGroupForYingDian(i);
                    } else {
                        group = getGroupForStudent(className, i);
                    }
                    
                    return {
                        å­¦å·: item[0],
                        å§“å: item[1],
                        ç»„åˆ«: group,
                        å­ç­çº§: className === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                        è¯¾å ‚è¡¨ç°: 0,
                        å°ç»„æ´»åŠ¨: 0,
                        ç¬”è®°1: false,
                        ç¬”è®°2: false,
                        ç¬”è®°æ€»åˆ†: 0,
                        è€ƒè¯•æˆç»©: 0,
                        å¹³æ—¶æ€»åˆ†: 0,
                        æ€»åˆ†: 0
                    };
                });
            }
            
            totalRecords += classStudents.length;
            
            // æ”¶é›†åˆ°æ±‡æ€»æ•°æ®ï¼ˆä½¿ç”¨æ•°ç»„ï¼Œæ–¹ä¾¿ç”ŸæˆTSVï¼‰
            classStudents.forEach(s => {
                allData.push([
                    className,
                    s.å­¦å·,
                    s.å§“å,
                    s.ç»„åˆ«,
                    s.è¯¾å ‚è¡¨ç°,
                    s.å°ç»„æ´»åŠ¨,
                    s.ç¬”è®°1 ? 'âˆš' : '',
                    s.ç¬”è®°2 ? 'âˆš' : '',
                    s.ç¬”è®°æ€»åˆ†,
                    s.å¹³æ—¶æ€»åˆ†,
                    s.è€ƒè¯•æˆç»©,
                    s.æ€»åˆ†
                ]);
            });
        });
        
        // ç”ŸæˆTSVæ ¼å¼ï¼ˆåˆ¶è¡¨ç¬¦åˆ†éš”ï¼Œé€‚åˆç›´æ¥ç²˜è´´åˆ°è¡¨æ ¼ï¼‰
        const headers = ['ç­çº§', 'å­¦å·', 'å§“å', 'ç»„åˆ«', 'è¯¾å ‚è¡¨ç°', 'å°ç»„æ´»åŠ¨', 'ç¬”è®°1', 'ç¬”è®°2', 'ç¬”è®°æ€»åˆ†', 'å¹³æ—¶æ€»åˆ†', 'è€ƒè¯•æˆç»©', 'æ€»åˆ†'];
        let tsvContent = headers.join('\t') + '\n';
        allData.forEach(row => {
            tsvContent += row.join('\t') + '\n';
        });
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(tsvContent).then(() => {
            showToast(`âœ… å·²å¤åˆ¶ ${totalRecords} æ¡è®°å½•åˆ°å‰ªè´´æ¿`, 'success', 3000);
            // è‡ªåŠ¨æ‰“å¼€WPSè¡¨æ ¼
            window.open('https://www.kdocs.cn/l/cvodF5Uw2mxZ', '_blank');
            showToast('ğŸ“‹ è¯·åœ¨WPSè¡¨æ ¼ä¸­ç²˜è´´ï¼ˆCtrl+Vï¼‰', 'info', 5000);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            
            // å¦‚æœå‰ªè´´æ¿APIå¤±è´¥ï¼Œæ˜¾ç¤ºæ•°æ®è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
            const textarea = document.createElement('textarea');
            textarea.value = tsvContent;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast(`âœ… å·²å¤åˆ¶ ${totalRecords} æ¡è®°å½•`, 'success');
                window.open('https://www.kdocs.cn/l/cvodF5Uw2mxZ', '_blank');
                showToast('ğŸ“‹ è¯·åœ¨WPSè¡¨æ ¼ä¸­ç²˜è´´ï¼ˆCtrl+Vï¼‰', 'info', 5000);
            } catch (e) {
                document.body.removeChild(textarea);
                showToast('<i class="fa-solid fa-triangle-exclamation"></i> å¤åˆ¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨"ä»WPSå¯¼å…¥"åŠŸèƒ½', 'error');
            }
        });
    }
    
    // å‡†å¤‡åŒæ­¥æ•°æ®
    function prepareSyncData() {
        // ç¡®ä¿æœ€æ–°ç¼–è¾‘çš„ç­çº§å·²å†™å›ç¼“å­˜
        saveToLocalStorage({ skipDirty: true, skipAutoSync: true });

        const classesSnapshot = {};
        let totalStudents = 0;

        Object.keys(classesData).forEach(className => {
            const classStudents = allClassesData[className] && allClassesData[className].length > 0
                ? allClassesData[className]
                : buildClassSnapshot(className, []);

            classesSnapshot[className] = classStudents.map(student => serializeStudentForRemote(student));
            totalStudents += classesSnapshot[className].length;
        });

        return {
            generatedAt: new Date().toISOString(),
            totalStudents,
            classes: classesSnapshot
        };
    }
    
    // å¤„ç†ä»WPSè·å–çš„æ•°æ®
    function processWPSData(wpsData) {
        if (!wpsData.data || !Array.isArray(wpsData.data)) {
            console.error('WPSæ•°æ®æ ¼å¼é”™è¯¯');
            return;
        }
        
        // æŒ‰ç­çº§åˆ†ç»„æ•°æ®
        const classGroups = {};
        wpsData.data.forEach(row => {
            const className = row['ç­çº§'];
            if (!classGroups[className]) {
                classGroups[className] = [];
            }
            classGroups[className].push(row);
        });
        
        // æ›´æ–°æœ¬åœ°æ•°æ®
        Object.keys(classGroups).forEach(className => {
            if (classesData[className]) {
                const classRows = classGroups[className];
                const originalData = classesData[className];
                
                allClassesData[className] = originalData.map((item, i) => {
                    const wpsStudent = classRows.find(row => 
                        row['å­¦å·'] === item[0] || row['å§“å'] === item[1]
                    );
                    
                    let group;
                    if (className === '25åº”ç”µ12ç­') {
                        group = getGroupForYingDian(i);
                    } else {
                        group = getGroupForStudent(className, i);
                    }
                    
                    if (wpsStudent) {
                        return {
                            å­¦å·: item[0],
                            å§“å: item[1],
                            ç»„åˆ«: group,
                            å­ç­çº§: className === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                            è¯¾å ‚è¡¨ç°: parseFloat(wpsStudent['è¯¾å ‚è¡¨ç°']) || 0,
                            å°ç»„æ´»åŠ¨: parseFloat(wpsStudent['å°ç»„æ´»åŠ¨']) || 0,
                            ç¬”è®°1: wpsStudent['ç¬”è®°1'] === 'âˆš' || wpsStudent['ç¬”è®°1'] === true,
                            ç¬”è®°2: wpsStudent['ç¬”è®°2'] === 'âˆš' || wpsStudent['ç¬”è®°2'] === true,
                            ç¬”è®°æ€»åˆ†: 0,
                            è€ƒè¯•æˆç»©: parseFloat(wpsStudent['è€ƒè¯•æˆç»©']) || 0,
                            å¹³æ—¶æ€»åˆ†: 0,
                            æ€»åˆ†: 0,
                            selected: false
                        };
                    } else {
                        // ä¿æŒåŸå§‹æ•°æ®
                        return {
                            å­¦å·: item[0],
                            å§“å: item[1],
                            ç»„åˆ«: group,
                            å­ç­çº§: className === '25åº”ç”µ12ç­' ? getSubClass(item[0]) : '',
                            è¯¾å ‚è¡¨ç°: 0,
                            å°ç»„æ´»åŠ¨: 0,
                            ç¬”è®°1: false,
                            ç¬”è®°2: false,
                            ç¬”è®°æ€»åˆ†: 0,
                            è€ƒè¯•æˆç»©: 0,
                            å¹³æ—¶æ€»åˆ†: 0,
                            æ€»åˆ†: 0,
                            selected: false
                        };
                    }
                });
                
                // é‡æ–°è®¡ç®—åˆ†æ•°
                allClassesData[className].forEach((s, i) => {
                    s.ç¬”è®°æ€»åˆ† = (s.ç¬”è®°1 ? 5 : 0) + (s.ç¬”è®°2 ? 5 : 0);
                    s.å¹³æ—¶æ€»åˆ† = s.è¯¾å ‚è¡¨ç° + s.å°ç»„æ´»åŠ¨ + s.ç¬”è®°æ€»åˆ†;
                    s.æ€»åˆ† = s.å¹³æ—¶æ€»åˆ† + s.è€ƒè¯•æˆç»©;
                });
            }
        });
        
        // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„ç­çº§ï¼Œæ›´æ–°æ˜¾ç¤º
        if (currentClass && allClassesData[currentClass]) {
            students = JSON.parse(JSON.stringify(allClassesData[currentClass]));
            render();
        }
        
        updateClassStatus();
        saveToLocalStorage();
    }
    
    
    
    // ==================== ç²˜è´´å¯¼å…¥åŠŸèƒ½ ====================
    
    function showPasteImport() {
        document.getElementById('pasteImportModal').classList.add('show');
        document.getElementById('pasteTextarea').value = '';
        document.getElementById('pasteImportResult').style.display = 'none';
        setTimeout(() => document.getElementById('pasteTextarea').focus(), 100);
    }
    
    function closePasteImport() {
        document.getElementById('pasteImportModal').classList.remove('show');
    }
    
    function clearPasteTextarea() {
        document.getElementById('pasteTextarea').value = '';
        document.getElementById('pasteImportResult').style.display = 'none';
    }
    
    function processPasteImport() {
        const text = document.getElementById('pasteTextarea').value.trim();
        if (!text) {
            alert('<i class="fa-solid fa-triangle-exclamation"></i> è¯·å…ˆç²˜è´´æ•°æ®ï¼\n\nåœ¨WPSè¡¨æ ¼ä¸­å¤åˆ¶"ç­çº§æ±‡æ€»"sheetçš„æ•°æ®åï¼Œç²˜è´´åˆ°æ–‡æœ¬æ¡†ä¸­ã€‚');
            return;
        }
        
        try {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length < 2) throw new Error('æ•°æ®è¡Œæ•°å¤ªå°‘ï¼Œè¯·ç¡®ä¿å¤åˆ¶äº†å®Œæ•´çš„æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰');
            
            const headers = lines[0].split('\t');
            const required = ['ç­çº§', 'å­¦å·', 'å§“å', 'ç»„åˆ«', 'è¯¾å ‚è¡¨ç°', 'å°ç»„æ´»åŠ¨'];
            if (!required.every(h => headers.includes(h))) {
                throw new Error('è¡¨å¤´æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿åŒ…å«ï¼š' + required.join('ã€'));
            }
            
            const idx = {
                ç­çº§: headers.indexOf('ç­çº§'), å­¦å·: headers.indexOf('å­¦å·'), å§“å: headers.indexOf('å§“å'),
                ç»„åˆ«: headers.indexOf('ç»„åˆ«'), å­ç­çº§: headers.indexOf('å­ç­çº§'), è¯¾å ‚è¡¨ç°: headers.indexOf('è¯¾å ‚è¡¨ç°'),
                å°ç»„æ´»åŠ¨: headers.indexOf('å°ç»„æ´»åŠ¨'), ç¬”è®°1: headers.indexOf('ç¬”è®°1'), ç¬”è®°2: headers.indexOf('ç¬”è®°2'),
                è€ƒè¯•æˆç»©: headers.indexOf('è€ƒè¯•æˆç»©')
            };
            
            const parsed = { '25æ— äººæœºä¸‰ç­': [], '25æ¶²å‹ä¸‰ç­': [], '25æ— äººæœºå››ç­': [], '25åº”ç”µ12ç­': [] };
            let imported = 0, skipped = 0;
            
            for (let i = 1; i < lines.length; i++) {
                const c = lines[i].split('\t');
                if (c.length < 4) { skipped++; continue; }
                
                const cls = c[idx.ç­çº§]?.trim();
                if (!parsed[cls]) { skipped++; continue; }
                
                const s = {
                    å­¦å·: c[idx.å­¦å·]?.trim() || '', å§“å: c[idx.å§“å]?.trim() || '', ç»„åˆ«: c[idx.ç»„åˆ«]?.trim() || '',
                    å­ç­çº§: idx.å­ç­çº§ >= 0 ? (c[idx.å­ç­çº§]?.trim() || '') : '',
                    è¯¾å ‚è¡¨ç°: parseFloat(c[idx.è¯¾å ‚è¡¨ç°]) || 0, å°ç»„æ´»åŠ¨: parseFloat(c[idx.å°ç»„æ´»åŠ¨]) || 0,
                    ç¬”è®°1: c[idx.ç¬”è®°1]?.trim() === 'âˆš', ç¬”è®°2: c[idx.ç¬”è®°2]?.trim() === 'âˆš',
                    ç¬”è®°æ€»åˆ†: 0, è€ƒè¯•æˆç»©: idx.è€ƒè¯•æˆç»© >= 0 ? (parseFloat(c[idx.è€ƒè¯•æˆç»©]) || 0) : 0,
                    å¹³æ—¶æ€»åˆ†: 0, æ€»åˆ†: 0, selected: false
                };
                
                s.ç¬”è®°æ€»åˆ† = (s.ç¬”è®°1 ? 5 : 0) + (s.ç¬”è®°2 ? 5 : 0);
                s.å¹³æ—¶æ€»åˆ† = s.è¯¾å ‚è¡¨ç° + s.å°ç»„æ´»åŠ¨ + s.ç¬”è®°æ€»åˆ†;
                s.æ€»åˆ† = s.å¹³æ—¶æ€»åˆ† + s.è€ƒè¯•æˆç»©;
                if (cls === '25åº”ç”µ12ç­' && !s.å­ç­çº§) s.å­ç­çº§ = getSubClass(s.å­¦å·);
                
                parsed[cls].push(s);
                imported++;
            }
            
            for (const cls in parsed) parsed[cls].sort((a, b) => a.å­¦å·.localeCompare(b.å­¦å·));
            
            let updated = [];
            for (const cls in parsed) {
                if (parsed[cls].length > 0) {
                    allClassesData[cls] = parsed[cls];
                    updated.push(`${cls}(${parsed[cls].length}äºº)`);
                }
            }
            
            if (currentClass && allClassesData[currentClass]) {
                students = JSON.parse(JSON.stringify(allClassesData[currentClass]));
                render();
            }
            
            saveToLocalStorage();
            updateClassStatus();
            showBackupReminder();
            
            // æ·»åŠ å†å²è®°å½•
            addHistory('ç²˜è´´å¯¼å…¥æ•°æ®', imported, {
                'æ›´æ–°ç­çº§': updated.join('ã€'),
                'è·³è¿‡': skipped
            });
            
            const res = document.getElementById('pasteImportResult');
            const txt = document.getElementById('pasteImportResultText');
            txt.innerHTML = `âœ… å¯¼å…¥æˆåŠŸï¼<br><i class="fa-solid fa-chart-bar"></i> å…±å¯¼å…¥ <strong>${imported}</strong> æ¡è®°å½•<br>` +
                `ğŸ“š æ›´æ–°ç­çº§ï¼š${updated.join('ã€')}<br>${skipped > 0 ? `<i class="fa-solid fa-triangle-exclamation"></i> è·³è¿‡ ${skipped} æ¡<br>` : ''}` +
                `<br><i class="fa-solid fa-lightbulb"></i> æ•°æ®å·²ä¿å­˜ï¼Œå¯åˆ‡æ¢ç­çº§æŸ¥çœ‹ã€‚`;
            res.style.display = 'block';
            res.style.background = '#d4edda';
            res.style.border = '1px solid #c3e6cb';
            
            setTimeout(() => {
                closePasteImport();
                alert(`âœ… å¯¼å…¥æˆåŠŸï¼\n\nå…±å¯¼å…¥ ${imported} æ¡è®°å½•\næ›´æ–°ç­çº§ï¼š${updated.join('ã€')}`);
            }, 3000);
            
        } catch (error) {
            console.error('ç²˜è´´å¯¼å…¥å¤±è´¥:', error);
            const res = document.getElementById('pasteImportResult');
            const txt = document.getElementById('pasteImportResultText');
            txt.innerHTML = `âŒ å¯¼å…¥å¤±è´¥<br>é”™è¯¯ï¼š${error.message}<br><br>è¯·æ£€æŸ¥ï¼š<br>` +
                `1. æ˜¯å¦ä»WPS"ç­çº§æ±‡æ€»"å¤åˆ¶<br>2. æ˜¯å¦åŒ…å«è¡¨å¤´è¡Œ<br>3. æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®`;
            res.style.display = 'block';
            res.style.background = '#f8d7da';
            res.style.border = '1px solid #f5c6cb';
        }
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹...');

        // å…ˆåŠ è½½æœ¬åœ°æ•°æ®ï¼ˆä¿åº•æ–¹æ¡ˆï¼‰
        loadFromLocalStorage();
        loadHistoryFromStorage(); // åŠ è½½å†å²è®°å½•
        updateClassStatus();

        // å®šæœŸä¿å­˜åˆ°æœ¬åœ°ï¼ˆæ¯5ç§’ï¼‰
        setInterval(() => saveToLocalStorage({ skipDirty: true, skipAutoSync: true }), 5000);

        // æ˜¾ç¤ºæç¤º
        showToast('â˜ï¸ è¯·ç‚¹å‡»â€œâ˜ï¸ ä»äº‘ç«¯æ¢å¤â€è·å–äº‘ç«¯æ•°æ®ï¼Œæˆ–å…ˆé€‰æ‹©ç­çº§åå¼€å§‹å½•å…¥', 'info', 6000);

        // åˆå§‹åŒ–GiteeåŒæ­¥
        console.log('â˜ï¸ åˆå§‹åŒ–Giteeäº‘åŒæ­¥...');
        console.log('Giteeé…ç½®:', {
            owner: giteeConfig.owner,
            repo: giteeConfig.repo,
            branch: giteeConfig.branch,
            autoSync: giteeConfig.autoSync
        });

        stopAutoSync();
        updateSyncStatus('å°šæœªåŠ è½½äº‘ç«¯æ•°æ®ï¼Œè¯·ç‚¹å‡»â€œâ˜ï¸ ä»äº‘ç«¯æ¢å¤â€æŒ‰é’®', 'warning');
        updateGiteeStatus('å¾…æ‰‹åŠ¨åŠ è½½', '#ff9800');

        // å¦‚æœæ²¡æœ‰é€‰æ‹©ç­çº§ï¼Œæç¤ºç”¨æˆ·
        if (!currentClass) {
            setTimeout(() => {
                showToast('ğŸ‘† è¯·ä»é¡¶éƒ¨ä¸‹æ‹‰æ¡†é€‰æ‹©ç­çº§å¼€å§‹', 'info', 5000);
            }, 2000);
        }

        // ã€å·²ç¦ç”¨ã€‘é¡µé¢å…³é—­å‰åªä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸è‡ªåŠ¨æ¨é€
        window.addEventListener('beforeunload', function(e) {
            // åªä¿å­˜å½“å‰æ•°æ®åˆ°æœ¬åœ°
            saveToLocalStorage({ skipDirty: true, skipAutoSync: true });
            console.log('ğŸ’¾ é¡µé¢å…³é—­ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
        });

        console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        console.log('<i class="fa-solid fa-chart-bar"></i> ç­çº§æ•°æ®:', {
            '25æ— äººæœºä¸‰ç­': 40,
            '25æ¶²å‹ä¸‰ç­': 30,
            '25æ— äººæœºå››ç­': 40,
            '25åº”ç”µ12ç­': 86
        });
    });
    </script>
</body>
</html>
