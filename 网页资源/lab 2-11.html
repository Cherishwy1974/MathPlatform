<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>函数连续性实验室</title>
    <!-- 本地化资源 -->
    <link rel="stylesheet" href="../common-assets/css/tailwind.css">
    <link rel="stylesheet" href="../common-assets/css/lab1-material-symbols.css">
    <!-- MathJax 本地化 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script async src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        canvas { touch-action: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 确保MathJax行内公式不换行 */
        mjx-container[jax="SVG"] { display: inline-block !important; vertical-align: middle; }
        mjx-container[jax="SVG"][display="true"] { display: block !important; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 h-16 flex-none flex items-center justify-between px-6 shadow-sm z-20">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <span class="material-symbols-outlined text-2xl">ssid_chart</span>
            </div>
            <h1 class="text-xl font-bold text-gray-800 tracking-tight">函数连续性实验室</h1>
        </div>
        <div class="text-sm text-gray-500 hidden sm:block font-medium">
            $\displaystyle\lim_{x \to x_0} f(x) = f(x_0)$
        </div>
    </header>
    
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <nav class="w-64 bg-white border-r border-gray-200 flex-none flex flex-col z-10 hidden md:flex">
            <div class="p-4 space-y-2">
                <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 bg-blue-50 text-blue-700" id="btn-definition" onclick="switchTab('definition')">
                    <span class="material-symbols-outlined">menu_book</span>
                    连续定义
                </button>
                <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 text-gray-600 hover:bg-gray-50" id="btn-types" onclick="switchTab('types')">
                    <span class="material-symbols-outlined">broken_image</span>
                    不连续类型
                </button>
                <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 text-gray-600 hover:bg-gray-50" id="btn-check" onclick="switchTab('check')">
                    <span class="material-symbols-outlined">fact_check</span>
                    连续性检验
                </button>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gray-50/50 p-4 md:p-8 relative scroll-smooth no-scrollbar">
            <!-- Tab 1: Definition -->
            <div class="tab-content space-y-6 max-w-5xl mx-auto" id="tab-definition">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-blue-600">functions</span>
                                连续性定义
                            </h2>
                            <div class="bg-blue-50 border border-blue-100 rounded-xl p-6 text-center mb-6">
                                <div class="text-xl text-gray-800 mb-3">
                                    $\displaystyle\lim_{x \to x_0} f(x) = f(x_0)$
                                </div>
                                <p class="text-sm text-blue-700">函数在点 $x_0$ 处连续的充要条件</p>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-start gap-3 p-3 rounded-lg bg-gray-50">
                                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-sm font-bold mt-0.5">1</span>
                                    <span class="text-sm text-gray-600">函数在 $x_0$ 处有定义，即 $f(x_0)$ 存在。</span>
                                </div>
                                <div class="flex items-start gap-3 p-3 rounded-lg bg-gray-50">
                                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-sm font-bold mt-0.5">2</span>
                                    <span class="text-sm text-gray-600">极限 $\displaystyle\lim_{x \to x_0} f(x)$ 存在。</span>
                                </div>
                                <div class="flex items-start gap-3 p-3 rounded-lg bg-gray-50">
                                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-sm font-bold mt-0.5">3</span>
                                    <span class="text-sm text-gray-600">极限值等于函数值。</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-indigo-600">compare_arrows</span>
                                左连续与右连续
                            </h2>
                            <div class="space-y-4 text-sm text-gray-600">
                                <div class="p-3 border-l-4 border-indigo-500 bg-indigo-50 rounded-r-lg">
                                    <strong>右连续：</strong> $\displaystyle\lim_{x \to x_0^+} f(x) = f(x_0)$
                                </div>
                                <div class="p-3 border-l-4 border-indigo-500 bg-indigo-50 rounded-r-lg">
                                    <strong>左连续：</strong> $\displaystyle\lim_{x \to x_0^-} f(x) = f(x_0)$
                                </div>
                                <p class="mt-2 text-center font-medium text-gray-800">函数连续 $\iff$ 既左连续又右连续</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 flex flex-col h-full">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-green-600">show_chart</span>
                            连续函数图像示例
                        </h2>
                        <div class="relative flex-1 min-h-[300px] w-full bg-white rounded-xl overflow-hidden border border-gray-100">
                            <canvas class="w-full h-full" id="continuousCanvas"></canvas>
                        </div>
                        <div class="mt-4 flex justify-center gap-4 text-xs text-gray-500">
                            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span> 函数曲线</div>
                            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500"></span> 连续点</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab 2: Discontinuity Types -->
            <div class="tab-content hidden space-y-6 max-w-6xl mx-auto" id="tab-types">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <!-- Type Selector -->
                    <div class="lg:col-span-4 space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">不连续点类型</h3>
                            <div class="space-y-2">
                                <button class="case-btn active w-full text-left p-4 rounded-xl border-2 border-blue-500 bg-blue-50 transition-all hover:shadow-md" data-case="1" onclick="selectCase(1)">
                                    <div class="font-bold text-blue-900 mb-1">第一类：跳跃间断点</div>
                                    <div class="text-xs text-blue-700">左右极限存在但不相等</div>
                                </button>
                                <button class="case-btn w-full text-left p-4 rounded-xl border-2 border-transparent hover:border-blue-200 bg-gray-50 transition-all hover:shadow-md" data-case="2" onclick="selectCase(2)">
                                    <div class="font-bold text-gray-800 mb-1">第一类：可去间断点</div>
                                    <div class="text-xs text-gray-500">左右极限相等，但无定义或不等于函数值</div>
                                </button>
                                <button class="case-btn w-full text-left p-4 rounded-xl border-2 border-transparent hover:border-blue-200 bg-gray-50 transition-all hover:shadow-md" data-case="3" onclick="selectCase(3)">
                                    <div class="font-bold text-gray-800 mb-1">第二类：无穷间断点</div>
                                    <div class="text-xs text-gray-500">左右极限至少有一个为无穷大</div>
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">案例分析</h3>
                            <div class="bg-gray-50 p-4 rounded-lg mb-4 text-center">
                                <div class="text-lg font-serif text-gray-800 mb-2" id="caseFormula">$f(x) = \text{sgn}(x)$</div>
                            </div>
                            <div class="text-sm text-gray-600 space-y-2" id="caseAnalysis">$\displaystyle\lim_{x \to 0^-} f(x) = -1 \neq \lim_{x \to 0^+} f(x) = 1$<br>左右极限存在但不相等。</div>
                        </div>
                    </div>
                    <!-- Visualization -->
                    <div class="lg:col-span-8">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 h-full flex flex-col">
                            <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-3">
                                <h3 class="text-lg font-bold text-gray-800">间断点图像演示</h3>
                                <div class="flex gap-2" id="caseTags">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">左右极限不等</span>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">第一类间断点</span>
                                </div>
                            </div>
                            <div class="relative flex-1 min-h-[400px] w-full bg-white rounded-xl overflow-hidden border border-gray-100">
                                <canvas class="w-full h-full" id="discontinuousCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab 3: Check -->
            <div class="tab-content hidden space-y-6 max-w-4xl mx-auto" id="tab-check">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-purple-100 p-2 rounded-lg text-purple-600">
                            <span class="material-symbols-outlined">science</span>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">连续性检验工具</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">选择测试函数</label>
                                <select class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-800 focus:ring-2 focus:ring-purple-500 outline-none" id="testFunc" onchange="runTest()">
                                    <option value="poly">f(x) = x² + 1 (多项式)</option>
                                    <option value="rational">f(x) = 1/(x−1) (有理函数)</option>
                                    <option value="piecewise">分段函数 (跳跃)</option>
                                    <option value="abs">f(x) = |x| (绝对值)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">检验点 $x_0$</label>
                                <div class="flex items-center gap-4">
                                    <input class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" id="testPointSlider" max="3" min="-3" oninput="updateTestPoint(this.value)" step="0.1" type="range" value="0">
                                    <input class="w-20 p-2 border border-gray-200 rounded-lg text-center font-mono text-sm" id="testPointInput" onchange="updateTestPoint(this.value)" type="number" value="0">
                                </div>
                            </div>
                            <button class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-md transition-all active:scale-95" onclick="runTest()">
                                执行检验
                            </button>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-5 border border-gray-100">
                            <h4 class="text-sm font-bold text-gray-500 uppercase mb-4 tracking-wider">检验报告</h4>
                            <div class="space-y-3" id="testReport">
                                <!-- Report items -->
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-200 text-center font-bold text-lg" id="testVerdict">
                                <!-- Verdict -->
                            </div>
                        </div>
                    </div>
                    <div class="relative w-full h-[300px] bg-white rounded-xl overflow-hidden border border-gray-200">
                        <canvas class="w-full h-full" id="testCanvas"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Mobile Nav -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 z-50">
        <button class="mobile-nav-btn flex flex-col items-center p-2 text-blue-600" data-target="definition" onclick="switchTab('definition')">
            <span class="material-symbols-outlined">menu_book</span>
            <span class="text-[10px] mt-1">定义</span>
        </button>
        <button class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-target="types" onclick="switchTab('types')">
            <span class="material-symbols-outlined">broken_image</span>
            <span class="text-[10px] mt-1">类型</span>
        </button>
        <button class="mobile-nav-btn flex flex-col items-center p-2 text-gray-400" data-target="check" onclick="switchTab('check')">
            <span class="material-symbols-outlined">fact_check</span>
            <span class="text-[10px] mt-1">检验</span>
        </button>
    </div>

    <script>
        // --- Global State ---
        let state = {
            currentCase: 1,
            testPoint: 0
        };

        // --- Tab Switching ---
        function switchTab(tabId) {
            // Desktop Nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.id === `btn-${tabId}`) {
                    btn.classList.add('bg-blue-50', 'text-blue-700');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-50');
                } else {
                    btn.classList.remove('bg-blue-50', 'text-blue-700');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-50');
                }
            });

            // Mobile Nav
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                if (btn.dataset.target === tabId) {
                    btn.classList.add('text-blue-600');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('text-blue-600');
                    btn.classList.add('text-gray-400');
                }
            });

            // Content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');

            // Render Logic
            if (tabId === 'definition') {
                requestAnimationFrame(drawContinuousGraph);
            } else if (tabId === 'types') {
                selectCase(state.currentCase);
            } else if (tabId === 'check') {
                runTest();
            }
        }

        // --- Canvas Helpers ---
        function setupCanvas(id) {
            const canvas = document.getElementById(id);
            if (!canvas) return null;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            const width = Math.max(rect.width, 100);
            const height = Math.max(rect.height, 100);
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            ctx.scale(dpr, dpr);
            return { ctx, width, height };
        }

        function drawGrid(ctx, width, height, scale, originX, originY) {
            ctx.strokeStyle = '#f3f4f6';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let x = originX; x < width; x += scale) { ctx.moveTo(x, 0); ctx.lineTo(x, height); }
            for(let x = originX; x > 0; x -= scale) { ctx.moveTo(x, 0); ctx.lineTo(x, height); }
            for(let y = originY; y < height; y += scale) { ctx.moveTo(0, y); ctx.lineTo(width, y); }
            for(let y = originY; y > 0; y -= scale) { ctx.moveTo(0, y); ctx.lineTo(width, y); }
            ctx.stroke();
        }

        function drawAxes(ctx, width, height, originX, originY) {
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            
            // X Axis
            ctx.moveTo(0, originY);
            ctx.lineTo(width, originY);
            ctx.lineTo(width - 8, originY - 4);
            ctx.moveTo(width, originY);
            ctx.lineTo(width - 8, originY + 4);

            // Y Axis
            ctx.moveTo(originX, height);
            ctx.lineTo(originX, 0);
            ctx.lineTo(originX - 4, 8);
            ctx.moveTo(originX, 0);
            ctx.lineTo(originX + 4, 8);
            
            ctx.stroke();

            ctx.fillStyle = '#1f2937';
            ctx.font = '12px sans-serif';
            ctx.fillText('x', width - 15, originY + 20);
            ctx.fillText('y', originX + 10, 15);
            ctx.fillText('O', originX - 12, originY + 15);
        }

        // --- Continuous Graph ---
        function drawContinuousGraph() {
            const setup = setupCanvas('continuousCanvas');
            if (!setup) return;
            const { ctx, width, height } = setup;
            const originX = width / 2;
            const originY = height / 2 + 20;
            const scale = 50;

            ctx.clearRect(0, 0, width, height);
            drawGrid(ctx, width, height, scale, originX, originY);
            drawAxes(ctx, width, height, originX, originY);

            // Draw f(x) = 0.5x^2 - 1
            ctx.beginPath();
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2.5;
            for (let px = 0; px <= width; px += 2) {
                const x = (px - originX) / scale;
                const y = 0.5 * x * x - 1;
                const py = originY - y * scale;
                if (px === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();

            // Draw Point at x=1
            const x0 = 1;
            const y0 = 0.5 * 1 * 1 - 1;
            const px0 = originX + x0 * scale;
            const py0 = originY - y0 * scale;

            ctx.fillStyle = '#10b981';
            ctx.beginPath();
            ctx.arc(px0, py0, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#374151';
            ctx.fillText(`(${x0}, ${y0})`, px0 + 10, py0);
        }

        // --- Discontinuous Types Logic ---
        const CASES = {
            1: {
                title: '跳跃间断点',
                formula: 'f(x) = \\text{sgn}(x)',
                analysis: '$\\displaystyle\\lim_{x \\to 0^-} f(x) = -1 \\neq \\lim_{x \\to 0^+} f(x) = 1$<br>左右极限存在但不相等。',
                tags: ['左右极限不等', '第一类间断点'],
                draw: (ctx, w, h, ox, oy, s) => {
                    // y = -1 for x < 0
                    ctx.beginPath();
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 2.5;
                    ctx.moveTo(0, oy + s);
                    ctx.lineTo(ox, oy + s);
                    ctx.stroke();
                    // Empty circle at (0, -1)
                    ctx.fillStyle = '#fff';
                    ctx.strokeStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.arc(ox, oy + s, 4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();

                    // y = 1 for x > 0
                    ctx.beginPath();
                    ctx.strokeStyle = '#ef4444';
                    ctx.moveTo(ox, oy - s);
                    ctx.lineTo(w, oy - s);
                    ctx.stroke();
                    // Empty circle at (0, 1)
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.arc(ox, oy - s, 4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                }
            },
            2: {
                title: '可去间断点',
                formula: 'f(x) = \\frac{x^2-1}{x-1}, x \\neq 1',
                analysis: '$\\displaystyle\\lim_{x \\to 1} f(x) = 2$，但 $f(1)$ 无定义。<br>左右极限相等，但在该点无定义或定义值不等于极限值。',
                tags: ['左右极限相等', '第一类间断点'],
                draw: (ctx, w, h, ox, oy, s) => {
                    // y = x + 1, hole at x=1
                    const xHole = 1;
                    const yHole = 2;
                    const pHoleX = ox + xHole * s;
                    const pHoleY = oy - yHole * s;

                    ctx.beginPath();
                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 2.5;
                    // Draw line
                    for (let px = 0; px <= w; px += 2) {
                        const x = (px - ox) / s;
                        const y = x + 1;
                        const py = oy - y * s;
                        if (px === 0) ctx.moveTo(px, py);
                        else ctx.lineTo(px, py);
                    }
                    ctx.stroke();

                    // Draw Hole
                    ctx.fillStyle = '#fff';
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(pHoleX, pHoleY, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                }
            },
            3: {
                title: '无穷间断点',
                formula: 'f(x) = \\frac{1}{x}',
                analysis: '$\\displaystyle\\lim_{x \\to 0^+} f(x) = +\\infty, \\lim_{x \\to 0^-} f(x) = -\\infty$<br>极限为无穷大。',
                tags: ['极限为无穷', '第二类间断点'],
                draw: (ctx, w, h, ox, oy, s) => {
                    ctx.strokeStyle = '#a855f7';
                    ctx.lineWidth = 2.5;

                    // Right branch
                    ctx.beginPath();
                    for (let px = ox + 1; px <= w; px += 2) {
                        const x = (px - ox) / s;
                        const y = 1 / x;
                        if (y > 10) continue;
                        const py = oy - y * s;
                        if (px === ox + 1) ctx.moveTo(px, py);
                        else ctx.lineTo(px, py);
                    }
                    ctx.stroke();

                    // Left branch
                    ctx.beginPath();
                    for (let px = 0; px < ox; px += 2) {
                        const x = (px - ox) / s;
                        const y = 1 / x;
                        if (y < -10) continue;
                        const py = oy - y * s;
                        if (px === 0) ctx.moveTo(px, py);
                        else ctx.lineTo(px, py);
                    }
                    ctx.stroke();

                    // Asymptote
                    ctx.setLineDash([5, 5]);
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(ox, 0);
                    ctx.lineTo(ox, h);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
        };

        function selectCase(id) {
            state.currentCase = id;

            // Update Buttons
            document.querySelectorAll('.case-btn').forEach(btn => {
                const titleEl = btn.querySelector('.font-bold');
                if (btn.dataset.case == id) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                    btn.classList.remove('border-transparent', 'bg-gray-50');
                    if (titleEl) {
                        titleEl.classList.remove('text-gray-800');
                        titleEl.classList.add('text-blue-900');
                    }
                } else {
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                    btn.classList.add('border-transparent', 'bg-gray-50');
                    if (titleEl) {
                        titleEl.classList.remove('text-blue-900');
                        titleEl.classList.add('text-gray-800');
                    }
                }
            });

            // Update Info
            const data = CASES[id];
            document.getElementById('caseFormula').innerHTML = `$${data.formula}$`;
            document.getElementById('caseAnalysis').innerHTML = data.analysis;

            const tagsContainer = document.getElementById('caseTags');
            tagsContainer.innerHTML = data.tags.map(t =>
                `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">${t}</span>`
            ).join('');

            if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();

            // Draw
            const setup = setupCanvas('discontinuousCanvas');
            if (!setup) return;
            const { ctx, width, height } = setup;
            const originX = width / 2;
            const originY = height / 2;
            const scale = 40;

            ctx.clearRect(0, 0, width, height);
            drawGrid(ctx, width, height, scale, originX, originY);
            drawAxes(ctx, width, height, originX, originY);
            data.draw(ctx, width, height, originX, originY, scale);
        }

        // --- Check Logic ---
        function updateTestPoint(val) {
            state.testPoint = parseFloat(val);
            document.getElementById('testPointSlider').value = state.testPoint;
            document.getElementById('testPointInput').value = state.testPoint;
            drawTestGraph();
        }

        function getFuncValue(type, x) {
            switch (type) {
                case 'poly': return x * x + 1;
                case 'rational': return x === 1 ? NaN : 1 / (x - 1);
                case 'piecewise': return x < 1 ? x : x + 1;
                case 'abs': return Math.abs(x);
                default: return 0;
            }
        }

        function checkContinuity(type, x0) {
            const epsilon = 0.0001;
            const f0 = getFuncValue(type, x0);
            const fLeft = getFuncValue(type, x0 - epsilon);
            const fRight = getFuncValue(type, x0 + epsilon);

            const isDefined = !isNaN(f0) && isFinite(f0);
            const limitExists = Math.abs(fLeft - fRight) < 0.1 && isFinite(fLeft);
            const isContinuous = isDefined && limitExists && Math.abs(fLeft - f0) < 0.1;

            return { isDefined, limitExists, isContinuous, f0, fLeft, fRight };
        }

        function runTest() {
            const type = document.getElementById('testFunc').value;
            const x0 = state.testPoint;
            const result = checkContinuity(type, x0);

            const reportDiv = document.getElementById('testReport');
            const verdictDiv = document.getElementById('testVerdict');

            let reportHTML = '';

            // 1. Definition
            reportHTML += `<div class="flex items-center gap-2 text-sm ${result.isDefined ? 'text-green-700' : 'text-red-700'}">
                <span class="material-symbols-outlined text-base">${result.isDefined ? 'check_circle' : 'cancel'}</span>
                1. 函数定义: ${result.isDefined ? `f(${x0}) = ${result.f0.toFixed(2)}` : '无定义'}
            </div>`;

            // 2. Limit
            reportHTML += `<div class="flex items-center gap-2 text-sm ${result.limitExists ? 'text-green-700' : 'text-red-700'}">
                <span class="material-symbols-outlined text-base">${result.limitExists ? 'check_circle' : 'cancel'}</span>
                2. 极限存在: ${result.limitExists ? `左右极限 ≈ ${result.fLeft.toFixed(2)}` : `左 ${result.fLeft.toFixed(2)} ≠ 右 ${result.fRight.toFixed(2)}`}
            </div>`;

            // 3. Equality
            const isEqual = result.isContinuous;
            reportHTML += `<div class="flex items-center gap-2 text-sm ${isEqual ? 'text-green-700' : 'text-red-700'}">
                <span class="material-symbols-outlined text-base">${isEqual ? 'check_circle' : 'cancel'}</span>
                3. 极限 = 函数值: ${isEqual ? '成立' : '不成立'}
            </div>`;

            reportDiv.innerHTML = reportHTML;

            verdictDiv.className = `mt-6 pt-4 border-t border-gray-200 text-center font-bold text-lg ${result.isContinuous ? 'text-green-600' : 'text-red-600'}`;
            verdictDiv.innerHTML = result.isContinuous ? '判定：连续' : '判定：不连续';

            if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise([reportDiv]);

            drawTestGraph();
        }

        function drawTestGraph() {
            const setup = setupCanvas('testCanvas');
            if (!setup) return;
            const { ctx, width, height } = setup;
            const originX = width / 2;
            const originY = height / 2 + 40;
            const scale = 40;

            ctx.clearRect(0, 0, width, height);
            drawGrid(ctx, width, height, scale, originX, originY);
            drawAxes(ctx, width, height, originX, originY);

            const type = document.getElementById('testFunc').value;
            const x0 = state.testPoint;

            ctx.beginPath();
            ctx.strokeStyle = '#4f46e5';
            ctx.lineWidth = 2.5;

            let start = true;
            for (let px = 0; px <= width; px += 2) {
                const x = (px - originX) / scale;
                // Handle visual discontinuity manually for piecewise
                if (type === 'rational' && Math.abs(x - 1) < 0.1) { start = true; continue; }
                if (type === 'piecewise' && Math.abs(x - 1) < 0.05) { start = true; continue; }

                const y = getFuncValue(type, x);
                if (isNaN(y) || Math.abs(y) > 10) { start = true; continue; }

                const py = originY - y * scale;
                if (start) { ctx.moveTo(px, py); start = false; }
                else { ctx.lineTo(px, py); }
            }
            ctx.stroke();

            // Draw Test Point Indicator
            const px0 = originX + x0 * scale;
            const yVal = getFuncValue(type, x0);

            ctx.strokeStyle = '#9333ea';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(px0, 0);
            ctx.lineTo(px0, height);
            ctx.stroke();
            ctx.setLineDash([]);

            // Point
            if (!isNaN(yVal) && isFinite(yVal)) {
                const py0 = originY - yVal * scale;
                ctx.fillStyle = '#9333ea';
                ctx.beginPath();
                ctx.arc(px0, py0, 6, 0, Math.PI * 2);
                ctx.fill();
            } else {
                // Draw empty circle for undefined
                let limY = getFuncValue(type, x0 + 0.01);
                if (isFinite(limY)) {
                    const py0 = originY - limY * scale;
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(px0, py0, 6, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        }

        // --- Init ---
        window.addEventListener('load', () => {
            switchTab('definition');
            selectCase(1);
        });

        window.addEventListener('resize', () => {
            if (!document.getElementById('tab-definition').classList.contains('hidden')) drawContinuousGraph();
            if (!document.getElementById('tab-types').classList.contains('hidden')) selectCase(state.currentCase);
            if (!document.getElementById('tab-check').classList.contains('hidden')) drawTestGraph();
        });
    </script>
</body>
</html>