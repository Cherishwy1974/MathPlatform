<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 8.4 全微分与线性近似实验室</title>
    
    <!-- ========================================
         修复1：使用本地MathJax，优化配置减少卡顿
         修复2：延迟加载，避免阻塞页面
         ======================================== -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax加载完成');
                    });
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <!-- 使用defer异步加载，避免阻塞 -->
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>
    
    <style>
        /* ========================================
           用户要求1：字号统一
           ======================================== */
        :root {
            --h1-size: 22px;      
            --h2-size: 20px;      
            --h3-size: 18px;      
            --btn-size: 16px;     
            --formula-size: 20px; 
            --text-size: 16px;
            
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #3730a3;
            --light: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ========================================
           用户要求：滚动条生效但不显示
           ======================================== */
        *::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }
        
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            font-size: var(--text-size);
            line-height: 1.5;
            background: var(--gray-50);
            color: var(--gray-800);
        }

        /* ========================================
           用户要求：横向布局（宽是高的2倍），压缩高度
           ======================================== */
        .container {
            width: 100%;
            max-width: 1400px;
            height: 100vh;
            max-height: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: var(--light);
        }

        .header {
            background: var(--primary);
            color: var(--light);
            padding: 8px 20px;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: var(--h2-size);
            margin: 0;
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========================================
           用户要求：侧边栏不动
           ======================================== */
        .sidebar {
            width: 120px;
            background: var(--gray-50);
            border-right: 1px solid var(--border);
            padding: 10px 8px;
        }

        .nav-btn {
            width: 100%;
            padding: 8px;
            margin-bottom: 4px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: var(--text-size);
            color: var(--gray-600);
            text-align: left;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: var(--gray-100);
        }

        .nav-btn.active {
            background: var(--primary);
            color: var(--light);
        }

        /* ========================================
           用户要求：最多左右两栏，必须有可视化
           ======================================== */
        .content {
            flex: 1;
            display: none;
            padding: 16px;
            overflow-y: auto;
        }

        .content.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .card {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .card h3 {
            font-size: var(--h3-size);
            color: var(--primary);
            margin-bottom: 12px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-size: var(--text-size);
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: var(--text-size);
            background: var(--gray-50);
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--light);
        }

        .btn {
            padding: 8px 16px;
            background: var(--primary);
            color: var(--light);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: var(--btn-size);
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .result {
            background: var(--gray-50);
            padding: 12px;
            border-radius: 4px;
            border: 1px solid var(--primary);
            text-align: center;
            font-size: var(--text-size);
            margin: 12px 0;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .formula-box {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid var(--primary);
            margin: 12px 0;
            text-align: center;
            font-size: var(--formula-size);
        }

        .info-box {
            background: var(--gray-50);
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: var(--text-size);
            text-align: center;
        }

        .steps {
            background: #fff9e6;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #f59e0b;
            line-height: 1.8;
            font-size: var(--text-size);
        }

        .canvas-container {
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            background: #fafafa;
            padding: 10px;
            min-height: 200px;
            max-height: 500px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-container canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
        }

        .dot-grid {
            display: grid;
            gap: 6px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 4px;
            justify-content: center;
            align-content: center;
            min-height: 200px;
            overflow: auto;
            max-width: 100%;
        }

        .dot {
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 4px;
            margin-top: 12px;
        }

        .slider-group label {
            min-width: 60px;
            font-size: var(--text-size);
        }

        .slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--gray-200);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }

        /* 立方体容器 - 智能自适应 */
        .cube-container {
            background: var(--gray-50);
            border-radius: 4px;
            padding: 20px;
            min-height: 250px;
            max-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .cube-container canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        /* ========================================
           响应式设计：小尺寸下导航按钮移到上方
           ======================================== */
        @media (max-width: 768px) {
            .main {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 8px 16px;
                display: flex;
                flex-direction: row;
                gap: 8px;
                overflow-x: auto;
                flex-shrink: 0;
                justify-content: center;
                flex-wrap: nowrap;
            }

            .nav-btn {
                min-width: 90px;
                text-align: center;
                margin-bottom: 0;
                white-space: nowrap;
                flex-shrink: 0;
                padding: 8px 12px;
                font-size: 14px;
            }

            .content.active {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .container {
                max-height: none;
                height: 100vh;
            }

            .header {
                padding: 6px 16px;
                height: 36px;
            }

            .header h1 {
                font-size: 18px;
            }

            .card {
                padding: 12px;
            }

            .canvas-container {
                min-height: 200px;
                max-height: 300px;
                padding: 8px;
            }

            .canvas-container canvas {
                width: 100%;
                max-width: 100%;
                height: auto;
            }

            .cube-container {
                min-height: 200px;
                max-height: 300px;
                padding: 16px;
            }

            .cube-container canvas {
                width: 100%;
                max-width: 100%;
                height: auto;
            }

            .dot-grid {
                min-height: 150px;
                padding: 12px;
                gap: 4px;
            }

            .dot {
                width: 20px;
                height: 20px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 4px 12px;
                height: 32px;
            }

            .header h1 {
                font-size: 16px;
            }

            .sidebar {
                padding: 6px 8px;
                gap: 6px;
                justify-content: space-between;
            }

            .nav-btn {
                min-width: 75px;
                padding: 6px 8px;
                font-size: 13px;
                flex: 1;
                max-width: 100px;
            }

            .content {
                padding: 12px;
            }

            .card {
                padding: 10px;
            }

            .canvas-container {
                min-height: 180px;
                max-height: 250px;
                padding: 6px;
            }

            .canvas-container canvas {
                width: 100%;
                max-width: 100%;
                height: auto;
            }

            .cube-container {
                min-height: 180px;
                max-height: 250px;
                padding: 12px;
            }

            .cube-container canvas {
                width: 100%;
                max-width: 100%;
                height: auto;
            }

            .dot-grid {
                min-height: 120px;
                padding: 8px;
                gap: 3px;
            }

            .dot {
                width: 18px;
                height: 18px;
            }
        }

        /* 极小屏幕优化 */
        @media (max-width: 360px) {
            .sidebar {
                padding: 4px 6px;
                gap: 4px;
            }

            .nav-btn {
                min-width: 65px;
                padding: 5px 6px;
                font-size: 12px;
            }

            .header h1 {
                font-size: 14px;
            }
        }
    </style>


</head>
<body>
    <div class="return-home-panel">
        <button class="return-toggle" type="button" aria-label="打开返回导航" onclick="toggleReturnPanel(event)"><i class="fa-solid fa-house"></i></button>
        <div class="return-links">
            <a class="return-link return-sub" href="index.html"><i class="fa-solid fa-arrow-left"></i> 返回目录</a>
            <a class="return-link return-main" href="../index.html"><i class="fa-solid fa-house"></i> 返回主站</a>
        </div>
    </div>
    <div class="container">
        <header class="header">
            <h1>Lab 8.4 全微分与线性近似</h1>
        </header>

        <div class="main">
            <!-- 侧边栏 -->
            <nav class="sidebar">
                <button class="nav-btn active" onclick="switchPanel('linear')">线性近似</button>
                <button class="nav-btn" onclick="switchPanel('differential')">全微分</button>
                <button class="nav-btn" onclick="switchPanel('error')">误差分析</button>
            </nav>

            <!-- 线性近似页面 -->
            <div class="content active" id="linear">
                <div class="column">
                    <div class="card">
                        <h3>函数与基准点</h3>
                        <div class="input-group">
                            <label>选择函数</label>
                            <select id="funcSelect" onchange="updateLinear()">
                                <option value="f1">f(x,y) = √(x²+y²)</option>
                                <option value="f2">f(x,y) = x²+y²</option>
                                <option value="f3">f(x,y) = e^(x+y)</option>
                            </select>
                        </div>
                        <div class="formula-box" id="linearFuncFormula">
                            $f(x,y)=\sqrt{x^2+y^2}$
                        </div>
                        <div class="input-group">
                            <label>基准点 $(x_0, y_0)$</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="x0" value="3" step="0.5">
                                <input type="number" id="y0" value="4" step="0.5">
                            </div>
                        </div>
                        <div class="info-box" id="baseValue">
                            $f(3, 4) = 5.00$
                        </div>
                        <div class="formula-box" id="linearFormula">
                            $L(x,y) = f(x_0,y_0) + f_x(x_0,y_0)(x-x_0) + f_y(x_0,y_0)(y-y_0)$
                        </div>
                    </div>
                    <div class="card">
                        <h3>近似点计算</h3>
                        <div class="input-group">
                            <label>近似点 $(x, y)$</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="x1" value="3.1" step="0.1">
                                <input type="number" id="y1" value="4.2" step="0.1">
                            </div>
                        </div>
                        <button class="btn" onclick="updateLinear()" style="width: 100%;">计算近似</button>
                        <div class="result" id="approxResult">
                            线性近似值：$L(3.1, 4.2) \approx 5.26$
                        </div>
                        <div class="result" id="exactResult">
                            精确值：$f(3.1, 4.2) = 5.24$
                        </div>
                        <div class="info-box" id="errorResult">
                            相对误差：0.38%
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="card">
                        <h3>几何意义</h3>
                        <div class="canvas-container">
                            <canvas id="linearCanvas" width="600" height="300"></canvas>
                        </div>
                        <div class="info-box">
                            蓝色：切平面（线性近似）<br>
                            红色：精确值点<br>
                            绿色：基准点
                        </div>
                    </div>
                </div>
            </div>

            <!-- 全微分页面 -->
            <div class="content" id="differential">
                <div class="column">
                    <div class="card">
                        <h3>全微分概念</h3>
                        <div class="formula-box">
                            $dz = f_x(x_0,y_0)dx + f_y(x_0,y_0)dy$
                        </div>
                        <div class="info-box">
                            全微分表示函数在某点沿任意方向的微小改变量，由两个偏导数决定。
                        </div>
                        <div class="input-group">
                            <label>微分点 $(x_0, y_0)$</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="dx0" value="1" step="0.5">
                                <input type="number" id="dy0" value="1" step="0.5">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>增量 $(dx, dy)$</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="dx" value="0.1" step="0.05">
                                <input type="number" id="dy" value="0.1" step="0.05">
                            </div>
                        </div>
                        <button class="btn" onclick="updateDifferential()" style="width: 100%;">计算全微分</button>
                        <div class="result" id="diffResult">
                            $dz = 0.14$
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="card">
                        <h3>全微分可微性</h3>
                        <div class="canvas-container">
                            <canvas id="diffCanvas" width="600" height="300"></canvas>
                        </div>
                        <div class="info-box">
                            函数可微 ⟺ 存在切平面<br>
                            可微 ⟹ 连续 ⟹ 偏导数存在
                        </div>
                    </div>
                </div>
            </div>

            <!-- 误差分析页面 -->
            <div class="content" id="error">
                <div class="column">
                    <div class="card">
                        <h3>误差估计</h3>
                        <div class="info-box">
                            线性近似误差：$|f(x,y) - L(x,y)|$<br>
                            通常在基准点附近很小
                        </div>
                        <div class="input-group">
                            <label>选择测试函数</label>
                            <select id="errorFunc" onchange="updateError()">
                                <option value="e1">f(x,y) = √(x²+y²)</option>
                                <option value="e2">f(x,y) = sin(x)cos(y)</option>
                                <option value="e3">f(x,y) = ln(1+x+y)</option>
                            </select>
                        </div>
                        <div class="formula-box" id="errorFuncFormula">
                            $f(x,y)=\sqrt{x^2+y^2}$
                        </div>
                        <div class="input-group">
                            <label>距离基准点</label>
                            <input type="range" id="distSlider" min="0" max="2" step="0.1" value="0.5" oninput="updateError()">
                            <span id="distValue">0.5</span>
                        </div>
                        <div class="result" id="errorValue">
                            绝对误差：0.012
                        </div>
                        <div class="result" id="relError">
                            相对误差：0.24%
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="card">
                        <h3>误差随距离变化</h3>
                        <div class="canvas-container">
                            <canvas id="errorCanvas" width="600" height="300"></canvas>
                        </div>
                        <div class="info-box">
                            图示：误差随距离增加而增大<br>
                            蓝线：绝对误差<br>
                            红线：相对误差(%)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        function renderMath() {
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise().catch(err => console.log('渲染错误:', err));
            }
        }

        // 页面切换
        function switchPanel(panel) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(panel).classList.add('active');
            
            // 延迟渲染公式，避免卡顿
            setTimeout(() => {
                renderMath();
                if (panel === 'linear') updateLinear();
                if (panel === 'differential') updateDifferential();
                if (panel === 'error') updateError();
            }, 50);
        }

        // 函数定义
        const functions = {
            f1: {
                f: (x,y) => Math.sqrt(x*x + y*y),
                fx: (x,y) => x / Math.sqrt(x*x + y*y),
                fy: (x,y) => y / Math.sqrt(x*x + y*y),
                name: 'f(x,y)=\\sqrt{x^2+y^2}'
            },
            f2: {
                f: (x,y) => x*x + y*y,
                fx: (x,y) => 2*x,
                fy: (x,y) => 2*y,
                name: 'f(x,y)=x^2+y^2'
            },
            f3: {
                f: (x,y) => Math.exp(x+y),
                fx: (x,y) => Math.exp(x+y),
                fy: (x,y) => Math.exp(x+y),
                name: 'f(x,y)=e^{x+y}'
            }
        };

        // 线性近似计算
        function updateLinear() {
            const key = document.getElementById('funcSelect')?.value || 'f1';
            const func = functions[key];
            const x0 = parseFloat(document.getElementById('x0')?.value || 3);
            const y0 = parseFloat(document.getElementById('y0')?.value || 4);
            const x1 = parseFloat(document.getElementById('x1')?.value || 3.1);
            const y1 = parseFloat(document.getElementById('y1')?.value || 4.2);
            
            const f0 = func.f(x0, y0);
            const fx0 = func.fx(x0, y0);
            const fy0 = func.fy(x0, y0);
            
            const L = f0 + fx0*(x1-x0) + fy0*(y1-y0);
            const exact = func.f(x1, y1);
            const error = Math.abs(exact - L) / exact * 100;
            
            // 更新公式显示框
            const formulaElem = document.getElementById('linearFuncFormula');
            if (formulaElem) {
                formulaElem.innerHTML = `$${func.name}$`;
            }
            
            const baseValueElem = document.getElementById('baseValue');
            const approxElem = document.getElementById('approxResult');
            const exactElem = document.getElementById('exactResult');
            const errorElem = document.getElementById('errorResult');
            
            if (baseValueElem) baseValueElem.innerHTML = `$${func.name.replace('f(x,y)', `f(${x0},${y0})`)} = ${f0.toFixed(2)}$`;
            if (approxElem) approxElem.innerHTML = `线性近似值：$L(${x1},${y1}) \\approx ${L.toFixed(2)}$`;
            if (exactElem) exactElem.innerHTML = `精确值：$${func.name.replace('f(x,y)', `f(${x1},${y1})`)} = ${exact.toFixed(2)}$`;
            if (errorElem) errorElem.innerHTML = `相对误差：${error.toFixed(2)}%`;
            
            drawLinear(func, x0, y0, x1, y1);
            renderMath();
        }

        // 绘制线性近似
        function drawLinear(func, x0, y0, x1, y1) {
            const canvas = document.getElementById('linearCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            
            const scale = 40;
            const ox = w/2, oy = h/2;
            
            // 绘制坐标轴
            ctx.strokeStyle = '#ccc';
            ctx.beginPath();
            ctx.moveTo(0, oy); ctx.lineTo(w, oy);
            ctx.moveTo(ox, 0); ctx.lineTo(ox, h);
            ctx.stroke();
            
            // 绘制切平面（线性近似）
            const fx0 = func.fx(x0, y0);
            const fy0 = func.fy(x0, y0);
            const f0 = func.f(x0, y0);
            
            ctx.strokeStyle = '#6366f1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let px = 0; px < w; px += 2) {
                const x = (px - ox) / scale;
                const z = f0 + fx0*(x-x0) + fy0*(0-y0);
                const py = oy - z * scale;
                if (px === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();
            
            // 基准点
            ctx.fillStyle = '#10b981';
            ctx.beginPath();
            ctx.arc(ox + x0*scale, oy - func.f(x0,y0)*scale, 6, 0, Math.PI*2);
            ctx.fill();
            
            // 近似点和精确点
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.arc(ox + x1*scale, oy - func.f(x1,y1)*scale, 5, 0, Math.PI*2);
            ctx.fill();
        }

        // 全微分计算
        function updateDifferential() {
            const x0 = parseFloat(document.getElementById('dx0')?.value || 1);
            const y0 = parseFloat(document.getElementById('dy0')?.value || 1);
            const dx = parseFloat(document.getElementById('dx')?.value || 0.1);
            const dy = parseFloat(document.getElementById('dy')?.value || 0.1);
            
            const f = (x,y) => x*x + y*y;
            const fx = (x,y) => 2*x;
            const fy = (x,y) => 2*y;
            
            const dz = fx(x0,y0)*dx + fy(x0,y0)*dy;
            
            const diffResultElem = document.getElementById('diffResult');
            if (diffResultElem) {
                diffResultElem.innerHTML = `$dz = ${dz.toFixed(2)}$`;
            }
            drawDifferential(x0, y0, dx, dy);
            renderMath();
        }

        // 绘制全微分示意
        function drawDifferential(x0, y0, dx, dy) {
            const canvas = document.getElementById('diffCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            
            const scale = 50;
            const ox = w/2, oy = h/2;
            
            // 绘制坐标轴
            ctx.strokeStyle = '#ccc';
            ctx.beginPath();
            ctx.moveTo(0, oy); ctx.lineTo(w, oy);
            ctx.moveTo(ox, 0); ctx.lineTo(ox, h);
            ctx.stroke();
            
            // 绘制切平面
            ctx.strokeStyle = '#6366f1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let px = 0; px < w; px += 2) {
                const x = (px - ox) / scale;
                const z = 2*x0*x + 2*y0*0;
                const py = oy - z * scale;
                ctx.lineTo(px, py);
            }
            ctx.stroke();
            
            // 增量向量
            ctx.strokeStyle = '#ef4444';
            ctx.beginPath();
            ctx.moveTo(ox + x0*scale, oy - (x0*x0+y0*y0)*scale);
            ctx.lineTo(ox + (x0+dx)*scale, oy - ((x0+dx)*(x0+dx)+(y0+dy)*(y0+dy))*scale/2);
            ctx.stroke();
        }

        // 误差分析
        function updateError() {
            const key = document.getElementById('errorFunc')?.value || 'e1';
            const dist = parseFloat(document.getElementById('distSlider')?.value || 0.5);
            const distElem = document.getElementById('distValue');
            if (distElem) distElem.textContent = dist.toFixed(1);
            
            const x0 = 1, y0 = 1;
            const x1 = x0 + dist*0.5, y1 = y0 + dist*0.5;
            
            let f, fx, fy, funcName;
            if (key === 'e1') {
                f = (x,y) => Math.sqrt(x*x+y*y);
                fx = (x,y) => x/Math.sqrt(x*x+y*y);
                fy = (x,y) => y/Math.sqrt(x*x+y*y);
                funcName = 'f(x,y)=\\sqrt{x^2+y^2}';
            } else if (key === 'e2') {
                f = (x,y) => Math.sin(x)*Math.cos(y);
                fx = (x,y) => Math.cos(x)*Math.cos(y);
                fy = (x,y) => -Math.sin(x)*Math.sin(y);
                funcName = 'f(x,y)=\\sin(x)\\cos(y)';
            } else {
                f = (x,y) => Math.log(1+x+y);
                fx = (x,y) => 1/(1+x+y);
                fy = (x,y) => 1/(1+x+y);
                funcName = 'f(x,y)=\\ln(1+x+y)';
            }
            
            // 更新公式显示
            const formulaElem = document.getElementById('errorFuncFormula');
            if (formulaElem) {
                formulaElem.innerHTML = `$${funcName}$`;
            }
            
            const exact = f(x1,y1);
            const approx = f(x0,y0) + fx(x0,y0)*(x1-x0) + fy(x0,y0)*(y1-y0);
            const absErr = Math.abs(exact - approx);
            const relErr = absErr / Math.abs(exact) * 100;
            
            const errorValueElem = document.getElementById('errorValue');
            const relErrorElem = document.getElementById('relError');
            if (errorValueElem) errorValueElem.innerHTML = `绝对误差：${absErr.toFixed(3)}`;
            if (relErrorElem) relErrorElem.innerHTML = `相对误差：${relErr.toFixed(2)}%`;
            
            drawErrorGraph();
            renderMath();
        }

        // 绘制误差图
        function drawErrorGraph() {
            const canvas = document.getElementById('errorCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width, h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            
            const ox = 40, oy = h - 40;
            
            // 坐标轴
            ctx.strokeStyle = '#666';
            ctx.beginPath();
            ctx.moveTo(ox, 20); ctx.lineTo(ox, oy);
            ctx.moveTo(ox, oy); ctx.lineTo(w-20, oy);
            ctx.stroke();
            
            // 误差曲线
            ctx.strokeStyle = '#6366f1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i <= 20; i++) {
                const d = i * 0.1;
                const err = d*d*0.1;
                const px = ox + d*200;
                const py = oy - err*200;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();
        }

        // 添加输入框事件监听
        function addInputListeners() {
            // 线性近似页面
            ['x0', 'y0', 'x1', 'y1'].forEach(id => {
                const elem = document.getElementById(id);
                if (elem) elem.addEventListener('input', updateLinear);
            });
            
            // 全微分页面
            ['dx0', 'dy0', 'dx', 'dy'].forEach(id => {
                const elem = document.getElementById(id);
                if (elem) elem.addEventListener('input', updateDifferential);
            });
        }

        // 初始化
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                addInputListeners();
                updateLinear();
                updateDifferential();
                updateError();
                renderMath();
            }, 100);
        });
    </script>
</body>
</html>